<!-- prettier-ignore-start -->
**Document Version:** 1.0
**Last Updated:** 2026-02-28
**Status:** ACTIVE
<!-- prettier-ignore-end -->

---

phase: 03-core-pipeline plan: 02 type: execute wave: 1 depends_on: []
files_modified:

- scripts/reviews/write-retro-record.ts
- scripts/reviews/write-deferred-items.ts
- scripts/reviews/write-invocation.ts
- scripts/reviews/**tests**/write-retro-record.test.ts
- scripts/reviews/**tests**/write-deferred-items.test.ts
- scripts/reviews/**tests**/write-invocation.test.ts autonomous: true

must_haves: truths: - "Running write-retro-record.ts creates a Zod-validated
RetroRecord in data/ecosystem-v2/retros.jsonl" - "When a review has deferred
items, write-deferred-items.ts auto-creates DeferredItemRecords in
deferred-items.jsonl" - "Running write-invocation.ts logs a skill/agent
invocation to invocations.jsonl with structured origin" - "Deferred items get
unique IDs derived from the parent review ID" - "Invocation records capture
skill name, type, duration, and success/error state" artifacts: - path:
"scripts/reviews/write-retro-record.ts" provides: "CLI to write validated
RetroRecord to v2 retros.jsonl" exports: ["writeRetroRecord (function)", "CLI
entry point"] - path: "scripts/reviews/write-deferred-items.ts" provides:
"Library + CLI for auto-creating deferred items from review findings" exports:
["createDeferredItems (function)", "CLI entry point"] - path:
"scripts/reviews/write-invocation.ts" provides: "CLI to log skill/agent
invocations to invocations.jsonl" exports: ["writeInvocation (function)", "CLI
entry point"] key_links: - from: "scripts/reviews/write-retro-record.ts" to:
"scripts/reviews/lib/schemas/retro.ts" via: "RetroRecord schema import" pattern:
"RetroRecord" - from: "scripts/reviews/write-deferred-items.ts" to:
"scripts/reviews/lib/schemas/deferred-item.ts" via: "DeferredItemRecord schema
import" pattern: "DeferredItemRecord" - from:
"scripts/reviews/write-invocation.ts" to:
"scripts/reviews/lib/schemas/invocation.ts" via: "InvocationRecord schema
import" pattern: "InvocationRecord"

---

<objective>
Build the retro writer, auto-deferred item creator, and invocation tracker CLIs.

Purpose: PIPE-02 (retro skill writes JSONL-first), PIPE-03 (auto-deferred item
creation), and PIPE-04 (unified invocation tracking) complete the write side of
the pipeline. Retro records capture retrospective data, deferred items are
auto-created when reviews have deferred findings (eliminating the manual step),
and invocations track all skill/agent usage in one place.

Output: Three CLI scripts with tests -- write-retro-record.ts,
write-deferred-items.ts, and write-invocation.ts, each validated by Zod schemas
from Phase 1. </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-pipeline/03-RESEARCH.md
@scripts/reviews/lib/schemas/retro.ts
@scripts/reviews/lib/schemas/deferred-item.ts
@scripts/reviews/lib/schemas/invocation.ts
@scripts/reviews/lib/schemas/shared.ts
@scripts/reviews/lib/write-jsonl.ts
@scripts/reviews/lib/read-jsonl.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create write-retro-record.ts and write-deferred-items.ts with tests</name>
  <files>
    scripts/reviews/write-retro-record.ts
    scripts/reviews/write-deferred-items.ts
    scripts/reviews/__tests__/write-retro-record.test.ts
    scripts/reviews/__tests__/write-deferred-items.test.ts
  </files>
  <action>
    Create `scripts/reviews/write-retro-record.ts`:
    1. CLI accepts `--data '{"pr":399,...}'` from process.argv
    2. Uses `findProjectRoot(__dirname)` to resolve `data/ecosystem-v2/retros.jsonl`
    3. Auto-assigns ID as `retro-pr-{pr_number}` if no id provided
    4. Validates with `RetroRecord.parse()` from `lib/schemas/retro.ts`
    5. Calls `appendRecord()` to write
    6. Outputs `Wrote retro {id} to retros.jsonl` on success
    7. Exits 1 on validation failure
    8. Export `writeRetroRecord(projectRoot, data)` for programmatic use

    Create `scripts/reviews/write-deferred-items.ts`:
    1. Export `createDeferredItems(projectRoot, reviewId, items, date)` function where items is `Array<{finding: string, reason?: string, severity?: string}>`
    2. For each item, constructs a DeferredItemRecord with:
       - id: `{reviewId}-deferred-{index+1}`
       - origin: `{type: "pr-review", tool: "write-deferred-items.ts"}`
       - status: "open"
       - defer_count: 1
       - promoted_to_debt: false
    3. Validates each with `DeferredItemRecord.parse()`
    4. Appends each to `data/ecosystem-v2/deferred-items.jsonl`
    5. Returns array of created records
    6. CLI mode: accepts `--review-id rev-N --date YYYY-MM-DD --items '[{"finding":"..."}]'`
    7. Creates the deferred-items.jsonl file if it doesn't exist (first use)

    Create test files:
    - `write-retro-record.test.ts`: valid retro writes, invalid rejects, auto-ID assigns `retro-pr-{N}`
    - `write-deferred-items.test.ts`: creates correct number of items, IDs follow `{reviewId}-deferred-{N}` pattern, creates file if missing, validates all fields, empty items array produces no records

    Use temp directories for test isolation. Node.js built-in test runner.

  </action>
  <verify>
    cd scripts/reviews && npx tsc --noEmit
    cd scripts/reviews && npx tsc && node dist/__tests__/write-retro-record.test.js
    cd scripts/reviews && node dist/__tests__/write-deferred-items.test.js
  </verify>
  <done>
    write-retro-record.ts and write-deferred-items.ts compile, all tests pass, retro records write to retros.jsonl, deferred items auto-create with correct IDs and schema validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create write-invocation.ts with tests</name>
  <files>
    scripts/reviews/write-invocation.ts
    scripts/reviews/__tests__/write-invocation.test.ts
  </files>
  <action>
    Create `scripts/reviews/write-invocation.ts`:
    1. CLI accepts `--data '{"skill":"pr-review","type":"skill",...}'` from process.argv
    2. Uses `findProjectRoot(__dirname)` to resolve `data/ecosystem-v2/invocations.jsonl`
    3. Auto-assigns ID as `inv-{timestamp}` if no id provided
    4. Auto-assigns date as today (YYYY-MM-DD) if no date provided
    5. Validates with `InvocationRecord.parse()` from `lib/schemas/invocation.ts`
    6. Calls `appendRecord()` to write
    7. Outputs `Tracked invocation {id} ({skill})` on success
    8. Exits 1 on validation failure
    9. Export `writeInvocation(projectRoot, data)` for programmatic use
    10. Creates the invocations.jsonl file if it doesn't exist (first use)

    The invocation record should support these skill/agent types from the research:
    - type: "skill" | "agent" (matching InvocationRecord schema)
    - skill: name of the skill (e.g., "pr-review", "pr-retro", "code-reviewer")
    - context: optional object with pr number, trigger info, etc.

    Create `scripts/reviews/__tests__/write-invocation.test.ts`:
    - Valid invocation writes successfully
    - Auto-ID uses timestamp-based format
    - Auto-date uses current date
    - Invalid data (missing skill name) rejects
    - Creates invocations.jsonl if not exists
    - Multiple invocations append correctly

    Use temp directories for test isolation.

  </action>
  <verify>
    cd scripts/reviews && npx tsc --noEmit
    cd scripts/reviews && npx tsc && node dist/__tests__/write-invocation.test.js
  </verify>
  <done>
    write-invocation.ts compiles, all tests pass, invocation records write to invocations.jsonl with auto-ID and auto-date, invalid data rejects
  </done>
</task>

</tasks>

<verification>
1. `cd scripts/reviews && npx tsc --noEmit` -- zero errors
2. All 3 test files pass: write-retro-record, write-deferred-items, write-invocation
3. Smoke test: write a retro record, verify it appears in retros.jsonl
4. Smoke test: create deferred items for a review, verify deferred-items.jsonl is created with correct entries
5. Smoke test: write an invocation, verify invocations.jsonl is created with correct entry
</verification>

<success_criteria>

- write-retro-record.ts writes Zod-validated RetroRecords to retros.jsonl
- write-deferred-items.ts auto-creates DeferredItemRecords with IDs derived from
  review ID
- write-invocation.ts tracks skill/agent invocations in invocations.jsonl
- All three create their target files if they don't exist
- Invalid data is rejected with clear Zod errors
- All tests pass </success_criteria>

<output>
After completion, create `.planning/phases/03-core-pipeline/03-02-SUMMARY.md`
</output>
