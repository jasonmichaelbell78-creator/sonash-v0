<!-- prettier-ignore-start -->
**Document Version:** 1.0
**Last Updated:** 2026-02-28
**Status:** ACTIVE
<!-- prettier-ignore-end -->

---

phase: 03-core-pipeline plan: 01 type: execute wave: 1 depends_on: []
files_modified:

- scripts/reviews/write-review-record.ts
- scripts/reviews/render-reviews-to-md.ts
- scripts/reviews/**tests**/write-review-record.test.ts
- scripts/reviews/**tests**/render-reviews-to-md.test.ts
- scripts/reviews/tsconfig.json autonomous: true

must_haves: truths: - "Running write-review-record.ts with valid JSON creates a
Zod-validated ReviewRecord in data/ecosystem-v2/reviews.jsonl" - "Running
write-review-record.ts with invalid data exits non-zero with a clear Zod error
message" - "Running render-reviews-to-md.ts produces human-readable markdown
from reviews.jsonl records" - "Auto-assigned IDs increment from the max existing
review ID in reviews.jsonl" artifacts: - path:
"scripts/reviews/write-review-record.ts" provides: "CLI to write validated
ReviewRecord to v2 reviews.jsonl" exports: ["writeReviewRecord (function)", "CLI
entry point"] - path: "scripts/reviews/render-reviews-to-md.ts" provides:
"JSONL-to-markdown renderer for reviews" exports: ["renderReviewsToMarkdown
(function)", "CLI entry point"] - path:
"scripts/reviews/**tests**/write-review-record.test.ts" provides: "Unit tests
for review writer" - path:
"scripts/reviews/**tests**/render-reviews-to-md.test.ts" provides: "Unit tests
for markdown renderer" key_links: - from:
"scripts/reviews/write-review-record.ts" to:
"scripts/reviews/lib/write-jsonl.ts" via: "appendRecord import" pattern:
"appendRecord" - from: "scripts/reviews/write-review-record.ts" to:
"scripts/reviews/lib/schemas/review.ts" via: "ReviewRecord schema import"
pattern: "ReviewRecord" - from: "scripts/reviews/render-reviews-to-md.ts" to:
"scripts/reviews/lib/read-jsonl.ts" via: "readValidatedJsonl import" pattern:
"readValidatedJsonl"

---

<objective>
Build the review record writer CLI and JSONL-to-markdown renderer.

Purpose: PIPE-01 (review skill writes JSONL-first) and PIPE-10 (render markdown
from JSONL source of truth) are the two ends of the review data flow -- write
structured data in, render human-readable views out. These scripts are the
bridge between skills and the v2 storage layer.

Output: Two CLI scripts with tests -- write-review-record.ts accepts review data
and appends a Zod-validated record to reviews.jsonl; render-reviews-to-md.ts
reads reviews.jsonl and produces formatted markdown output. </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-pipeline/03-RESEARCH.md
@scripts/reviews/lib/schemas/review.ts
@scripts/reviews/lib/schemas/shared.ts
@scripts/reviews/lib/write-jsonl.ts
@scripts/reviews/lib/read-jsonl.ts
@scripts/reviews/lib/completeness.ts
@scripts/reviews/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create write-review-record.ts CLI and tests</name>
  <files>
    scripts/reviews/write-review-record.ts
    scripts/reviews/__tests__/write-review-record.test.ts
    scripts/reviews/tsconfig.json
  </files>
  <action>
    Create `scripts/reviews/write-review-record.ts` as a CLI script that:
    1. Accepts `--data '{"pr":399,...}'` as a CLI argument (parse from process.argv)
    2. Uses `findProjectRoot(__dirname)` to resolve `data/ecosystem-v2/reviews.jsonl`
    3. If no `id` field in data, auto-assigns `rev-{N}` where N = max existing numeric suffix + 1 (read last few lines of reviews.jsonl to find max)
    4. Validates the record with `ReviewRecord.parse()` from `lib/schemas/review.ts`
    5. Calls `appendRecord()` from `lib/write-jsonl.ts` to write the validated record
    6. Outputs `Wrote review {id} to reviews.jsonl` on success
    7. Exits with code 1 on validation failure, printing the Zod error
    8. Export the core `writeReviewRecord(projectRoot, data)` function for programmatic use

    Also export a `getNextReviewId(projectRoot)` helper that reads reviews.jsonl and returns the next `rev-N` id.

    Update `scripts/reviews/tsconfig.json` include array: change from `["lib/**/*.ts", "dedup-debt.ts", "backfill-reviews.ts"]` to `["lib/**/*.ts", "*.ts"]` to automatically include all top-level scripts (per research open question #1). Keep exclude as-is.

    Create `scripts/reviews/__tests__/write-review-record.test.ts` with tests:
    - Valid full record writes successfully and appends to file
    - Invalid record (missing required fields) throws Zod error
    - Auto-ID assignment reads existing file and increments
    - Empty file produces rev-1 as first ID
    - CLI entry point exits 0 on success, 1 on failure (test via child_process.execSync on compiled JS)

    Use temp directories for test files (fs.mkdtempSync). Clean up in afterEach.
    Follow project test patterns: Node.js built-in test runner (node:test), assert module.

  </action>
  <verify>
    cd scripts/reviews && npx tsc --noEmit
    cd scripts/reviews && npx tsc && node dist/__tests__/write-review-record.test.js
  </verify>
  <done>
    write-review-record.ts compiles, all tests pass, valid data appends to JSONL, invalid data rejects with Zod error, auto-ID works correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create render-reviews-to-md.ts renderer and tests</name>
  <files>
    scripts/reviews/render-reviews-to-md.ts
    scripts/reviews/__tests__/render-reviews-to-md.test.ts
  </files>
  <action>
    Create `scripts/reviews/render-reviews-to-md.ts` that:
    1. Reads reviews.jsonl using `readValidatedJsonl()` from `lib/read-jsonl.ts` with the ReviewRecord schema
    2. Renders each record as a formatted markdown section with:
       - Heading: `### Review {id}: {title}`
       - Date, PR number, source
       - Stats table: total | fixed | deferred | rejected
       - Severity breakdown if present
       - Patterns list if present
       - Learnings list if present
    3. CLI mode: `node render-reviews-to-md.js` outputs to stdout
    4. Optional `--output path/to/file.md` writes to file
    5. Optional `--filter-pr N` renders only reviews for PR N
    6. Optional `--last N` renders only last N reviews
    7. Export `renderReviewRecord(record)` for single-record rendering (used by skills to show the review after writing)
    8. Export `renderReviewsToMarkdown(records)` for batch rendering

    Handle partial/stub records gracefully: render what's available, skip null fields, note completeness tier if not "full".

    Create `scripts/reviews/__tests__/render-reviews-to-md.test.ts` with tests:
    - Full record renders all sections
    - Partial record renders available fields, skips nulls
    - Stub record renders minimal info with completeness note
    - --filter-pr filters correctly
    - --last N limits output
    - Empty JSONL produces "No reviews found" message
    - Multiple records render in order

    Use Phase 1 test fixtures (full/partial/stub) from `scripts/reviews/__tests__/fixtures/` if they exist, otherwise create inline test data matching the ReviewRecord schema.

  </action>
  <verify>
    cd scripts/reviews && npx tsc --noEmit
    cd scripts/reviews && npx tsc && node dist/__tests__/render-reviews-to-md.test.js
  </verify>
  <done>
    render-reviews-to-md.ts compiles, all tests pass, full/partial/stub records render correctly, CLI flags work, output is human-readable markdown
  </done>
</task>

</tasks>

<verification>
1. `cd scripts/reviews && npx tsc --noEmit` -- zero errors
2. `cd scripts/reviews && npx tsc && node dist/__tests__/write-review-record.test.js` -- all pass
3. `cd scripts/reviews && node dist/__tests__/render-reviews-to-md.test.js` -- all pass
4. Manual smoke: `echo '{"pr":999,"title":"Test","date":"2026-02-28","schema_version":1,"completeness":"full","completeness_missing":[],"origin":{"type":"pr-review","tool":"test"},"source":"manual","total":5,"fixed":4,"deferred":1,"rejected":0}' | node dist/write-review-record.js --data -` writes to reviews.jsonl (or equivalent CLI invocation)
5. `node dist/render-reviews-to-md.js --last 1` shows the most recent review as markdown
</verification>

<success_criteria>

- write-review-record.ts writes Zod-validated ReviewRecords to
  data/ecosystem-v2/reviews.jsonl
- render-reviews-to-md.ts reads reviews.jsonl and produces formatted markdown
- Auto-ID assignment works (rev-N incrementing)
- Invalid data is rejected with clear error messages
- All tests pass
- tsconfig.json updated to include all top-level .ts files </success_criteria>

<output>
After completion, create `.planning/phases/03-core-pipeline/03-01-SUMMARY.md`
</output>
