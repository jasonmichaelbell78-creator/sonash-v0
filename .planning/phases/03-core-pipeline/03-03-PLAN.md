<!-- prettier-ignore-start -->
**Document Version:** 1.0
**Last Updated:** 2026-02-28
**Status:** ACTIVE
<!-- prettier-ignore-end -->

---

phase: 03-core-pipeline plan: 03 type: execute wave: 1 depends_on: []
files_modified:

- scripts/promote-patterns.ts
- scripts/generate-claude-antipatterns.ts
- scripts/generate-fix-template-stubs.ts
- scripts/reviews/**tests**/promotion-pipeline.test.ts autonomous: true

must_haves: truths: - "promote-patterns.ts detects patterns recurring N>=3 times
across M>=2 distinct PRs from reviews.jsonl" - "Promoted patterns are appended
to CODE_PATTERNS.md with dedup against existing entries" - "Each promoted
pattern generates an enforcement rule skeleton for
check-pattern-compliance.js" - "generate-claude-antipatterns.ts updates only the
auto-managed region of CLAUDE.md Section 4" - "generate-fix-template-stubs.ts
appends template skeletons to FIX_TEMPLATES.md for new patterns" - "Existing
run-consolidation.js continues to work during transition (not modified)"
artifacts: - path: "scripts/promote-patterns.ts" provides: "Merged promotion
pipeline: recurrence detection + CODE_PATTERNS + rule skeletons" exports:
["detectRecurrence", "promotePatterns", "generateRuleSkeleton"] - path:
"scripts/generate-claude-antipatterns.ts" provides: "CLAUDE.md Section 4
auto-updater" exports: ["generateAntiPatternsTable", "updateClaudeMd"] - path:
"scripts/generate-fix-template-stubs.ts" provides: "FIX_TEMPLATES.md stub
generator" exports: ["generateFixTemplateStub", "appendFixTemplateStubs"] -
path: "scripts/reviews/**tests**/promotion-pipeline.test.ts" provides: "Tests
for promotion pipeline, anti-patterns gen, and template stubs" key_links: -
from: "scripts/promote-patterns.ts" to: "scripts/reviews/lib/read-jsonl.ts" via:
"readValidatedJsonl to load reviews" pattern: "readValidatedJsonl" - from:
"scripts/promote-patterns.ts" to: "docs/agent_docs/CODE_PATTERNS.md" via:
"section-aware insertion (reuse logic from run-consolidation.js)" pattern:
"insertPatternsIntoSections|CODE_PATTERNS" - from:
"scripts/generate-claude-antipatterns.ts" to: "CLAUDE.md" via: "marker-delimited
section replacement" pattern: "AUTO-ANTIPATTERNS-START|AUTO-ANTIPATTERNS-END"

---

<objective>
Build the merged promotion pipeline with auto-generation of CODE_PATTERNS entries, enforcement rule skeletons, CLAUDE.md anti-patterns, and FIX_TEMPLATE stubs.

Purpose: PIPE-05 (merged promotion), PIPE-06 (auto rule generation), PIPE-07
(CLAUDE.md auto-gen), and PIPE-08 (FIX_TEMPLATE stubs) replace the manual
pattern lifecycle with an automated pipeline. When a pattern recurs N>=3 times
across M>=2 distinct PRs, the pipeline auto-promotes it to CODE_PATTERNS,
generates an enforcement rule skeleton, updates CLAUDE.md anti-patterns, and
creates a FIX_TEMPLATE stub.

Output: Three scripts -- promote-patterns.ts (core pipeline),
generate-claude-antipatterns.ts (CLAUDE.md updater),
generate-fix-template-stubs.ts (template stub generator) -- plus comprehensive
tests. </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-pipeline/03-RESEARCH.md
@scripts/run-consolidation.js
@scripts/reviews/lib/read-jsonl.ts
@scripts/reviews/lib/schemas/review.ts
@docs/agent_docs/CODE_PATTERNS.md
@docs/agent_docs/FIX_TEMPLATES.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create promote-patterns.ts with recurrence detection and CODE_PATTERNS promotion</name>
  <files>
    scripts/promote-patterns.ts
    scripts/reviews/__tests__/promotion-pipeline.test.ts
  </files>
  <action>
    Create `scripts/promote-patterns.ts` as a TypeScript CLI script that:

    1. **Read reviews**: Use `readValidatedJsonl()` with ReviewRecord schema to load `data/ecosystem-v2/reviews.jsonl`
    2. **Detect recurrence**: Implement `detectRecurrence(reviews, minOccurrences=3, minDistinctPRs=2)` that:
       - Extracts patterns from each review's `patterns` array
       - Counts occurrences and distinct PR numbers per pattern
       - Returns patterns meeting both thresholds, sorted by count descending
       - Returns `RecurrenceResult[]` with: pattern, count, distinctPRs (Set<number>), reviewIds
    3. **Filter already-promoted**: Read `docs/agent_docs/CODE_PATTERNS.md`, extract existing pattern names, skip patterns already present (reuse logic from run-consolidation.js `filterNewPatterns` approach -- read CODE_PATTERNS.md and check if pattern name already appears in a heading or table row)
    4. **Promote to CODE_PATTERNS**: For each new pattern, append a section to CODE_PATTERNS.md under the appropriate category (Security/JS/Shell/CI/Docs/General -- use keyword-based categorization similar to `categorizePatterns` in run-consolidation.js). Each entry includes: pattern name, description derived from review data, occurrence count, PR references, enforcement status "pending"
    5. **Generate rule skeletons**: For each promoted pattern, generate an enforcement rule skeleton object matching the format used by `check-pattern-compliance.js`: `{id, pattern (regex string), message, fix, fileTypes, severity}`. Output these to stdout as JSON for manual review, and also return them programmatically
    6. **Update consolidation state**: Read `.claude/state/consolidation.json` if it exists, update the `lastProcessedId` or equivalent marker so the script is idempotent across runs

    Export all core functions for testing: `detectRecurrence`, `filterAlreadyPromoted`, `categorizePattern`, `generateRuleSkeleton`, `promotePatterns` (orchestrator).

    CLI mode: `node scripts/promote-patterns.js` runs the full pipeline, outputs summary.
    Flags: `--dry-run` shows what would be promoted without writing, `--min-occurrences N`, `--min-prs M`.

    IMPORTANT: Do NOT modify `scripts/run-consolidation.js`. The promotion script is a new parallel path. Both coexist during transition per research pitfall #5. Reuse algorithmic logic by reimplementing the key functions in TypeScript (they're small -- pattern matching, section insertion, dedup).

    Note: This script lives in `scripts/` (not `scripts/reviews/`) because it operates across multiple data sources and outputs to non-review files (CODE_PATTERNS.md). However, its test file goes in `scripts/reviews/__tests__/` where the test infrastructure exists.

    Create `scripts/reviews/__tests__/promotion-pipeline.test.ts`:
    - detectRecurrence: returns patterns meeting threshold, ignores below-threshold
    - detectRecurrence: counts distinct PRs correctly (same pattern in multiple reviews for same PR = 1 PR)
    - filterAlreadyPromoted: filters out patterns already in CODE_PATTERNS.md
    - categorizePattern: maps "error-handling" to JS, "path-traversal" to Security, unknown to General
    - generateRuleSkeleton: produces valid rule object with all required fields
    - Integration: full pipeline with mock reviews produces correct promotions

    Tests should use inline test data, not read from production files. Create mock review records matching ReviewRecord shape.

  </action>
  <verify>
    cd scripts/reviews && npx tsc --noEmit
    cd scripts/reviews && npx tsc && node dist/__tests__/promotion-pipeline.test.js
    node scripts/promote-patterns.js --dry-run 2>&1 | head -20
  </verify>
  <done>
    promote-patterns.ts compiles, all tests pass, --dry-run shows recurrence analysis from real data without writing, patterns meeting threshold are correctly identified and categorized
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CLAUDE.md and FIX_TEMPLATES auto-generators</name>
  <files>
    scripts/generate-claude-antipatterns.ts
    scripts/generate-fix-template-stubs.ts
  </files>
  <action>
    Create `scripts/generate-claude-antipatterns.ts`:
    1. Reads the recurrence data (either by importing from promote-patterns.ts or by running its own analysis of reviews.jsonl)
    2. Takes top 6 patterns by recurrence count
    3. Generates a markdown table matching CLAUDE.md Section 4 "Top 5" format: `| Pattern | Rule |`
    4. Reads CLAUDE.md, finds the auto-managed region between `<!-- AUTO-ANTIPATTERNS-START -->` and `<!-- AUTO-ANTIPATTERNS-END -->` markers
    5. If markers don't exist yet, adds them around the existing "Top 5" table in Section 4 (first run setup)
    6. Replaces content between markers with the new table
    7. Writes updated CLAUDE.md
    8. CRITICAL: Preserves all content outside the markers exactly as-is. Does not change line count significantly (CLAUDE.md must stay ~120 lines per project rules)
    9. Export `generateAntiPatternsTable(patterns)` and `updateClaudeMd(projectRoot, patterns)` for testing

    CLI: `node scripts/generate-claude-antipatterns.js` runs the update.
    Flag: `--dry-run` shows the new table without writing.

    Create `scripts/generate-fix-template-stubs.ts`:
    1. Accepts an array of promoted patterns (from promote-patterns.ts output or its own analysis)
    2. For each pattern not already in FIX_TEMPLATES.md:
       - Finds the next template number (read existing, find max `### Template #NN`, increment)
       - Generates a stub: `### Template #NN: {Pattern Name}\n\n**Pattern:** {description}\n**When to use:** [TODO: fill in]\n**Fix:**\n\`\`\`\n// TODO: add fix example\n\`\`\`\n**Source:** Auto-generated from {count}x recurrence across {M} PRs\n`
    3. Appends stubs to `docs/agent_docs/FIX_TEMPLATES.md`
    4. Export `generateFixTemplateStub(pattern, templateNumber)` and `appendFixTemplateStubs(projectRoot, patterns)` for testing

    CLI: `node scripts/generate-fix-template-stubs.js` runs the generation.
    Flag: `--dry-run` shows stubs without writing.

    Add tests for both to the existing `promotion-pipeline.test.ts` (or create separate small test files if promotion-pipeline.test.ts is already large):
    - generateAntiPatternsTable: produces correct markdown table with top 6
    - updateClaudeMd: replaces content between markers, preserves rest
    - updateClaudeMd: adds markers on first run if missing
    - generateFixTemplateStub: produces correctly numbered stub
    - appendFixTemplateStubs: skips patterns already in FIX_TEMPLATES.md

  </action>
  <verify>
    cd scripts/reviews && npx tsc --noEmit
    node scripts/generate-claude-antipatterns.js --dry-run
    node scripts/generate-fix-template-stubs.js --dry-run
  </verify>
  <done>
    Both scripts compile, --dry-run shows correct output, CLAUDE.md markers work (add on first run, replace on subsequent), FIX_TEMPLATE stubs are correctly numbered and skip existing patterns
  </done>
</task>

</tasks>

<verification>
1. `cd scripts/reviews && npx tsc --noEmit` -- zero errors
2. `node dist/__tests__/promotion-pipeline.test.js` -- all tests pass
3. `node scripts/promote-patterns.js --dry-run` -- shows recurrence analysis
4. `node scripts/generate-claude-antipatterns.js --dry-run` -- shows anti-patterns table
5. `node scripts/generate-fix-template-stubs.js --dry-run` -- shows template stubs
6. `npm run consolidation:run` still works (run-consolidation.js not broken)
</verification>

<success_criteria>

- promote-patterns.ts detects recurrence (N>=3, M>=2 PRs) and promotes to
  CODE_PATTERNS.md
- Rule skeletons generated for each promoted pattern
- generate-claude-antipatterns.ts updates CLAUDE.md Section 4 between markers
  only
- generate-fix-template-stubs.ts appends numbered stubs to FIX_TEMPLATES.md
- run-consolidation.js is untouched and still works
- All --dry-run modes work for safe preview
- All tests pass </success_criteria>

<output>
After completion, create `.planning/phases/03-core-pipeline/03-03-SUMMARY.md`
</output>
