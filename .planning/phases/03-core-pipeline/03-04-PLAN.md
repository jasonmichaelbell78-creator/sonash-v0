<!-- prettier-ignore-start -->
**Document Version:** 1.0
**Last Updated:** 2026-02-28
**Status:** ACTIVE
<!-- prettier-ignore-end -->

---

phase: 03-core-pipeline plan: 04 type: execute wave: 2 depends_on: ["03-01",
"03-02", "03-03"] files_modified:

- .claude/skills/pr-review/SKILL.md
- .claude/skills/pr-retro/SKILL.md
- docs/agent_docs/FIX_TEMPLATES.md autonomous: true

must_haves: truths: - "pr-review SKILL.md includes a step that invokes
write-review-record.ts to write JSONL after completing the review" - "pr-review
SKILL.md includes a step that invokes write-deferred-items.ts for any deferred
findings" - "pr-review SKILL.md includes a step that invokes write-invocation.ts
to track the invocation" - "pr-retro SKILL.md includes dual-write: JSONL via
write-retro-record.ts AND legacy markdown append" - "pr-retro SKILL.md includes
a step that invokes write-invocation.ts to track the invocation" - "3
security-specific FIX_TEMPLATES exist for error sanitization, path traversal,
and symlink guard patterns" artifacts: - path:
".claude/skills/pr-review/SKILL.md" provides: "Updated pr-review skill with
JSONL write steps" contains: "write-review-record" - path:
".claude/skills/pr-retro/SKILL.md" provides: "Updated pr-retro skill with JSONL
dual-write steps" contains: "write-retro-record" - path:
"docs/agent_docs/FIX_TEMPLATES.md" provides: "3 new security fix templates"
key_links: - from: ".claude/skills/pr-review/SKILL.md" to:
"scripts/reviews/write-review-record.ts" via: "CLI invocation instruction in
skill step" pattern: "write-review-record" - from:
".claude/skills/pr-review/SKILL.md" to:
"scripts/reviews/write-deferred-items.ts" via: "CLI invocation instruction for
deferred items" pattern: "write-deferred-items" - from:
".claude/skills/pr-retro/SKILL.md" to: "scripts/reviews/write-retro-record.ts"
via: "CLI invocation instruction in skill step" pattern: "write-retro-record"

---

<objective>
Wire JSONL writes into the pr-review and pr-retro skills and author 3 security FIX_TEMPLATES.

Purpose: PIPE-09 (security FIX_TEMPLATES) and the skill wiring for
PIPE-01/02/03/04 are the final integration layer. The CLI scripts from Plans
01-03 exist but aren't invoked by anything yet. This plan adds the JSONL write
steps to the skill documents so Claude follows them during review/retro
execution, and creates 3 authored security templates for the most common
security patterns.

Output: Updated pr-review and pr-retro SKILL.md files with JSONL pipeline steps,
plus 3 new security FIX_TEMPLATES in FIX_TEMPLATES.md. </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-pipeline/03-RESEARCH.md
@.planning/phases/03-core-pipeline/03-01-SUMMARY.md
@.planning/phases/03-core-pipeline/03-02-SUMMARY.md
@.planning/phases/03-core-pipeline/03-03-SUMMARY.md
@.claude/skills/pr-review/SKILL.md
@.claude/skills/pr-retro/SKILL.md
@docs/agent_docs/FIX_TEMPLATES.md
@docs/agent_docs/CODE_PATTERNS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire JSONL writes into pr-review and pr-retro skills</name>
  <files>
    .claude/skills/pr-review/SKILL.md
    .claude/skills/pr-retro/SKILL.md
  </files>
  <action>
    Update `.claude/skills/pr-review/SKILL.md`:

    1. Add a new step between STEP 7 (LEARNING) and STEP 8 (FINAL SUMMARY) called **STEP 7.5: JSONL PIPELINE** with these sub-steps:

       **7.5.1 Write Review Record:**
       ```bash
       cd scripts/reviews && npx tsc && node dist/write-review-record.js --data '{"pr":PR_NUM,"title":"PR #N RX - Source","date":"YYYY-MM-DD","schema_version":1,"completeness":"full","completeness_missing":[],"origin":{"type":"pr-review","pr":PR_NUM,"round":ROUND,"tool":"write-review-record.ts"},"source":"SOURCE","total":TOTAL,"fixed":FIXED,"deferred":DEFERRED,"rejected":REJECTED,"patterns":["pattern1","pattern2"],"learnings":["learning1"],"severity_breakdown":{"critical":N,"major":N,"minor":N,"trivial":N},"per_round_detail":null,"rejection_analysis":null,"ping_pong_chains":null}'
       ```
       Fill in actual values from the review. The id will be auto-assigned.

       **7.5.2 Create Deferred Items (if deferred > 0):**
       ```bash
       node dist/write-deferred-items.js --review-id REV_ID --date YYYY-MM-DD --items '[{"finding":"description","severity":"major"}]'
       ```
       Create one item per deferred finding from Step 6.

       **7.5.3 Track Invocation:**
       ```bash
       node dist/write-invocation.js --data '{"skill":"pr-review","type":"skill","duration_ms":null,"success":true,"error":null,"context":{"pr":PR_NUM,"trigger":"user-invoked"}}'
       ```

    2. Add a note at the top of STEP 7.5: "This step writes structured data to the v2 JSONL pipeline. The JSONL record is the source of truth; the markdown learning log entry (Step 7) is a human-readable view that coexists during transition."

    3. Keep all existing steps intact. Do not remove or modify Steps 0-7 or Steps 8-9. Only insert Step 7.5.

    4. Update the Protocol Overview ASCII diagram to include Step 7.5.

    5. Bump version to 3.6 with description: "Add JSONL pipeline step (Step 7.5) for v2 data capture"

    Update `.claude/skills/pr-retro/SKILL.md`:

    1. Modify STEP 4 (SAVE TO LOG) to add dual-write:

       **4.1 Write JSONL Record (source of truth):**
       ```bash
       cd scripts/reviews && npx tsc && node dist/write-retro-record.js --data '{"pr":PR_NUM,"date":"YYYY-MM-DD","schema_version":1,"completeness":"full","completeness_missing":[],"origin":{"type":"pr-retro","pr":PR_NUM,"tool":"write-retro-record.ts"},"session":null,"top_wins":["win1"],"top_misses":["miss1"],"process_changes":["change1"],"score":8.0,"metrics":{"total_findings":N,"fix_rate":0.8,"pattern_recurrence":N}}'
       ```

       **4.2 Append to Legacy Log (dual-write during transition):**
       Keep existing: Append the complete retrospective to `docs/AI_REVIEW_LEARNINGS_LOG.md`.

       **4.3 Sync:**
       Keep existing: Run `npm run reviews:sync -- --apply`.

       **4.4 Track Invocation:**
       ```bash
       node dist/write-invocation.js --data '{"skill":"pr-retro","type":"skill","duration_ms":null,"success":true,"error":null,"context":{"pr":PR_NUM,"trigger":"user-invoked"}}'
       ```

    2. Add a note: "Step 4.1 is the source of truth. Step 4.2 is the legacy view maintained during transition. Both must be written."

    3. Bump version to 3.3 with description: "Add JSONL dual-write in Step 4, invocation tracking"

    IMPORTANT: Keep both SKILL.md files under 500 lines (current project constraint). The JSONL steps should be concise -- template commands that Claude fills in with actual values.

  </action>
  <verify>
    wc -l .claude/skills/pr-review/SKILL.md (must be under 500)
    wc -l .claude/skills/pr-retro/SKILL.md (must be under 500)
    grep -c "write-review-record" .claude/skills/pr-review/SKILL.md (should be >= 1)
    grep -c "write-retro-record" .claude/skills/pr-retro/SKILL.md (should be >= 1)
    grep -c "write-invocation" .claude/skills/pr-review/SKILL.md (should be >= 1)
    grep -c "write-invocation" .claude/skills/pr-retro/SKILL.md (should be >= 1)
    grep -c "write-deferred-items" .claude/skills/pr-review/SKILL.md (should be >= 1)
  </verify>
  <done>
    Both SKILL.md files updated with JSONL pipeline steps, under 500 lines each, all CLI script references present, version numbers bumped
  </done>
</task>

<task type="auto">
  <name>Task 2: Author 3 security FIX_TEMPLATES</name>
  <files>
    docs/agent_docs/FIX_TEMPLATES.md
  </files>
  <action>
    Read `docs/agent_docs/FIX_TEMPLATES.md` to find the current max template number and existing security templates.

    Based on the research (PIPE-09) and CODE_PATTERNS.md, the 3 most common security patterns are:
    1. **Error sanitization** -- using scripts/lib/sanitize-error.js to prevent raw error.message leaking
    2. **Path traversal prevention** -- checking relative paths with regex, using path containment helpers
    3. **Symlink guard patterns** -- using safe-fs.js isSafeToWrite before any file write

    Append 3 new authored (not stub) templates to FIX_TEMPLATES.md:

    **Template #N+1: Error Sanitization Guard**
    - Pattern: Raw `error.message` or `err.message` logged/returned without sanitization
    - When to use: Any catch block that surfaces error info to logs, user output, or error responses
    - Fix: Import and use `sanitizeError(error)` from `scripts/lib/sanitize-error.js`
    - Before/After code examples showing the transformation
    - Edge cases: nested errors, error chains, non-Error throws
    - Source: CODE_PATTERNS.md, enforced by `npm run patterns:check`

    **Template #N+2: Path Traversal Prevention**
    - Pattern: User-supplied or dynamic paths used without traversal check
    - When to use: Any code that constructs file paths from variables, CLI args, or external input
    - Fix: Use `/^\.\.(?:[\\/]|$)/.test(rel)` pattern (NOT `startsWith('..')` which misses `../`)
    - Before/After with `path.resolve` + containment check
    - Include the full guard: normalize -> resolve -> check containment within allowed directory
    - Source: CODE_PATTERNS.md, CLAUDE.md Section 4

    **Template #N+3: Symlink Guard for File Writes**
    - Pattern: `fs.writeFileSync`, `fs.appendFileSync`, `fs.renameSync` without symlink check
    - When to use: Any file write operation in scripts/ or .claude/hooks/
    - Fix: Use `isSafeToWrite(path)` from `scripts/lib/safe-fs.js` before writing
    - Before/After showing the guard wrapper pattern
    - Include: what to do when isSafeToWrite returns false (log warning, skip write, throw)
    - Source: CLAUDE.md Section 2 Rule 1, enforced by security-auditor agent

    Each template should follow the existing format in FIX_TEMPLATES.md (read the file to match style). Templates should be substantive -- full code examples, not stubs. These are authored content meant to be copy-pasted by Claude during reviews.

  </action>
  <verify>
    grep -c "Template #" docs/agent_docs/FIX_TEMPLATES.md (should increase by 3)
    grep "Error Sanitization" docs/agent_docs/FIX_TEMPLATES.md
    grep "Path Traversal" docs/agent_docs/FIX_TEMPLATES.md
    grep "Symlink Guard" docs/agent_docs/FIX_TEMPLATES.md
  </verify>
  <done>
    3 new security FIX_TEMPLATES appended to FIX_TEMPLATES.md with full code examples, matching existing format, covering the 3 most common security patterns from CODE_PATTERNS.md
  </done>
</task>

</tasks>

<verification>
1. pr-review SKILL.md has Step 7.5 with write-review-record, write-deferred-items, write-invocation references
2. pr-retro SKILL.md has updated Step 4 with dual-write (JSONL + legacy markdown) and invocation tracking
3. Both skills under 500 lines
4. FIX_TEMPLATES.md has 3 new security templates with full code examples
5. Version numbers bumped in both skills
6. No existing functionality broken (all prior steps preserved)
</verification>

<success_criteria>

- pr-review skill directs Claude to write review JSONL, create deferred items,
  and log invocation
- pr-retro skill directs Claude to write retro JSONL (source of truth) AND
  legacy markdown (dual-write)
- Both skills track invocations via write-invocation.ts
- 3 authored security FIX_TEMPLATES cover error sanitization, path traversal,
  and symlink guards
- All changes are additive -- no existing functionality removed
  </success_criteria>

<output>
After completion, create `.planning/phases/03-core-pipeline/03-04-SUMMARY.md`
</output>
