<!-- prettier-ignore-start -->
**Document Version:** 1.0
**Last Updated:** 2026-02-28
**Status:** ACTIVE
<!-- prettier-ignore-end -->

---

phase: 01-storage-foundation plan: 01 type: execute wave: 1 depends_on: []
files_modified:

- scripts/reviews/lib/schemas/shared.ts
- scripts/reviews/lib/schemas/review.ts
- scripts/reviews/lib/schemas/retro.ts
- scripts/reviews/lib/schemas/deferred-item.ts
- scripts/reviews/lib/schemas/invocation.ts
- scripts/reviews/lib/schemas/warning.ts
- scripts/reviews/lib/schemas/index.ts
- scripts/reviews/tsconfig.json
- tsconfig.test.json autonomous: true

must_haves: truths: - "Zod schemas exist for all 5 JSONL file types (reviews,
retros, deferred-items, invocations, warnings)" - "Each schema enforces the
three-tier completeness model (full/partial/stub) with completeness_missing
array" - "Origin is a structured Zod object, never a string" - "TypeScript
compiles without errors" artifacts: - path:
"scripts/reviews/lib/schemas/shared.ts" provides: "BaseRecord, Origin,
CompletenessTier shared schemas" exports: ["BaseRecord", "Origin",
"CompletenessTier"] - path: "scripts/reviews/lib/schemas/review.ts" provides:
"ReviewRecord schema with required/standard/extended tiers" exports:
["ReviewRecord", "ReviewRecordType"] - path:
"scripts/reviews/lib/schemas/retro.ts" provides: "RetroRecord schema" exports:
["RetroRecord", "RetroRecordType"] - path:
"scripts/reviews/lib/schemas/deferred-item.ts" provides: "DeferredItemRecord
schema" exports: ["DeferredItemRecord", "DeferredItemRecordType"] - path:
"scripts/reviews/lib/schemas/invocation.ts" provides: "InvocationRecord schema"
exports: ["InvocationRecord", "InvocationRecordType"] - path:
"scripts/reviews/lib/schemas/warning.ts" provides: "WarningRecord schema"
exports: ["WarningRecord", "WarningRecordType"] - path:
"scripts/reviews/lib/schemas/index.ts" provides: "Barrel re-export of all
schemas and types" - path: "scripts/reviews/tsconfig.json" provides: "TypeScript
compilation config for v2 scripts" key_links: - from:
"scripts/reviews/lib/schemas/review.ts" to:
"scripts/reviews/lib/schemas/shared.ts" via: "import and extend BaseRecord"
pattern: "BaseRecord\\.extend" - from: "scripts/reviews/lib/schemas/index.ts"
to: "all schema files" via: "re-export" pattern: "export .\* from"

---

<objective>
Define Zod schemas for all 5 JSONL file types with shared base record, structured origin, and three-tier completeness model. Set up TypeScript compilation for the new scripts/reviews/ directory.

Purpose: Every subsequent plan and phase depends on these schemas for
validation. They are the contract that ensures data integrity across the entire
ecosystem. Output: 7 TypeScript schema files + 2 tsconfig updates, all compiling
cleanly. </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-storage-foundation/01-RESEARCH.md

Key existing files to reference: @functions/src/schemas.ts (Zod pattern
reference) @tsconfig.test.json (needs include path update)
@scripts/lib/safe-fs.js (file I/O infrastructure -- DO NOT modify) </context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory structure, tsconfig, and shared schema</name>
  <files>
    scripts/reviews/lib/schemas/shared.ts
    scripts/reviews/tsconfig.json
    tsconfig.test.json
  </files>
  <action>
1. Create directory: `scripts/reviews/lib/schemas/`

2. Create `scripts/reviews/tsconfig.json`:
   - Extends root `../../tsconfig.json`
   - compilerOptions: outDir `./dist`, module `commonjs`, moduleResolution
     `node`, target `ES2019`, declaration `true`, esModuleInterop `true`, strict
     `true`, noEmit `false`
   - include: `["lib/**/*.ts"]`

3. Update `tsconfig.test.json`:
   - Add `"scripts/reviews/lib/**/*.ts"` to the `include` array (alongside
     existing entries)
   - This ensures test compilation can import the schema types

4. Create `scripts/reviews/lib/schemas/shared.ts`:
   - Import `z` from `"zod"`
   - Define `CompletenessTier = z.enum(["full", "partial", "stub"])`
   - Define
     `Origin = z.object({ type: z.enum(["pr-review", "pr-retro", "backfill", "migration", "manual"]), pr: z.number().int().positive().optional(), round: z.number().int().positive().optional(), session: z.string().optional(), tool: z.string().optional() })`
   - Define
     `BaseRecord = z.object({ id: z.string().min(1), date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/), schema_version: z.number().int().positive(), completeness: CompletenessTier, completeness_missing: z.array(z.string()).default([]), origin: Origin })`
   - Export all three schemas AND their inferred types: `CompletenessTierType`,
     `OriginType`, `BaseRecordType`

IMPORTANT Zod 4 notes:

- Use `z.enum()` not `z.nativeEnum()`
- Import as `import { z } from "zod"`
- Use `z.infer<typeof SchemaName>` for type inference
- Do NOT use `z.string().email()` -- use `z.email()` if needed (not needed here)
  </action> <verify> Run: `npx tsc -p scripts/reviews/tsconfig.json --noEmit` --
  should exit 0 with no errors. Run: `npx tsc -p tsconfig.test.json --noEmit` --
  should exit 0 with no errors. </verify> <done>shared.ts exports BaseRecord,
  Origin, CompletenessTier schemas and inferred types. Both tsconfigs compile
  without errors.</done> </task>

<task type="auto">
  <name>Task 2: Create all 5 entity schemas with barrel export</name>
  <files>
    scripts/reviews/lib/schemas/review.ts
    scripts/reviews/lib/schemas/retro.ts
    scripts/reviews/lib/schemas/deferred-item.ts
    scripts/reviews/lib/schemas/invocation.ts
    scripts/reviews/lib/schemas/warning.ts
    scripts/reviews/lib/schemas/index.ts
  </files>
  <action>
Each schema extends BaseRecord using `.extend()`. Export both the schema and the inferred type from each file.

1. `review.ts` - ReviewRecord:
   - Extends BaseRecord with:
     - title: z.string().nullable().optional()
     - pr: z.number().int().positive().nullable().optional()
     - source: z.string().nullable().optional()
     - total: z.number().int().min(0).nullable().optional()
     - fixed: z.number().int().min(0).nullable().optional()
     - deferred: z.number().int().min(0).nullable().optional()
     - rejected: z.number().int().min(0).nullable().optional()
     - patterns: z.array(z.string()).nullable().optional()
     - learnings: z.array(z.string()).nullable().optional()
     - severity_breakdown: z.object({ critical: z.number().int().min(0), major:
       z.number().int().min(0), minor: z.number().int().min(0), trivial:
       z.number().int().min(0) }).nullable().optional()
     - per_round_detail: z.array(z.unknown()).nullable().optional()
     - rejection_analysis: z.array(z.unknown()).nullable().optional()
     - ping_pong_chains: z.array(z.unknown()).nullable().optional()

2. `retro.ts` - RetroRecord:
   - Extends BaseRecord with:
     - pr: z.number().int().positive().nullable().optional()
     - session: z.string().nullable().optional()
     - top_wins: z.array(z.string()).nullable().optional()
     - top_misses: z.array(z.string()).nullable().optional()
     - process_changes: z.array(z.string()).nullable().optional()
     - score: z.number().min(0).max(10).nullable().optional()
     - metrics: z.object({ total_findings: z.number().int().min(0), fix_rate:
       z.number().min(0).max(1), pattern_recurrence: z.number().int().min(0)
       }).nullable().optional()

3. `deferred-item.ts` - DeferredItemRecord:
   - Extends BaseRecord with:
     - review_id: z.string().min(1)
     - finding: z.string().min(1)
     - reason: z.string().nullable().optional()
     - severity: z.enum(["S0", "S1", "S2", "S3"]).nullable().optional()
     - status: z.enum(["open", "resolved", "promoted",
       "wont-fix"]).default("open")
     - resolved_date:
       z.string().regex(/^\d{4}-\d{2}-\d{2}$/).nullable().optional()
     - defer_count: z.number().int().min(1).default(1)
     - promoted_to_debt: z.boolean().default(false)

4. `invocation.ts` - InvocationRecord:
   - Extends BaseRecord with:
     - skill: z.string().min(1)
     - type: z.enum(["skill", "agent", "team"])
     - duration_ms: z.number().int().min(0).nullable().optional()
     - success: z.boolean()
     - error: z.string().nullable().optional()
     - context: z.object({ pr: z.number().int().positive().optional(), session:
       z.string().optional(), trigger: z.string().optional()
       }).nullable().optional()

5. `warning.ts` - WarningRecord:
   - Extends BaseRecord with:
     - category: z.string().min(1)
     - message: z.string().min(1)
     - severity: z.enum(["info", "warning", "error"])
     - lifecycle: z.enum(["new", "acknowledged", "resolved",
       "stale"]).default("new")
     - resolved_date:
       z.string().regex(/^\d{4}-\d{2}-\d{2}$/).nullable().optional()
     - source_script: z.string().nullable().optional()
     - related_ids: z.array(z.string()).nullable().optional()

6. `index.ts` - Barrel export:
   - Re-export everything from shared.ts, review.ts, retro.ts, deferred-item.ts,
     invocation.ts, warning.ts
   - Also export a `SCHEMA_MAP` constant mapping file names to schemas:
     ```typescript
     export const SCHEMA_MAP = {
       reviews: ReviewRecord,
       retros: RetroRecord,
       "deferred-items": DeferredItemRecord,
       invocations: InvocationRecord,
       warnings: WarningRecord,
     } as const;
     ```

IMPORTANT: Do NOT redefine the `type` field name in InvocationRecord --
BaseRecord does not have a `type` field, so there is no conflict. The
`origin.type` is nested inside the origin object. </action> <verify> Run:
`npx tsc -p scripts/reviews/tsconfig.json --noEmit` -- should exit 0. Verify:
`node -e "const s = require('./scripts/reviews/dist/schemas/index.js'); console.log(Object.keys(s.SCHEMA_MAP))"`
prints all 5 file names (after compiling with
`npx tsc -p scripts/reviews/tsconfig.json`). </verify> <done>All 5 entity
schemas compile, extend BaseRecord properly, and are accessible via barrel
export and SCHEMA_MAP.</done> </task>

</tasks>

<verification>
1. `npx tsc -p scripts/reviews/tsconfig.json --noEmit` exits 0
2. `npx tsc -p scripts/reviews/tsconfig.json` produces dist/ output
3. All 7 schema files exist under scripts/reviews/lib/schemas/
4. Each schema extends BaseRecord (grep for "BaseRecord.extend" in all entity files)
5. SCHEMA_MAP has exactly 5 entries
6. tsconfig.test.json includes scripts/reviews path
</verification>

<success_criteria>

- 5 Zod schemas defined, each with completeness model and structured origin
  (STOR-01, STOR-03, STOR-04, STOR-05)
- Schemas reject invalid data via z.parse() (STOR-01)
- TypeScript compiles cleanly with no errors
- Barrel export provides single import point for all schemas </success_criteria>

<output>
After completion, create `.planning/phases/01-storage-foundation/01-01-SUMMARY.md`
</output>
