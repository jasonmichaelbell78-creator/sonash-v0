name: Documentation Lint

on:
  pull_request:
    branches: [main]
    paths:
      - "**/*.md"
      - "docs/**"
      - "scripts/check-docs-light.js"

jobs:
  docs-lint:
    name: Lint Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Get changed markdown files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            **/*.md
            docs/**/*.md
          separator: "\n"

      - name: Run documentation linter
        id: docs-lint
        if: ${{ steps.changed-files.outputs.any_changed == 'true' }}
        continue-on-error: true
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "## Documentation Lint Results" > lint-results.md
          echo "" >> lint-results.md

          # Track overall status
          ERRORS=0
          WARNINGS=0

          # Process changed files safely (newline-separated, handles spaces in filenames)
          while IFS= read -r file; do
            # Skip empty lines
            if [[ -z "$file" ]]; then
              continue
            fi

            echo "Checking: $file"

            # Skip non-markdown files and templates
            if [[ ! "$file" =~ \.md$ ]]; then
              continue
            fi

            # Skip template files (both TEMPLATE.md and _TEMPLATE.md patterns)
            if [[ "$file" =~ (TEMPLATE|_TEMPLATE)\.md$ ]]; then
              echo "  Skipping template file"
              continue
            fi

            # Skip archive files (historical documents with outdated links)
            if [[ "$file" =~ ^docs/archive/ ]] || [[ "$file" =~ /archive/ ]]; then
              echo "  Skipping archive file"
              continue
            fi

            # Run linter and capture output
            if ! OUTPUT=$(node scripts/check-docs-light.js "$file" 2>&1); then
              EXIT_CODE=1
            else
              EXIT_CODE=0
            fi

            # Sanitize output to prevent markdown injection
            SAFE_OUTPUT=$(echo "$OUTPUT" | sed 's/```/\\`\\`\\`/g')

            if [[ $EXIT_CODE -ne 0 ]]; then
              ERRORS=$((ERRORS + 1))
              echo "### ❌ $file" >> lint-results.md
              echo "" >> lint-results.md
              echo '```' >> lint-results.md
              echo "$SAFE_OUTPUT" >> lint-results.md
              echo '```' >> lint-results.md
              echo "" >> lint-results.md
            elif echo "$OUTPUT" | grep -q "Warning:"; then
              WARNINGS=$((WARNINGS + 1))
              echo "### ⚠️ $file" >> lint-results.md
              echo "" >> lint-results.md
              echo '```' >> lint-results.md
              echo "$SAFE_OUTPUT" >> lint-results.md
              echo '```' >> lint-results.md
              echo "" >> lint-results.md
            else
              echo "### ✅ $file" >> lint-results.md
              echo "" >> lint-results.md
            fi
          done <<< "$CHANGED_FILES"

          # Summary
          echo "" >> lint-results.md
          echo "---" >> lint-results.md
          echo "" >> lint-results.md
          echo "**Summary:** $ERRORS error(s), $WARNINGS warning(s)" >> lint-results.md

          # Set outputs
          echo "errors=$ERRORS" >> "$GITHUB_OUTPUT"
          echo "warnings=$WARNINGS" >> "$GITHUB_OUTPUT"

          # Output to console
          cat lint-results.md

      - name: Comment on PR
        if: ${{ steps.changed-files.outputs.any_changed == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('lint-results.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('Documentation Lint Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Check for errors
        if: ${{ steps.changed-files.outputs.any_changed == 'true' }}
        env:
          LINT_ERRORS: ${{ steps.docs-lint.outputs.errors || '0' }}
        run: |
          if [[ "$LINT_ERRORS" -gt 0 ]]; then
            echo "Documentation linting found $LINT_ERRORS error(s)"
            echo "Please fix the issues listed above before merging"
            exit 1
          fi
          echo "Documentation linting passed"

      - name: No markdown changes
        if: ${{ steps.changed-files.outputs.any_changed != 'true' }}
        run: echo "No markdown files changed, skipping documentation lint"
