name: Validate Phase Completion

on:
  pull_request:
    branches: [main]
    paths:
      - "docs/archive/completed-plans/INTEGRATED_IMPROVEMENT_PLAN.md"

jobs:
  validate-phase-completion:
    name: Validate Phase Completion Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate phase completions
        run: node scripts/validate-phase-completion.js

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ‚ùå Phase Completion Validation Failed

            When marking a phase as COMPLETE, you must:

            1. **Add "What Was Accomplished" section** with deliverables list
            2. **Check acceptance criteria** (mark with \`[x]\`)
            3. **Add completion date** (e.g., \`**Completed:** 2026-01-01\`)

            Run \`npm run phase:complete\` to properly complete a phase.

            See [AI_WORKFLOW.md](./AI_WORKFLOW.md) for the full Deliverable Audit procedure.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
