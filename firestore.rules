rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================

    // Validate date ID format (YYYY-MM-DD)
    function isValidDateFormat(dateId) {
      return dateId.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$');
    }

    // Check if a date is within reasonable range (10 years past to 1 year future)
    function isReasonableDate(dateId) {
      let year = int(dateId.split('-')[0]);
      let currentYear = int(request.time.toMillis() / 31536000000 + 1970);
      return year >= currentYear - 10 && year <= currentYear + 1;
    }

    // Validate inventory entry type
    function isValidInventoryType(type) {
      return type in [
        'resentment',
        'fear',
        'relationship',
        'harm',
        'spotCheck',
        'morning',
        'nightReview',
        'gratitude'
      ];
    }

    // Validate required fields exist for inventory entries
    function hasRequiredInventoryFields(data) {
      return data.keys().hasAll(['type', 'data', 'createdAt', 'updatedAt'])
             && isValidInventoryType(data.type);
    }

    // Validate inventory link structure
    function isValidInventoryLink(data) {
      return data.keys().hasAll(['fromId', 'toId', 'fromType', 'toType', 'createdAt'])
             && isValidInventoryType(data.fromType)
             && isValidInventoryType(data.toType);
    }

    // Size limits to prevent abuse
    function isReasonableSize(data) {
      // Limit individual string fields to 50KB
      // Limit total document to ~500KB (Firestore max is 1MB)
      return request.resource.data.size() < 500000;
    }

    // Verify request has valid App Check token (bot protection)
    // Note: request.app is unreliable with debug tokens, so we make it optional for now
    // In production with real reCAPTCHA tokens, request.app will be populated
    function hasValidAppCheck() {
      return request.auth != null;
      // TODO: Re-enable once App Check debug tokens work reliably
      // return request.auth != null && request.app != null;
    }

    // ============================================================
    // USER DATA - STRICT OWNER-ONLY ACCESS
    // ============================================================

    match /users/{uid} {
      // Users can only read and write their own profile with valid App Check
      allow read: if hasValidAppCheck() && request.auth.uid == uid;
      allow write: if hasValidAppCheck() && request.auth.uid == uid;

      // Daily logs subcollection - READ ONLY for clients
      // All writes must go through Cloud Functions for server-side rate limiting
      match /daily_logs/{logId} {
        allow read: if hasValidAppCheck() && request.auth.uid == uid;
        allow write: if false; // All writes must use saveDailyLog Cloud Function
      }

      // Inventory entries subcollection (Step 4, Step 10/11, Daily Practice)
      match /inventoryEntries/{entryId} {
        // Owner-only read access with App Check
        allow read: if hasValidAppCheck() && request.auth.uid == uid;

        // Owner-only write with validation and App Check
        allow create: if hasValidAppCheck() &&
                         request.auth.uid == uid &&
                         hasRequiredInventoryFields(request.resource.data) &&
                         isReasonableSize(request.resource.data);

        allow update: if hasValidAppCheck() &&
                         request.auth.uid == uid &&
                         hasRequiredInventoryFields(request.resource.data) &&
                         isReasonableSize(request.resource.data) &&
                         // Prevent changing the entry type after creation
                         request.resource.data.type == resource.data.type;

        allow delete: if hasValidAppCheck() && request.auth.uid == uid;
      }

      // Inventory links subcollection (cross-references between entries)
      match /inventoryLinks/{linkId} {
        allow read: if hasValidAppCheck() && request.auth.uid == uid;

        allow create: if hasValidAppCheck() &&
                         request.auth.uid == uid &&
                         isValidInventoryLink(request.resource.data);

        // Links are immutable once created (delete and recreate if needed)
        allow update: if false;

        allow delete: if hasValidAppCheck() && request.auth.uid == uid;
      }
    }

    // ============================================================
    // PUBLIC/SHARED DATA
    // ============================================================

    // Meetings collection (public read with App Check, admin full access)
    match /meetings/{meetingId} {
      // Public read with App Check, OR admin read without App Check
      allow read: if hasValidAppCheck() || (request.auth != null && request.auth.token.admin == true);
      // Admin users can write (requires admin custom claim)
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // ============================================================
    // DENY ALL OTHER ACCESS
    // ============================================================

    // Catch-all: deny access to any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
