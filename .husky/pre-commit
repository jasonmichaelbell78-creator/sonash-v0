#!/bin/sh
# Pre-commit hook - AUTOMATED GATE (not optional documentation)
# This blocks commits if checks fail

echo "üîç Running pre-commit checks..."

# 1. Run ESLint - rely on exit code, not output parsing
echo "  ‚ñ∂ Running ESLint..."
if ! npm run lint > /dev/null 2>&1; then
  echo "  ‚ùå ESLint has errors"
  npm run lint 2>&1 | tail -10
  echo ""
  echo "  Fix errors before committing. Run: npm run lint"
  exit 1
fi
echo "  ‚úÖ ESLint passed (0 errors)"

# 2. Auto-format staged files with lint-staged (Prettier)
# Automatically formats staged files - no manual intervention needed
echo "  ‚ñ∂ Running lint-staged (auto-format)..."
# Check if lint-staged is installed as devDependency (security: --no-install prevents supply chain attacks)
if npm list lint-staged --depth=0 > /dev/null 2>&1; then
  if ! npx --no-install lint-staged; then
    echo "  ‚ùå Lint-staged failed"
    exit 1
  fi
  echo "  ‚úÖ Lint-staged passed (files formatted)"
else
  echo "  ‚ö†Ô∏è lint-staged not installed - run 'npm ci' to enable auto-formatting"
  echo "  ‚è≠Ô∏è Skipping lint-staged (devDependency missing from node_modules)"
fi

# 3. Run pattern compliance check (catches issues before PR review tools)
echo "  ‚ñ∂ Running pattern compliance..."
if ! npm run patterns:check > /dev/null 2>&1; then
  echo "  ‚ùå Pattern compliance failed"
  npm run patterns:check 2>&1 | tail -15
  echo ""
  echo "  Fix pattern issues before committing. Run: npm run patterns:check"
  exit 1
fi
echo "  ‚úÖ Pattern compliance passed"

# 4. Run tests - stream output using temp file
echo "  ‚ñ∂ Running tests..."
TEST_TMPFILE=$(mktemp)
trap 'rm -f "$TEST_TMPFILE"' EXIT

if ! npm test > "$TEST_TMPFILE" 2>&1; then
  echo "  ‚ùå Tests failed"
  tail -10 "$TEST_TMPFILE"
  echo ""
  echo "  Fix tests before committing. Run: npm test"
  exit 1
fi
echo "  ‚úÖ Tests passed"

# 5. CANON schema validation (non-blocking warning, ~1s)
# Validates CANON files when audit output is staged
STAGED_FILES=$(git diff --cached --name-only 2>/dev/null || echo "")
if echo "$STAGED_FILES" | grep -q "docs/reviews/.*\.jsonl"; then
  echo "  ‚ñ∂ Validating CANON schema..."
  if npm run validate:canon > /dev/null 2>&1; then
    echo "  ‚úÖ CANON validation passed"
  else
    echo "  ‚ö†Ô∏è CANON validation issues found (not blocking - run: npm run validate:canon)"
  fi
fi

# 6. Skill configuration validation (non-blocking, when skill files modified)
if echo "$STAGED_FILES" | grep -q "\.claude/commands/.*\.md"; then
  echo "  ‚ñ∂ Validating skill configurations..."
  skills_output=$(npm run skills:validate 2>&1)
  if echo "$skills_output" | grep -q "‚ùå ERROR"; then
    echo "  ‚ö†Ô∏è Skill validation issues found (not blocking - run: npm run skills:validate)"
    printf '%s\n' "$skills_output" | grep -E "^üìÑ|^   ‚ùå" | head -10
  else
    echo "  ‚úÖ Skill validation passed"
  fi
fi

# 7. Cross-document dependency check (BLOCKING - Session #69)
# Blocks commit when documents are modified that have known dependencies on other docs
# Override with: SKIP_CROSS_DOC_CHECK=1 git commit ...
# See: docs/DOCUMENT_DEPENDENCIES.md#cross-document-update-triggers
echo "  ‚ñ∂ Checking cross-document dependencies..."
if ! node scripts/check-cross-doc-deps.js; then
  echo "  ‚ùå Cross-document dependency check failed"
  echo ""
  echo "  Fix dependencies before committing. Run: npm run crossdoc:check"
  echo "  Override (use sparingly): SKIP_CROSS_DOC_CHECK=1 git commit ..."
  exit 1
fi
echo "  ‚úÖ Cross-document dependencies satisfied"

# 8. Documentation Index staleness check (BLOCKING - Session #103)
# Blocks commit if new docs are added but DOCUMENTATION_INDEX.md not updated
# Override with: SKIP_DOC_INDEX_CHECK=1 git commit ...
if [ -z "$SKIP_DOC_INDEX_CHECK" ]; then
  NEW_MD_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E "\.md$" || true)
  if [ -n "$NEW_MD_FILES" ]; then
    if ! echo "$STAGED_FILES" | grep -q "DOCUMENTATION_INDEX.md"; then
      echo "  ‚ùå New .md files added but DOCUMENTATION_INDEX.md not updated"
      echo ""
      echo "  New files detected:"
      echo "$NEW_MD_FILES" | head -5
      echo ""
      echo "  Regenerate the index and stage it:"
      echo "    npm run docs:index && git add DOCUMENTATION_INDEX.md"
      echo ""
      echo "  Override (use sparingly): SKIP_DOC_INDEX_CHECK=1 git commit ..."
      exit 1
    fi
  fi
fi

# 9. Learning entry reminder (non-blocking, ~0.5s)  [was step 8]
# Reminds to capture learnings when it looks like PR feedback was addressed
LEARNINGS_LOG="docs/AI_REVIEW_LEARNINGS_LOG.md"

# Check if learnings log is being updated
if echo "$STAGED_FILES" | grep -q "$LEARNINGS_LOG"; then
  echo "  ‚úÖ Learning entry detected"
else
  # Count staged files - if many files changed, might be addressing review
  STAGED_COUNT=$(echo "$STAGED_FILES" | grep -c . 2>/dev/null || printf "0")
  STAGED_COUNT=${STAGED_COUNT:-0}
  # Check for template/doc changes that often accompany reviews
  TEMPLATE_CHANGES=$(echo "$STAGED_FILES" | grep -c -E "templates|\.claude/commands|\.claude/hooks" 2>/dev/null || printf "0")
  TEMPLATE_CHANGES=${TEMPLATE_CHANGES:-0}

  if [ "$STAGED_COUNT" -gt 5 ] 2>/dev/null || [ "$TEMPLATE_CHANGES" -gt 0 ] 2>/dev/null; then
    echo "  üí° Reminder: If addressing PR feedback, add Review #N to $LEARNINGS_LOG"
  fi
fi

# 10. Audit file S0/S1 validation (BLOCKING - Session #98)
# Validates that S0/S1 findings have proper verification_steps
# Override with: SKIP_AUDIT_VALIDATION=1 git commit ...
if [ -z "$SKIP_AUDIT_VALIDATION" ]; then
  STAGED_AUDIT_FILES=$(echo "$STAGED_FILES" | grep -E "docs/audits/.*\.jsonl$" || true)
  if [ -n "$STAGED_AUDIT_FILES" ]; then
    echo "  ‚ñ∂ Validating audit S0/S1 compliance..."
    # POSIX-compatible: Write to temp file, read with while loop
    # Review #204: Pipe creates subshell where variable changes don't propagate
    # Chain with existing EXIT trap instead of overwriting
    AUDIT_TMPFILE=$(mktemp)
    trap 'rm -f "$TEST_TMPFILE" "$AUDIT_TMPFILE" 2>/dev/null' EXIT
    echo "$STAGED_AUDIT_FILES" > "$AUDIT_TMPFILE"
    AUDIT_FAILED=0
    while IFS= read -r audit_file || [ -n "$audit_file" ]; do
      [ -z "$audit_file" ] && continue
      if ! node scripts/validate-audit.js "$audit_file" --strict-s0s1 > /dev/null 2>&1; then
        AUDIT_FAILED=1
        echo "  ‚ùå S0/S1 validation failed: $audit_file"
        node scripts/validate-audit.js "$audit_file" --strict-s0s1 2>&1 | grep -E "^   ‚ùå|BLOCKING" | head -5
      fi
    done < "$AUDIT_TMPFILE"
    rm -f "$AUDIT_TMPFILE"
    if [ "$AUDIT_FAILED" -eq 1 ]; then
      echo ""
      echo "  Fix S0/S1 violations or downgrade severity. Run:"
      echo "    node scripts/validate-audit.js <file> --strict-s0s1"
      echo "  Override (use sparingly): SKIP_AUDIT_VALIDATION=1 git commit ..."
      exit 1
    fi
    echo "  ‚úÖ Audit S0/S1 validation passed"
  fi
else
  echo "  ‚è≠Ô∏è Skipping audit validation (SKIP_AUDIT_VALIDATION set)"
fi

# 11. Agent compliance check (non-blocking warning - Session #101)
# Warns if code files are being committed but agents weren't invoked
# Make blocking with: STRICT_AGENT_CHECK=1 git commit ...
echo "  ‚ñ∂ Checking agent compliance..."
if [ -n "$STRICT_AGENT_CHECK" ]; then
  if ! node scripts/check-agent-compliance.js --strict 2>&1; then
    exit 1
  fi
else
  node scripts/check-agent-compliance.js 2>&1 || true
fi

echo ""
echo "‚úÖ All pre-commit checks passed - commit allowed"
