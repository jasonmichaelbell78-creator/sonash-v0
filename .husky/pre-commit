#!/bin/sh
# Pre-commit hook - AUTOMATED GATE (not optional documentation)
# This blocks commits if checks fail

# Log all output to .git/hook-output.log for debugging
# (hook stderr is often invisible in CI/agent contexts like Claude Code)
# Note: Husky v9 runs hooks with `sh -e`, so must be POSIX-compatible.
# Cannot use bash process substitution >() since sh doesn't support it.
# Simple redirect to log file; caller can read the log after.
HOOK_OUTPUT_LOG="$(git rev-parse --show-toplevel 2>/dev/null || echo .)/.git/hook-output.log"
exec > "$HOOK_OUTPUT_LOG" 2>&1

# Display log on failure so developers see what went wrong (Gemini review #379)
# Uses EXIT_TRAP_CHAIN via add_exit_trap (defined below) to coexist with temp file cleanup

# POSIX-safe EXIT trap chaining ‚Äî appends cleanup commands without overwriting prior traps
# Uses a shell variable to accumulate trap commands (avoids fragile trap -p parsing)
add_exit_trap() {
  EXIT_TRAP_CHAIN="${EXIT_TRAP_CHAIN:+$EXIT_TRAP_CHAIN; }$1"
  trap "$EXIT_TRAP_CHAIN" EXIT
}

# Display log on failure so developers see what went wrong (Gemini review #379)
# Capture exit code before chain runs; display log to stderr on failure
add_exit_trap 'HOOK_EXIT=$?; if [ "$HOOK_EXIT" -ne 0 ] && [ -f "$HOOK_OUTPUT_LOG" ]; then exec 1>/dev/null; printf "\n--- PRE-COMMIT HOOK FAILED ---\n" >&2; cat "$HOOK_OUTPUT_LOG" >&2; printf "--- END OF LOGS ---\n" >&2; fi'

# --- SKIP_CHECKS consolidation ---
# Single variable: SKIP_CHECKS="cross-doc,patterns" SKIP_REASON="reason" git commit ...
# Check if a named check should be skipped
is_skipped() {
  case ",$SKIP_CHECKS," in *",$1,"*) return 0 ;; esac
  return 1
}

# Backward compat: map individual SKIP_ vars to SKIP_CHECKS
for _sk in PATTERN_CHECK:patterns AUDIT_VALIDATION:audit TESTS:tests CROSS_DOC_CHECK:cross-doc DOC_INDEX_CHECK:doc-index DOC_HEADER_CHECK:doc-header DEBT_VALIDATION:debt; do
  _var="SKIP_${_sk%%:*}"; _name="${_sk#*:}"
  eval "_val=\${$_var:-}"
  [ "$_val" = "1" ] && SKIP_CHECKS="${SKIP_CHECKS:+$SKIP_CHECKS,}$_name"
done

# Shared guard: any SKIP_ override requires SKIP_REASON (Session #162)
require_skip_reason() {
  if [ -z "${SKIP_REASON:-}" ]; then
    echo "  ‚ùå SKIP_REASON is required when overriding checks"
    echo "  Usage: SKIP_REASON=\"your reason\" $1 git commit ..."
    echo "  The audit trail is useless without a reason."
    exit 1
  fi
  # Reject multi-line reasons (prevents JSONL/log injection) ‚Äî POSIX-safe (no grep -P)
  cr="$(printf '\r')"
  if [ "$(printf '%s' "$SKIP_REASON" | wc -l | tr -d ' ')" -gt 1 ] || printf '%s' "$SKIP_REASON" | grep -q "$cr"; then
    echo "  ‚ùå SKIP_REASON must be a single line (no CR/LF characters)"
    exit 1
  fi
  # Reject control characters (prevents log injection) ‚Äî POSIX-safe
  if printf '%s' "$SKIP_REASON" | LC_ALL=C grep -q '[[:cntrl:]]'; then
    echo "  ‚ùå SKIP_REASON must not contain control characters"
    exit 1
  fi
  # Enforce max length to prevent DoS via oversized reasons
  skip_len=${#SKIP_REASON}
  if [ "$skip_len" -gt 500 ]; then
    echo "  ‚ùå SKIP_REASON must be <= 500 characters (got $skip_len)"
    exit 1
  fi
  # Validate minimum length to prevent meaningless skip reasons like "x" or "test"
  if [ "$skip_len" -lt 10 ]; then
    echo "  ‚ùå SKIP_REASON must be at least 10 characters (got $skip_len)"
    echo "  Provide a meaningful reason for the audit trail."
    exit 1
  fi
}

# Validate skip reason once at the top if any checks are being skipped
if [ -n "${SKIP_CHECKS:-}" ]; then
  require_skip_reason "SKIP_CHECKS=\"$SKIP_CHECKS\""
fi

echo "üîç Running pre-commit checks..."

# --- Wave 1: ESLint + Tests in parallel ---
# These are the two slowest checks (~15s each). Run concurrently for ~50% time savings.
# Pattern compliance runs sequentially after (it's fast, ~0.1s).

ESLINT_TMPFILE="$(mktemp)" || { echo "  ‚ùå Failed to create temp file"; exit 1; }
TEST_TMPFILE="$(mktemp)" || { echo "  ‚ùå Failed to create temp file"; exit 1; }
add_exit_trap 'rm -f "$ESLINT_TMPFILE" "$TEST_TMPFILE" 2>/dev/null'

# --- Start ESLint in background ---
echo "  ‚ñ∂ Running ESLint..."
(npm run lint > "$ESLINT_TMPFILE" 2>&1; echo $? > "${ESLINT_TMPFILE}.exit") &
PID_LINT=$!

# --- Determine if tests should run, start in background if so ---
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")
RUN_TESTS=0
SKIP_TEST_REASON=""
PID_TEST=""

if is_skipped tests; then
  node scripts/log-override.js --quick --check=tests --reason="$SKIP_REASON" 2>/dev/null || true
  SKIP_TEST_REASON="SKIP_CHECKS"
elif printf '%s\n' "$STAGED_FILES" | grep -Eq '^(package\.json|package-lock\.json|pnpm-lock\.yaml|yarn\.lock|tsconfig.*\.json|next\.config\.(js|mjs|ts)|\.husky/|\.github/)'; then
  RUN_TESTS=1
  echo "  ‚ñ∂ Running tests (config changes detected)..."
  (npm test > "$TEST_TMPFILE" 2>&1; echo $? > "${TEST_TMPFILE}.exit") &
  PID_TEST=$!
else
  DOC_DIRS="docs/|\.claude/"
  DOC_FILES="DOCUMENTATION_INDEX|SESSION_CONTEXT|ROADMAP|CLAUDE|ARCHITECTURE|DEVELOPMENT|AI_WORKFLOW"
  DOC_EXTS="md|mdx|txt|png|jpg|jpeg|gif|svg|jsonl"
  DOC_PATTERN="^(${DOC_DIRS}).*|(${DOC_FILES})|.*\.(${DOC_EXTS})$"
  NON_DOC_FILES=$(printf '%s\n' "$STAGED_FILES" | grep -Ev "$DOC_PATTERN" || true)
  if [ -z "$NON_DOC_FILES" ]; then
    SKIP_TEST_REASON="doc-only"
  else
    RUN_TESTS=1
    echo "  ‚ñ∂ Running tests..."
    (npm test > "$TEST_TMPFILE" 2>&1; echo $? > "${TEST_TMPFILE}.exit") &
    PID_TEST=$!
  fi
fi

# --- Wait for ESLint ---
wait $PID_LINT 2>/dev/null || true
LINT_EXIT=$(cat "${ESLINT_TMPFILE}.exit" 2>/dev/null || echo "1")
rm -f "${ESLINT_TMPFILE}.exit" 2>/dev/null
if [ "$LINT_EXIT" -ne 0 ]; then
  echo "  ‚ùå ESLint has errors"
  tail -20 "$ESLINT_TMPFILE"
  echo ""
  echo "  Fix errors before committing. Run: npm run lint"
  # Kill test if still running
  [ -n "$PID_TEST" ] && kill $PID_TEST 2>/dev/null || true
  exit 1
fi
echo "  ‚úÖ ESLint passed"

# --- Wait for tests ---
if [ "$RUN_TESTS" -eq 1 ] && [ -n "$PID_TEST" ]; then
  wait $PID_TEST 2>/dev/null || true
  TEST_EXIT=$(cat "${TEST_TMPFILE}.exit" 2>/dev/null || echo "1")
  rm -f "${TEST_TMPFILE}.exit" 2>/dev/null
  if [ "$TEST_EXIT" -ne 0 ]; then
    echo "  ‚ùå Tests failed"
    tail -10 "$TEST_TMPFILE"
    echo ""
    echo "  Fix tests before committing. Run: npm test"
    exit 1
  fi
  echo "  ‚úÖ Tests passed"
elif [ -n "$SKIP_TEST_REASON" ]; then
  echo "  ‚è≠Ô∏è Skipping tests ($SKIP_TEST_REASON)"
fi

# 2. Auto-format staged files with lint-staged (Prettier)
# Automatically formats staged files - no manual intervention needed
echo "  ‚ñ∂ Running lint-staged (auto-format)..."
# Check if lint-staged is installed as devDependency (security: --no-install prevents supply chain attacks)
if npm list lint-staged --depth=0 > /dev/null 2>&1; then
  if ! npx --no-install lint-staged; then
    echo "  ‚ùå Lint-staged failed"
    exit 1
  fi
  echo "  ‚úÖ Lint-staged passed (files formatted)"
else
  echo "  ‚ö†Ô∏è lint-staged not installed - run 'npm ci' to enable auto-formatting"
  echo "  ‚è≠Ô∏è Skipping lint-staged (devDependency missing from node_modules)"
fi

# 3. Run pattern compliance check on staged files (warnings only, never blocks)
# Override with: SKIP_CHECKS="patterns" SKIP_REASON="reason" git commit ...
if is_skipped patterns; then
  node scripts/log-override.js --quick --check=pattern-compliance --reason="$SKIP_REASON" 2>/dev/null || true
  echo "  ‚è≠Ô∏è Skipping pattern compliance (skipped via SKIP_CHECKS)"
else
  echo "  ‚ñ∂ Running pattern compliance..."
  patterns_output="$(node scripts/check-pattern-compliance.js --staged 2>&1)" || true
  echo "  ‚úÖ Pattern compliance checked"
fi

# 4. Audit file S0/S1 validation (BLOCKING - Session #98)
# Validates that S0/S1 findings have proper verification_steps
# Override with: SKIP_CHECKS="audit" SKIP_REASON="reason" git commit ...
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")
if ! is_skipped audit; then
  STAGED_AUDIT_FILES=$(printf '%s\n' "$STAGED_FILES" | grep -E "docs/audits/.*\.jsonl$" || true)
  if [ -n "$STAGED_AUDIT_FILES" ]; then
    echo "  ‚ñ∂ Validating audit S0/S1 compliance..."
    # POSIX-compatible: Write to temp file, read with while loop
    # Review #204: Pipe creates subshell where variable changes don't propagate
    # Chain with existing EXIT trap instead of overwriting
    AUDIT_TMPFILE="$(mktemp)" || { echo "  ‚ùå Failed to create temp file"; exit 1; }
    add_exit_trap 'rm -f "$AUDIT_TMPFILE" 2>/dev/null'
    echo "$STAGED_AUDIT_FILES" > "$AUDIT_TMPFILE"
    AUDIT_FAILED=0
    while IFS= read -r audit_file || [ -n "$audit_file" ]; do
      [ -z "$audit_file" ] && continue
      audit_out="$(node scripts/validate-audit.js "$audit_file" --strict-s0s1 2>&1)"
      audit_code=$?
      if [ "$audit_code" -ne 0 ]; then
        AUDIT_FAILED=1
        echo "  ‚ùå S0/S1 validation failed: $audit_file"
        printf '%s\n' "$audit_out" | grep -E "^   ‚ùå|BLOCKING" | head -5
      fi
    done < "$AUDIT_TMPFILE"
    rm -f "$AUDIT_TMPFILE"
    if [ "$AUDIT_FAILED" -eq 1 ]; then
      echo ""
      echo "  Fix S0/S1 violations or downgrade severity. Run:"
      echo "    node scripts/validate-audit.js <file> --strict-s0s1"
      echo "  Override: SKIP_CHECKS=\"audit\" SKIP_REASON=\"reason\" git commit ..."
      exit 1
    fi
    echo "  ‚úÖ Audit S0/S1 validation passed"
  fi
else
  node scripts/log-override.js --quick --check=audit-s0s1 --reason="$SKIP_REASON" 2>/dev/null || true
  echo "  ‚è≠Ô∏è Skipping audit validation (skipped via SKIP_CHECKS)"
fi

# 5. CANON schema validation (non-blocking warning, ~1s)
# Validates CANON files when audit output is staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")
if printf '%s\n' "$STAGED_FILES" | grep -q "docs/reviews/.*\.jsonl"; then
  echo "  ‚ñ∂ Validating CANON schema..."
  if npm run validate:canon > /dev/null 2>&1; then
    echo "  ‚úÖ CANON validation passed"
  else
    echo "  ‚ö†Ô∏è CANON validation issues found (not blocking - run: npm run validate:canon)"
    node scripts/append-hook-warning.js --hook=pre-commit --type=canon --severity=warning --message="CANON validation issues found" --action="npm run validate:canon" 2>/dev/null || true
  fi
fi

# 6. Skill configuration validation (non-blocking, when skill files modified)
if printf '%s\n' "$STAGED_FILES" | grep -Eq '\.(claude)/(skills|commands)/.*\.md$'; then
  echo "  ‚ñ∂ Validating skill configurations..."
  skills_output=$(npm run skills:validate 2>&1)
  if echo "$skills_output" | grep -q "‚ùå ERROR"; then
    echo "  ‚ö†Ô∏è Skill validation issues found (not blocking - run: npm run skills:validate)"
    printf '%s\n' "$skills_output" | grep -E "^üìÑ|^   ‚ùå" | head -10
    node scripts/append-hook-warning.js --hook=pre-commit --type=skill --severity=warning --message="Skill validation issues found" --action="npm run skills:validate" 2>/dev/null || true
  else
    echo "  ‚úÖ Skill validation passed"
  fi
fi

# 7. Cross-document dependency check (BLOCKING - Session #69)
# Override with: SKIP_CHECKS="cross-doc" SKIP_REASON="reason" git commit ...
if is_skipped cross-doc; then
  node scripts/log-override.js --quick --check=cross-doc-deps --reason="$SKIP_REASON" 2>/dev/null || true
  echo "  ‚è≠Ô∏è Skipping cross-doc dependency check (skipped via SKIP_CHECKS)"
else
  echo "  ‚ñ∂ Checking cross-document dependencies..."
  if ! node scripts/check-cross-doc-deps.js --trivial; then
    echo "  ‚ùå Cross-document dependency check failed"
    echo ""
    echo "  Fix dependencies before committing. Run: npm run crossdoc:check"
    echo "  Override: SKIP_CHECKS=\"cross-doc\" SKIP_REASON=\"reason\" git commit ..."
    exit 1
  fi
  echo "  ‚úÖ Cross-document dependencies satisfied"
fi

# 8. Documentation Index auto-update (AUTO-FIX - Session #103, fixed #149)
# Override with: SKIP_CHECKS="doc-index" SKIP_REASON="reason" git commit ...
if is_skipped doc-index; then
  node scripts/log-override.js --quick --check=doc-index --reason="$SKIP_REASON" 2>/dev/null || true
  echo "  ‚è≠Ô∏è Skipping doc index check (skipped via SKIP_CHECKS)"
else
  CHANGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ADM | grep -E '\.md$' || true)
  if [ -n "$CHANGED_MD_FILES" ]; then
    echo "  ‚ñ∂ Auto-updating documentation index..."
    if npm run docs:index > /dev/null 2>&1; then
      # Format after regeneration so CI Prettier check passes
      npx prettier --write DOCUMENTATION_INDEX.md > /dev/null 2>&1 || true
      git add DOCUMENTATION_INDEX.md
      echo "  ‚úÖ Documentation index updated and staged"
    else
      echo "  ‚ö†Ô∏è Documentation index generation failed (non-blocking)"
    fi
  fi
fi

# 9. Document header validation for NEW docs (BLOCKING - Session #115)
# Override with: SKIP_CHECKS="doc-header" SKIP_REASON="reason" git commit ...
if is_skipped doc-header; then
  node scripts/log-override.js --quick --check=doc-header --reason="$SKIP_REASON" 2>/dev/null || true
else
  NEW_MD_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E '\.md$' || true)
  if [ -n "$NEW_MD_FILES" ]; then
    echo "  ‚ñ∂ Validating new document headers..."
    if ! node scripts/check-doc-headers.js; then
      exit 1
    fi
    echo "  ‚úÖ Document headers validated"
  fi
fi

# 10. Agent compliance check (non-blocking, single-line summary)
echo "  ‚ñ∂ Checking agent compliance..."
if [ -n "${STRICT_AGENT_CHECK:-}" ]; then
  if ! node scripts/check-agent-compliance.js --strict 2>&1; then
    exit 1
  fi
else
  agent_output=$(node scripts/check-agent-compliance.js 2>&1) || true
  if echo "$agent_output" | grep -q "‚ö†Ô∏è"; then
    echo "  ‚ö†Ô∏è Agent compliance: code changed without agent review"
    node scripts/append-hook-warning.js --hook=pre-commit --type=agent --severity=warning --message="Agent compliance warnings - code changed without agent review" --action="Use code-reviewer agent for modified code" 2>/dev/null || true
  fi
fi

# 11. Technical debt schema validation (BLOCKING - TDMS Phase 7)
# Override with: SKIP_CHECKS="debt" SKIP_REASON="reason" git commit ...
if is_skipped debt; then
  node scripts/log-override.js --quick --check=debt-schema --reason="$SKIP_REASON" 2>/dev/null || true
else
  if printf '%s\n' "$STAGED_FILES" | grep -q "docs/technical-debt/MASTER_DEBT.jsonl"; then
    echo "  ‚ñ∂ Validating technical debt schema (changed lines)..."
    if ! node scripts/debt/validate-schema.js --staged-only > /dev/null 2>&1; then
      echo "  ‚ùå Technical debt schema validation failed"
      node scripts/debt/validate-schema.js --staged-only 2>&1 | tail -10
      echo ""
      echo "  Fix schema issues before committing. Run:"
      echo "    node scripts/debt/validate-schema.js --staged-only"
      echo "  Override: SKIP_CHECKS=\"debt\" SKIP_REASON=\"reason\" git commit ..."
      exit 1
    fi
    echo "  ‚úÖ Technical debt schema passed"
  fi
fi

echo ""
echo "‚úÖ All pre-commit checks passed - commit allowed"
