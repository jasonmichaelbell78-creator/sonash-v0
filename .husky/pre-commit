#!/bin/sh
# Pre-commit hook - AUTOMATED GATE (not optional documentation)
# This blocks commits if checks fail

echo "ðŸ” Running pre-commit checks..."

# 1. Run ESLint - rely on exit code, not output parsing
echo "  â–¶ Running ESLint..."
if ! npm run lint > /dev/null 2>&1; then
  echo "  âŒ ESLint has errors"
  npm run lint 2>&1 | tail -10
  echo ""
  echo "  Fix errors before committing. Run: npm run lint"
  exit 1
fi
echo "  âœ… ESLint passed (0 errors)"

# 2. Check code formatting (Prettier)
# NOTE: Currently set to WARN (not block) until initial codebase formatting is applied
# TODO: Change to blocking after running 'npm run format' on the codebase
echo "  â–¶ Checking code formatting..."
if ! npm run format:check > /dev/null 2>&1; then
  echo "  âš ï¸  Formatting issues found (not blocking - run: npm run format)"
else
  echo "  âœ… Code formatting passed"
fi

# 3. Run pattern compliance check (catches issues before PR review tools)
echo "  â–¶ Running pattern compliance..."
if ! npm run patterns:check > /dev/null 2>&1; then
  echo "  âŒ Pattern compliance failed"
  npm run patterns:check 2>&1 | tail -15
  echo ""
  echo "  Fix pattern issues before committing. Run: npm run patterns:check"
  exit 1
fi
echo "  âœ… Pattern compliance passed"

# 4. Run tests - stream output using temp file
echo "  â–¶ Running tests..."
TEST_TMPFILE=$(mktemp)
trap 'rm -f "$TEST_TMPFILE"' EXIT

if ! npm test > "$TEST_TMPFILE" 2>&1; then
  echo "  âŒ Tests failed"
  tail -10 "$TEST_TMPFILE"
  echo ""
  echo "  Fix tests before committing. Run: npm test"
  exit 1
fi
echo "  âœ… Tests passed"

# 5. Learning entry reminder (non-blocking, ~0.5s)
# Reminds to capture learnings when it looks like PR feedback was addressed
STAGED_FILES=$(git diff --cached --name-only 2>/dev/null || echo "")
LEARNINGS_LOG="docs/AI_REVIEW_LEARNINGS_LOG.md"

# Check if learnings log is being updated
if echo "$STAGED_FILES" | grep -q "$LEARNINGS_LOG"; then
  echo "  âœ… Learning entry detected"
else
  # Count staged files - if many files changed, might be addressing review
  STAGED_COUNT=$(echo "$STAGED_FILES" | grep -c . || echo "0")
  # Check for template/doc changes that often accompany reviews
  TEMPLATE_CHANGES=$(echo "$STAGED_FILES" | grep -c "templates\|\.claude/commands\|\.claude/hooks" || echo "0")

  if [ "$STAGED_COUNT" -gt 5 ] || [ "$TEMPLATE_CHANGES" -gt 0 ]; then
    echo "  ðŸ’¡ Reminder: If addressing PR feedback, add Review #N to $LEARNINGS_LOG"
  fi
fi

echo ""
echo "âœ… All pre-commit checks passed - commit allowed"
