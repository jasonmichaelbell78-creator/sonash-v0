#!/bin/sh
# Pre-commit hook - AUTOMATED GATE (not optional documentation)
# This blocks commits if checks fail

echo "ğŸ” Running pre-commit checks..."

# 1. Run ESLint - rely on exit code, not output parsing
echo "  â–¶ Running ESLint..."
if ! npm run lint > /dev/null 2>&1; then
  echo "  âŒ ESLint has errors"
  npm run lint 2>&1 | tail -10
  echo ""
  echo "  Fix errors before committing. Run: npm run lint"
  exit 1
fi
echo "  âœ… ESLint passed (0 errors)"

# 2. Check code formatting (Prettier)
# NOTE: Currently set to WARN (not block) until initial codebase formatting is applied
# TODO: Change to blocking after running 'npm run format' on the codebase
echo "  â–¶ Checking code formatting..."
if ! npm run format:check > /dev/null 2>&1; then
  echo "  âš ï¸  Formatting issues found (not blocking - run: npm run format)"
else
  echo "  âœ… Code formatting passed"
fi

# 3. Run pattern compliance check (catches issues before PR review tools)
echo "  â–¶ Running pattern compliance..."
if ! npm run patterns:check > /dev/null 2>&1; then
  echo "  âŒ Pattern compliance failed"
  npm run patterns:check 2>&1 | tail -15
  echo ""
  echo "  Fix pattern issues before committing. Run: npm run patterns:check"
  exit 1
fi
echo "  âœ… Pattern compliance passed"

# 4. Run tests - stream output using temp file
echo "  â–¶ Running tests..."
TEST_TMPFILE=$(mktemp)
trap 'rm -f "$TEST_TMPFILE"' EXIT

if ! npm test > "$TEST_TMPFILE" 2>&1; then
  echo "  âŒ Tests failed"
  tail -10 "$TEST_TMPFILE"
  echo ""
  echo "  Fix tests before committing. Run: npm test"
  exit 1
fi
echo "  âœ… Tests passed"

echo ""
echo "âœ… All pre-commit checks passed - commit allowed"
