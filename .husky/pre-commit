#!/bin/sh
# Pre-commit hook - AUTOMATED GATE (not optional documentation)
# This blocks commits if checks fail

# Log all output to .git/hook-output.log for debugging
# (hook stderr is often invisible in CI/agent contexts like Claude Code)
# Note: Husky v9 runs hooks with `sh -e`, so must be POSIX-compatible.
# Cannot use bash process substitution >() since sh doesn't support it.
# Simple redirect to log file; caller can read the log after.
HOOK_OUTPUT_LOG="$(git rev-parse --show-toplevel 2>/dev/null || echo .)/.git/hook-output.log"
exec > "$HOOK_OUTPUT_LOG" 2>&1

# Display log on failure so developers see what went wrong (Gemini review #379)
# Uses EXIT_TRAP_CHAIN via add_exit_trap (defined below) to coexist with temp file cleanup

# Shared guard: any SKIP_ override requires SKIP_REASON (Session #162)
require_skip_reason() {
  if [ -z "${SKIP_REASON:-}" ]; then
    echo "  ‚ùå SKIP_REASON is required when overriding checks"
    echo "  Usage: SKIP_REASON=\"your reason\" $1 git commit ..."
    echo "  The audit trail is useless without a reason."
    exit 1
  fi
  # Reject multi-line reasons (prevents JSONL/log injection) ‚Äî POSIX-safe (no grep -P)
  cr="$(printf '\r')"
  if [ "$(printf '%s' "$SKIP_REASON" | wc -l | tr -d ' ')" -gt 1 ] || printf '%s' "$SKIP_REASON" | grep -q "$cr"; then
    echo "  ‚ùå SKIP_REASON must be a single line (no CR/LF characters)"
    exit 1
  fi
  # Reject control characters (prevents log injection) ‚Äî POSIX-safe
  if printf '%s' "$SKIP_REASON" | LC_ALL=C grep -q '[[:cntrl:]]'; then
    echo "  ‚ùå SKIP_REASON must not contain control characters"
    exit 1
  fi
  # Enforce max length to prevent DoS via oversized reasons
  skip_len=${#SKIP_REASON}
  if [ "$skip_len" -gt 500 ]; then
    echo "  ‚ùå SKIP_REASON must be <= 500 characters (got $skip_len)"
    exit 1
  fi
  # Validate minimum length to prevent meaningless skip reasons like "x" or "test"
  if [ "$skip_len" -lt 10 ]; then
    echo "  ‚ùå SKIP_REASON must be at least 10 characters (got $skip_len)"
    echo "  Provide a meaningful reason for the audit trail."
    exit 1
  fi
}

# POSIX-safe EXIT trap chaining ‚Äî appends cleanup commands without overwriting prior traps
# Uses a shell variable to accumulate trap commands (avoids fragile trap -p parsing)
add_exit_trap() {
  EXIT_TRAP_CHAIN="${EXIT_TRAP_CHAIN:+$EXIT_TRAP_CHAIN; }$1"
  trap "$EXIT_TRAP_CHAIN" EXIT
}

# Display log on failure so developers see what went wrong (Gemini review #379)
# Capture exit code before chain runs; display log to stderr on failure
add_exit_trap 'HOOK_EXIT=$?; if [ "$HOOK_EXIT" -ne 0 ] && [ -f "$HOOK_OUTPUT_LOG" ]; then exec 1>/dev/null; printf "\n--- PRE-COMMIT HOOK FAILED ---\n" >&2; cat "$HOOK_OUTPUT_LOG" >&2; printf "--- END OF LOGS ---\n" >&2; fi'

echo "üîç Running pre-commit checks..."

# 1. Run ESLint - rely on exit code, not output parsing
echo "  ‚ñ∂ Running ESLint..."
if ! npm run lint > /dev/null 2>&1; then
  echo "  ‚ùå ESLint has errors"
  npm run lint 2>&1 | tail -10
  echo ""
  echo "  Fix errors before committing. Run: npm run lint"
  exit 1
fi
echo "  ‚úÖ ESLint passed (0 errors)"

# 1b. CC check on NEW JS files (error-level, blocks new CC >15 functions)
# Only checks newly added files (diff-filter=A) to avoid pre-existing violations.
# Uses --no-config-lookup (ESLint 9 flat config compatible; replaces --no-eslintrc).
# Note: xargs -r is GNU (not POSIX) but safe here ‚Äî guarded by [ -n "$new_js" ]
# and both target platforms (Linux GNU, Windows MSYS2) include GNU findutils.
# Recommended in 5 consecutive retros (#367-#371).
new_js=$(git diff --cached --name-only --diff-filter=A | grep '\.js$' || true)
if [ -n "$new_js" ]; then
  if ! printf '%s\n' "$new_js" | xargs -r npx eslint --no-config-lookup --no-inline-config --rule 'complexity: [error, 15]' --parser-options=ecmaVersion:2022 --parser-options=sourceType:module -- > /dev/null 2>&1; then
    echo "  ‚ùå Cognitive Complexity >15 in new JS files"
    printf '%s\n' "$new_js" | xargs -r npx eslint --no-config-lookup --no-inline-config --rule 'complexity: [error, 15]' --parser-options=ecmaVersion:2022 --parser-options=sourceType:module -- 2>&1 | grep "complexity" | head -10 || true
    echo ""
    echo "  Extract helpers to reduce CC. See FIX_TEMPLATES.md Template 30."
    exit 1
  fi
fi

# 2. Auto-format staged files with lint-staged (Prettier)
# Automatically formats staged files - no manual intervention needed
echo "  ‚ñ∂ Running lint-staged (auto-format)..."
# Check if lint-staged is installed as devDependency (security: --no-install prevents supply chain attacks)
if npm list lint-staged --depth=0 > /dev/null 2>&1; then
  if ! npx --no-install lint-staged; then
    echo "  ‚ùå Lint-staged failed"
    exit 1
  fi
  echo "  ‚úÖ Lint-staged passed (files formatted)"
else
  echo "  ‚ö†Ô∏è lint-staged not installed - run 'npm ci' to enable auto-formatting"
  echo "  ‚è≠Ô∏è Skipping lint-staged (devDependency missing from node_modules)"
fi

# 3. Run pattern compliance check on staged files (catches issues before PR review tools)
# Review #308: Capture output once instead of running command twice
# Override with: SKIP_REASON="reason" SKIP_PATTERN_CHECK=1 git commit ...
if [ "${SKIP_PATTERN_CHECK:-}" = "1" ]; then
  require_skip_reason "SKIP_PATTERN_CHECK=1"
  node scripts/log-override.js --quick --check=pattern-compliance --reason="$SKIP_REASON" 2>/dev/null || true
  echo "  ‚è≠Ô∏è Skipping pattern compliance (SKIP_PATTERN_CHECK=1)"
else
  echo "  ‚ñ∂ Running pattern compliance..."
  if ! patterns_output="$(node scripts/check-pattern-compliance.js --staged 2>&1)"; then
    echo "  ‚ùå Pattern compliance failed"
    printf '%s\n' "$patterns_output" | tail -15
    echo ""
    echo "  Fix pattern issues before committing. Run: node scripts/check-pattern-compliance.js --staged"
    echo "  Override: SKIP_REASON=\"reason\" SKIP_PATTERN_CHECK=1 git commit ..."
    exit 1
  fi
  echo "  ‚úÖ Pattern compliance passed"
fi

# 4. Audit file S0/S1 validation (BLOCKING - Session #98)
# Validates that S0/S1 findings have proper verification_steps
# Moved before functional checks: security gates should run early
# Override with: SKIP_AUDIT_VALIDATION=1 git commit ...
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")
if [ "${SKIP_AUDIT_VALIDATION:-}" != "1" ]; then
  STAGED_AUDIT_FILES=$(printf '%s\n' "$STAGED_FILES" | grep -E "docs/audits/.*\.jsonl$" || true)
  if [ -n "$STAGED_AUDIT_FILES" ]; then
    echo "  ‚ñ∂ Validating audit S0/S1 compliance..."
    # POSIX-compatible: Write to temp file, read with while loop
    # Review #204: Pipe creates subshell where variable changes don't propagate
    # Chain with existing EXIT trap instead of overwriting
    AUDIT_TMPFILE="$(mktemp)" || { echo "  ‚ùå Failed to create temp file"; exit 1; }
    add_exit_trap 'rm -f "$AUDIT_TMPFILE" 2>/dev/null'
    echo "$STAGED_AUDIT_FILES" > "$AUDIT_TMPFILE"
    AUDIT_FAILED=0
    while IFS= read -r audit_file || [ -n "$audit_file" ]; do
      [ -z "$audit_file" ] && continue
      audit_out="$(node scripts/validate-audit.js "$audit_file" --strict-s0s1 2>&1)"
      audit_code=$?
      if [ "$audit_code" -ne 0 ]; then
        AUDIT_FAILED=1
        echo "  ‚ùå S0/S1 validation failed: $audit_file"
        printf '%s\n' "$audit_out" | grep -E "^   ‚ùå|BLOCKING" | head -5
      fi
    done < "$AUDIT_TMPFILE"
    rm -f "$AUDIT_TMPFILE"
    if [ "$AUDIT_FAILED" -eq 1 ]; then
      echo ""
      echo "  Fix S0/S1 violations or downgrade severity. Run:"
      echo "    node scripts/validate-audit.js <file> --strict-s0s1"
      echo "  Override: SKIP_REASON=\"reason\" SKIP_AUDIT_VALIDATION=1 git commit ..."
      exit 1
    fi
    echo "  ‚úÖ Audit S0/S1 validation passed"
  fi
else
  require_skip_reason "SKIP_AUDIT_VALIDATION=1"
  node scripts/log-override.js --quick --check=audit-s0s1 --reason="$SKIP_REASON" 2>/dev/null || true
  echo "  ‚è≠Ô∏è Skipping audit validation (SKIP_AUDIT_VALIDATION set)"
fi

# 5. Run tests - stream output using temp file
# Review #322: Run tests for config files that can break builds; skip for doc-only
# Override with: SKIP_TESTS=1 git commit ... (use sparingly)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
DOC_ONLY_COMMIT=0

if [ "${SKIP_TESTS:-}" = "1" ]; then
  require_skip_reason "SKIP_TESTS=1"
  node scripts/log-override.js --quick --check=tests --reason="$SKIP_REASON" 2>/dev/null || true
  echo "  ‚è≠Ô∏è Skipping tests (SKIP_TESTS=1)"
# Always run tests for risky config changes that can break builds/tests
# Review #322 Round 4: Include lockfiles (package-lock.json, yarn.lock, pnpm-lock.yaml)
elif printf '%s\n' "$STAGED_FILES" | grep -Eq '^(package\.json|package-lock\.json|pnpm-lock\.yaml|yarn\.lock|tsconfig.*\.json|next\.config\.(js|mjs|ts)|\.husky/|\.github/)'; then
  echo "  ‚ñ∂ Running tests (config changes detected)..."
  TEST_TMPFILE="$(mktemp)" || { echo "  ‚ùå Failed to create temp file"; exit 1; }
  add_exit_trap 'rm -f "$TEST_TMPFILE" 2>/dev/null'

  if ! npm test > "$TEST_TMPFILE" 2>&1; then
    echo "  ‚ùå Tests failed"
    tail -10 "$TEST_TMPFILE"
    echo ""
    echo "  Fix tests before committing. Run: npm test"
    exit 1
  fi
  echo "  ‚úÖ Tests passed"
else
  # Review #322 Round 3: More conservative doc-only detection
  # Only skip tests if ALL staged files are documentation-like
  # Session #121: Expanded to include JSONL (debt tracking), JSON (mappings), and common doc paths
  NON_DOC_FILES=$(printf '%s\n' "$STAGED_FILES" | grep -Ev '^(docs/|\.claude/|DOCUMENTATION_INDEX|SESSION_CONTEXT|ROADMAP|CLAUDE|ARCHITECTURE|DEVELOPMENT|AI_WORKFLOW).+|.*\.(md|mdx|txt|png|jpg|jpeg|gif|svg|jsonl)$' || true)
  if [ -z "$NON_DOC_FILES" ]; then
    DOC_ONLY_COMMIT=1
    echo "  ‚è≠Ô∏è Skipping tests (doc-only commit)"
  else
    echo "  ‚ñ∂ Running tests..."
    TEST_TMPFILE="$(mktemp)" || { echo "  ‚ùå Failed to create temp file"; exit 1; }
    add_exit_trap 'rm -f "$TEST_TMPFILE" 2>/dev/null'

    if ! npm test > "$TEST_TMPFILE" 2>&1; then
      echo "  ‚ùå Tests failed"
      tail -10 "$TEST_TMPFILE"
      echo ""
      echo "  Fix tests before committing. Run: npm test"
      exit 1
    fi
    echo "  ‚úÖ Tests passed"
  fi
fi

# 6. CANON schema validation (non-blocking warning, ~1s)
# Validates CANON files when audit output is staged
# Review #322 Round 3: Use printf for safer file path handling
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")
if printf '%s\n' "$STAGED_FILES" | grep -q "docs/reviews/.*\.jsonl"; then
  echo "  ‚ñ∂ Validating CANON schema..."
  if npm run validate:canon > /dev/null 2>&1; then
    echo "  ‚úÖ CANON validation passed"
  else
    echo "  ‚ö†Ô∏è CANON validation issues found (not blocking - run: npm run validate:canon)"
    node scripts/append-hook-warning.js --hook=pre-commit --type=canon --severity=warning --message="CANON validation issues found" --action="npm run validate:canon" 2>/dev/null || true
  fi
fi

# 7. Skill configuration validation (non-blocking, when skill files modified)
# Review #322 Round 4: Include .claude/skills/ not just .claude/commands/
if printf '%s\n' "$STAGED_FILES" | grep -Eq '\.(claude)/(skills|commands)/.*\.md$'; then
  echo "  ‚ñ∂ Validating skill configurations..."
  skills_output=$(npm run skills:validate 2>&1)
  if echo "$skills_output" | grep -q "‚ùå ERROR"; then
    echo "  ‚ö†Ô∏è Skill validation issues found (not blocking - run: npm run skills:validate)"
    printf '%s\n' "$skills_output" | grep -E "^üìÑ|^   ‚ùå" | head -10
    node scripts/append-hook-warning.js --hook=pre-commit --type=skill --severity=warning --message="Skill validation issues found" --action="npm run skills:validate" 2>/dev/null || true
  else
    echo "  ‚úÖ Skill validation passed"
  fi
fi

# 8. Cross-document dependency check (BLOCKING - Session #69)
# Blocks commit when documents are modified that have known dependencies on other docs
# Hook-quality fix: --trivial skips enforcement for whitespace/comment/formatting-only changes
# Override with: SKIP_REASON="reason" SKIP_CROSS_DOC_CHECK=1 git commit ...
# See: docs/DOCUMENT_DEPENDENCIES.md#cross-document-update-triggers
if [ "${SKIP_CROSS_DOC_CHECK:-}" = "1" ]; then
  require_skip_reason "SKIP_CROSS_DOC_CHECK=1"
  node scripts/log-override.js --quick --check=cross-doc-deps --reason="$SKIP_REASON" 2>/dev/null || true
  echo "  ‚è≠Ô∏è Skipping cross-doc dependency check (SKIP_CROSS_DOC_CHECK=1)"
else
  echo "  ‚ñ∂ Checking cross-document dependencies..."
  if ! node scripts/check-cross-doc-deps.js --trivial; then
    echo "  ‚ùå Cross-document dependency check failed"
    echo ""
    echo "  Fix dependencies before committing. Run: npm run crossdoc:check"
    echo "  Override: SKIP_REASON=\"reason\" SKIP_CROSS_DOC_CHECK=1 git commit ..."
    exit 1
  fi
  echo "  ‚úÖ Cross-document dependencies satisfied"
fi

# 9. Documentation Index auto-update (AUTO-FIX - Session #103, fixed #149)
# When .md files are staged, auto-regenerate and re-stage DOCUMENTATION_INDEX.md
# This eliminates timing issues where lint-staged's stash/restore cycle
# drops DOCUMENTATION_INDEX.md from the staging area (false-positive failures).
# Override with: SKIP_DOC_INDEX_CHECK=1 git commit ...
if [ "${SKIP_DOC_INDEX_CHECK:-}" = "1" ]; then
  require_skip_reason "SKIP_DOC_INDEX_CHECK=1"
  node scripts/log-override.js --quick --check=doc-index --reason="$SKIP_REASON" 2>/dev/null || true
  echo "  ‚è≠Ô∏è Skipping doc index check (SKIP_DOC_INDEX_CHECK=1)"
fi
if [ "${SKIP_DOC_INDEX_CHECK:-}" != "1" ]; then
  CHANGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ADM | grep -E '\.md$' || true)
  if [ -n "$CHANGED_MD_FILES" ]; then
    echo "  ‚ñ∂ Auto-updating documentation index..."
    if npm run docs:index > /dev/null 2>&1; then
      # Format after regeneration so CI Prettier check passes
      npx prettier --write DOCUMENTATION_INDEX.md > /dev/null 2>&1 || true
      git add DOCUMENTATION_INDEX.md
      echo "  ‚úÖ Documentation index updated and staged"
    else
      echo "  ‚ö†Ô∏è Documentation index generation failed (non-blocking)"
    fi
  fi
fi

# 10. Document header validation for NEW docs (BLOCKING - Session #115)
# Ensures new .md files have required headers (Version, Last Updated, Status)
# Override with: SKIP_DOC_HEADER_CHECK=1 git commit ...
if [ "${SKIP_DOC_HEADER_CHECK:-}" = "1" ]; then
  require_skip_reason "SKIP_DOC_HEADER_CHECK=1"
  node scripts/log-override.js --quick --check=doc-header --reason="$SKIP_REASON" 2>/dev/null || true
fi
if [ "${SKIP_DOC_HEADER_CHECK:-}" != "1" ]; then
  NEW_MD_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E '\.md$' || true)
  if [ -n "$NEW_MD_FILES" ]; then
    echo "  ‚ñ∂ Validating new document headers..."
    if ! node scripts/check-doc-headers.js; then
      exit 1
    fi
    echo "  ‚úÖ Document headers validated"
  fi
fi

# 11. Learning entry reminder (non-blocking, ~0.5s)
# Reminds to capture learnings when it looks like PR feedback was addressed
LEARNINGS_LOG="docs/AI_REVIEW_LEARNINGS_LOG.md"

# Check if learnings log is being updated
# Review #322 Round 3: Use printf for safer file path handling
if printf '%s\n' "$STAGED_FILES" | grep -q "$LEARNINGS_LOG"; then
  echo "  ‚úÖ Learning entry detected"
else
  # Count staged files - if many files changed, might be addressing review
  STAGED_COUNT=$(printf '%s\n' "$STAGED_FILES" | grep -c . 2>/dev/null || printf "0")
  STAGED_COUNT=${STAGED_COUNT:-0}
  # Check for template/doc changes that often accompany reviews
  TEMPLATE_CHANGES=$(printf '%s\n' "$STAGED_FILES" | grep -c -E "templates|\.claude/commands|\.claude/hooks" 2>/dev/null || printf "0")
  TEMPLATE_CHANGES=${TEMPLATE_CHANGES:-0}

  if [ "$STAGED_COUNT" -gt 5 ] 2>/dev/null || [ "$TEMPLATE_CHANGES" -gt 0 ] 2>/dev/null; then
    echo "  üí° Reminder: If addressing PR feedback, add Review #N to $LEARNINGS_LOG"
  fi
fi

# 12. Agent compliance check (non-blocking warning - Session #101)
# Warns if code files are being committed but agents weren't invoked
# Make blocking with: STRICT_AGENT_CHECK=1 git commit ...
echo "  ‚ñ∂ Checking agent compliance..."
if [ -n "${STRICT_AGENT_CHECK:-}" ]; then
  if ! node scripts/check-agent-compliance.js --strict 2>&1; then
    exit 1
  fi
else
  agent_output=$(node scripts/check-agent-compliance.js 2>&1) || true
  echo "$agent_output"
  if echo "$agent_output" | grep -q "‚ö†Ô∏è"; then
    node scripts/append-hook-warning.js --hook=pre-commit --type=agent --severity=warning --message="Agent compliance warnings - code changed without agent review" --action="Use code-reviewer agent for modified code" 2>/dev/null || true
  fi
fi

# 13. Technical debt schema validation (BLOCKING - TDMS Phase 7)
# Validates MASTER_DEBT.jsonl schema when modified
# Hook-quality fix: --staged-only validates only changed lines, not the entire file
# Override with: SKIP_DEBT_VALIDATION=1 git commit ...
if [ "${SKIP_DEBT_VALIDATION:-}" = "1" ]; then
  require_skip_reason "SKIP_DEBT_VALIDATION=1"
  node scripts/log-override.js --quick --check=debt-schema --reason="$SKIP_REASON" 2>/dev/null || true
fi
if [ "${SKIP_DEBT_VALIDATION:-}" != "1" ]; then
  if printf '%s\n' "$STAGED_FILES" | grep -q "docs/technical-debt/MASTER_DEBT.jsonl"; then
    echo "  ‚ñ∂ Validating technical debt schema (changed lines)..."
    if ! node scripts/debt/validate-schema.js --staged-only > /dev/null 2>&1; then
      echo "  ‚ùå Technical debt schema validation failed"
      node scripts/debt/validate-schema.js --staged-only 2>&1 | tail -10
      echo ""
      echo "  Fix schema issues before committing. Run:"
      echo "    node scripts/debt/validate-schema.js --staged-only"
      echo "  Override: SKIP_REASON=\"reason\" SKIP_DEBT_VALIDATION=1 git commit ..."
      exit 1
    fi
    echo "  ‚úÖ Technical debt schema passed"
  fi
fi

# 14. Technical debt canonical location check (WARNING - TDMS Phase 7)
# Session #128: Canonical locations for debt data:
#   - docs/technical-debt/ (MASTER_DEBT.jsonl + views)
#   - docs/audits/single-session/ (audit output files)
# Warn if debt-like files (.jsonl) appear elsewhere in docs/
# PR #332 Review #235: Anchor regex for robustness
DEBT_CANONICAL_PATHS="^docs/technical-debt/|^docs/audits/single-session/"
DEBT_OUTSIDE_CANONICAL=$(printf '%s\n' "$STAGED_FILES" | grep -E '^docs/.*\.(jsonl)$' | grep -Ev "$DEBT_CANONICAL_PATHS" || true)
if [ -n "$DEBT_OUTSIDE_CANONICAL" ]; then
  echo "  ‚ö†Ô∏è  Warning: JSONL data files outside canonical debt locations"
  echo "     Canonical locations:"
  echo "       - docs/technical-debt/MASTER_DEBT.jsonl"
  echo "       - docs/audits/single-session/"
  echo "     Files found elsewhere:"
  printf '%s\n' "$DEBT_OUTSIDE_CANONICAL" | head -5 | sed 's/^/       /'
  node scripts/append-hook-warning.js --hook=pre-commit --type=debt-location --severity=warning --message="Debt files outside canonical location" --action="Move to docs/technical-debt/ or docs/audits/single-session/" 2>/dev/null || true
fi

echo ""
echo "‚úÖ All pre-commit checks passed - commit allowed"
