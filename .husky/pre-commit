#!/bin/sh
# Pre-commit hook - AUTOMATED GATE (not optional documentation)
# This blocks commits if checks fail

echo "üîç Running pre-commit checks..."

# 1. Run ESLint - rely on exit code, not output parsing
echo "  ‚ñ∂ Running ESLint..."
if ! npm run lint > /dev/null 2>&1; then
  echo "  ‚ùå ESLint has errors"
  npm run lint 2>&1 | tail -10
  echo ""
  echo "  Fix errors before committing. Run: npm run lint"
  exit 1
fi
echo "  ‚úÖ ESLint passed (0 errors)"

# 2. Check code formatting (Prettier)
# NOTE: Currently set to WARN (not block) until initial codebase formatting is applied
# TODO: Change to blocking after running 'npm run format' on the codebase
echo "  ‚ñ∂ Checking code formatting..."
if ! npm run format:check > /dev/null 2>&1; then
  echo "  ‚ö†Ô∏è  Formatting issues found (not blocking - run: npm run format)"
else
  echo "  ‚úÖ Code formatting passed"
fi

# 3. Run pattern compliance check (catches issues before PR review tools)
echo "  ‚ñ∂ Running pattern compliance..."
if ! npm run patterns:check > /dev/null 2>&1; then
  echo "  ‚ùå Pattern compliance failed"
  npm run patterns:check 2>&1 | tail -15
  echo ""
  echo "  Fix pattern issues before committing. Run: npm run patterns:check"
  exit 1
fi
echo "  ‚úÖ Pattern compliance passed"

# 4. Run tests - stream output using temp file
echo "  ‚ñ∂ Running tests..."
TEST_TMPFILE=$(mktemp)
trap 'rm -f "$TEST_TMPFILE"' EXIT

if ! npm test > "$TEST_TMPFILE" 2>&1; then
  echo "  ‚ùå Tests failed"
  tail -10 "$TEST_TMPFILE"
  echo ""
  echo "  Fix tests before committing. Run: npm test"
  exit 1
fi
echo "  ‚úÖ Tests passed"

# 5. CANON schema validation (non-blocking warning, ~1s)
# Validates CANON files when audit output is staged
STAGED_FILES=$(git diff --cached --name-only 2>/dev/null || echo "")
if echo "$STAGED_FILES" | grep -q "docs/reviews/.*\.jsonl"; then
  echo "  ‚ñ∂ Validating CANON schema..."
  if npm run validate:canon > /dev/null 2>&1; then
    echo "  ‚úÖ CANON validation passed"
  else
    echo "  ‚ö†Ô∏è CANON validation issues found (not blocking - run: npm run validate:canon)"
  fi
fi

# 6. Learning entry reminder (non-blocking, ~0.5s)
# Reminds to capture learnings when it looks like PR feedback was addressed
LEARNINGS_LOG="docs/AI_REVIEW_LEARNINGS_LOG.md"

# Check if learnings log is being updated
if echo "$STAGED_FILES" | grep -q "$LEARNINGS_LOG"; then
  echo "  ‚úÖ Learning entry detected"
else
  # Count staged files - if many files changed, might be addressing review
  STAGED_COUNT=$(echo "$STAGED_FILES" | grep -c . || echo "0")
  # Check for template/doc changes that often accompany reviews
  TEMPLATE_CHANGES=$(echo "$STAGED_FILES" | grep -c "templates\|\.claude/commands\|\.claude/hooks" || echo "0")

  if [ "$STAGED_COUNT" -gt 5 ] || [ "$TEMPLATE_CHANGES" -gt 0 ]; then
    echo "  üí° Reminder: If addressing PR feedback, add Review #N to $LEARNINGS_LOG"
  fi
fi

echo ""
echo "‚úÖ All pre-commit checks passed - commit allowed"
