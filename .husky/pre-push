#!/bin/sh
# Pre-push hook - Additional gate before pushing to remote
# This blocks pushes if checks fail

echo "ðŸš€ Running pre-push checks..."

# 1. Tests already run in pre-commit (Quick Win - Session #113)
# Removed duplicate test run - saves 50-60s per push

# 2. Check for circular dependencies (blocking - architectural integrity)
echo "  â–¶ Checking for circular dependencies..."
if ! npm run deps:circular > /dev/null 2>&1; then
  echo "  âŒ Circular dependencies detected"
  npm run deps:circular 2>&1 | tail -10
  echo ""
  echo "  Fix circular dependencies before pushing. Run: npm run deps:circular"
  exit 1
fi
echo "  âœ… No circular dependencies"

# 3. Run pattern compliance check (BLOCKING - 14 critical files)
# Fixed 2026-01-04: Legacy violations resolved (Session #23)
# Note: Uses default file list (critical files). Full repo check (--all) may have violations in migration scripts.
# Fixed in Review #51: Capture output once instead of running command multiple times
echo "  â–¶ Running pattern compliance check..."
patterns_output=$(npm run patterns:check 2>&1)
patterns_exit=$?
if [ $patterns_exit -ne 0 ]; then
  echo "  âŒ Pattern compliance violations found"
  printf '%s\n' "$patterns_output" | grep -E "^ðŸ“„|Found [0-9]+ potential" || printf '%s\n' "$patterns_output" | tail -15
  echo ""
  echo "  Fix pattern violations before pushing. Run: npm run patterns:check"
  exit 1
fi
echo "  âœ… Pattern compliance passed"

# 4. Security pattern check (files being pushed, blocking for CRITICAL/HIGH)
echo "  â–¶ Running security pattern check..."
set +e
changed_files=$(git diff --name-only --diff-filter=ACMR @{u}...HEAD 2>/dev/null | grep -E '\.(js|ts|tsx|json)$')
diff_exit=$?
set -e

if [ $diff_exit -ne 0 ] || [ -z "${changed_files:-}" ]; then
  echo "  âš ï¸ No upstream or no JS/TS/JSON changes detected; skipping targeted security scan"
else
  security_exit=0
  security_output=""

  while IFS= read -r file; do
    [ -z "$file" ] && continue
    [ -f "$file" ] || continue

    set +e
    out=$(node scripts/security-check.js --file "$file" --blocking 2>&1)
    code=$?
    set -e

    security_output="${security_output}"$'\n'"${out}"
    if [ $code -ne 0 ]; then
      security_exit=$code
    fi
  done <<EOF
$changed_files
EOF

  if [ $security_exit -ne 0 ]; then
    echo "  âŒ Security pattern violations found"
    printf '%s\n' "$security_output" | grep -E "CRITICAL|HIGH|ðŸ›‘|file:" | head -15
    echo ""
    echo "  Fix security issues before pushing. Run: npm run security:check"
    exit 1
  elif echo "$security_output" | grep -q "MEDIUM\|LOW"; then
    echo "  âš ï¸ Security warnings (not blocking) - run: npm run security:check"
    node scripts/append-hook-warning.js --hook=pre-push --type=security --severity=warning --message="Security warnings (MEDIUM/LOW) found in pushed code" --action="npm run security:check" 2>/dev/null || true
  else
    echo "  âœ… Security check passed"
  fi
fi

# 5. Type check
echo "  â–¶ Running type check..."
if ! npx tsc --noEmit > /dev/null 2>&1; then
  echo "  âŒ Type check failed"
  npx tsc --noEmit 2>&1 | tail -10
  echo ""
  echo "  Fix type errors before pushing. Run: npx tsc --noEmit"
  exit 1
fi
echo "  âœ… Type check passed"

# 6. Security audit (non-blocking warning, ~3-8s)
# Checks for high/critical vulnerabilities in dependencies
echo "  â–¶ Running security audit..."
audit_output=$(npm audit --audit-level=high 2>&1)
audit_exit=$?
if [ $audit_exit -ne 0 ]; then
  # Check if it's a real vulnerability (exit code 1) vs network error
  if echo "$audit_output" | grep -q "vulnerabilities"; then
    echo "  âš ï¸ Security vulnerabilities found (not blocking - run: npm audit)"
    echo "$audit_output" | grep -E "high|critical|vulnerabilities" | head -5
    node scripts/append-hook-warning.js --hook=pre-push --type=audit --severity=warning --message="npm audit found security vulnerabilities" --action="npm audit" 2>/dev/null || true
  else
    echo "  âš ï¸ npm audit check skipped (network or registry issue)"
  fi
else
  echo "  âœ… No high/critical vulnerabilities"
fi

# 7. Event-based trigger checker (blocking for security, warning for others)
# Checks: security_audit (files with auth/token/etc.), consolidation, skill_validation
echo "  â–¶ Checking event-based triggers..."
if [ "${SKIP_TRIGGERS:-}" = "1" ]; then
  echo "  âš ï¸ Triggers skipped (SKIP_TRIGGERS=1)"
  # Log the override for audit trail with reason
  node scripts/log-override.js --check=triggers --reason="${SKIP_REASON:-No reason provided}" 2>/dev/null || true
else
  triggers_output=$(npm run triggers:check 2>&1)
  triggers_exit=$?
  if [ $triggers_exit -eq 1 ]; then
    echo "  âŒ Blocking trigger(s) activated"
    printf '%s\n' "$triggers_output" | grep -E "^ðŸš«|^âŒ|^   Action:|^   Files:" | head -20
    echo ""
    echo "  Complete required actions or use: SKIP_TRIGGERS=1 git push"
    exit 1
  elif [ $triggers_exit -eq 0 ]; then
    # Show warnings but don't block
    if echo "$triggers_output" | grep -q "âš ï¸"; then
      printf '%s\n' "$triggers_output" | grep -E "^âš ï¸|^   Action:" | head -10
      # Extract first warning message for the alert
      first_warning=$(printf '%s\n' "$triggers_output" | grep "^âš ï¸" | head -1 | sed 's/^âš ï¸ *//')
      # Review #214: Only create alert if we have a non-empty message
      if [ -n "$first_warning" ]; then
        node scripts/append-hook-warning.js --hook=pre-push --type=trigger --severity=info --message="$first_warning" 2>/dev/null || true
      fi
    else
      echo "  âœ… No blocking triggers"
    fi
  fi
fi

echo ""
echo "âœ… All pre-push checks passed - push allowed"
