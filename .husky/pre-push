#!/bin/sh
# Pre-push hook - Additional gate before pushing to remote
# This blocks pushes if checks fail

echo "üöÄ Running pre-push checks..."

# 1. Run tests
echo "  ‚ñ∂ Running tests..."
if ! npm test > /dev/null 2>&1; then
  echo "  ‚ùå Tests failed"
  npm test 2>&1 | tail -10
  echo ""
  echo "  Fix tests before pushing. Run: npm test"
  exit 1
fi
echo "  ‚úÖ Tests passed"

# 2. Check for circular dependencies (blocking - architectural integrity)
echo "  ‚ñ∂ Checking for circular dependencies..."
if ! npm run deps:circular > /dev/null 2>&1; then
  echo "  ‚ùå Circular dependencies detected"
  npm run deps:circular 2>&1 | tail -10
  echo ""
  echo "  Fix circular dependencies before pushing. Run: npm run deps:circular"
  exit 1
fi
echo "  ‚úÖ No circular dependencies"

# 3. Run pattern compliance check (BLOCKING - 14 critical files)
# Fixed 2026-01-04: Legacy violations resolved (Session #23)
# Note: Uses default file list (critical files). Full repo check (--all) may have violations in migration scripts.
# Fixed in Review #51: Capture output once instead of running command multiple times
echo "  ‚ñ∂ Running pattern compliance check..."
patterns_output=$(npm run patterns:check 2>&1)
patterns_exit=$?
if [ $patterns_exit -ne 0 ]; then
  echo "  ‚ùå Pattern compliance violations found"
  printf '%s\n' "$patterns_output" | grep -E "^üìÑ|Found [0-9]+ potential" || printf '%s\n' "$patterns_output" | tail -15
  echo ""
  echo "  Fix pattern violations before pushing. Run: npm run patterns:check"
  exit 1
fi
echo "  ‚úÖ Pattern compliance passed"

# 4. Type check
echo "  ‚ñ∂ Running type check..."
if ! npx tsc --noEmit > /dev/null 2>&1; then
  echo "  ‚ùå Type check failed"
  npx tsc --noEmit 2>&1 | tail -10
  echo ""
  echo "  Fix type errors before pushing. Run: npx tsc --noEmit"
  exit 1
fi
echo "  ‚úÖ Type check passed"

# 5. Security audit (non-blocking warning, ~3-8s)
# Checks for high/critical vulnerabilities in dependencies
echo "  ‚ñ∂ Running security audit..."
audit_output=$(npm audit --audit-level=high 2>&1)
audit_exit=$?
if [ $audit_exit -ne 0 ]; then
  # Check if it's a real vulnerability (exit code 1) vs network error
  if echo "$audit_output" | grep -q "vulnerabilities"; then
    echo "  ‚ö†Ô∏è Security vulnerabilities found (not blocking - run: npm audit)"
    echo "$audit_output" | grep -E "high|critical|vulnerabilities" | head -5
  else
    echo "  ‚ö†Ô∏è npm audit check skipped (network or registry issue)"
  fi
else
  echo "  ‚úÖ No high/critical vulnerabilities"
fi

echo ""
echo "‚úÖ All pre-push checks passed - push allowed"
