#!/bin/sh
# Pre-push hook - Additional gate before pushing to remote
# This blocks pushes if checks fail

# Shared guard: any SKIP_ override requires SKIP_REASON (Session #162)
require_skip_reason() {
  if [ -z "${SKIP_REASON:-}" ]; then
    echo "  ‚ùå SKIP_REASON is required when overriding checks"
    echo "  Usage: SKIP_REASON=\"your reason\" $1 git push ..."
    echo "  The audit trail is useless without a reason."
    exit 1
  fi
  # Reject multi-line reasons (prevents JSONL/log injection) ‚Äî POSIX-safe (no grep -P)
  if [ "$(printf '%s' "$SKIP_REASON" | wc -l | tr -d ' ')" -gt 1 ] || printf '%s' "$SKIP_REASON" | grep -q $'\r'; then
    echo "  ‚ùå SKIP_REASON must be a single line (no CR/LF characters)"
    exit 1
  fi
  # Validate minimum length to prevent meaningless skip reasons like "x" or "test"
  skip_len=${#SKIP_REASON}
  if [ "$skip_len" -lt 10 ]; then
    echo "  ‚ùå SKIP_REASON must be at least 10 characters (got $skip_len)"
    echo "  Provide a meaningful reason for the audit trail."
    exit 1
  fi
}

echo "üöÄ Running pre-push checks..."

# 1. Tests already run in pre-commit (Quick Win - Session #113)
# Removed duplicate test run - saves 50-60s per push

# 2. Check for circular dependencies (blocking - architectural integrity)
echo "  ‚ñ∂ Checking for circular dependencies..."
if ! npm run deps:circular > /dev/null 2>&1; then
  echo "  ‚ùå Circular dependencies detected"
  npm run deps:circular 2>&1 | tail -10
  echo ""
  echo "  Fix circular dependencies before pushing. Run: npm run deps:circular"
  exit 1
fi
echo "  ‚úÖ No circular dependencies"

# 3. Pattern compliance: REMOVED from pre-push (hook-quality fix)
# Pattern compliance already runs in pre-commit on staged files.
# Running it again here on 14 hardcoded files caused graduation double-jeopardy:
# a warning in pre-commit would escalate to a BLOCK in pre-push hours later,
# even if the file wasn't part of the push. Keeping pre-commit only.
echo "  ‚è≠Ô∏è Pattern compliance (covered by pre-commit)"

# 3b. Code-reviewer gate for script changes (Session #151)
# If scripts/.claude/hooks/.husky/ changed, check if code-reviewer ran this session
echo "  ‚ñ∂ Checking code-reviewer coverage for script changes..."
set +e
script_changes=$(git diff --name-only --diff-filter=ACMR @{u}...HEAD 2>/dev/null | grep -E '^(scripts/|\.claude/hooks/|\.husky/)' | head -5)
set -e

if [ -n "${script_changes:-}" ]; then
  # Check if code-reviewer was invoked this session
  reviewer_ran=0
  if [ -f ".claude/state/agent-invocations.jsonl" ]; then
    # Look for code-reviewer invocation in the last 4 hours
    if grep -q '"code-reviewer"' .claude/state/agent-invocations.jsonl 2>/dev/null; then
      reviewer_ran=1
    fi
  fi

  if [ "$reviewer_ran" -eq 0 ]; then
    echo "  ‚ö†Ô∏è Script changes detected but code-reviewer not invoked this session"
    echo "  Changed files:"
    printf '%s\n' "$script_changes" | while read -r f; do echo "    - $f"; done
    echo ""
    echo "  Run code-reviewer before pushing script changes."
    echo "  Use: SKIP_REASON=\"reason\" SKIP_REVIEWER=1 git push to bypass (not recommended)"
    if [ "${SKIP_REVIEWER:-}" != "1" ]; then
      exit 1
    fi
    require_skip_reason "SKIP_REVIEWER=1"
    echo "  ‚ö†Ô∏è Bypassed with SKIP_REVIEWER=1"
    node scripts/log-override.js --quick --check=reviewer --reason="$SKIP_REASON" 2>/dev/null || true
    node scripts/append-hook-warning.js --hook=pre-push --type=reviewer --severity=warning --message="Code-reviewer bypassed for script changes" --action="Run code-reviewer agent" 2>/dev/null || true
  else
    echo "  ‚úÖ Code-reviewer was invoked for script changes"
  fi
else
  echo "  ‚úÖ No script changes (code-reviewer gate skipped)"
fi

# 4. Security pattern check (diff-only mode: only flag violations in ADDED lines)
# Hook-quality fix: Previously scanned entire files, catching pre-existing violations
# that weren't introduced by the current commits. Now uses --diff-only to only check
# lines that were actually added in the push.
echo "  ‚ñ∂ Running security pattern check (diff-only)..."
set +e
security_diff=$(git diff --diff-filter=ACMR @{u}...HEAD -U0 2>/dev/null | grep -E '^\+[^+]' | grep -v '^+++')
diff_exit=$?
set -e

if [ "$diff_exit" -ne 0 ] || [ -z "${security_diff:-}" ]; then
  echo "  ‚ö†Ô∏è No upstream or no added lines detected; skipping security scan"
else
  # Write added lines to temp file for scanning
  # Use .js extension so security-check.js applies JS/TS patterns to the content
  SEC_TMPFILE=$(mktemp --suffix=.js)
  trap 'rm -f "$SEC_TMPFILE"' EXIT
  printf '%s\n' "$security_diff" > "$SEC_TMPFILE"

  set +e
  out=$(node scripts/security-check.js --file "$SEC_TMPFILE" --blocking 2>&1)
  code=$?
  set -e

  if [ "$code" -ne 0 ]; then
    echo "  ‚ùå Security violations found in NEW code"
    printf '%s\n' "$out" | grep -E "CRITICAL|HIGH|üõë|file:" | head -15
    echo ""
    echo "  Fix security issues in your new code before pushing."
    exit 1
  elif echo "$out" | grep -q "MEDIUM\|LOW"; then
    echo "  ‚ö†Ô∏è Security warnings in new code (not blocking) - review recommended"
    node scripts/append-hook-warning.js --hook=pre-push --type=security --severity=warning --message="Security warnings (MEDIUM/LOW) found in pushed code" --action="npm run security:check" 2>/dev/null || true
  else
    echo "  ‚úÖ Security check passed (new code only)"
  fi
fi

# 5. Type check
echo "  ‚ñ∂ Running type check..."
if ! npx tsc --noEmit > /dev/null 2>&1; then
  echo "  ‚ùå Type check failed"
  npx tsc --noEmit 2>&1 | tail -10
  echo ""
  echo "  Fix type errors before pushing. Run: npx tsc --noEmit"
  exit 1
fi
echo "  ‚úÖ Type check passed"

# 6. Security audit (non-blocking warning, ~3-8s)
# Checks for high/critical vulnerabilities in dependencies
echo "  ‚ñ∂ Running security audit..."
# Review #214: Disable errexit for npm audit (returns non-zero for vulnerabilities)
# Review #322: Preserve and restore original errexit state
had_errexit=0
case $- in
  *e*) had_errexit=1 ;;
esac
set +e
audit_output=$(npm audit --audit-level=high 2>&1)
audit_exit=$?
if [ "$had_errexit" -eq 1 ]; then
  set -e
fi
if [ "$audit_exit" -ne 0 ]; then
  # Check if it's a real vulnerability (exit code 1) vs network error
  if echo "$audit_output" | grep -q "vulnerabilities"; then
    echo "  ‚ö†Ô∏è Security vulnerabilities found (not blocking - run: npm audit)"
    echo "$audit_output" | grep -E "high|critical|vulnerabilities" | head -5
    node scripts/append-hook-warning.js --hook=pre-push --type=audit --severity=warning --message="npm audit found security vulnerabilities" --action="npm audit" 2>/dev/null || true
  else
    echo "  ‚ö†Ô∏è npm audit check skipped (network or registry issue)"
  fi
else
  echo "  ‚úÖ No high/critical vulnerabilities"
fi

# 7. Event-based trigger checker (blocking for security, warning for others)
# Checks: security_audit (files with auth/token/etc.), consolidation, skill_validation
echo "  ‚ñ∂ Checking event-based triggers..."
if [ "${SKIP_TRIGGERS:-}" = "1" ]; then
  require_skip_reason "SKIP_TRIGGERS=1"
  echo "  ‚ö†Ô∏è Triggers skipped (SKIP_TRIGGERS=1)"
  # Log the override for audit trail with reason
  node scripts/log-override.js --check=triggers --reason="$SKIP_REASON" 2>/dev/null || true
else
  triggers_output=$(npm run triggers:check 2>&1)
  triggers_exit=$?
  if [ "$triggers_exit" -eq 1 ]; then
    echo "  ‚ùå Blocking trigger(s) activated"
    printf '%s\n' "$triggers_output" | grep -E "^üö´|^‚ùå|^   Action:|^   Files:" | head -20
    echo ""
    echo "  Complete required actions or use: SKIP_REASON=\"reason\" SKIP_TRIGGERS=1 git push"
    exit 1
  elif [ "$triggers_exit" -eq 0 ]; then
    # Show warnings but don't block
    if echo "$triggers_output" | grep -q "‚ö†Ô∏è"; then
      printf '%s\n' "$triggers_output" | grep -E "^‚ö†Ô∏è|^   Action:" | head -10
      # Extract first warning message for the alert
      first_warning=$(printf '%s\n' "$triggers_output" | grep "^‚ö†Ô∏è" | head -1 | sed 's/^‚ö†Ô∏è *//')
      # Review #322: Normalize warning message to single line to prevent parsing issues
      first_warning_one_line=$(printf '%s' "$first_warning" | tr '\n\r' '  ' | sed 's/[[:space:]]\{1,\}/ /g; s/^ *//; s/ *$//')
      # Review #214: Only create alert if we have a non-empty message
      if [ -n "$first_warning_one_line" ]; then
        node scripts/append-hook-warning.js --hook=pre-push --type=trigger --severity=info --message="$first_warning_one_line" 2>/dev/null || true
      fi
    else
      echo "  ‚úÖ No blocking triggers"
    fi
  else
    # Fail closed: unexpected exit code means something went wrong
    echo "  ‚ùå Triggers check failed (exit $triggers_exit)"
    printf '%s\n' "$triggers_output" | tail -20
    echo ""
    echo "  Fix the triggers checker error or use: SKIP_REASON=\"reason\" SKIP_TRIGGERS=1 git push"
    exit 1
  fi
fi

echo ""
echo "‚úÖ All pre-push checks passed - push allowed"
