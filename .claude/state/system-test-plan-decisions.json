{
  "meta": {
    "document": "System Test Plan V2 - Complete Decision Record",
    "created": "2026-02-18",
    "status": "round-1-complete, round-2-in-progress",
    "plan_file_structure": "session-based split (5 session files + master index)",
    "v1_location": ".claude/plans/system-test-plan.md",
    "total_domains": 22,
    "domain_range": "0-21 (0=Self-Validation, 21=Post-Test Self-Audit)"
  },
  "decisions": {
    "Q01_skill_name": "system-test (invoked as /system-test)",
    "Q02_tdms_source_id": "system-test:{DOMAIN}-{NNN} (e.g. system-test:BUILD-001)",
    "Q03_tdms_intake_timing": "Batch at end - complete full report, then interactive review, then intake",
    "Q04_review_fields": "Standard audit fields + Impact Radius + Auto-fixable + Blocking Status",
    "Q05_review_decisions": "5 options: ACCEPT, DECLINE, DEFER, AUTOFIX, MERGE",
    "Q06_session_architecture": "Configurable scope: --full, --session N, --domain NAME",
    "Q07_state_persistence": "Dual: state JSON + results directory",
    "Q08_finding_id_format": "Domain-prefixed: BUILD-001, SCRIPTS-003, HOOKS-007",
    "Q09_report_output": "JSONL (machine) + Markdown (human) dual output",
    "Q10_run_diffing": "Full finding-level diff between runs (new/resolved/persistent)",
    "Q11_domains_1_10_gaps": "ALL additions accepted (maximum thoroughness)",
    "Q12_domains_11_20_gaps": "ALL additions accepted (maximum thoroughness)",
    "Q13_compaction_guardrails": "4-layer: state JSON + per-domain JSONL + checkpoint MD + review decisions",
    "Q14_separate_review_mode": "--review [run-id] to enter/re-enter review for existing run",
    "Q15_domain_0_self_validation": "YES - test skill infrastructure before running tests",
    "Q16_parallelism": "Dependency graph with wave-based parallel execution via subagents",
    "Q17_domain_21_post_test_audit": "YES - full interactive review format",
    "Q18_s0_escalation": "Stop-and-confirm gate when S0 found during execution",
    "Q19_exclusion_mechanism": "--skip domain, --exclude FINDING-ID, FALSE_POSITIVES.jsonl integration",
    "Q20_metrics_dashboard": "--dashboard mode for trend analysis across runs"
  },
  "domain_gap_additions": {
    "domain_0_self_validation": [
      "Test scripts/lib/ modules load without errors",
      "JSONL writer round-trip test",
      "Disk space pre-flight check",
      "State file write+read round-trip test",
      "Verify results directory is writable"
    ],
    "domain_1_prerequisites": [
      "Disk space check",
      "Git state validation (clean working tree, correct branch)",
      "Shell environment validation ($PATH, expected tools)",
      "MCP server connectivity test (Playwright, SonarCloud, memory)",
      ".npmrc audit (registry overrides)",
      "Self-test of scripts/lib/ modules"
    ],
    "domain_2_build": [
      "Incremental build cache validation (.next/cache/ stale/corrupt test)",
      "next.config.mjs logic review (redirects, rewrites, headers, image domains, experimental)",
      "Static export validation (no getServerSideProps usage)",
      "Bundle analysis (@next/bundle-analyzer)",
      "Source map validation (correct generation, not exposed in production)"
    ],
    "domain_3_tests": [
      "Test isolation verification (randomized order run)",
      "Test file naming convention check (*.test.ts consistent)",
      "Snapshot staleness check",
      "Mock completeness audit (Firebase/Firestore mock coverage)",
      "Test performance profiling (flag >5s tests)",
      "Dead test detection (files outside tsconfig include paths)"
    ],
    "domain_4_static_analysis": [
      "ESLint disable comment audit (count, justification review)",
      "TypeScript strict mode gap check",
      "Accessibility linting (jsx-a11y configuration check)",
      "Import order enforcement check",
      "Unused type exports check"
    ],
    "domain_5_dependencies": [
      "Phantom dependency detection",
      "Engine field 4-way alignment (package.json vs actual Node vs CI vs Firebase)",
      "Peer dependency warnings audit",
      "Lock file drift check (package-lock.json vs package.json)",
      "Duplicate package versions in lockfile"
    ],
    "domain_6_app_code": [
      "Accessibility audit (ARIA, keyboard nav, focus, contrast WCAG 2.1 AA)",
      "Error boundary coverage check",
      "Loading state coverage check",
      "Dead code detection (exported but never imported)",
      "Environment variable usage audit (NEXT_PUBLIC_* refs vs .env.local.example)",
      "Image optimization audit (next/image vs raw img)",
      "Client/Server boundary audit (use client directives)"
    ],
    "domain_7_cloud_functions": [
      "Cold start analysis (heavy top-level imports)",
      "Memory/timeout configuration review",
      "Error handling completeness (try/catch + HTTP status codes)",
      "Idempotency verification (safe retry for scheduled jobs)",
      "Data validation completeness (Zod schema coverage)",
      "CORS configuration review"
    ],
    "domain_8_security": [
      "Dependency vulnerability deep-dive (reachability analysis)",
      "Secret rotation audit",
      "Authentication flow audit (full login/logout/session/token/password flow)",
      "Data at rest encryption check",
      "Logging and monitoring for security events",
      "Third-party script audit (supply chain risk)"
    ],
    "domain_9_scripts": [
      "Script dependency graph (which scripts call others)",
      "Argument validation testing",
      "Error message quality review",
      "Script-to-package.json cross-reference (npm run targets exist?)",
      "Shebang/permissions audit",
      "Output format consistency check"
    ],
    "domain_10_hooks": [
      "Hook performance profiling (time per hook)",
      "Hook error recovery testing (does crash block workflow?)",
      "Hook interaction testing (conflicts on same state file)",
      "Event coverage audit (Claude Code events not hooked)",
      "Hook ordering dependencies"
    ],
    "domain_11_skills": [
      "Skill invocation testing (can /command resolve?)",
      "Skill frontmatter validation (required YAML sections)",
      "Skill version history audit",
      "Reference file audit (do all referenced files exist?)",
      "Skill duplication/overlap detection",
      "Skill documentation completeness (inputs/outputs/errors/related)",
      "Deprecated skill cleanup (find deprecated-but-present)"
    ],
    "domain_12_agents": [
      "Agent-to-tool mapping verification (tool lists accurate?)",
      "Agent prompt quality review (clear, non-contradictory, actionable)",
      "Agent naming consistency (filename vs internal name)",
      "Global vs local agent delineation logic check",
      "Agent test coverage (which agents never used?)"
    ],
    "domain_13_cicd": [
      "Workflow trigger overlap detection",
      "Workflow runtime estimation/optimization",
      "Branch protection rules alignment",
      "Artifact retention audit",
      "Workflow dependency chain (workflow_run)",
      "Self-hosted runner security (if applicable)",
      "Concurrency controls (concurrency groups)"
    ],
    "domain_14_docs": [
      "Broken internal link detection (relative path links)",
      "Code example validation (do examples actually work?)",
      "Screenshot/image freshness",
      "Terminology consistency across docs",
      "Onboarding path audit (test DEVELOPMENT.md steps from zero)",
      "Doc coverage mapping (code modules with NO docs)",
      "Version/date staleness (>30 days old check)"
    ],
    "domain_15_config": [
      "Config drift detection (.example vs actual divergence)",
      "Unused config entries (defined but unreferenced in code)",
      "Config documentation for complex options",
      "Environment-specific config differences (dev/staging/prod)",
      "Config file ownership clarity"
    ],
    "domain_16_tdms": [
      "TDMS item age analysis (open >30 days without triage)",
      "Source distribution analysis",
      "Category coverage analysis (zero-item categories)",
      "Effort estimation accuracy (actual vs estimated for resolved)",
      "TDMS-to-code file existence (do referenced files still exist?)",
      "Duplicate content detection (near-identical titles/descriptions)"
    ],
    "domain_17_roadmap": [
      "Sprint velocity analysis (items per sprint, trending)",
      "Orphaned roadmap items detection",
      "Milestone accuracy (planned dates vs actual delivery)",
      "Roadmap-to-TDMS bidirectional check"
    ],
    "domain_18_integration": [
      "Full deployment pipeline dry-run",
      "Skill-to-TDMS integration verification",
      "Hook-to-state file integrity verification",
      "MCP-to-TDMS pipeline test (SonarCloud -> sync -> MASTER_DEBT)",
      "Cross-system error propagation testing"
    ],
    "domain_19_eslint_plugin": [
      "False positive rate testing",
      "Autofix testing (do fixes produce valid code?)",
      "Performance impact benchmark (ESLint with/without plugin)",
      "Rule documentation audit"
    ],
    "domain_20_final_report": [
      "Executive summary with trends (if not first run)",
      "Heatmap visualization (directory/file finding hotspots)",
      "Risk assessment (likelihood + business impact)",
      "Time-to-fix estimation (hours by severity tier)",
      "Automated fix script generation (for AUTOFIX items)"
    ],
    "domain_21_post_test_audit": [
      "What worked: which domains ran smoothly, which tools performed well",
      "What didnt work: domain issues, unexpected failures",
      "Execution quality: finding accuracy, false positive rate",
      "Process improvements: skill improvements for next run",
      "Timing analysis: per-domain duration, bottleneck identification",
      "Coverage confidence: how confident we caught everything",
      "Tool effectiveness: which scripts/tools provided most value",
      "Recommendations: specific improvements",
      "Known gaps: what we explicitly couldnt test and why",
      "Full interactive review format (same as finding review)"
    ]
  },
  "compaction_guardrails": {
    "layer_1": "State file: .claude/state/system-test-state.json (run_id, domains_complete, findings_count, etc)",
    "layer_2": "Per-domain JSONL: docs/audits/system-test/run-YYYY-MM-DD/domain-NN-name.jsonl",
    "layer_3": "Checkpoint MD: docs/audits/system-test/run-YYYY-MM-DD/CHECKPOINT.md",
    "layer_4": "Review decisions: docs/audits/system-test/run-YYYY-MM-DD/REVIEW_DECISIONS.md",
    "recovery": "Check state file -> ask resume -> read CHECKPOINT.md -> skip completed domains"
  },
  "severity_calibration": {
    "S0": "Build fails, tests crash, security vulnerability, data loss risk",
    "S1": "Functionality broken, major misalignment, missing critical config",
    "S2": "Code smell, minor misalignment, outdated config, style issues",
    "S3": "Documentation, cosmetic, nice-to-have improvements"
  },
  "parallel_execution_waves": {
    "note": "Independent domains can run in parallel via subagents",
    "session_1": "Domains 0-5 are sequential (build must succeed before tests)",
    "session_2": "Domains 6+7 independent, Domain 8 depends on both",
    "session_3": "Domains 9+10+11+12 all independent",
    "session_4": "Domains 13+14+15+16+17 mostly independent (16+17 share TDMS data)",
    "session_5": "Domains 18+19 independent, 20+21 sequential at end"
  }
}
