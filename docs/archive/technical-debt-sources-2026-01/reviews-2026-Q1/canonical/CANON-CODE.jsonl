{"canonical_id":"CANON-0001","category":"Security","title":"App Check disabled on all production Cloud Functions","severity":"S0","effort":"E2","status":"CONFIRMED","final_confidence":100,"consensus_score":3,"sources":["claude-sonnet-4.5","claude-code"],"confirmations":2,"suspects":0,"files":["functions/src/index.ts"],"symbols":["saveDailyLog","saveJournalEntry","saveInventoryEntry","softDeleteJournalEntry"],"why_it_matters":"S0: Bot/device attestation layer is disabled for callable endpoints, increasing abuse/spam risk and weakening defense-in-depth.","suggested_fix":"Re-enable App Check (requireAppCheck: true) across functions; add monitoring for App Check failures and ensure client App Check init is working.","pr_bucket_suggestion":"security-hardening","dependencies":["CANON-0003"]}
{"canonical_id":"CANON-0002","category":"Security","title":"Legacy journalEntries collection allows direct client writes (bypasses function security posture)","severity":"S0","effort":"E2","status":"CONFIRMED","final_confidence":100,"consensus_score":3,"sources":["claude-sonnet-4.5","github-copilot"],"confirmations":2,"suspects":0,"files":["firestore.rules"],"symbols":["journalEntries"],"why_it_matters":"S0: Direct client writes bypass App Check / rate limiting / server-side validation, creating a high-risk security outlier vs other collections.","suggested_fix":"Migrate remaining data off legacy path and set allow write: if false (or route writes through Cloud Functions if still used).","pr_bucket_suggestion":"security-hardening","dependencies":[]}
{"canonical_id":"CANON-0003","category":"Hygiene/Duplication","title":"Console.* usage in app components bypasses standardized logger/sanitization","severity":"S1","effort":"E1","status":"CONFIRMED","final_confidence":100,"consensus_score":4,"sources":["claude-sonnet-4.5","jules","claude-code"],"confirmations":3,"suspects":0,"files":["lib/db/library.ts","lib/firestore-service.ts","components/notebook/journal-modal.tsx","components/notebook/pages/today-page.tsx","components/notebook/pages/library-page.tsx","lib/firebase.ts","components/growth/Step1WorksheetCard.tsx","components/admin/jobs-tab.tsx","components/admin/prayers-tab.tsx"],"symbols":["console.log","console.error","console.warn","initializeFirebase","TodayPage","Step1WorksheetCard","callCloudFunction","fetchQuickLinks","fetchPrayers"],"why_it_matters":"Raw console logging can leak sensitive details, creates inconsistent observability, and violates the project's documented logger/sanitization intent.","suggested_fix":"Replace console.* with logger.* (or a client-safe wrapper), then enforce via lint rule (no-console with exceptions for logger implementation).","pr_bucket_suggestion":"security-hardening","dependencies":["CANON-0023"]}
{"canonical_id":"CANON-0004","category":"Types/Correctness","title":"Cloud Function schema missing 'step-1-worksheet' journal entry type (validation drift / feature break)","severity":"S1","effort":"E0","status":"CONFIRMED","final_confidence":95,"consensus_score":3,"sources":["claude-sonnet-4.5","github-copilot"],"confirmations":2,"suspects":0,"files":["functions/src/schemas.ts","types/journal.ts"],"symbols":["journalEntrySchema","JournalEntryType"],"why_it_matters":"Users can create Step 1 worksheet entries client-side that fail server validation, breaking saves at runtime.","suggested_fix":"Add 'step-1-worksheet' to journalEntrySchema type enum in functions/src/schemas.ts.","pr_bucket_suggestion":"types-domain","dependencies":[]}
{"canonical_id":"CANON-0005","category":"Security","title":"Client App Check initialization is disabled/commented out","severity":"S1","effort":"E1","status":"CONFIRMED","final_confidence":85,"consensus_score":3,"sources":["codex","github-copilot"],"confirmations":2,"suspects":0,"files":["lib/firebase.ts"],"symbols":["initializeFirebase","_appCheck"],"why_it_matters":"Without client App Check init, tokens may not be sent, undermining verification and/or causing callable failures once functions enforce App Check.","suggested_fix":"Restore initializeAppCheck gated by configured site key; use debug tokens only in development.","pr_bucket_suggestion":"security-hardening","dependencies":[]}
{"canonical_id":"CANON-0006","category":"Hygiene/Duplication","title":"Cloud Function error handling duplicated (4 locations) + duplicate CloudFunctionError type definitions","severity":"S1","effort":"E1","status":"CONFIRMED","final_confidence":85,"consensus_score":3,"sources":["github-copilot","claude-code"],"confirmations":2,"suspects":0,"files":["lib/firestore-service.ts","hooks/use-journal.ts"],"symbols":["saveDailyLog","saveNotebookJournalEntry","addEntry","crumplePage","CloudFunctionError"],"why_it_matters":"Multiple copies of error mapping/code checks create drift risk and inconsistent user messaging; changes require editing several sites.","suggested_fix":"Extract CloudFunctionError type + handleCloudFunctionError() helper (likely in lib/utils/errors.ts) and use it in all locations.","pr_bucket_suggestion":"hooks-standardization","dependencies":[]}
{"canonical_id":"CANON-0007","category":"Hygiene/Duplication","title":"Critical logic divergence in journal saving (deprecated FirestoreService path bypasses hook business logic)","severity":"S1","effort":"E1","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["jules"],"confirmations":1,"suspects":0,"files":["lib/firestore-service.ts","hooks/use-journal.ts","components/growth/Step1WorksheetCard.tsx","components/notebook/pages/today-page.tsx"],"symbols":["FirestoreService.saveNotebookJournalEntry","useJournal.addEntry","generateSearchableText","generateTags"],"why_it_matters":"Entries saved through the deprecated service miss searchable metadata, breaking search/filter for those entries.","suggested_fix":"Refactor Step1WorksheetCard and TodayPage to use useJournal.addEntry; remove deprecated saveNotebookJournalEntry from FirestoreService.","pr_bucket_suggestion":"hooks-standardization","dependencies":["CANON-0007"]}
{"canonical_id":"CANON-0008","category":"Security","title":"reCAPTCHA verification is logged but not enforced when configured","severity":"S1","effort":"E1","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["codex"],"confirmations":1,"suspects":0,"files":["functions/src/security-wrapper.ts"],"symbols":["withSecurityChecks"],"why_it_matters":"Requests can bypass bot mitigation if missing tokens are allowed to proceed while only being logged.","suggested_fix":"When recaptchaAction is set, require a token (throw on missing/blank) unless an explicit opt-out is provided.","pr_bucket_suggestion":"security-hardening","dependencies":[]}
{"canonical_id":"CANON-0009","category":"Next/React Boundaries","title":"Server layout composes client providers; boundary should be explicit","severity":"S1","effort":"E1","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-sonnet-4.5"],"confirmations":1,"suspects":0,"files":["app/layout.tsx"],"symbols":["RootLayout"],"why_it_matters":"Boundary clarity and potential hydration/bundle concerns; explicit client-side providers wrapper is recommended.","suggested_fix":"Create app/providers.tsx ('use client') wrapping AuthProvider/CelebrationProvider/ErrorBoundary and import from layout.tsx.","pr_bucket_suggestion":"boundaries","dependencies":[]}
{"canonical_id":"CANON-0010","category":"Security","title":"Admin-claim Firestore rule writes lack function-only defense-in-depth","severity":"S1","effort":"E2","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-sonnet-4.5"],"confirmations":1,"suspects":0,"files":["firestore.rules"],"symbols":["isAdmin"],"why_it_matters":"If admin claims are compromised/misconfigured, direct writes expand blast radius without server-side auditing/enforcement.","suggested_fix":"Add Cloud Function wrappers for admin mutations with server-side checks + audit logging; tighten rules to function-only where appropriate.","pr_bucket_suggestion":"security-hardening","dependencies":[]}
{"canonical_id":"CANON-0011","category":"Testing","title":"Missing automated tests for Cloud Function security layers (App Check / rate limiting / authz)","severity":"S1","effort":"E2","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-sonnet-4.5"],"confirmations":1,"suspects":0,"files":["functions/src/index.ts","functions/src/security-wrapper.ts"],"symbols":["withSecurityChecks","saveDailyLog","saveJournalEntry"],"why_it_matters":"Security regressions can ship undetected without tests covering enforcement layers.","suggested_fix":"Add tests covering unauth rejection, rate-limit behavior, App Check pass/fail, user-scope enforcement, and reCAPTCHA behavior.","pr_bucket_suggestion":"tests-hardening","dependencies":["CANON-0001","CANON-0002"]}
{"canonical_id":"CANON-0012","category":"Testing","title":"No integration tests for Firestore rules (emulator-based)","severity":"S1","effort":"E2","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-sonnet-4.5"],"confirmations":1,"suspects":0,"files":["firestore.rules"],"symbols":[],"why_it_matters":"Rules are a primary security boundary; regressions can become data exposure incidents without automated tests.","suggested_fix":"Set up Firebase emulator rule tests using @firebase/rules-unit-testing for key permission scenarios (including legacy collections).","pr_bucket_suggestion":"tests-hardening","dependencies":["CANON-0002","CANON-0008"]}
{"canonical_id":"CANON-0013","category":"Testing","title":"Security-critical files have low test coverage (account-linking, firestore-service, recaptcha, users DB)","severity":"S1","effort":"E2","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-code"],"confirmations":1,"suspects":0,"files":["lib/auth/account-linking.ts","lib/firestore-service.ts","lib/recaptcha.ts","lib/db/users.ts"],"symbols":["linkEmailPassword","linkWithGoogle","saveDailyLog","getRecaptchaToken"],"why_it_matters":"Low coverage in auth/data/recaptcha paths increases risk of undetected production regressions in security-sensitive user flows.","suggested_fix":"Add tests to raise coverage targets for these files; mock Cloud Functions where needed; add token generation unit coverage.","pr_bucket_suggestion":"tests-hardening","dependencies":[]}
{"canonical_id":"CANON-0014","category":"Security","title":"reCAPTCHA verification coverage may be incomplete when App Check is disabled (needs verification)","severity":"S1","effort":"E1","status":"SUSPECTED","final_confidence":35,"consensus_score":1,"sources":["github-copilot"],"confirmations":0,"suspects":1,"files":["functions/src/index.ts","functions/src/recaptcha-verify.ts"],"symbols":["verifyRecaptcha","saveDailyLog","saveJournalEntry"],"why_it_matters":"If server-side verification is not enforced independently, bot mitigation may be weaker than intended when App Check is off.","suggested_fix":"Verify server-side recaptchaToken validation paths; consider making reCAPTCHA mandatory (align with CANON-0004).","pr_bucket_suggestion":"security-hardening","dependencies":["CANON-0004","CANON-0001"]}
{"canonical_id":"CANON-0015","category":"Security","title":"Potential rate limit bypass via cycling anonymous accounts (needs threat-model validation)","severity":"S1","effort":"E2","status":"SUSPECTED","final_confidence":35,"consensus_score":1,"sources":["claude-code"],"confirmations":0,"suspects":1,"files":["components/providers/auth-context.tsx","lib/auth/account-linking.ts"],"symbols":["ensureAnonymousSession","signInAnonymously"],"why_it_matters":"If rate limiting is keyed only by userId, attackers might bypass limits by creating new anonymous sessions repeatedly.","suggested_fix":"Validate feasibility; if real, add secondary rate limiting keyed by device/IP or strengthen anonymous auth constraints.","pr_bucket_suggestion":"security-hardening","dependencies":[]}
{"canonical_id":"CANON-0016","category":"Security","title":"Potential sensitive data in localStorage (needs audit)","severity":"S1","effort":"E2","status":"SUSPECTED","final_confidence":30,"consensus_score":1,"sources":["claude-sonnet-4.5"],"confirmations":0,"suspects":1,"files":[],"symbols":[],"why_it_matters":"If recovery/journal content is stored in localStorage, it persists unencrypted on-device and may raise privacy/compliance concerns.","suggested_fix":"Audit localStorage/sessionStorage usage; restrict to non-sensitive UI prefs; document policy.","pr_bucket_suggestion":"security-hardening","dependencies":[]}
{"canonical_id":"CANON-0017","category":"Hygiene/Duplication","title":"Duplicated time-of-day rotation logic for quotes and slogans","severity":"S2","effort":"E1","status":"CONFIRMED","final_confidence":85,"consensus_score":3,"sources":["codex","github-copilot"],"confirmations":2,"suspects":0,"files":["lib/db/quotes.ts","lib/db/slogans.ts"],"symbols":["QuotesService.getQuoteForNow","SlogansService.getSloganForNow","getTimeOfDay","getQuoteForNow","getSloganForNow"],"why_it_matters":"Rotation changes risk diverging behavior and duplicating bug fixes.","suggested_fix":"Extract shared rotation utilities and reuse in both services; add unit tests for schedule/rotation paths.","pr_bucket_suggestion":"ui-primitives","dependencies":[]}
{"canonical_id":"CANON-0018","category":"Types/Correctness","title":"Unsafe type assertions with 'as unknown as' (worksheet + related components)","severity":"S2","effort":"E1","status":"CONFIRMED","final_confidence":85,"consensus_score":3,"sources":["jules","claude-code"],"confirmations":2,"suspects":0,"files":["components/growth/Step1WorksheetCard.tsx","components/journal/entry-detail-dialog.tsx","components/maps/meeting-map.tsx"],"symbols":["Step1WorksheetCard","Step1Data","entry-detail-dialog","meeting-map"],"why_it_matters":"Double casts bypass TypeScript safety; runtime crashes possible if data shape differs.","suggested_fix":"Add runtime validation (e.g., Zod parse) before casting; replace with type guards where applicable.","pr_bucket_suggestion":"types-domain","dependencies":["CANON-0007"]}
{"canonical_id":"CANON-0019","category":"Security","title":"ESLint security plugin warnings in scripts (unsafe regex / non-literal fs / object injection patterns)","severity":"S2","effort":"E2","status":"CONFIRMED","final_confidence":85,"consensus_score":3,"sources":["jules","claude-code"],"confirmations":2,"suspects":0,"files":["scripts/check-review-needed.js","scripts/suggest-pattern-automation.js","scripts/validate-phase-completion.js","scripts/check-pattern-compliance.js","scripts/update-readme-status.js"],"symbols":["detectUnsafeRegex","detectNonLiteralFs","detectObjectInjection"],"why_it_matters":"Even if scripts run in trusted contexts, these patterns are repeatedly flagged and can become risky if reused; they also create noisy lint output.","suggested_fix":"Address highest-risk warnings first: validate dynamic paths, constrain object key access, simplify/guard regex patterns; aim to reduce warnings materially.","pr_bucket_suggestion":"security-hardening","dependencies":[]}
{"canonical_id":"CANON-0020","category":"Hygiene/Duplication","title":"Journal entry type definitions duplicated across client types and server schemas (single-source refactor)","severity":"S2","effort":"E2","status":"CONFIRMED","final_confidence":85,"consensus_score":3,"sources":["claude-sonnet-4.5","github-copilot"],"confirmations":2,"suspects":0,"files":["types/journal.ts","functions/src/schemas.ts"],"symbols":["JournalEntryType","journalEntrySchema"],"why_it_matters":"Adding new entry types requires multi-file changes and risks client/server mismatch.","suggested_fix":"Extract shared constants (or generate TS types from Zod) so both client and functions import from one source.","pr_bucket_suggestion":"types-domain","dependencies":["CANON-0007"]}
{"canonical_id":"CANON-0021","category":"Types/Correctness","title":"Missing error.message null safety in TodayPage catch block","severity":"S2","effort":"E0","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-sonnet-4.5"],"confirmations":1,"suspects":0,"files":["components/notebook/pages/today-page.tsx"],"symbols":["handleSave"],"why_it_matters":"If a non-Error is thrown, accessing error.message/stack can crash; catch is unknown.","suggested_fix":"Use getErrorMessage(error) helper to safely extract message.","pr_bucket_suggestion":"types-domain","dependencies":[]}
{"canonical_id":"CANON-0022","category":"Types/Correctness","title":"Unsafe localStorage JSON.parse in use-smart-prompts hook","severity":"S2","effort":"E0","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["jules"],"confirmations":1,"suspects":0,"files":["components/notebook/hooks/use-smart-prompts.ts"],"symbols":["useSmartPrompts"],"why_it_matters":"Corrupted localStorage can throw and crash the component.","suggested_fix":"Wrap JSON.parse in try/catch or use a safe parse utility with defaults.","pr_bucket_suggestion":"types-domain","dependencies":[]}
{"canonical_id":"CANON-0023","category":"Hygiene/Duplication","title":"Duplicated DailyQuoteCard component exists in multiple directories (2 confirmed; possible 3rd variant)","severity":"S2","effort":"E1","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-sonnet-4.5"],"confirmations":1,"suspects":0,"files":["components/notebook/features/daily-quote-card.tsx","components/widgets/daily-quote-card.tsx","components/widgets/compact-daily-quote.tsx"],"symbols":["DailyQuoteCard","CompactDailyQuote"],"why_it_matters":"Duplication increases maintenance burden; inconsistent exports/variants raise drift risk.","suggested_fix":"Consolidate to a single source of truth (auditor suggests keeping widgets version) and compose variants if needed.","pr_bucket_suggestion":"ui-primitives","dependencies":[]}
{"canonical_id":"CANON-0024","category":"Hygiene/Duplication","title":"Inconsistent Firebase Functions import pattern (static vs dynamic imports)","severity":"S2","effort":"E1","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-code"],"confirmations":1,"suspects":0,"files":["lib/firestore-service.ts","hooks/use-journal.ts","lib/auth/account-linking.ts","components/admin/jobs-tab.tsx","components/admin/errors-tab.tsx","components/admin/dashboard-tab.tsx"],"symbols":["getFunctions","httpsCallable"],"why_it_matters":"Inconsistent patterns increase maintenance burden and make bundling/code-splitting intent unclear.","suggested_fix":"Standardize import strategy (e.g., static imports for client-side code; reserve dynamic imports for specific lazy routes if intentionally needed).","pr_bucket_suggestion":"firebase-access","dependencies":[]}
{"canonical_id":"CANON-0025","category":"Types/Correctness","title":"Inconsistent httpsCallable typing (missing generic request/response types)","severity":"S2","effort":"E1","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-sonnet-4.5"],"confirmations":1,"suspects":0,"files":["lib/firestore-service.ts"],"symbols":["callCloudFunction"],"why_it_matters":"Callable returns unknown, forcing casts and losing compile-time safety.","suggested_fix":"Add generic type parameters to callCloudFunction / httpsCallable usage.","pr_bucket_suggestion":"types-domain","dependencies":[]}
{"canonical_id":"CANON-0026","category":"Next/React Boundaries","title":"useJournal sets up its own auth listener instead of using shared auth context","severity":"S2","effort":"E1","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["github-copilot"],"confirmations":1,"suspects":0,"files":["hooks/use-journal.ts","components/providers/auth-provider.tsx"],"symbols":["useJournal","auth.onAuthStateChanged"],"why_it_matters":"Redundant subscriptions can cause state-sync issues and unnecessary listeners.","suggested_fix":"Refactor useJournal to consume user from auth context (or accept user as param) and remove internal onAuthStateChanged listener.","pr_bucket_suggestion":"boundaries","dependencies":["CANON-0006"]}
{"canonical_id":"CANON-0027","category":"Testing","title":"Cloud Function integration test is skipped in firestore-service test suite","severity":"S2","effort":"E2","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["github-copilot"],"confirmations":1,"suspects":0,"files":["tests/firestore-service.test.ts"],"symbols":["saveDailyLog test"],"why_it_matters":"Primary data save path is effectively untested; skip note indicates missing integration harness/emulator setup.","suggested_fix":"Add an integration test suite using Firebase emulator; optionally mock httpsCallable for unit coverage.","pr_bucket_suggestion":"tests-hardening","dependencies":[]}
{"canonical_id":"CANON-0028","category":"Types/Correctness","title":"Journal entry schema data is weakly typed (z.record unknown; per-type validation not enforced)","severity":"S2","effort":"E2","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["github-copilot"],"confirmations":1,"suspects":0,"files":["functions/src/schemas.ts"],"symbols":["journalEntrySchema"],"why_it_matters":"Malformed entries can pass validation; intended per-type validation is not enforced.","suggested_fix":"Use a Zod discriminated union for per-entry-type data schemas.","pr_bucket_suggestion":"types-domain","dependencies":["CANON-0016"]}
{"canonical_id":"CANON-0029","category":"Testing","title":"No tests for useJournal hook","severity":"S2","effort":"E2","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["github-copilot"],"confirmations":1,"suspects":0,"files":["hooks/use-journal.ts"],"symbols":["useJournal","addEntry","crumplePage"],"why_it_matters":"Core journal interaction logic lacks dedicated tests; regressions can break journaling flows.","suggested_fix":"Add tests for useJournal with mocked Firebase/Cloud Functions covering auth changes, addEntry, and crumplePage.","pr_bucket_suggestion":"tests-hardening","dependencies":["CANON-0006"]}
{"canonical_id":"CANON-0030","category":"Types/Correctness","title":"@ts-expect-error suppression comment in production code","severity":"S3","effort":"E0","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-code"],"confirmations":1,"suspects":0,"files":["components/notebook/pages/resources-page.tsx"],"symbols":["setGenderFilter"],"why_it_matters":"Suppresses type checking and can hide real mismatches; should be replaced with proper typing or a type guard.","suggested_fix":"Fix type annotation or add explicit narrowing so the call is type-safe without suppression.","pr_bucket_suggestion":"types-domain","dependencies":[]}
{"canonical_id":"CANON-0031","category":"Next/React Boundaries","title":"Environment variables accessed directly in components (centralize in typed config)","severity":"S3","effort":"E0","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["jules"],"confirmations":1,"suspects":0,"files":["app/layout.tsx"],"symbols":["process.env"],"why_it_matters":"Harder to track and type-check configuration dependencies across components.","suggested_fix":"Move env access to a config module exporting typed constants.","pr_bucket_suggestion":"boundaries","dependencies":[]}
{"canonical_id":"CANON-0032","category":"Types/Correctness","title":"'any' types leaking into production code (needs tightening)","severity":"S3","effort":"E1","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["claude-code"],"confirmations":1,"suspects":0,"files":["lib/sentry.client.ts","components/admin/meetings-tab.tsx","functions/src/admin.ts","tests/firestore-service.test.ts"],"symbols":["any"],"why_it_matters":"Use of any reduces type safety; in production files it can mask real issues.","suggested_fix":"Replace production any with unknown + type guards or concrete types; allow any only in tests/mocks if necessary.","pr_bucket_suggestion":"types-domain","dependencies":[]}
{"canonical_id":"CANON-0033","category":"Next/React Boundaries","title":"Landing page forced to client component for top-level state","severity":"S3","effort":"E1","status":"CONFIRMED","final_confidence":60,"consensus_score":1,"sources":["jules"],"confirmations":1,"suspects":0,"files":["app/page.tsx"],"symbols":["Home","useState"],"why_it_matters":"Forces full landing page client rendering, potentially affecting FCP/bundle size.","suggested_fix":"Move stateful logic into a small client wrapper; keep app/page.tsx server-rendered where possible.","pr_bucket_suggestion":"boundaries","dependencies":[]}
