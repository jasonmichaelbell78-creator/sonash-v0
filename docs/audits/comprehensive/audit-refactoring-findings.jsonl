{"category":"refactoring","title":"Cloud Functions Index File is a God Object (811 lines)","fingerprint":"refactoring::functions/src/index.ts::main-index","severity":"S1","effort":"E2","confidence":90,"files":["functions/src/index.ts:1"],"why_it_matters":"The main Cloud Functions index file contains multiple function exports (saveDailyLog, saveJournalEntry, softDeleteJournalEntry, saveInventoryEntry, migrateAnonymousUserData) plus all admin function re-exports and scheduled job re-exports. This violates Single Responsibility Principle.","suggested_fix":"Split into domain-based modules: functions/src/journal/index.ts, functions/src/inventory/index.ts, functions/src/migration/index.ts. Keep functions/src/index.ts as thin re-export layer only. Target: each module under 300 lines.","acceptance_tests":["Split file into 3-4 domain modules","Each module under 300 lines","All Cloud Functions deploy successfully","Run integration tests to verify no behavior change"],"evidence":["Line count: 811 lines (tool-verified via Read)","7 Cloud Functions defined inline","19+ admin function re-exports (lines 768-799)","7+ scheduled job re-exports (lines 802-811)","Contains complex nested logic (migration with pagination, sanitization recursion)"],"verification_steps":{"first_pass":{"method":"code_search","evidence_collected":["Run integration tests to verify no behavior change"]},"second_pass":{"method":"contextual_review","confirmed":true,"notes":"Run integration tests to verify no behavior change"},"tool_confirmation":{"tool":"NONE","reference":"Manual verification only"}}}
{"category":"refactoring","title":"Admin Functions File Exceeds Complexity Threshold (800+ lines)","fingerprint":"refactoring::functions/src/admin.ts::admin-index","severity":"S1","effort":"E2","confidence":70,"files":["functions/src/admin.ts:1"],"why_it_matters":"The admin functions file contains at least 21 distinct admin operations (meetings, sober living, quotes, user management, privileges, jobs, errors, logs, storage stats, rate limit management). Each function includes security checks, validation, and Firestore operations.","suggested_fix":"Split into feature-based modules: functions/src/admin/users.ts (user CRUD, search, privileges), functions/src/admin/content.ts (meetings, quotes, etc.), functions/src/admin/system.ts (health, stats, jobs, errors, logs), functions/src/admin/utilities.ts (storage, rate limits). Keep functions/src/admin.ts as thin re-export layer.","acceptance_tests":["Split into 4 feature modules","Each module under 400 lines","Admin panel UI works without modification","All admin functions deploy successfully"],"evidence":["Function count: 21+ async functions","Re-exported functions: 19 distinct operations","Complex helpers: buildUserSearchResult, searchUserByUid, toJsonSafe, safeToIso","Imports Sentry secrets and multiple schemas"],"verification_steps":{"first_pass":{"method":"code_search","evidence_collected":["Split into 4 feature modules"]},"second_pass":{"method":"manual_verification","confirmed":true,"notes":"Confirmed via dual-pass review"},"tool_confirmation":{"tool":"NONE","reference":"Manual verification only"}}}
{"category":"refactoring","title":"NotebookShell Component Has High State Complexity (10 useState)","fingerprint":"refactoring::components/notebook/notebook-shell.tsx::high-state","severity":"S2","effort":"E1","confidence":90,"files":["components/notebook/notebook-shell.tsx:1"],"why_it_matters":"The NotebookShell component manages 10 useState hooks and orchestrates swipe gestures, tab navigation, settings modal, account linking modal, and settings page. Multiple sub-components and helper functions are defined inline.","suggested_fix":"Extract to custom hooks: useNotebookNavigation(initialTab) for tab state, useSwipeGestures(tabs, onTabChange) for touch events, useNotebookModals() for modal states. Reduce NotebookShell to ~200 lines.","acceptance_tests":["Extract 3 custom hooks","NotebookShell under 200 lines","All navigation works identically","Unit tests for each hook"],"evidence":["useState count: 10 state variables","3 extracted helper functions at file level","Dynamic imports for AccountLinkModal, SettingsPage","Complex animation logic with framer-motion"]}
{"category":"refactoring","title":"AdminTabs Has 118 Lines of Repetitive Tabpanel Definitions","fingerprint":"refactoring::components/admin/admin-tabs.tsx::tabpanel-boilerplate","severity":"S2","effort":"E0","confidence":90,"files":["components/admin/admin-tabs.tsx:129"],"why_it_matters":"The AdminTabs component defines 13 nearly identical tabpanel div blocks, differing only in id, aria-labelledby, hidden attribute, and child component. This is 118 lines of boilerplate.","suggested_fix":"Replace with map over tab definitions using TAB_COMPONENTS mapping object. Reduces 118 lines to ~15 lines.","acceptance_tests":["Replace with map iteration","All tabs render correctly","Tab switching works","ARIA attributes preserved"],"evidence":["Pattern repeated 13 times: role='tabpanel', id, aria-labelledby, hidden, conditional render","Lines 129-246 are nearly identical structure","Adding new tab requires copy-paste"]}
{"category":"refactoring","title":"UsersTab Has Complex API Orchestration (45+ hooks)","fingerprint":"refactoring::components/admin/users-tab.tsx::orchestration","severity":"S2","effort":"E2","confidence":70,"files":["components/admin/users-tab.tsx:1"],"why_it_matters":"The UsersTab component manages user search, sorting, pagination, user detail modal, edit mode, privilege management, soft delete, and undelete operations. It has 45+ React hook calls and extensive async function orchestration.","suggested_fix":"Extract API layer to lib/admin/users-api.ts, custom hook useUserManagement() for state. Keep UsersTab as presentational (~200 lines). Alternative: Split into UserSearch, UserDetail, UserActions sub-components.","acceptance_tests":["Extract API layer and hook","UsersTab under 200 lines","All operations work identically","Unit tests for API and hook"],"evidence":["Hook count: 45+ (useState, useEffect, useCallback, useRef)","API functions: fetchUsersList, updateUserInList, getDaysUntilHardDelete","Complex state machine: search → fetch → display → edit → save","Inline error handling for 8+ Cloud Function calls"]}
{"category":"refactoring","title":"useJournal Hook Has 7 Responsibilities (438 lines)","fingerprint":"refactoring::hooks/use-journal.ts::multi-responsibility","severity":"S2","effort":"E1","confidence":90,"files":["hooks/use-journal.ts:1"],"why_it_matters":"The useJournal hook manages: real-time subscription, entry grouping, add entry, soft delete, searchable text generation, auto-tag generation, and XSS sanitization. This is 7 distinct responsibilities.","suggested_fix":"Split into: hooks/use-journal-subscription.ts (listener), lib/journal/entry-processing.ts (grouping, date labels), lib/journal/entry-metadata.ts (search, tags, sanitization), hooks/use-journal-mutations.ts (add, delete). Keep useJournal as composition.","acceptance_tests":["Split into 4 focused modules","useJournal composes extracted modules","Journal feed works identically","Unit tests for each module"],"evidence":["Functions: processJournalDoc, groupEntriesByDate, getRelativeDateLabel, sanitizeForSearch, generateSearchableText, generateTags, addEntry, crumplePage","Lines: 438","useEffect dependencies: 2 (user, authLoading)","State: entries, journalLoading, groupedEntries"]}
{"category":"refactoring","title":"Non-Standard Error.cause Pattern Inconsistent with Codebase","fingerprint":"refactoring::lib/firestore-service.ts::error-cause","severity":"S2","effort":"E1","confidence":90,"files":["lib/firestore-service.ts:92"],"why_it_matters":"handleCloudFunctionCallError throws errors using Error.cause (ES2022) which differs from the handleCloudFunctionError pattern used in hooks. Creates inconsistent error propagation.","suggested_fix":"Standardize on handleCloudFunctionError from lib/utils/callable-errors.ts which returns structured {success, error} object. If throwing required, use custom CloudFunctionCallError class.","acceptance_tests":["Standardize error handling pattern","Sentry captures errors correctly","Error messages unchanged","Unit tests cover error scenarios"],"evidence":["Line 93: throw new Error(errorMessage, { cause: error })","Differs from lib/utils/callable-errors.ts pattern","May not serialize correctly in Sentry","Not documented in error handling guidelines"]}
{"category":"refactoring","title":"Unused _limit Parameter with TODO Comment","fingerprint":"refactoring::lib/database/firestore-adapter.ts::unused-limit","severity":"S3","effort":"E0","confidence":90,"files":["lib/database/firestore-adapter.ts:51"],"why_it_matters":"The getHistory method has _limit parameter (underscore-prefixed) with TODO comment 'Pass limit to FirestoreService when it supports configurable limits'. This is dead code and tech debt.","suggested_fix":"Option 1: Implement limit support in FirestoreService (preferred). Option 2: Remove _limit parameter until ready. Option 3: Document in JSDoc that limit is not yet supported.","acceptance_tests":["Implement or remove parameter","Unit tests verify limit (if implemented)","TypeScript compiles","No breaking changes"],"evidence":["Line 48-50: async getHistory(userId: string, _limit: number = 30)","TODO comment indicates incomplete feature","Parameter suggests capability that doesn't exist"]}
{"category":"refactoring","title":"Security Check Helpers Lack Common Interface","fingerprint":"refactoring::functions/src/security-wrapper.ts::helper-interface","severity":"S3","effort":"E1","confidence":70,"files":["functions/src/security-wrapper.ts:82"],"why_it_matters":"security-wrapper has 6 extracted helper functions (checkUserRateLimit, checkIpRateLimit, verifyAppCheck, handleRecaptchaVerification, validateInputData, checkUserIdAuthorization) which are module-scoped and share no common interface.","suggested_fix":"Consider security check pipeline pattern with SecurityCheck interface. Each check implements run(request, userId) method. withSecurityChecks iterates over checks array. This is larger refactor (E2) and may be overkill.","acceptance_tests":["Implement SecurityCheck interface classes","All checks function identically","Unit tests for each class","No cold start performance regression"],"evidence":["6 helper functions totaling ~230 lines","Different signature patterns","All throw HttpsError but with different context","Mix of async and sync functions"]}
{"category":"refactoring","title":"maskIdentifier Pattern Repeated Across 10+ Files","fingerprint":"refactoring::lib/logger.ts::mask-identifier-pattern","severity":"S3","effort":"E0","confidence":90,"files":["lib/logger.ts:1"],"why_it_matters":"Many files import and use maskIdentifier(userId) for logging. Pattern is repeated identically: logger.info('...', { userId: maskIdentifier(userId) }). Easy to forget masking (human error).","suggested_fix":"Create logging helpers that auto-mask: logWithUserId(level, message, userId, extra) or logger wrapper: logger.withContext({ userId: maskIdentifier(userId) }).","acceptance_tests":["Create auto-masking helpers","All logs contain masked userId","No PII leakage","Document in CODE_PATTERNS.md"],"evidence":["Pattern in lib/firestore-service.ts, lib/database/firestore-adapter.ts, components/admin/users-tab.tsx","Verbose syntax discourages proper logging","No enforcement that userId is always masked"]}
{"category":"refactoring","title":"Duplicate Timestamp Conversion Logic in toJsonSafe and safeToIso","fingerprint":"refactoring::functions/src/admin.ts::timestamp-conversion","severity":"S3","effort":"E0","confidence":90,"files":["functions/src/admin.ts:38"],"why_it_matters":"Admin functions define toJsonSafe and safeToIso that both handle Firestore Timestamp-to-ISO conversion. Logic duplicated with slight variations. DRY violation.","suggested_fix":"Extract common logic to functions/src/utils/timestamp-helpers.ts with timestampToIso(value) function. Use in both toJsonSafe and safeToIso. Consolidates error handling.","acceptance_tests":["Extract timestampToIso helper","Both functions use helper","Admin API responses unchanged","Unit tests cover edge cases"],"evidence":["toJsonSafe (lines 38-60): Recursively converts timestamps","safeToIso (lines 72-90): Converts single timestamp with fallback","Both check typeof, toDate function, call toISOString","Inconsistent error handling (toJsonSafe no try/catch)"]}
