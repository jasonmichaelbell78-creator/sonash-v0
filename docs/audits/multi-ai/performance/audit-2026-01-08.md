# Multi-AI Performance Audit Report

**Audit Date:** 2026-01-08 **Audit Type:** Multi-AI Aggregated **Session:** #37
**Status:** COMPLETED

---

## Purpose

This document reports performance audit findings aggregated from 5 AI models.
It identifies performance bottlenecks, bundle size issues, and optimization
opportunities for the SoNash application.

## Version History

| Version | Date       | Changes                         |
| ------- | ---------- | ------------------------------- |
| 1.0     | 2026-01-08 | Initial multi-AI audit findings |

---

## Executive Summary

This performance audit aggregated findings from 5 AI models analyzing the SoNash
Recovery Notebook codebase. The audit identified **28 canonical findings**
across 7 categories, with **1 Critical (S0)**, **7 High (S1)**, **17 Medium
(S2)**, and **3 Low (S3)** severity issues.

### AI Models Participating

| Model                | Measurement Tool    | Environment |
| -------------------- | ------------------- | ----------- |
| Copilot              | Lighthouse          | Production  |
| Claude Sonnet 4.5    | Code Analysis       | N/A         |
| Codex                | Custom              | Production  |
| Claude Code Opus 4.5 | Next Build Analysis | Production  |
| ChatGPT 5.2 Thinking | Custom              | Production  |

---

## Baseline Metrics

| Metric      | Value            | Notes                                                     |
| ----------- | ---------------- | --------------------------------------------------------- |
| Bundle Size | 2,373 - 2,764 KB | Two measurement methods (JS chunks vs total .next/static) |
| Build Time  | 7.8s             | Measured by Opus 4.5                                      |
| LCP         | Not measured     | Needs Lighthouse baseline                                 |
| CLS         | Not measured     | Needs Lighthouse baseline                                 |
| INP/FID     | Not measured     | Needs Lighthouse baseline                                 |

**Recommended Next Steps:**

1. Run Lighthouse mobile+desktop and record LCP/CLS/INP baselines
2. Standardize bundle metric measurement method

---

## Findings Summary

### By Severity

| Severity      | Count | Categories                              |
| ------------- | ----- | --------------------------------------- |
| S0 (Critical) | 1     | Memory Management                       |
| S1 (High)     | 7     | Bundle Size, Rendering, Core Web Vitals |
| S2 (Medium)   | 17    | Data Fetching, Rendering, Observability |
| S3 (Low)      | 3     | Observability, Memory, Bundle           |

### By Category

| Category                   | Count | Severity Range |
| -------------------------- | ----- | -------------- |
| Bundle Size & Loading      | 8     | S1-S3          |
| Data Fetching & Caching    | 6     | S2             |
| Rendering Performance      | 5     | S1-S3          |
| Core Web Vitals            | 3     | S2             |
| Observability & Monitoring | 4     | S2-S3          |
| Memory Management          | 2     | S0, S3         |

---

## Critical Findings (S0)

### PERF-001: useJournal snapshot lifecycle leak

**Files:** `hooks/use-journal.ts` **Confidence:** 85% **Sources:** ChatGPT 5.2
Thinking, Claude Sonnet 4.5

**Issue:** Firestore listener lifecycle is unsafe - onSnapshot unsubscribe
returned inside onAuthStateChanged callback may be ignored, causing listener
leaks.

**Recommendation:** Own onSnapshot unsubscribe in the useEffect scope and invoke
it on unmount and user switch; do not rely on returning cleanup from inside
onAuthStateChanged callbacks.

**Success Check:** Navigate away/back repeatedly; verify only one active journal
listener and no duplicate updates.

---

## High Priority Findings (S1)

### PERF-003: TodayPage resubscribe storm

- **File:** `components/notebook/pages/today-page.tsx`
- Real-time listener re-subscribes on every keystroke due to journalEntry in
  useEffect deps
- **Fix:** Key listener effect only by (user, referenceDate)

### PERF-004: Landing page client-side bundle

- **Files:** `app/page.tsx`, `components/notebook/notebook-shell.tsx`
- Landing page eagerly imports NotebookShell + framer-motion
- **Fix:** Dynamic import NotebookShell; split notebook pages per tab

### PERF-005: Large bundle without code splitting

- Heavy libraries (Firebase, Framer, Leaflet) not route-split
- **Fix:** Enforce route-level code splitting

### PERF-007: Static export disables image optimization

- **File:** `next.config.mjs`
- images.unoptimized=true prevents Next.js optimization
- **Fix:** Implement static-friendly responsive image pipeline

### PERF-008: Excessive 'use client' usage

- Too many client components inflate bundle
- **Fix:** Audit directives; convert eligible to Server Components

### PERF-009: Step1WorksheetCard lacks memoization

- **File:** `components/growth/Step1WorksheetCard.tsx`
- Large component with minimal memoization causing re-renders
- **Fix:** Split into smaller memoized subcomponents

---

## Optimization Plan (Priority Order)

| Priority | IDs                     | Impact | Effort | Action                                          |
| -------- | ----------------------- | ------ | ------ | ----------------------------------------------- |
| 1        | PERF-001                | S0     | E1     | Fix useJournal snapshot lifecycle               |
| 2        | PERF-016                | S2     | E0     | Remove/gate console.\* statements               |
| 3        | PERF-003                | S1     | E1     | Fix TodayPage effect deps                       |
| 4        | PERF-002                | S2     | E1     | Remove redundant auth listener                  |
| 5        | PERF-017, 023           | S2     | E1     | Gate reCAPTCHA + server-side soft-delete filter |
| 6        | PERF-018-020, 027       | S2-S3  | E0-E1  | Wire Sentry + Web Vitals                        |
| 7        | PERF-004, 024, 005      | S1-S2  | E2     | Code-split landing/notebook                     |
| 8        | PERF-012, 022           | S2     | E1-E2  | Fix quote reads + add caching layer             |
| 9        | PERF-010, 011, 025      | S2-S3  | E1-E2  | Virtualize entry list + pagination              |
| 10       | PERF-006, 007           | S1-S2  | E1     | Image optimization pipeline                     |
| 11       | PERF-013-015            | S2     | E2     | Admin pagination, map clustering, confetti      |
| 12       | PERF-009, 008, 026, 028 | S1-S3  | E1-E3  | Component splitting, cleanup audit              |

---

## Key Recommendations

### Immediate Actions (This Week)

1. **Fix useJournal lifecycle (PERF-001)** - S0 critical, potential memory leak
2. **Fix TodayPage resubscribe (PERF-003)** - S1 user-facing input
   responsiveness
3. **Remove console statements (PERF-016)** - S2 but trivial effort

### Short-term Actions (Next Sprint)

4. **Code-split landing page** - Biggest initial-load lever
5. **Wire Sentry + Web Vitals** - Enable measurement before further optimization
6. **Reduce Firestore overreads** - Quote collection, soft-delete filtering

### Medium-term Actions (Future Sprints)

7. **Virtualize entry lists** - Improves scroll performance at scale
8. **Image optimization pipeline** - Static export constraints require custom
   solution
9. **Reduce 'use client' footprint** - E3 effort but significant bundle impact

---

## Files Referenced

### Critical Path Files

- `hooks/use-journal.ts` - PERF-001, 002, 011, 022, 023
- `components/notebook/pages/today-page.tsx` - PERF-003
- `app/page.tsx` - PERF-004, 006, 021
- `next.config.mjs` - PERF-005, 006, 007

### Secondary Files

- `components/notebook/notebook-shell.tsx`
- `components/notebook/roadmap-modules.tsx`
- `components/journal/entry-feed.tsx`
- `lib/db/quotes.ts`
- `lib/sentry.client.ts`
- `app/layout.tsx`

---

## Audit Artifacts

| Artifact          | Location                                                             |
| ----------------- | -------------------------------------------------------------------- |
| JSONL Findings    | `docs/audits/multi-ai/performance/audit-2026-01-08.jsonl`            |
| Metrics JSON      | `docs/audits/multi-ai/performance/metrics-2026-01-08.json`           |
| Optimization Plan | `docs/audits/multi-ai/performance/optimization-plan-2026-01-08.json` |
| This Report       | `docs/audits/multi-ai/performance/audit-2026-01-08.md`               |

---

## Next Steps

1. Address PERF-001 (S0) immediately
2. Establish Lighthouse baselines for Core Web Vitals
3. Begin priority 1-6 fixes in optimization plan
4. Re-measure after each batch of fixes to validate improvements

---

**Audit Completed By:** Multi-AI Aggregation (Copilot, Claude Sonnet 4.5, Codex,
Claude Code Opus 4.5, ChatGPT 5.2 Thinking) **Report Generated:** 2026-01-08
