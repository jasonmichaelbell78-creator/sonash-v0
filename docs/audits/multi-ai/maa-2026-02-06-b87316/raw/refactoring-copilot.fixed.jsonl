{"category":"Hygiene/Duplication","title":"Cloud Function call boilerplate not migrated to callSecureFunction()","fingerprint":"Hygiene/Duplication::lib/firestore-service.ts::saveDailyLog::cf-call-boilerplate-not-migrated","severity":"S1","effort":"E2","confidence":95,"files":["lib/firestore-service.ts","hooks/use-journal.ts","lib/auth/account-linking.ts","lib/utils/secure-caller.ts"],"symbols":["saveDailyLog","saveInventoryEntry","saveNotebookJournalEntry","addEntry","crumplePage","linkEmailPassword","linkWithGoogle","callSecureFunction"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"7+ call sites repeat the same 4-step pattern: getRecaptchaToken -> dynamic import firebase/functions -> getFunctions()/httpsCallable() -> retryCloudFunction(). The canonical wrapper callSecureFunction() already exists in lib/utils/secure-caller.ts but is unused.","instances":[{"file":"lib/firestore-service.ts","symbol":"saveDailyLog"},{"file":"lib/firestore-service.ts","symbol":"saveInventoryEntry"},{"file":"lib/firestore-service.ts","symbol":"saveNotebookJournalEntry"},{"file":"hooks/use-journal.ts","symbol":"addEntry"},{"file":"hooks/use-journal.ts","symbol":"crumplePage"},{"file":"lib/auth/account-linking.ts","symbol":"linkEmailPassword"},{"file":"lib/auth/account-linking.ts","symbol":"linkWithGoogle"}],"consolidation_target":"lib/utils/secure-caller.ts (callSecureFunction)"},"why_it_matters":"The consolidation target already exists but isn't adopted. Every new Cloud Function call copies the boilerplate pattern instead of using the wrapper, compounding inconsistency and making reCAPTCHA/retry behavior changes require 7+ edits.","suggested_fix":"Migrate all 7 call sites to use callSecureFunction() or createSecureFunctionCaller() from lib/utils/secure-caller.ts. Remove inline dynamic imports of firebase/functions.","acceptance_tests":["npm run lint","npm test","All Cloud Function operations still work end-to-end"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["lib/firestore-service.ts: dynamic import 'firebase/functions' at lines ~188, ~378, ~434","hooks/use-journal.ts: getFunctions()/httpsCallable() at lines ~352, ~402","lib/auth/account-linking.ts: dynamic import 'firebase/functions' at lines ~213, ~335","lib/utils/secure-caller.ts: callSecureFunction() defined but 0 import references in production code"],"notes":"CANON-0076 from prior audits. The secure-caller.ts was created as the fix but adoption was never completed."}
{"category":"Hygiene/Duplication","title":"CRUD boilerplate duplicated across 5+ lib/db/ services","fingerprint":"Hygiene/Duplication::lib/db/quotes.ts::QuotesService::crud-boilerplate-dup","severity":"S2","effort":"E2","confidence":85,"files":["lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts","lib/db/glossary.ts","lib/db/library.ts"],"symbols":["QuotesService","SlogansService"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Each lib/db/ service reimplements getAll/add/update/delete with identical collection/getDocs/addDoc/updateDoc/deleteDoc patterns. Only collection name and type differ.","instances":[{"file":"lib/db/quotes.ts","symbol":"QuotesService"},{"file":"lib/db/slogans.ts","symbol":"SlogansService"},{"file":"lib/db/sober-living.ts","symbol":"SoberLivingService"},{"file":"lib/db/glossary.ts","symbol":"GlossaryService"},{"file":"lib/db/library.ts","symbol":"LibraryService"}],"consolidation_target":"lib/db/create-crud-service.ts (factory function)"},"why_it_matters":"Adding validation, error handling, or caching to any CRUD operation requires editing 5+ files. A single factory could enforce consistent patterns.","suggested_fix":"Create createCrudService<T>(collectionName, options?) factory that generates typed getAll/add/update/delete methods. Migrate services one at a time.","acceptance_tests":["npm run lint","npm test","Admin panel CRUD for quotes/slogans/glossary still works"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["lib/db/quotes.ts: getAllQuotes/addQuote/updateQuote/deleteQuote pattern","lib/db/slogans.ts: getAllSlogans/addSlogan/updateSlogan/deleteSlogan (identical structure)"],"notes":"CANON-0021 from prior audits."}
{"category":"Types/Correctness","title":"JournalEntryType string literals defined in 4+ locations without single source of truth","fingerprint":"Types/Correctness::types/journal.ts::JournalEntryType::entry-type-scattered","severity":"S1","effort":"E1","confidence":90,"files":["types/journal.ts","functions/src/schemas.ts","lib/firestore-service.ts","components/journal/entry-creator-menu.tsx"],"symbols":["JournalEntryType","journalEntrySchema","inventoryEntrySchema","saveNotebookJournalEntry","saveInventoryEntry"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"The 10 journal entry type strings are defined as a TypeScript union in types/journal.ts, a Zod enum in functions/src/schemas.ts, inline string literals in firestore-service.ts methods, and a subset literal in entry-creator-menu.tsx. No compile-time link between client and functions packages.","instances":[{"file":"types/journal.ts","symbol":"JournalEntryType"},{"file":"functions/src/schemas.ts","symbol":"journalEntrySchema.type"},{"file":"lib/firestore-service.ts","symbol":"saveNotebookJournalEntry"},{"file":"components/journal/entry-creator-menu.tsx","symbol":"onSelectType"}],"consolidation_target":"types/journal.ts should be the single source. Zod enum in schemas.ts should derive from it."},"why_it_matters":"Adding a new entry type requires finding and updating 4-6 files manually. Forgetting one creates silent runtime failures where server rejects valid client data or client sends data the server doesn't handle.","suggested_fix":"Export JOURNAL_ENTRY_TYPES const array from types/journal.ts. Derive the TypeScript type and Zod enum from it.","acceptance_tests":["npm run lint","npx tsc --noEmit"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["types/journal.ts:1-11 defines JournalEntryType with 10 literals","functions/src/schemas.ts:20-31 repeats the same 10 literals in z.enum()","lib/firestore-service.ts:~409-420 repeats subset inline","components/journal/entry-creator-menu.tsx:10 uses hardcoded subset"],"notes":"CANON-0067 from prior audits."}
{"category":"Architecture/Boundaries","title":"functions/src/admin.ts is 136KB — critical god file","fingerprint":"Architecture/Boundaries::functions/src/admin.ts::admin::god-file-136kb","severity":"S1","effort":"E3","confidence":95,"files":["functions/src/admin.ts"],"symbols":["admin"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"At 136KB, this is likely 3000-4000 lines. Any change risks merge conflicts. Testing, reviewing, and reasoning about this file is extremely difficult. Cold start time for Cloud Functions is proportional to bundle size.","suggested_fix":"Split into domain-specific modules: admin-users.ts, admin-meetings.ts, admin-content.ts, etc. Re-export from admin/index.ts.","acceptance_tests":["npm run build (in functions/)","All admin operations work end-to-end"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["functions/src/admin.ts has size 136418 bytes per GitHub API"],"notes":"Single highest-impact architecture improvement available."}
{"category":"Architecture/Boundaries","title":"Hooks split across hooks/ and lib/hooks/ directories","fingerprint":"Architecture/Boundaries::hooks/::use-journal::hooks-split-directories","severity":"S2","effort":"E1","confidence":80,"files":["hooks/use-daily-quote.ts","hooks/use-geolocation.ts","hooks/use-journal.ts","hooks/use-speech-recognition.ts"],"symbols":["useDailyQuote","useGeolocation","useJournal","useSpeechRecognition"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Developers don't know whether to look in hooks/ or lib/hooks/ for a hook. Import paths are inconsistent.","suggested_fix":"Consolidate all hooks into the top-level hooks/ directory. Update import aliases.","acceptance_tests":["npm run lint","npx tsc --noEmit","No imports from lib/hooks/ remain"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["hooks/ directory has 4 files","lib/hooks/ directory exists as separate location"],"notes":""}
{"category":"Architecture/Boundaries","title":"DB modules split across lib/db/ and lib/database/ directories","fingerprint":"Architecture/Boundaries::lib/db/::collections::db-split-directories","severity":"S2","effort":"E1","confidence":75,"files":["lib/db/collections.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts","lib/db/glossary.ts","lib/db/library.ts","lib/db/meetings.ts","lib/db/users.ts"],"symbols":["QuotesService","SlogansService"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Two directories for the same concern creates ambiguity about where new DB code should go.","suggested_fix":"Audit lib/database/ contents. Merge into lib/db/ or create clear separation of concerns.","acceptance_tests":["npm run lint","npx tsc --noEmit"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["lib/db/ has 8 files","lib/database/ exists as separate directory"],"notes":""}
{"category":"Architecture/Boundaries","title":"lib/db/ services bypass firestore-service.ts repository pattern","fingerprint":"Architecture/Boundaries::lib/db/quotes.ts::QuotesService::bypasses-service-layer","severity":"S2","effort":"E2","confidence":85,"files":["lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts","lib/db/glossary.ts","lib/db/library.ts","lib/db/meetings.ts","lib/db/users.ts","lib/firestore-service.ts"],"symbols":["QuotesService","SlogansService","FirestoreService"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Architecture docs say all Firestore operations should go through lib/firestore-service.ts, but lib/db/ services directly import db from lib/firebase.ts and call Firestore SDK methods. This bypasses centralized validation, logging, and rate limiting.","suggested_fix":"Decide: either (a) firestore-service.ts is only for user-scoped writes and lib/db/ is for public/admin reads, then document clearly; or (b) route all DB access through firestore-service.ts.","acceptance_tests":["Architecture boundary documented in DEVELOPMENT.md"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["lib/db/quotes.ts:1 imports db from '../firebase'","lib/db/slogans.ts:6 imports db from '@/lib/firebase'","CLAUDE.md Section 3: 'Add new queries to service files, not inline in components'"],"notes":"The actual pattern appears to be: firestore-service.ts for user-scoped writes (via Cloud Functions), lib/db/ for read-only public/admin data. Reasonable boundary but undocumented."}
{"category":"Security Hardening","title":"App Check still disabled since Dec 2025","fingerprint":"Security Hardening::lib/firebase.ts::initializeFirebase::appcheck-disabled","severity":"S1","effort":"E2","confidence":98,"files":["lib/firebase.ts"],"symbols":["initializeFirebase","_appCheck"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"App Check prevents unauthorized API usage and bot attacks on Cloud Functions. Disabled 2+ months past stated re-enable date. All Cloud Functions unprotected from non-app callers.","suggested_fix":"Re-enable App Check initialization in lib/firebase.ts. Ensure all Cloud Functions have requireAppCheck: true. Test with debug tokens in dev.","acceptance_tests":["App Check initialized on client load","Cloud Functions reject calls without valid App Check tokens"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":["lib/firebase.ts:57-90 shows entire App Check block commented out","Comment says 'TEMPORARILY DISABLED' with Dec 31 date","Current date is Feb 2026"],"notes":"CANON-0002 from prior audits. Single highest-priority security item."}
{"category":"Testing Infrastructure","title":"Critical auth and journal paths have minimal/no test coverage","fingerprint":"Testing Infrastructure::hooks/use-journal.ts::useJournal::missing-critical-tests","severity":"S2","effort":"E2","confidence":85,"files":["hooks/use-journal.ts","lib/auth/account-linking.ts","lib/recaptcha.ts","lib/db/meetings.ts"],"symbols":["useJournal","addEntry","crumplePage","linkEmailPassword","linkWithGoogle","getRecaptchaToken"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Core journal hook (16KB) and account linking (17.5% coverage) are security-critical paths with no dedicated tests. Regressions break core functionality or create security vulnerabilities.","suggested_fix":"Add tests/use-journal.test.ts and tests/account-linking.test.ts. Mock httpsCallable per project patterns.","acceptance_tests":["tests/use-journal.test.ts exists with coverage for addEntry, crumplePage","tests/account-linking.test.ts exists","npm test passes"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["No test file for use-journal.ts in tests/","Prior audit docs state account-linking.ts at 17.5% coverage"],"notes":""}
{"category":"Hygiene/Duplication","title":"Growth card dialog/save state pattern duplicated across 4 components","fingerprint":"Hygiene/Duplication::components/growth/SpotCheckCard.tsx::SpotCheckCard::growth-card-dialog-dup","severity":"S2","effort":"E1","confidence":40,"files":["components/growth/SpotCheckCard.tsx","components/growth/GratitudeCard.tsx","components/growth/NightReviewCard.tsx","components/growth/Step1WorksheetCard.tsx"],"symbols":["SpotCheckCard","GratitudeCard","NightReviewCard","Step1WorksheetCard"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"isOpen/isSaving/handleSave state management pattern repeated in 4 growth card components","instances":[{"file":"components/growth/SpotCheckCard.tsx","symbol":"SpotCheckCard"},{"file":"components/growth/GratitudeCard.tsx","symbol":"GratitudeCard"},{"file":"components/growth/NightReviewCard.tsx","symbol":"NightReviewCard"},{"file":"components/growth/Step1WorksheetCard.tsx","symbol":"Step1WorksheetCard"}],"consolidation_target":"hooks/use-growth-card-dialog.ts"},"why_it_matters":"Each new growth card requires copying 20+ lines of dialog state boilerplate.","suggested_fix":"Extract useGrowthCardDialog(saveConfig) hook.","acceptance_tests":["npm run lint","npm test"],"pr_bucket_suggestion":"hooks-standardization","dependencies":[],"evidence":["Prior audit REF-007 identified this pattern"],"notes":"CANON-0079. Confidence low — haven't inspected these files directly."}
{"category":"Hygiene/Duplication","title":"DailyQuoteCard component may be duplicated in 2-3 locations","fingerprint":"Hygiene/Duplication::components/widgets/daily-quote-card.tsx::DailyQuoteCard::quote-card-dup","severity":"S2","effort":"E1","confidence":35,"files":["components/notebook/features/daily-quote-card.tsx","components/widgets/daily-quote-card.tsx","components/widgets/compact-daily-quote.tsx"],"symbols":["DailyQuoteCard","CompactDailyQuote"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"2-3 quote card implementations with same fetch logic","instances":[{"file":"components/notebook/features/daily-quote-card.tsx","symbol":"DailyQuoteCard"},{"file":"components/widgets/daily-quote-card.tsx","symbol":"DailyQuoteCard"},{"file":"components/widgets/compact-daily-quote.tsx","symbol":"CompactDailyQuote"}],"consolidation_target":"components/widgets/daily-quote-card.tsx with variant prop"},"why_it_matters":"Same fetch logic in 2-3 places means feature drift.","suggested_fix":"Consolidate to single component with variant prop.","acceptance_tests":["npm run lint","npx tsc --noEmit"],"pr_bucket_suggestion":"ui-primitives","dependencies":[],"evidence":["Prior audit CANON-0013/CANON-0073 identified this pattern"],"notes":"Confidence low — notebook version may have been removed."}
{"category":"Architecture/Boundaries","title":"resources-page.tsx is 728-line god component","fingerprint":"Architecture/Boundaries::components/notebook/pages/resources-page.tsx::ResourcesPage::god-component","severity":"S2","effort":"E2","confidence":35,"files":["components/notebook/pages/resources-page.tsx"],"symbols":["ResourcesPage"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Mixes meeting and sober-home logic with distinct data fetching, filtering, and display in one component.","suggested_fix":"Extract MeetingsSection and SoberHomesSection components. Create useResourceFilters hook.","acceptance_tests":["npm run lint","npx tsc --noEmit"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["Prior audit REF-004 identified 728 lines"],"notes":"CANON from prior audit. Confidence low — may have been refactored."}