{"category":"Hygiene/Duplication","title":"Direct Firestore SDK reads in UI/components bypass typed db/services","fingerprint":"Hygiene/Duplication::components/admin/admin-crud-table.tsx::AdminCrudTable::direct-firestore-reads-in-ui","severity":"S1","effort":"E2","confidence":92,"files":["components/admin/admin-crud-table.tsx","components/dev/lighthouse-tab.tsx","components/growth/DailySloganWidget.tsx","components/notebook/pages/today-page.tsx","hooks/use-journal.ts","lib/db/collections.ts"],"symbols":["AdminCrudTable","LighthouseTab","DailySloganWidget","TodayPage","useJournal","collectionRef"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Multiple UI modules directly call Firestore SDK (collection/query/getDocs/onSnapshot) and manually map docs, despite having typed collection helpers (lib/db/collections.ts) and db service modules. This creates drift in query patterns, error handling, and type safety.","instances":[{"file":"components/admin/admin-crud-table.tsx","symbol":"AdminCrudTable"},{"file":"components/dev/lighthouse-tab.tsx","symbol":"LighthouseTab"},{"file":"components/growth/DailySloganWidget.tsx","symbol":"DailySloganWidget"},{"file":"components/notebook/pages/today-page.tsx","symbol":"TodayPage"},{"file":"hooks/use-journal.ts","symbol":"useJournal"}],"consolidation_target":"lib/db/* services + lib/db/collections.ts (create small repo-layer functions per feature and have UI call those)"},"why_it_matters":"Firestore access scattered across UI increases duplication and makes behavior inconsistent (query limits, mapping, validation, error logging). It also makes refactors (schema/paths/security) harder and riskier.","suggested_fix":"Introduce feature-scoped repo/service functions (e.g., lib/db/dev-lighthouse.ts, lib/db/slogans.ts usage from widgets) that encapsulate Firestore reads, mapping, and validation. UI components should consume services/hooks only and stop importing firebase/firestore directly.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["components/admin/admin-crud-table.tsx:60-66 uses collection(db, config.collectionName) + getDocs","components/dev/lighthouse-tab.tsx:63-72 uses collection(db,'dev','lighthouse','history') + getDocs","components/growth/DailySloganWidget.tsx:23-29 uses collection(db,'slogans') + getDocs","components/notebook/pages/today-page.tsx:710+ dynamic import firebase/firestore then collection(db, users/${user.uid}/daily_logs)","hooks/use-journal.ts:270-305 uses collection(db, users/${user.uid}/journal) + onSnapshot"],"notes":"This is a cross-cutting boundary issue too (UI vs data layer)."}
{"category":"Hygiene/Duplication","title":"Repeated Firestore snapshot.docs.map -> {id,...data} casting patterns","fingerprint":"Hygiene/Duplication::lib/db/meetings.ts::MeetingsService::snapshot-doc-mapping-dup","severity":"S2","effort":"E1","confidence":90,"files":["components/admin/admin-crud-table.tsx","components/growth/DailySloganWidget.tsx","lib/db/glossary.ts","lib/db/meetings.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts"],"symbols":["AdminCrudTable","DailySloganWidget","getGlossaryTerms","MeetingsService","getQuotes","SlogansService","SoberLivingService"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Multiple modules map Firestore query snapshots into typed objects by spreading doc.data() and injecting id, then casting (as T / as Slogan / as Meeting...). This is repeated and inconsistent (sometimes id last, sometimes first).","instances":[{"file":"components/admin/admin-crud-table.tsx","symbol":"AdminCrudTable"},{"file":"components/growth/DailySloganWidget.tsx","symbol":"DailySloganWidget"},{"file":"lib/db/glossary.ts","symbol":"getGlossaryTerms"},{"file":"lib/db/meetings.ts","symbol":"MeetingsService"},{"file":"lib/db/quotes.ts","symbol":"getQuotes"},{"file":"lib/db/slogans.ts","symbol":"SlogansService"},{"file":"lib/db/sober-living.ts","symbol":"SoberLivingService"}],"consolidation_target":"lib/db/firestore-mappers.ts (e.g., mapDocWithId<T>(doc) + optional zod decode)"},"why_it_matters":"This pattern is a long-term correctness trap: schema changes, missing fields, or Timestamp/date conversions will break silently behind type casts. Consolidating allows consistent runtime validation and safer typing.","suggested_fix":"Add a small shared mapper that takes a QueryDocumentSnapshot and returns {id,...data} with optional zod schema decode. Replace local snapshot.docs.map casts with the shared helper.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["lib/db/glossary.ts:28 snapshot.docs.map((doc)=>({id:doc.id,...doc.data()})) as GlossaryTerm","lib/db/quotes.ts:35 snapshot.docs.map((doc)=>({id:doc.id,...doc.data()})) as Quote","lib/db/slogans.ts:41 snapshot.docs.map((d)=>({id:d.id,...d.data()})) as Slogan","lib/db/sober-living.ts:33 snapshot.docs.map((doc)=>({id:doc.id,...doc.data()})) as SoberLivingHome","components/growth/DailySloganWidget.tsx:27 snapshot.docs.map((d)=>({id:d.id,...d.data()})) as Slogan","components/admin/admin-crud-table.tsx:62 snapshot.docs.map((d)=>({id:d.id,...d.data()})) as T"],"notes":"Keep the mapper tiny and dependency-free to avoid circular imports."}
{"category":"Types/Correctness","title":"Timestamp/string->Date conversion helper duplicated and inconsistent","fingerprint":"Types/Correctness::components/dev/lighthouse-tab.tsx::toDate::timestamp-conversion-dup","severity":"S2","effort":"E0","confidence":96,"files":["components/dev/lighthouse-tab.tsx","lib/types/firebase-types.ts"],"symbols":["toDate","toDate"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Local helper converts string|Timestamp to Date, while shared lib/types/firebase-types.ts exposes toDate(value: unknown): Date|null with broader handling and validation.","instances":[{"file":"components/dev/lighthouse-tab.tsx","symbol":"toDate"},{"file":"lib/types/firebase-types.ts","symbol":"toDate"}],"consolidation_target":"lib/types/firebase-types.ts::toDate"},"why_it_matters":"Duplicate conversion utilities drift over time (e.g., handling Date/number/invalid values). Using the shared helper reduces correctness bugs and simplifies future Timestamp handling changes.","suggested_fix":"Replace components/dev/lighthouse-tab.tsx local toDate with import { toDate } from '@/lib/types/firebase-types' and handle null return (fallback UI).","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["components/dev/lighthouse-tab.tsx defines function toDate(value: string | Timestamp): Date","lib/types/firebase-types.ts exports function toDate(value: unknown): Date | null"],"notes":"This is a quick win and a good pattern for other date conversions."}
{"category":"Architecture/Boundaries","title":"TodayPage is a high-complexity god-component mixing UI, Firestore queries, debug logging, and analytics","fingerprint":"Architecture/Boundaries::components/notebook/pages/today-page.tsx::TodayPage::god-component-split","severity":"S1","effort":"E3","confidence":85,"files":["components/notebook/pages/today-page.tsx"],"symbols":["TodayPage","calculateWeeklyStats"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Large multi-responsibility components accumulate cognitive complexity quickly and become the hardest places to safely refactor. They also encourage ad-hoc patterns (dynamic imports, console logs, direct SDK calls) that spread.","suggested_fix":"Extract Firestore query + mapping into a small lib/db module (daily logs repo) and extract weekly stats computation into a dedicated hook (useWeeklyStats). Strip dev-only console logging behind a single debug helper or remove entirely. Break TodayPage into subcomponents (StatsHeader, LogEditor, etc.).","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["components/notebook/pages/today-page.tsx exports default function TodayPage(...)","components/notebook/pages/today-page.tsx:~710+ calculateWeeklyStats dynamically imports firebase/firestore then runs queries and extensive console debugging"],"notes":"Even without Sonar data, this file clearly exceeds the repo's typical complexity envelope."}
{"category":"Security Hardening","title":"Error logging inconsistent: many call sites log raw error objects instead of sanitized errorType/errorCode","fingerprint":"Security/Hardening::components/growth/DailySloganWidget.tsx::DailySloganWidget::raw-error-logging-drift","severity":"S1","effort":"E2","confidence":88,"files":["app/admin/page.tsx","app/meetings/all/page.tsx","components/admin/analytics-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/errors-tab.tsx","components/admin/jobs-tab.tsx","components/admin/links-tab.tsx","components/admin/logs-tab.tsx","components/admin/prayers-tab.tsx","components/auth/sign-in-modal.tsx","components/growth/DailySloganWidget.tsx","components/growth/GratitudeCard.tsx","components/growth/NightReviewCard.tsx","components/growth/SpotCheckCard.tsx","components/growth/Step1WorksheetCard.tsx","components/journal/entry-forms/daily-log-form.tsx","components/journal/entry-forms/free-write-form.tsx","components/journal/entry-forms/gratitude-form.tsx","components/journal/entry-forms/inventory-form.tsx","components/journal/entry-forms/mood-form.tsx","components/journal/entry-wizard.tsx","components/journal/journal-hub.tsx","components/notebook/journal-modal.tsx","components/notebook/notebook-shell.tsx","components/notebook/pages/library-page.tsx","components/notebook/pages/resources-page.tsx","components/widgets/compact-meeting-countdown.tsx","hooks/use-speech-recognition.ts","lib/db/library.ts","lib/db/meetings.ts","lib/utils/retry.ts"],"symbols":["AdminPage","AllMeetingsPage","AnalyticsTab","DashboardTab","ErrorsTab","JobsTab","LinksTab","LogsTab","PrayersTab","SignInModal","DailySloganWidget","GratitudeCard","NightReviewCard","SpotCheckCard","Step1WorksheetCard","DailyLogForm","FreeWriteForm","GratitudeForm","InventoryForm","MoodForm","EntryWizard","JournalHub","JournalModal","NotebookShell","LibraryPage","ResourcesPage","CompactMeetingCountdown","useSpeechRecognition","getAllQuickLinks","MeetingsService","retryWithBackoff"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Many modules call logger.error(..., { error }) or logger.error(..., { error: err }) which can leak raw error objects (PII/stack traces/SDK internals), while other code follows a sanitized pattern (errorType/errorCode).","instances":[{"file":"app/admin/page.tsx","symbol":"AdminPage"},{"file":"components/growth/DailySloganWidget.tsx","symbol":"DailySloganWidget"},{"file":"components/admin/dashboard-tab.tsx","symbol":"DashboardTab"}],"consolidation_target":"lib/logger.ts (add logger.safeError / helper to normalize errorType+errorCode and forbid raw error payloads)"},"why_it_matters":"Raw error objects can contain sensitive metadata and are inconsistent with the repo's own CANON guidance. Consolidation reduces security/PII risk and keeps observability consistent.","suggested_fix":"Create a single helper (e.g., logErrorSafe(message, err, context)) that extracts errorType/errorCode and optionally masks identifiers. Replace all {error}/{error:err} callsites via codemod/grep-driven edits.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":["components/growth/DailySloganWidget.tsx:38 logger.error('Error fetching daily slogan', { error })","components/admin/dashboard-tab.tsx multiple logger.error(...,{ error: err })","components/journal/* forms logger.error(...,{ error })"],"notes":"Some admin/dev logs may be acceptable internally, but consolidating still improves predictability."}
{"category":"Security Hardening","title":"reCAPTCHA action strings/constants duplicated across client and functions; raw strings used","fingerprint":"Security/Hardening::lib/utils/secure-caller.ts::RECAPTCHA_ACTIONS::recaptcha-action-drift","severity":"S2","effort":"E2","confidence":86,"files":["hooks/use-journal.ts","lib/auth/account-linking.ts","lib/firestore-service.ts","lib/utils/secure-caller.ts","functions/src/recaptcha-verify.ts"],"symbols":["useJournal","linkWithEmail","linkWithGoogle","createFirestoreService","RECAPTCHA_ACTIONS","verifyRecaptchaToken"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"reCAPTCHA action identifiers exist in multiple places (client constants, server constants) while callers often pass raw string literals. This risks action mismatch and makes rotation/renaming hard.","instances":[{"file":"hooks/use-journal.ts","symbol":"useJournal"},{"file":"lib/auth/account-linking.ts","symbol":"linkWithEmail"},{"file":"lib/utils/secure-caller.ts","symbol":"RECAPTCHA_ACTIONS"},{"file":"functions/src/recaptcha-verify.ts","symbol":"RECAPTCHA_ACTIONS"}],"consolidation_target":"shared constants consumed by both app and functions"},"why_it_matters":"Action mismatch defeats a key protection (token reuse prevention) and causes hard-to-debug production failures. A single source of truth reduces drift.","suggested_fix":"Move action names to a shared module that both environments can import. Update call sites to use RECAPTCHA_ACTIONS constants (no raw strings) and tighten types (RecaptchaAction).","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":["hooks/use-journal.ts uses getRecaptchaToken('save_journal_entry') and getRecaptchaToken('delete_journal_entry')","lib/auth/account-linking.ts uses getRecaptchaToken('migrate_user_data')","lib/firestore-service.ts uses getRecaptchaToken('save_daily_log' / 'save_inventory' / 'save_journal_entry')","lib/utils/secure-caller.ts exports RECAPTCHA_ACTIONS (client-side)","functions/src/recaptcha-verify.ts exports RECAPTCHA_ACTIONS (server-side)"],"notes":"If shared imports across app/functions are hard, add a script/test that asserts both constant sets match exactly."}
{"category":"Hygiene/Duplication","title":"Cloud Function calling patterns duplicated despite existing secure-caller abstraction","fingerprint":"Hygiene/Duplication::lib/utils/secure-caller.ts::createSecureFunctionCaller::bypass-secure-caller","severity":"S1","effort":"E2","confidence":89,"files":["components/admin/admin-crud-table.tsx","components/admin/analytics-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/errors-tab.tsx","components/admin/jobs-tab.tsx","components/admin/logs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/users-tab.tsx","hooks/use-journal.ts","lib/auth/account-linking.ts","lib/firestore-service.ts","lib/utils/secure-caller.ts"],"symbols":["AdminCrudTable","AnalyticsTab","DashboardTab","ErrorsTab","JobsTab","LogsTab","PrivilegesTab","UsersTab","useJournal","linkWithEmail","linkWithGoogle","createFirestoreService","createSecureFunctionCaller"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Many call sites directly use getFunctions()+httpsCallable() even though lib/utils/secure-caller.ts exists to standardize retries, recaptcha, and result shaping.","instances":[{"file":"components/admin/users-tab.tsx","symbol":"UsersTab"},{"file":"hooks/use-journal.ts","symbol":"useJournal"},{"file":"lib/auth/account-linking.ts","symbol":"linkWithEmail"},{"file":"lib/firestore-service.ts","symbol":"createFirestoreService"}],"consolidation_target":"lib/utils/secure-caller.ts (wrap all callable usage)"},"why_it_matters":"Duplicated callable wiring increases inconsistency in retries, error normalization, auth/context, and security. It also bloats UI components and makes changes expensive.","suggested_fix":"Adopt secure-caller as the only supported path: create per-function typed wrappers built from createSecureFunctionCaller. Migrate admin tabs and hooks to call wrappers rather than httpsCallable directly.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["grep httpsCallable hits include components/admin/, hooks/use-journal.ts, lib/auth/account-linking.ts, lib/firestore-service.ts","lib/utils/secure-caller.ts defines createSecureFunctionCaller and documents standardized usage"],"notes":"Admin-only screens may keep custom behavior, but should still reuse the shared caller."}
{"category":"Types/Correctness","title":"Firestore collection names/paths inconsistently hard-coded vs central COLLECTIONS helpers","fingerprint":"Types/Correctness::lib/db/collections.ts::COLLECTIONS::collection-name-drift","severity":"S2","effort":"E1","confidence":82,"files":["components/dev/lighthouse-tab.tsx","components/growth/DailySloganWidget.tsx","lib/db/library.ts","lib/db/meetings.ts","lib/db/slogans.ts","lib/db/collections.ts"],"symbols":["LighthouseTab","DailySloganWidget","getAllQuickLinks","MeetingsService","SlogansService","COLLECTIONS"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Several modules directly embed collection names as strings while lib/db/collections.ts defines COLLECTIONS constants and user path builders.","instances":[{"file":"components/growth/DailySloganWidget.tsx","symbol":"DailySloganWidget"},{"file":"components/dev/lighthouse-tab.tsx","symbol":"LighthouseTab"},{"file":"lib/db/library.ts","symbol":"getAllQuickLinks"},{"file":"lib/db/meetings.ts","symbol":"MeetingsService"},{"file":"lib/db/slogans.ts","symbol":"SlogansService"}],"consolidation_target":"lib/db/collections.ts (expand COLLECTIONS to cover all root collections)"},"why_it_matters":"Stringly-typed collection paths create silent drift and make refactors (rename/move collections) painful. Centralizing enables static checks and safer access patterns.","suggested_fix":"Replace hard-coded collection names with COLLECTIONS constants. Extend COLLECTIONS to include quick_links/prayers and any dev namespaces.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["components/growth/DailySloganWidget.tsx uses collection(db,'slogans')","components/dev/lighthouse-tab.tsx uses collection(db,'dev','lighthouse','history')","lib/db/library.ts uses collection(db,'quick_links') and collection(db,'prayers')"],"notes":"If dev paths shouldn't be in COLLECTIONS, still define them once in a dev-only module."}
{"category":"Testing Infrastructure","title":"Quality gates don't include patterns:check and dependency health in primary test pipeline","fingerprint":"Testing Infrastructure::package.json::scripts.test::missing-quality-gate-hooks","severity":"S2","effort":"E0","confidence":94,"files":["package.json"],"symbols":["scripts.test","scripts.test:coverage","scripts.patterns:check","scripts.deps:circular","scripts.deps:unused"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Refactoring rules (pattern compliance, circular deps, unused exports) are only effective if they run in the default quality pipeline. Otherwise regressions slip in.","suggested_fix":"Add a single meta-script (e.g., 'check': lint + patterns:check + deps:circular + deps:unused + test) and have CI call it.","acceptance_tests":["npm run lint","npm run patterns:check","npm run deps:circular","npm run deps:unused","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["package.json scripts.test runs test:build then node --test dist-tests; does not run patterns:check/deps:","package.json includes scripts.patterns:check, scripts.deps:circular, scripts.deps:unused but not chained into test"],"notes":"Low-risk and makes refactor consolidation enforceable."}
{"category":"Testing Infrastructure","title":"No automated guardrail to prevent new raw logger.error({error}) call sites","fingerprint":"Testing Infrastructure::scripts/check-pattern-compliance.js::main::missing-logger-guardrail","severity":"S2","effort":"E1","confidence":70,"files":["scripts/check-pattern-compliance.js","components/growth/DailySloganWidget.tsx","components/admin/dashboard-tab.tsx"],"symbols":["main","DailySloganWidget","DashboardTab"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"You already have a pattern-compliance system; extending it to cover the biggest drift source (raw error logging) prevents slow regression.","suggested_fix":"Add a pattern rule that flags logger.error(...,{ error }) unless the payload is sanitized (errorType/errorCode). Add a script test to assert the rule is enforced.","acceptance_tests":["npm run patterns:check","npm run test"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["grep results show many logger.error(...,{ error }) call sites across app/components/lib","repo already includes scripts/check-pattern-compliance.js"],"notes":"Turns a big refactor cluster into a permanently enforced standard."}
{"category":"Architecture/Boundaries","title":"AdminCrudTable mixes UI concerns with data access; config allows both service and direct collection fetch","fingerprint":"Architecture/Boundaries::components/admin/admin-crud-table.tsx::AdminCrudTable::service-boundary-leak","severity":"S2","effort":"E1","confidence":84,"files":["components/admin/admin-crud-table.tsx"],"symbols":["AdminCrudTable","fetchItems"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Allowing either 'service' or 'collectionName' invites drift: some entities get robust service logic while others get ad-hoc reads/writes.","suggested_fix":"Make service mandatory in AdminCrudConfig and remove the direct Firestore path. Provide small entity services for the remaining cases.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["components/admin/admin-crud-table.tsx:52-66 fetchItems chooses between config.service.getAll() vs direct collection(db, config.collectionName) + getDocs"],"notes":"Small but high-leverage boundary standardization."}
{"category":"Types/Correctness","title":"Potential duplicated domain types across lib/types and types/ with drift risk","fingerprint":"Types/Correctness::types/journal.ts::JournalEntry::possible-type-drift","severity":"S3","effort":"E1","confidence":35,"files":["types/journal.ts","hooks/use-journal.ts","lib/firestore-service.ts"],"symbols":["JournalEntry","useJournal","createFirestoreService"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"When types exist in multiple places or get re-exported inconsistently, refactors become risky and runtime validation gets skipped.","suggested_fix":"Confirm whether overlapping Journal/DailyLog/Inventory entity definitions exist outside types/*. If so, consolidate into types/ and re-export from lib/types if desired.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["hooks/use-journal.ts imports JournalEntry from '@/types/journal' while FirestoreService also shapes journal payloads"],"notes":"Needs full search to confirm drift; suspected only."}
{"category":"Testing Infrastructure","title":"Dependency health baselines (circular/unused exports) not verifiable; potential drift","fingerprint":"Testing Infrastructure::knip.json::knip::needs-fresh-baseline","severity":"S3","effort":"E1","confidence":30,"files":["knip.json","package.json"],"symbols":["knip","scripts.deps:circular","scripts.deps:unused"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Even small circular/unused-export drift compounds refactoring cost and encourages awkward boundaries.","suggested_fix":"Run npm run deps:circular and npm run deps:unused in CI and keep a documented baseline; fail on regressions.","acceptance_tests":["npm run deps:circular","npm run deps:unused"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["package.json defines deps:circular and deps:unused but they are not part of npm test pipeline"],"notes":"Cannot run these commands (no node_modules), so this remains suspected."}