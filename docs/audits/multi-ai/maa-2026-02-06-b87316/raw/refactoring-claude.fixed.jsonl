{"category":"Duplication","title":"admin.ts Mega-File: 33 Cloud Functions with identical boilerplate","fingerprint":"Duplication::functions/src/admin.ts::mega_file_boilerplate","severity":"S1","effort":"E3","confidence":100,"files":["functions/src/admin.ts","functions/src/security-wrapper.ts"],"line":1,"why_it_matters":"4108-line file with 33 Cloud Functions all following identical pattern: requireAdmin → Zod validate in try/catch → Firestore operation in try/catch → logSecurityEvent. security-wrapper.ts provides withSecurityChecks() used 9× in index.ts but 0× in admin.ts. Every function manually reimplements the same auth/validation/logging boilerplate.","evidence":["functions/src/admin.ts: 4108 lines, 33 exported Cloud Functions","functions/src/security-wrapper.ts: withSecurityChecks() used 9× in index.ts, 0× in admin.ts","All 33 instances: adminSaveMeeting, adminDeleteMeeting, adminSaveSoberLiving, adminDeleteSoberLiving, adminSaveQuote, adminDeleteQuote, adminHealthCheck, adminGetDashboardStats, adminSearchUsers, adminGetUserDetail, adminUpdateUser, adminDisableUser, adminSoftDeleteUser, adminUndeleteUser, adminTriggerJob, adminGetJobsStatus, adminGetJobRunHistory, adminGetSentryErrorSummary, adminGetLogs, adminGetErrorsWithUsers, adminGetUserActivityByHash, adminFindUserByHash, adminGetPrivilegeTypes, adminSavePrivilegeType, adminDeletePrivilegeType, adminSetUserPrivilege, adminListUsers, adminSendPasswordReset, adminGetStorageStats, adminGetRateLimitStatus, adminClearRateLimit, adminGetCollectionStats, adminGetUserAnalytics"],"suggested_fix":{"steps":["1. Create withAdminChecks() wrapper in security-wrapper.ts (extends withSecurityChecks with requireAdmin)","2. Split admin.ts into domain modules: admin-meetings.ts, admin-users.ts, admin-jobs.ts, admin-analytics.ts, admin-privileges.ts, admin-system.ts","3. Migrate each function to use withAdminChecks() wrapper","4. Target ~400 lines per module"],"verification":["Each admin function uses withAdminChecks() wrapper","No manual requireAdmin/try-catch boilerplate remains","All admin functions pass existing tests"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Duplication","title":"getFunctions()/httpsCallable() boilerplate in 10 files","fingerprint":"Duplication::components/admin::httpsCallable_boilerplate","severity":"S1","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/errors-tab.tsx","components/admin/jobs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/analytics-tab.tsx","components/admin/logs-tab.tsx","components/admin/admin-crud-table.tsx","hooks/use-journal.ts"],"line":null,"why_it_matters":"28 raw getFunctions()/httpsCallable() calls scattered across 10 files. Every admin tab independently initializes Firebase Functions with identical boilerplate: const functions = getFunctions(); const fn = httpsCallable<Req, Res>(functions, 'functionName'). users-tab.tsx alone has 10 such calls.","evidence":["users-tab.tsx: 10 getFunctions() calls","dashboard-tab.tsx: 5 getFunctions() calls","errors-tab.tsx: 3 getFunctions() calls","jobs-tab.tsx: 3 getFunctions() calls","privileges-tab.tsx: 3 getFunctions() calls","analytics-tab.tsx: 1 getFunctions() call","logs-tab.tsx: 1 getFunctions() call","admin-crud-table.tsx: 2 getFunctions() calls","use-journal.ts: 2 getFunctions() calls"],"suggested_fix":{"steps":["1. Create callAdminFunction<Req, Res>(name, data) helper that encapsulates getFunctions + httpsCallable + error handling","2. Create callCloudFunction<Req, Res>(name, data) variant for non-admin functions","3. Incrementally replace raw calls across all files"],"verification":["Zero raw getFunctions()/httpsCallable() calls remain in component files","All admin tabs use callAdminFunction() helper","use-journal.ts uses callCloudFunction() helper"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Consistency","title":"COLLECTIONS constants built but never adopted","fingerprint":"Consistency::lib/db/collections.ts::constants_unused","severity":"S2","effort":"E1","confidence":100,"files":["lib/db/collections.ts","lib/db/meetings.ts","lib/db/library.ts","lib/db/glossary.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts","components/dev/lighthouse-tab.tsx","components/growth/DailySloganWidget.tsx","components/notebook/pages/today-page.tsx","components/admin/admin-crud-table.tsx","hooks/use-journal.ts"],"line":null,"why_it_matters":"lib/db/collections.ts defines COLLECTIONS constants and typed getCollection()/getDocument() helpers. Zero lib/db/ service files use them. All 7 services + 5 components use raw collection(db, 'string_literal') instead. 12 bypass instances identified.","evidence":["lib/db/meetings.ts: 4× raw collection() calls","lib/db/library.ts: 4× raw collection() calls","lib/db/glossary.ts: raw collection() call","lib/db/quotes.ts: raw collection() call","lib/db/slogans.ts: raw collection() call","lib/db/sober-living.ts: raw collection() call","components/dev/lighthouse-tab.tsx: raw collection() call","components/growth/DailySloganWidget.tsx: raw collection() call","components/notebook/pages/today-page.tsx: raw collection() call","components/admin/admin-crud-table.tsx: raw collection() call","hooks/use-journal.ts: raw collection() call"],"suggested_fix":{"steps":["1. Add missing COLLECTIONS entries: quick_links, prayers, dev/lighthouse/history","2. Replace all raw collection(db, 'string') calls with COLLECTIONS constants","3. Use getCollection()/getDocument() typed helpers where applicable"],"verification":["Zero raw collection(db, 'string_literal') calls remain in lib/db/ and components","All collection names come from COLLECTIONS constants","Missing collections (quick_links, prayers, dev/lighthouse/history) added"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Architecture","title":"Triple data access layer: 3 overlapping Firestore patterns","fingerprint":"Architecture::lib::triple_data_access_layer","severity":"S1","effort":"E3","confidence":100,"files":["lib/firestore-service.ts","lib/database/firestore-adapter.ts","lib/db/meetings.ts","lib/db/library.ts","lib/db/glossary.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts"],"line":null,"why_it_matters":"Three overlapping Firestore access patterns coexist: (1) FirestoreService in lib/firestore-service.ts (476 lines) handles daily logs, inventory, journal; (2) FirestoreAdapter in lib/database/firestore-adapter.ts overlaps with daily logs; (3) Per-entity services in lib/db/*.ts (7 modules) handle meetings, quotes, slogans, glossary, etc. No clear canonical path for data access.","evidence":["lib/firestore-service.ts: 476 lines, handles daily logs + inventory + journal","lib/database/firestore-adapter.ts: overlaps with FirestoreService on daily logs","lib/db/*.ts: 7 separate modules (meetings, library, glossary, quotes, slogans, sober-living, collections)","Components import from different layers depending on which entity they need"],"suggested_fix":{"steps":["1. Migrate FirestoreService methods into appropriate lib/db/ modules","2. Deprecate and remove FirestoreAdapter (functionality absorbed by lib/db/)","3. Establish lib/db/ as the single canonical data access layer","4. Update all component imports to use lib/db/ exclusively"],"verification":["FirestoreService removed or reduced to re-exports from lib/db/","FirestoreAdapter removed entirely","All data access goes through lib/db/ modules","No overlapping functionality between modules"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Duplication","title":"9 unmigrated admin tabs with duplicated CRUD/fetch patterns","fingerprint":"Duplication::components/admin::unmigrated_tabs","severity":"S2","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx","components/admin/errors-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/logs-tab.tsx","components/admin/jobs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/analytics-tab.tsx","components/admin/links-tab.tsx","components/admin/prayers-tab.tsx"],"line":null,"why_it_matters":"5 tabs use AdminCrudTable. 9 tabs don't, totaling ~7300 lines of duplicated CRUD/fetch patterns. Each unmigrated tab independently implements loading states, error handling, data fetching, and CRUD operations.","evidence":["users-tab.tsx: 2092 lines, High complexity (10 separate Cloud Function calls)","errors-tab.tsx: 1095 lines, High complexity","dashboard-tab.tsx: 1031 lines, High complexity (5 separate fetches)","logs-tab.tsx: 730 lines, Medium complexity","jobs-tab.tsx: 625 lines, Medium complexity","privileges-tab.tsx: 600 lines, Medium complexity","analytics-tab.tsx: 457 lines, Low complexity","links-tab.tsx: 344 lines, Low (could adopt AdminCrudTable directly)","prayers-tab.tsx: 323 lines, Low (could adopt AdminCrudTable directly)"],"suggested_fix":{"steps":["1. Migrate links-tab.tsx and prayers-tab.tsx to AdminCrudTable (easiest, direct fit)","2. Create specialized variants of AdminCrudTable for medium-complexity tabs","3. Gradually migrate remaining tabs, starting with lower complexity"],"verification":["links-tab.tsx and prayers-tab.tsx use AdminCrudTable","Total line count across admin tabs reduced by >30%","All tabs share common loading/error/CRUD patterns"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Security","title":"admin functions use weaker security checks than user-facing functions","fingerprint":"Security::functions/src/admin.ts::weak_admin_checks","severity":"S1","effort":"E2","confidence":100,"files":["functions/src/admin.ts","functions/src/security-wrapper.ts","functions/src/index.ts"],"line":null,"why_it_matters":"User-facing functions in index.ts use withSecurityChecks() which enforces App Check, reCAPTCHA, rate limiting, and Zod validation. Admin functions in admin.ts use manual requireAdmin() + ad-hoc try/catch, missing standardized rate limiting and App Check enforcement. Admin endpoints should have equal or stronger security, not weaker.","evidence":["functions/src/index.ts: 9 functions use withSecurityChecks() with full security stack","functions/src/admin.ts: 33 functions use manual requireAdmin() without withSecurityChecks()","admin.ts functions lack standardized rate limiting pattern","admin.ts functions lack App Check enforcement"],"suggested_fix":{"steps":["1. Create withAdminChecks() in security-wrapper.ts extending withSecurityChecks() with admin role verification","2. Migrate all 33 admin functions to use withAdminChecks()","3. Ensure admin rate limiting is at least as strict as user-facing functions"],"verification":["All admin functions use withAdminChecks() wrapper","Admin functions enforce App Check and rate limiting","No manual requireAdmin() calls remain outside wrapper"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Consistency","title":"Missing COLLECTIONS constants for 3 entities","fingerprint":"Consistency::lib/db/collections.ts::missing_entries","severity":"S3","effort":"E0","confidence":100,"files":["lib/db/collections.ts"],"line":null,"why_it_matters":"COLLECTIONS constants object in lib/db/collections.ts is missing entries for quick_links, prayers, and dev/lighthouse/history. Components accessing these collections use raw string literals with no type safety or centralized reference.","evidence":["lib/db/collections.ts: no entry for quick_links","lib/db/collections.ts: no entry for prayers","lib/db/collections.ts: no entry for dev/lighthouse/history"],"suggested_fix":{"steps":["1. Add QUICK_LINKS, PRAYERS, and LIGHTHOUSE_HISTORY to COLLECTIONS constant","2. Update components using these collections to use the new constants"],"verification":["COLLECTIONS contains entries for all collection names used in codebase","No raw string literals for these 3 collections remain"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Types","title":"Duplicate UserProfile and LogEntry type definitions","fingerprint":"Types::types::duplicate_user_profile_log_entry","severity":"S2","effort":"E1","confidence":90,"files":["types/user.ts","types/daily-log.ts","functions/src/schemas.ts"],"line":null,"why_it_matters":"UserProfile and LogEntry types are defined in multiple locations with slightly different shapes. Frontend types/ directory and functions/src/schemas.ts both define these types, leading to potential drift and import confusion.","evidence":["types/ directory: UserProfile type definition","functions/src/schemas.ts: Zod schemas that implicitly define the same types","Multiple imports across components reference different sources"],"suggested_fix":{"steps":["1. Establish single source of truth for shared types (recommend functions/src/schemas.ts with z.infer<>)","2. Export inferred types from schemas","3. Update all imports to use canonical source"],"verification":["Single definition for UserProfile and LogEntry","All imports reference the same source","No type drift between frontend and backend definitions"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Complexity","title":"today-page.tsx oversized component (1199+ lines)","fingerprint":"Complexity::components/notebook/pages/today-page.tsx::oversized","severity":"S2","effort":"E2","confidence":100,"files":["components/notebook/pages/today-page.tsx"],"line":null,"why_it_matters":"today-page.tsx exceeds 1199 lines with multiple responsibilities: daily log management, journal entries, inventory tracking, meeting display, slogan display, and quote display. Should be decomposed into focused sub-components with custom hooks for data fetching.","evidence":["components/notebook/pages/today-page.tsx: 1199+ lines","Multiple data fetching patterns inline","Multiple UI sections that could be independent components"],"suggested_fix":{"steps":["1. Extract custom hooks: useDailyLog, useJournalEntries, useInventory, useMeetings","2. Extract sub-components: DailyLogSection, JournalSection, InventorySection, MeetingSection","3. Keep today-page.tsx as thin orchestrator composing sub-components","4. Target <400 lines for main component"],"verification":["today-page.tsx under 400 lines","Each sub-component is self-contained with own hook","No functionality regression"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Complexity","title":"users-tab.tsx oversized component (2092 lines)","fingerprint":"Complexity::components/admin/users-tab.tsx::oversized","severity":"S2","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx"],"line":null,"why_it_matters":"users-tab.tsx at 2092 lines is the largest admin tab with 10 separate Cloud Function calls, user search, user detail view, user editing, and multiple sub-features all in one file. Should be decomposed into focused components.","evidence":["components/admin/users-tab.tsx: 2092 lines","10 separate getFunctions()/httpsCallable() calls","High complexity: search, detail view, editing, status management all inline"],"suggested_fix":{"steps":["1. Extract UserSearchPanel, UserDetailPanel, UserEditForm sub-components","2. Create useAdminUsers custom hook for all Cloud Function calls","3. Adopt callAdminFunction() helper (after PR#2)","4. Target <400 lines for main component"],"verification":["users-tab.tsx under 400 lines","Each panel is independent component","10 raw httpsCallable calls replaced with callAdminFunction()"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Duplication","title":"links-tab.tsx simple CRUD tab not using AdminCrudTable","fingerprint":"Duplication::components/admin/links-tab.tsx::no_crud_table","severity":"S2","effort":"E1","confidence":100,"files":["components/admin/links-tab.tsx","components/admin/admin-crud-table.tsx"],"line":null,"why_it_matters":"links-tab.tsx at 344 lines implements basic CRUD operations manually when it could directly adopt the existing AdminCrudTable component. Low complexity tab with straightforward list/add/edit/delete pattern that perfectly fits the existing abstraction.","evidence":["components/admin/links-tab.tsx: 344 lines of manual CRUD","components/admin/admin-crud-table.tsx: existing reusable CRUD component","5 tabs already successfully use AdminCrudTable"],"suggested_fix":{"steps":["1. Define column/form config for links entity","2. Replace manual CRUD implementation with AdminCrudTable","3. Verify all existing functionality preserved"],"verification":["links-tab.tsx uses AdminCrudTable","Line count reduced by >50%","All CRUD operations still functional"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Duplication","title":"prayers-tab.tsx simple CRUD tab not using AdminCrudTable","fingerprint":"Duplication::components/admin/prayers-tab.tsx::no_crud_table","severity":"S2","effort":"E1","confidence":100,"files":["components/admin/prayers-tab.tsx","components/admin/admin-crud-table.tsx"],"line":null,"why_it_matters":"prayers-tab.tsx at 323 lines implements basic CRUD operations manually when it could directly adopt the existing AdminCrudTable component. Low complexity tab with straightforward list/add/edit/delete pattern.","evidence":["components/admin/prayers-tab.tsx: 323 lines of manual CRUD","components/admin/admin-crud-table.tsx: existing reusable CRUD component","5 tabs already successfully use AdminCrudTable"],"suggested_fix":{"steps":["1. Define column/form config for prayers entity","2. Replace manual CRUD implementation with AdminCrudTable","3. Verify all existing functionality preserved"],"verification":["prayers-tab.tsx uses AdminCrudTable","Line count reduced by >50%","All CRUD operations still functional"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Architecture","title":"FirestoreAdapter overlaps with FirestoreService on daily logs","fingerprint":"Architecture::lib/database/firestore-adapter.ts::overlapping_adapter","severity":"S2","effort":"E1","confidence":40,"files":["lib/database/firestore-adapter.ts","lib/firestore-service.ts"],"line":null,"why_it_matters":"SUSPECTED: FirestoreAdapter appears to duplicate daily log access methods already provided by FirestoreService. If confirmed, one should be removed to eliminate confusion about which to import. Needs investigation to confirm overlap extent.","evidence":["lib/database/firestore-adapter.ts: daily log methods","lib/firestore-service.ts: daily log methods (overlapping scope)"],"suggested_fix":{"steps":["1. Audit both files to confirm exact method overlap","2. If confirmed, migrate callers of FirestoreAdapter to FirestoreService (or lib/db/)","3. Remove FirestoreAdapter"],"verification":["No duplicate daily log access methods","Single canonical module for daily log data access"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Complexity","title":"dashboard-tab.tsx may have extractable data-fetching hooks","fingerprint":"Complexity::components/admin/dashboard-tab.tsx::extractable_hooks","severity":"S2","effort":"E2","confidence":40,"files":["components/admin/dashboard-tab.tsx"],"line":null,"why_it_matters":"SUSPECTED: dashboard-tab.tsx at 1031 lines with 5 separate fetch operations likely contains extractable custom hooks and sub-components. Needs investigation to confirm decomposition opportunities.","evidence":["components/admin/dashboard-tab.tsx: 1031 lines","5 separate fetch operations identified"],"suggested_fix":{"steps":["1. Audit file to identify independent data-fetching patterns","2. Extract custom hooks for each dashboard metric","3. Extract sub-components for each dashboard section"],"verification":["dashboard-tab.tsx under 500 lines","Custom hooks encapsulate data fetching"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Consistency","title":"Inconsistent error handling patterns across admin tabs","fingerprint":"Consistency::components/admin::inconsistent_error_handling","severity":"S2","effort":"E2","confidence":40,"files":["components/admin/users-tab.tsx","components/admin/errors-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/jobs-tab.tsx"],"line":null,"why_it_matters":"SUSPECTED: Each admin tab appears to implement error handling differently — some use toast notifications, some use inline error states, some use both. Needs investigation to confirm inconsistency and determine standardization approach.","evidence":["Multiple admin tabs with independent error handling implementations","No shared error handling hook or utility across admin tabs"],"suggested_fix":{"steps":["1. Audit error handling patterns across all admin tabs","2. Create useAdminError() hook with standardized toast + inline error pattern","3. Migrate all tabs to use the shared hook"],"verification":["All admin tabs use consistent error handling","Single useAdminError() hook used across tabs"]},"acceptance_tests":["Verify fix applied correctly"]}