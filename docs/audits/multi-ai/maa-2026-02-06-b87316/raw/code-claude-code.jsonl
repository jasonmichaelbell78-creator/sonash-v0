{"category":"Hygiene","title":"God Object: functions/src/admin.ts (4108 lines)","fingerprint":"Hygiene::functions/src/admin.ts::admin.ts::god-object","severity":"S1","effort":"E3","confidence":100,"files":["functions/src/admin.ts"],"symbols":["admin.ts"],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"4108-line file violates single responsibility principle. Contains 30+ Cloud Functions in one file, making it difficult to navigate, test, and maintain. Changes require understanding entire file context.","suggested_fix":"Split into domain-specific modules: admin/users.ts, admin/privileges.ts, admin/analytics.ts, admin/errors.ts, admin/logs.ts, admin/jobs.ts. Each module exports 3-5 related functions. Use barrel export from admin/index.ts.","acceptance_tests":["Verify all Cloud Functions still callable after split","Run integration tests for admin endpoints","Verify no circular dependencies with: npm run deps:circular","Check test coverage maintained or improved"],"pr_bucket_suggestion":"misc","dependencies":[],"evidence":["wc -l shows 4108 lines","File contains adminGetUsers, adminSetUserPrivilege, adminGetErrorsWithUsers, adminGetUserAnalytics, adminGetJobRunHistory, and 20+ more functions","DEBT-0012 confirms cognitive complexity 22 at line 576"],"notes":"TDMS already tracks this - references DEBT-0012, DEBT-0035, DEBT-0045, DEBT-0046. Roadmap placement: M2.2 (Functions refactoring)."}
{"category":"Hygiene","title":"God Object: components/admin/users-tab.tsx (2092 lines)","fingerprint":"Hygiene::components/admin/users-tab.tsx::UsersTab::god-component","severity":"S1","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx"],"symbols":["UsersTab"],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"2092-line component violates React best practices. Single component handles user search, pagination, profile viewing, editing, privilege management, soft-delete, and hard-delete. Difficult to test and maintain.","suggested_fix":"Extract sub-components: UserSearchPanel, UserProfileCard, UserEditDialog, PrivilegeManager, UserDeleteControls. Move data fetching to custom hooks: useUserSearch, useUserProfile, useUserPrivileges. Target: main component <200 lines.","acceptance_tests":["Component renders without errors","User search functionality unchanged","Privilege updates work end-to-end","Soft-delete and hard-delete workflows functional","No console errors during interactions"],"pr_bucket_suggestion":"ui-primitives","dependencies":[],"evidence":["wc -l shows 2092 lines","Component imports 20+ icons from lucide-react","Contains inline helper functions at lines 97-200","Multiple useState calls (10+) managing complex state"],"notes":"Part of admin panel complexity. See also errors-tab.tsx (1095 lines) and dashboard-tab.tsx (1031 lines). Total admin components: 13,159 lines."}
{"category":"Types","title":"Type Safety: `any` type in today-page.tsx","fingerprint":"Types::components/notebook/pages/today-page.tsx::handleSnapshotUpdate::any-type","severity":"S2","effort":"E0","confidence":100,"files":["components/notebook/pages/today-page.tsx"],"symbols":["handleSnapshotUpdate"],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"Using `any` defeats TypeScript's type checking. Function receives Firestore DocumentSnapshot but types it as `any`, allowing unsafe property access without compile-time validation.","suggested_fix":"Replace `(docSnap: any, isMounted: boolean)` with proper Firestore type: `(docSnap: DocumentSnapshot<JournalEntryData>, isMounted: boolean)`. Import DocumentSnapshot from firebase/firestore and define JournalEntryData interface.","acceptance_tests":["TypeScript compiles without errors","IDE autocomplete works for docSnap properties","Runtime behavior unchanged"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["Line 507: `(docSnap: any, isMounted: boolean) => {`","Function accesses docSnap.exists() and docSnap.data() without type safety"],"notes":"Low-hanging fruit. Quick fix with immediate safety improvement."}
{"category":"Types","title":"Type Divergence: Client types vs Server schemas","fingerprint":"Types::types/journal.ts::JournalEntry::client-server-divergence","severity":"S1","effort":"E2","confidence":85,"files":["types/journal.ts","functions/src/schemas.ts"],"symbols":["JournalEntry","journalEntrySchema"],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"Client TypeScript types and server Zod schemas define journal entries independently, leading to silent validation failures. Adding new entry types requires coordinated changes in 2+ places with no automated consistency check.","suggested_fix":"Create single source of truth: lib/types/journal-shared.ts with Zod schemas. Generate TypeScript types using zod's z.infer<typeof schema>. Export both schema (for validation) and type (for TypeScript). Import in both client and server.","acceptance_tests":["Schemas validate expected journal entry structures","TypeScript types match Zod schema shapes","Client-side validation catches same errors as server","No breaking changes to existing journal entries"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["DEBT-0049 confirms this issue","grep shows 142 Zod schema definitions across codebase","Types defined separately in types/ directory"],"notes":"Already tracked as DEBT-0049 with roadmap placement M2.1. Affects data integrity."}
{"category":"Framework","title":"Boundary Violation: 'use client' in lib/contexts","fingerprint":"Framework::lib/contexts/admin-tab-context.tsx::admin-tab-context::misplaced-use-client","severity":"S2","effort":"E0","confidence":100,"files":["lib/contexts/admin-tab-context.tsx"],"symbols":["admin-tab-context"],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"'use client' directive in lib/ violates Next.js 13+ architecture. Contexts should live in components/providers/ to maintain clear Server/Client boundary. Makes it harder to understand what code runs where.","suggested_fix":"Move lib/contexts/admin-tab-context.tsx to components/providers/admin-tab-provider.tsx. Update imports across codebase. Follow established pattern used by components/providers/auth-context.tsx.","acceptance_tests":["Admin tabs render correctly","State persists across tab switches","No hydration errors in console","grep confirms no remaining lib/contexts/ files with 'use client'"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["lib/contexts/admin-tab-context.tsx:1 contains 'use client'","grep shows this is the only lib/ file with 'use client'","components/providers/ exists with proper client boundary files"],"notes":"Architectural hygiene. Prevents future confusion about Server vs Client components."}
{"category":"Security","title":"Direct Firestore Write in auth-context.tsx","fingerprint":"Security::components/providers/auth-context.tsx::AuthProvider::direct-firestore-write","severity":"S2","effort":"E1","confidence":90,"files":["components/providers/auth-context.tsx"],"symbols":["AuthProvider","updateDoc"],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"Direct updateDoc call in client code (line 103) updates users collection, bypassing Cloud Function security layer. While lastActive timestamp is low-risk, it sets a precedent for direct writes and could bypass future validation logic.","suggested_fix":"Create Cloud Function `updateUserActivity` that verifies user identity and updates lastActive. Call via httpsCallable from auth-context. Alternatively, document explicit exception in SECURITY.md if this pattern is intentionally allowed for performance.","acceptance_tests":["lastActive timestamp still updates on user activity","Firestore rules still block unauthorized updates","No performance regression (measure with console.time)","Security audit passes with documented exception if keeping direct write"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["Line 103-105: await updateDoc(doc(db, 'users', currentUser.uid), { lastActive: serverTimestamp() })","claude.md Section 2 states: 'NO DIRECT WRITES to journal, daily_logs, inventoryEntries'","Pattern differs from established httpsCallable approach used elsewhere"],"notes":"Low severity because lastActive is non-sensitive and user-scoped. However, inconsistent with stated architecture pattern."}
{"category":"Security","title":"reCAPTCHA Token Bypass (Existing DEBT-0045)","fingerprint":"Security::functions/src/security-wrapper.ts::security-wrapper::recaptcha-bypass","severity":"S1","effort":"E1","confidence":100,"files":["functions/src/security-wrapper.ts"],"symbols":["security-wrapper"],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"If recaptchaAction is configured for an endpoint, missing token logs warning but continues processing. Should fail closed to prevent automated abuse. Currently allows requests without reCAPTCHA validation.","suggested_fix":"Require non-empty recaptchaToken when recaptchaAction is set. Throw HttpsError('failed-precondition', 'reCAPTCHA required') if missing. Allow bypass only in explicit dev/test mode via ALLOW_RECAPTCHA_BYPASS env flag.","acceptance_tests":["Requests without token are rejected with 400 error","Dev/test mode explicitly enabled via env flag","Production mode requires valid tokens","Integration tests pass with proper token handling"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":["DEBT-0045 from MASTER_DEBT.jsonl","Wrapper logs missing token but continues processing (Claude Opus evidence)","Currently deployed in production with this behavior"],"notes":"Already tracked in TDMS. Roadmap: Track-S (Security). Fix before public launch."}
{"category":"Security","title":"Incomplete Rate Limiting (Existing DEBT-0046)","fingerprint":"Security::functions/src/security-wrapper.ts::security-wrapper::rate-limit-gaps","severity":"S1","effort":"E2","confidence":100,"files":["functions/src/security-wrapper.ts"],"symbols":["security-wrapper","FirestoreRateLimiter"],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"Rate limiting has 3 gaps: (1) No IP-based throttling (user can create multiple accounts), (2) Admin endpoints unprotected, (3) Inconsistent 429-equivalent error codes. Allows abuse via account creation spam.","suggested_fix":"Add secondary limiter keyed by IP address (req.rawRequest.ip). Wrap admin callables with rate limiter using admin-tier limits. Standardize all rate-limit errors to return 'resource-exhausted' code with retry-after guidance.","acceptance_tests":["IP-based rate limiting blocks multiple accounts from same IP","Admin endpoints respect rate limits","All rate-limit responses return consistent error code","Load test confirms limits are enforced"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":["DEBT-0046 from MASTER_DEBT.jsonl","Admin callables have no limiter (both models)","Limiter keyed by userId only; no IP-based throttling (ChatGPT 5.2)"],"notes":"Already tracked in TDMS. Roadmap: Track-S (Security). Higher effort due to IP extraction and testing complexity."}
{"category":"Testing","title":"Zero Component Test Coverage","fingerprint":"Testing::components::all-components::no-component-tests","severity":"S1","effort":"E3","confidence":100,"files":["components/"],"symbols":["*"],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"20+ component directories with 150+ React components have zero test coverage. No automated verification of UI behavior, accessibility, or user interactions. High regression risk when refactoring large components.","suggested_fix":"Start with critical paths: (1) auth-context provider, (2) admin CRUD operations, (3) journal entry creation. Use @testing-library/react with MSW for API mocking. Target 50% coverage for Phase 1. Document testing patterns in TESTING.md.","acceptance_tests":["npm test runs component tests successfully","Critical user flows have test coverage","Tests catch at least one real bug during implementation","CI runs tests on every PR"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["find components -name '*.test.tsx' returns 0 results","package.json shows testing infrastructure exists (node:test, cross-env)","tests/ directory contains 20 files but none for components"],"notes":"Major gap. Aligns with DEBT-0050 (script test coverage). Track A Testing Plan exists in docs/plans/TRACK_A_TESTING_PLAN.md."}
{"category":"AICode","title":"Excessive Cognitive Complexity (40+ files)","fingerprint":"AICode::scripts::multiple-files::cognitive-complexity-pattern","severity":"S1","effort":"E3","confidence":100,"files":["scripts/check-docs-light.js","scripts/validate-audit.js","scripts/phase-complete-check.js","scripts/archive-doc.js","functions/src/security-wrapper.ts","components/notebook/pages/history-page.tsx","components/notebook/pages/resources-page.tsx"],"symbols":["checkDocument","validateS0S1Strict","checkPhaseComplete","archiveDocument","createSecurityWrapper","HistoryPage","ResourcesPage"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Pattern of deeply nested conditional logic without helper function extraction. 40+ files exceed SonarCloud's cognitive complexity threshold of 15.","instances":[{"file":"scripts/check-docs-light.js","symbol":"checkDocument","complexity":51},{"file":"scripts/validate-audit.js","symbol":"validateS0S1Strict","complexity":34},{"file":"scripts/phase-complete-check.js","symbol":"checkPhaseComplete","complexity":27},{"file":"functions/src/security-wrapper.ts","symbol":"createSecurityWrapper","complexity":39},{"file":"components/notebook/pages/history-page.tsx","symbol":"HistoryPage","complexity":35},{"file":"components/notebook/pages/resources-page.tsx","symbol":"ResourcesPage","complexity":48}]},"why_it_matters":"High cognitive complexity (15+) makes code difficult to understand, test, and debug. Pattern suggests AI-generated code without human refactoring. Increases bug density and maintenance burden.","suggested_fix":"Extract helper functions to reduce nesting. Pattern: (1) Extract validation helpers, (2) Extract conditional branches into named functions, (3) Use early returns to flatten logic. Apply SonarCloud refactoring suggestions already documented in TDMS DEBT-0010 through DEBT-0044.","acceptance_tests":["All affected files reduce complexity to <=15","Functionality unchanged (regression tests pass)","Helper functions have descriptive names","Code coverage maintained or improved"],"pr_bucket_suggestion":"misc","dependencies":[],"evidence":["MASTER_DEBT.jsonl entries DEBT-0010 to DEBT-0044 document 35 cognitive complexity violations","SonarCloud rule typescript:S3776 and javascript:S3776","Grep shows helper function extraction pattern already used in some files (line 97 comment in users-tab.tsx)"],"notes":"This is a cross-cutting pattern, not isolated instances. Shows good intent (helper comment exists) but incomplete application. Roadmap: M2.1 (components), M2.2 (functions), Track-E (scripts)."}
{"category":"Debugging","title":"Limited Structured Logging","fingerprint":"Debugging::lib::all-files::console-logging-prevalence","severity":"S3","effort":"E1","confidence":80,"files":["lib/logger.ts"],"symbols":["logger"],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"29 console.log/warn/error statements across codebase. While lib/logger.ts exists, adoption is incomplete. No correlation IDs for request tracing. Debugging production issues requires log aggregation without structured context.","suggested_fix":"Migrate remaining console statements to logger. Add correlation ID to logger context (generate on request entry, pass through all layers). Ensure Sentry integration captures logger calls with full context.","acceptance_tests":["grep 'console\\.(log|warn|error)' returns <5 results (intentional CLI output only)","All logger calls include correlation ID when available","Sentry events show correlation ID in breadcrumbs","Production logs can trace full request lifecycle"],"pr_bucket_suggestion":"misc","dependencies":[],"evidence":["grep count: 29 console statements","lib/logger.ts exists with winston-style interface","lib/sentry.client.ts shows Sentry integration exists","No correlation ID pattern found in grep"],"notes":"Low severity - logger exists and is partially adopted. Mostly needs completion, not new infrastructure. Good foundation already in place."}
{"category":"AICode","title":"AI Health Score Analysis","fingerprint":"AICode::project::sonash-v0::ai-health-metrics","severity":"S1","effort":"E0","confidence":75,"files":[],"symbols":[],"duplication_cluster":{"is_cluster":false,"cluster_summary":"","instances":[]},"why_it_matters":"Assessing codebase AI generation quality to identify systematic improvements needed in AI-assisted development workflow. Low score indicates need for human refactoring pass after AI generation.","suggested_fix":"Document AI code review checklist: (1) Refactor functions >50 lines, (2) Extract helpers for cognitive complexity >15, (3) Add tests for new components, (4) Verify types (no any), (5) Check boundaries (use client placement). Apply before committing AI-generated code.","acceptance_tests":["AI Health Score improves to >75 in next audit","God objects (>500 lines) reduced by 50%","Cognitive complexity violations reduced by 30%","Component test coverage >30%"],"pr_bucket_suggestion":"misc","dependencies":["FINDING-001","FINDING-002","FINDING-010"],"evidence":["Hallucination Rate: 0% (no node_modules imports found, all imports valid)","Test Validity: 0% component tests (20 test files but none for components)","Error Handling: ~70% (logger used, try/catch present, but some gaps)","Consistency Score: 60% (patterns exist but incomplete application)","Documentation Drift: Unknown (requires separate audit)"],"notes":"AI Health Score (weighted): ~45/100. Breakdown: Hallucination (30% weight) = 30/30, Test Validity (25% weight) = 0/25, Error Handling (20% weight) = 14/20, Consistency (15% weight) = 9/15, Docs (10% weight) = 0/10 (not assessed). Score indicates good AI foundations but needs human review pass."}
