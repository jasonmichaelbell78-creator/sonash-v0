SoNash v0 — Refactoring Audit: Human Summary
Date: 2026-02-06
Repo: jasonmichaelbell78-creator/sonash-v0 (main)
Auditor: Claude Opus 4.6
CAPABILITIES: browse_files=yes, run_commands=yes, repo_checkout=yes (via curl zip),
limitations="Git clone blocked by proxy; used curl zipball download instead. Cannot run npm/quality gates."

Executive Summary
The SoNash codebase has strong architectural foundations (typed service layers, security wrappers, centralized constants) — but adoption of those patterns is incomplete. The audit identified 12 confirmed findings and 3 suspected findings across 5 categories. The dominant theme is "built the infrastructure, didn't finish the migration" — key abstractions exist but aren't universally used.
Severity	Count	Description
S1	3	Major maintainability drag, risky to modify
S2	8	Moderate duplication/inconsistency causing friction
S3	1	Minor cleanup
Suspected	3	Needs further investigation (confidence <= 40)

Estimated total effort: 40-60 hours across 8-10 PRs

Top 5 Duplication Clusters
1. admin.ts Mega-File (S1, E3) — 33 Cloud Functions x identical boilerplate
4108 lines. Every Cloud Function follows the same pattern:
await requireAdmin(request, "functionName")
-> Zod validate in try/catch
-> Firestore operation in try/catch
-> logSecurityEvent for success/failure
Meanwhile, security-wrapper.ts already provides withSecurityChecks() — used 9x in index.ts but 0x in admin.ts.
All 33 instances: adminSaveMeeting, adminDeleteMeeting, adminSaveSoberLiving, adminDeleteSoberLiving, adminSaveQuote, adminDeleteQuote, adminHealthCheck, adminGetDashboardStats, adminSearchUsers, adminGetUserDetail, adminUpdateUser, adminDisableUser, adminSoftDeleteUser, adminUndeleteUser, adminTriggerJob, adminGetJobsStatus, adminGetJobRunHistory, adminGetSentryErrorSummary, adminGetLogs, adminGetErrorsWithUsers, adminGetUserActivityByHash, adminFindUserByHash, adminGetPrivilegeTypes, adminSavePrivilegeType, adminDeletePrivilegeType, adminSetUserPrivilege, adminListUsers, adminSendPasswordReset, adminGetStorageStats, adminGetRateLimitStatus, adminClearRateLimit, adminGetCollectionStats, adminGetUserAnalytics

2. getFunctions()/httpsCallable() in Admin Tabs (S1, E2) — 28 raw calls
Every admin tab independently initializes Firebase Functions:
const functions = getFunctions();
const fn = httpsCallable<Req, Res>(functions, "functionName");
Tab	getFunctions() calls
users-tab.tsx	10
dashboard-tab.tsx	5
errors-tab.tsx	3
jobs-tab.tsx	3
privileges-tab.tsx	3
analytics-tab.tsx	1
logs-tab.tsx	1
admin-crud-table.tsx	2
use-journal.ts	2

3. COLLECTIONS Constants: Built but Never Adopted (S2, E1)
lib/db/collections.ts defines COLLECTIONS constants and typed getCollection()/getDocument() helpers. Zero lib/db/ service files use them. All 7 services + 5 components use raw collection(db, "string_literal").
All 12 bypass instances: lib/db/meetings.ts (4x), lib/db/library.ts (4x), lib/db/glossary.ts, lib/db/quotes.ts, lib/db/slogans.ts, lib/db/sober-living.ts, components/dev/lighthouse-tab.tsx, components/growth/DailySloganWidget.tsx, components/notebook/pages/today-page.tsx, components/admin/admin-crud-table.tsx, hooks/use-journal.ts
Missing from COLLECTIONS: quick_links, prayers, dev/lighthouse/history

4. Triple Data Access Layer (S1, E3)
Three overlapping Firestore access patterns:
Layer	Location	Scope
FirestoreService	lib/firestore-service.ts (476 lines)	Daily logs, inventory, journal
FirestoreAdapter	lib/database/firestore-adapter.ts	Daily logs (overlaps with above)
Per-entity services	lib/db/*.ts (7 modules)	Meetings, quotes, slogans, glossary, etc.

5. Unmigrated Admin Tabs (S2, E2)
5 tabs use AdminCrudTable. 9 tabs don't, totaling ~7300 lines of duplicated CRUD/fetch patterns:
Tab	Lines	Complexity
users-tab.tsx	2092	High (10 separate Cloud Function calls)
errors-tab.tsx	1095	High
dashboard-tab.tsx	1031	High (5 separate fetches)
logs-tab.tsx	730	Medium
jobs-tab.tsx	625	Medium
privileges-tab.tsx	600	Medium
analytics-tab.tsx	457	Low
links-tab.tsx	344	Low (could adopt AdminCrudTable directly)
prayers-tab.tsx	323	Low (could adopt AdminCrudTable directly)

Top 5 High-Impact Refactors

1. Create withAdminChecks() and split admin.ts — Unifies security enforcement, reduces 4108 lines to ~6 files of ~400 lines each. Also closes the security gap where admin functions use weaker checks than user-facing functions.
2. Create callAdminFunction() helper — Eliminates 28+ getFunctions/httpsCallable boilerplate instances across admin tabs and lib/.
3. Adopt COLLECTIONS constants universally — Low effort (E1), high consistency win. Add missing collections, migrate lib/db/ and component-level access.
4. Consolidate triple data access layer — Migrate FirestoreService methods into lib/db/, deprecate FirestoreAdapter. One canonical path for all data access.
5. Decompose today-page.tsx and users-tab.tsx — Two files totaling 3291 lines. Extract custom hooks and sub-components to get each under 400 lines.

Suggested PR Sequence (10 PRs)
PR#	Bucket	Findings	Risk	Est. Hours	Dependencies
1	firebase-access	COLLECTIONS constants adoption	Low	2-3h	None
2	firebase-access	callAdminFunction / callCloudFunction helpers	Low	3-4h	None
3	types-domain	Deduplicate UserProfile, LogEntry	Low	1-2h	None
4	firebase-access	Migrate admin tabs to use callable helpers (PR#2)	Low	4-6h	PR#2
5	security-hardening	Create withAdminChecks() in security-wrapper.ts	Medium	4-6h	None
6	firebase-access	Split admin.ts into domain modules using withAdminChecks	Medium	8-12h	PR#5
7	firebase-access	Consolidate triple data layer -> lib/db/ canonical	Medium	6-8h	PR#1
8	ui-primitives	Migrate links-tab + prayers-tab to AdminCrudTable	Low	2-3h	None
9	hooks-standardization	Decompose today-page.tsx + users-tab.tsx	Medium	6-8h	PR#2, PR#7
10	tests-hardening	Add tests for admin functions, use-journal, today-page	Low	6-8h	PR#6, PR#9

"Do First" Shortlist (Low-Risk Enablers)
PR#1: COLLECTIONS constants — Add missing constants, update lib/db/ imports. Purely additive, no behavior change.
PR#2: Callable helpers — New utility file, then incrementally adopt. No breaking changes.
PR#3: Deduplicate types — Import instead of redefine. Type-only change.
PR#8: Migrate links/prayers tabs — These are simple CRUD tabs that fit AdminCrudTable perfectly.
Combined: ~8-12 hours, zero behavioral risk, enables all subsequent PRs.

Dependency Graph
PR#1 (COLLECTIONS) -> PR#7 (Data layer consolidation) -> PR#9 (Decompose components)
PR#2 (Callable helpers) -> PR#4 (Admin tabs adopt helpers) -> PR#9
PR#3 (Type dedup) -> PR#9
PR#5 (withAdminChecks) -> PR#6 (Split admin.ts) -> PR#10 (Tests)
PR#8 (Migrate links/prayers) -> PR#10
PRs 1, 2, 3, 5, 8 can all start in parallel.

Notes
- No SonarQube manifest found
- npm quality gates not run — proxy blocks git clone
- Prior refactoring work acknowledged — AdminCrudTable migration is partially complete (5 of 14 tabs)
