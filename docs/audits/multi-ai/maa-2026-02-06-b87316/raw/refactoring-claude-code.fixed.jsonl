{"category":"Duplication","title":"Admin API service missing: 30+ getFunctions()/httpsCallable() inline calls","fingerprint":"Duplication::components/admin::admin_api_service_missing","severity":"S1","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/errors-tab.tsx","components/admin/jobs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/admin-crud-table.tsx","components/admin/analytics-tab.tsx","components/admin/logs-tab.tsx","components/admin/links-tab.tsx","components/admin/prayers-tab.tsx","components/admin/meetings-tab.tsx","lib/auth/account-linking.ts"],"line":145,"why_it_matters":"30+ getFunctions()/httpsCallable() calls scattered across 12 files. Every admin tab independently initializes Firebase Functions with identical boilerplate. users-tab.tsx alone has 10 instances. This is the #1 blocker for admin maintainability — adding a new admin endpoint requires duplicating boilerplate in 9+ files.","evidence":["components/admin/users-tab.tsx: 10 instances (lines 145, 164, 177, 190, 206, 218, 230, 245, 258, 270)","components/admin/dashboard-tab.tsx: 5 instances (lines 731, 754, 780, 806, 832)","components/admin/errors-tab.tsx: 3 instances (lines 331, 542, 774)","components/admin/jobs-tab.tsx: 3 instances (lines 184, 517, 545)","components/admin/privileges-tab.tsx: 3 instances (lines 87, 166, 213)","components/admin/admin-crud-table.tsx: 2 instances (lines 147, 193)","components/admin/analytics-tab.tsx: 1 instance (line 272)","components/admin/logs-tab.tsx: 1 instance (line 392)","lib/auth/account-linking.ts: 2 instances (lines 204, 329)"],"suggested_fix":{"steps":["1. Create lib/admin-api.ts with typed AdminApiClient class following lib/firestore-service.ts pattern","2. Centralize getFunctions() initialization, error handling, retry logic, rate limiting","3. Replace all 30+ raw calls with AdminApiClient methods","4. Add centralized logging and telemetry"],"verification":["Zero raw getFunctions()/httpsCallable() calls in component files","All admin tabs use AdminApiClient","Centralized error handling and retry logic"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Consistency","title":"Timestamp inconsistency: Timestamp.now() vs serverTimestamp()","fingerprint":"Consistency::lib/db::timestamp_inconsistency","severity":"S2","effort":"E1","confidence":100,"files":["lib/db/glossary.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/library.ts","lib/db/users.ts"],"line":34,"why_it_matters":"Client-side Timestamp.now() used in 3 service files while 6+ other locations correctly use serverTimestamp(). Client timestamps cause race conditions when client clock is wrong, incorrect query ordering, and audit trail inconsistencies.","evidence":["lib/db/glossary.ts:34 - createdAt: Timestamp.now() (client-side)","lib/db/quotes.ts:41 - createdAt: Timestamp.now() (client-side)","lib/db/slogans.ts:52 - createdAt: Timestamp.now() (client-side)","lib/db/library.ts:72,73,82,122,123,132 - 6 uses of serverTimestamp() (correct)","lib/db/users.ts:113,114,151 - 3 uses of serverTimestamp() (correct)","functions/src/admin.ts:742,836,931,1002,1415,1479 - 6 uses of FieldValue.serverTimestamp() (correct)"],"suggested_fix":{"steps":["1. Replace Timestamp.now() with serverTimestamp() in glossary.ts:34, quotes.ts:41, slogans.ts:52","2. Document timestamp policy in ARCHITECTURE.md: always use serverTimestamp() for audit fields","3. Test that createdAt fields are correctly populated after migration"],"verification":["Zero Timestamp.now() calls remain for audit fields (createdAt, updatedAt)","All new documents use serverTimestamp()","Query ordering unaffected"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Consistency","title":"Bypassed typed collection helpers: 27 raw collection() calls","fingerprint":"Consistency::lib/db::bypassed_collection_helpers","severity":"S2","effort":"E0","confidence":100,"files":["components/admin/admin-crud-table.tsx","components/dev/lighthouse-tab.tsx","components/growth/DailySloganWidget.tsx","components/notebook/pages/today-page.tsx","lib/db/glossary.ts","lib/db/library.ts","lib/db/meetings.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts"],"line":60,"why_it_matters":"lib/db/collections.ts provides typed getCollection()/getDocument() helpers and COLLECTIONS constants but has 0 usages. All 7 services + 5 components use raw collection(db, 'string_literal') — 27 instances total. Bypassing typed helpers loses compile-time type checking, autocomplete, and protection against typos.","evidence":["components/admin/admin-crud-table.tsx:60 - collection(db, config.collectionName)","components/dev/lighthouse-tab.tsx:83 - collection(db, 'dev', 'lighthouse', 'history')","components/growth/DailySloganWidget.tsx:25 - collection(db, 'slogans')","components/notebook/pages/today-page.tsx:735 - collection(db, `users/${user.uid}/daily_logs`)","lib/db/glossary.ts:26 - collection(db, COLLECTION)","lib/db/library.ts:49,69,99,119 - 4x collection(db, 'quick_links')","lib/db/meetings.ts:111,140,170,223 - 4x collection(db, 'meetings')","lib/db/quotes.ts:33 - collection(db, COLLECTION)","lib/db/slogans.ts:39,48 - 2x collection(db, COLLECTION_NAME)","lib/db/sober-living.ts:31,37,57,62 - 4x collection(db, COLLECTION)"],"suggested_fix":{"steps":["1. Expand COLLECTIONS constant with any missing collection names","2. Replace all 27 raw collection() calls with getCollection() typed helpers","3. Use getDocument() for single-document access patterns"],"verification":["Zero raw collection(db, 'string') calls in lib/db/ and components","All collection access uses typed helpers","COLLECTIONS constant covers all collection names in codebase"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Duplication","title":"Toast error handling duplicated: 55+ try-catch blocks across admin tabs","fingerprint":"Duplication::components/admin::toast_error_handling","severity":"S2","effort":"E1","confidence":100,"files":["components/admin/users-tab.tsx","components/admin/links-tab.tsx","components/admin/prayers-tab.tsx","components/admin/errors-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/jobs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/analytics-tab.tsx","components/admin/logs-tab.tsx"],"line":null,"why_it_matters":"55+ similar try/catch blocks with toast.error() scattered across 9 admin tabs. Each implements error handling independently with inconsistent error messages. No centralized error telemetry. 55+ locations to update if error handling pattern changes.","evidence":["components/admin/users-tab.tsx: 55 try-catch blocks","components/admin/links-tab.tsx: 5 toast.error calls (lines 68, 110, 124, 139, 151)","components/admin/prayers-tab.tsx: 5 toast.error calls (lines 64, 104, 118, 133, 145)","All other admin tabs have similar patterns"],"suggested_fix":{"steps":["1. Create lib/utils/admin-error-handler.ts with handleAdminApiError(error, operation)","2. Embed in AdminApiClient if Finding #1 implemented","3. Standardize error message format and telemetry"],"verification":["All admin error handling uses centralized handler","Consistent error messages across all admin tabs","Centralized telemetry for admin errors"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Duplication","title":"Query builder duplication in lib/db/*.ts services","fingerprint":"Duplication::lib/db::query_builder_duplication","severity":"S2","effort":"E1","confidence":100,"files":["lib/db/glossary.ts","lib/db/quotes.ts","lib/db/sober-living.ts","lib/db/meetings.ts"],"line":26,"why_it_matters":"Repeated query(collection(db, COLLECTION)) + orderBy() + getDocs() pattern across lib/db/ service files. Inconsistent pagination (some use limit, some don't). Repeated import boilerplate makes it harder to add features like cursor pagination uniformly.","evidence":["lib/db/glossary.ts:26 - query(collection(db, COLLECTION))","lib/db/quotes.ts:33 - query(collection(db, COLLECTION))","lib/db/sober-living.ts:31,57 - 2x query(collection(db, COLLECTION))","lib/db/meetings.ts:112,140,170 - more complex but similar pattern"],"suggested_fix":{"steps":["1. Create lib/db/query-builders.ts with helpers: listAll(), listOrdered(), addPagination()","2. Replace repeated query patterns with query builder helpers","3. Standardize pagination approach across all services"],"verification":["All lib/db/ services use query builder helpers","Consistent pagination pattern","Reduced import boilerplate"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Complexity","title":"users-tab.tsx mega-component: 2092 lines, 43 state hooks","fingerprint":"Complexity::components/admin/users-tab.tsx::mega_component","severity":"S1","effort":"E3","confidence":100,"files":["components/admin/users-tab.tsx"],"line":1,"why_it_matters":"users-tab.tsx at 2092 lines with 43 state hooks is the largest admin component. Contains user search, detail view, editing, status management, and 10 separate Cloud Function calls all inline. Untestable and risky to modify.","evidence":["components/admin/users-tab.tsx: 2092 lines","43 useState hooks","10 separate getFunctions()/httpsCallable() calls","User search, detail view, editing, status management all inline"],"suggested_fix":{"steps":["1. Extract UserSearchPanel, UserDetailPanel, UserEditForm sub-components","2. Create useAdminUsers custom hook for Cloud Function calls","3. Adopt AdminApiClient (after admin API service created)","4. Target <300 lines for main component"],"verification":["users-tab.tsx under 300 lines","Each panel is independent testable component","43 state hooks distributed across sub-components"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Complexity","title":"errors-tab.tsx mega-component: 1095 lines","fingerprint":"Complexity::components/admin/errors-tab.tsx::mega_component","severity":"S1","effort":"E2","confidence":100,"files":["components/admin/errors-tab.tsx"],"line":1,"why_it_matters":"errors-tab.tsx at 1095 lines with high complexity. Contains error listing, filtering, detail views, and 3 Cloud Function calls inline. Should be decomposed into focused sub-components.","evidence":["components/admin/errors-tab.tsx: 1095 lines","3 getFunctions()/httpsCallable() instances (lines 331, 542, 774)","High complexity rating"],"suggested_fix":{"steps":["1. Extract ErrorListPanel, ErrorDetailPanel, ErrorFilterPanel sub-components","2. Create useAdminErrors custom hook","3. Target <300 lines for main component"],"verification":["errors-tab.tsx under 300 lines","Sub-components are independently testable"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Complexity","title":"dashboard-tab.tsx mega-component: 1031 lines with 5 separate fetches","fingerprint":"Complexity::components/admin/dashboard-tab.tsx::mega_component","severity":"S2","effort":"E2","confidence":100,"files":["components/admin/dashboard-tab.tsx"],"line":1,"why_it_matters":"dashboard-tab.tsx at 1031 lines with 5 separate Cloud Function fetch operations. Each dashboard section independently manages loading state, error handling, and data transformation.","evidence":["components/admin/dashboard-tab.tsx: 1031 lines","5 separate fetch operations (lines 731, 754, 780, 806, 832)","High complexity (5 separate fetches)"],"suggested_fix":{"steps":["1. Extract custom hooks for each dashboard metric","2. Extract DashboardMetricCard, DashboardChart sub-components","3. Target <300 lines for main component"],"verification":["dashboard-tab.tsx under 500 lines","Custom hooks encapsulate data fetching","Each dashboard section is a sub-component"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Types","title":"Entry type consolidation needed: duplicate type definitions","fingerprint":"Types::types::entry_type_consolidation","severity":"S2","effort":"E2","confidence":100,"files":["types/journal.ts","functions/src/schemas.ts"],"line":null,"why_it_matters":"Entry types (journal entries, log entries) are defined in multiple locations. Frontend types/ directory and functions/src/schemas.ts both define overlapping types, creating potential drift. May discover types are intentionally separate (client vs server shapes).","evidence":["types/journal.ts: frontend type definitions","functions/src/schemas.ts: Zod schemas defining equivalent server-side types","Multiple imports across components reference different type sources"],"suggested_fix":{"steps":["1. Audit all entry type definitions across types/ and functions/src/","2. Identify intentional vs accidental differences","3. Establish single source of truth using z.infer<> from Zod schemas","4. Update all imports to canonical source"],"verification":["Single canonical definition per entity type","All imports reference same source","No type drift between client and server"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Consistency","title":"Timestamp pattern undocumented in ARCHITECTURE.md","fingerprint":"Consistency::docs::timestamp_pattern_undocumented","severity":"S3","effort":"E0","confidence":100,"files":["ARCHITECTURE.md"],"line":null,"why_it_matters":"No documented policy for timestamp usage in ARCHITECTURE.md. The codebase uses both Timestamp.now() and serverTimestamp() inconsistently. A documented pattern would prevent future inconsistencies.","evidence":["ARCHITECTURE.md: no timestamp usage policy","Mixed usage: 3 files use Timestamp.now(), 3+ files use serverTimestamp()"],"suggested_fix":{"steps":["1. Add timestamp policy section to ARCHITECTURE.md","2. Document: always use serverTimestamp() for createdAt/updatedAt audit fields","3. Document when Timestamp.now() is acceptable (client-only display timestamps)"],"verification":["ARCHITECTURE.md contains timestamp usage policy","Policy referenced in onboarding docs"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Security","title":"Rate limiting inconsistent in admin functions","fingerprint":"Security::functions/src/admin.ts::inconsistent_rate_limiting","severity":"S2","effort":"E1","confidence":100,"files":["functions/src/admin.ts","functions/src/index.ts"],"line":null,"why_it_matters":"Admin functions in admin.ts implement rate limiting ad-hoc while user-facing functions in index.ts use standardized withSecurityChecks() rate limiting. Some admin functions may lack rate limiting entirely. Inconsistent enforcement creates potential for abuse of admin endpoints.","evidence":["functions/src/admin.ts: 33 admin functions with ad-hoc security checks","functions/src/index.ts: standardized rate limiting via withSecurityChecks()","No centralized rate limiting for admin endpoints"],"suggested_fix":{"steps":["1. Audit all 33 admin functions for rate limiting coverage","2. Standardize rate limiting via withAdminChecks() wrapper","3. Document rate limit policy for admin vs user-facing endpoints"],"verification":["All admin functions have consistent rate limiting","Rate limits documented per endpoint category"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Duplication","title":"account-linking.ts bypasses service pattern with raw httpsCallable","fingerprint":"Duplication::lib/auth/account-linking.ts::raw_httpsCallable","severity":"S2","effort":"E1","confidence":100,"files":["lib/auth/account-linking.ts"],"line":204,"why_it_matters":"lib/auth/account-linking.ts has 2 raw getFunctions()/httpsCallable() calls (lines 204, 329) that bypass whatever service pattern exists. As a non-admin file using the same anti-pattern, this confirms the issue extends beyond admin tabs.","evidence":["lib/auth/account-linking.ts:204 - getFunctions()/httpsCallable() raw call","lib/auth/account-linking.ts:329 - getFunctions()/httpsCallable() raw call"],"suggested_fix":{"steps":["1. Create callCloudFunction() helper (non-admin variant)","2. Replace raw calls in account-linking.ts","3. Ensure error handling matches service pattern"],"verification":["Zero raw httpsCallable() calls in account-linking.ts","Uses centralized callable helper"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Duplication","title":"Admin tabs bypass repository pattern for data access","fingerprint":"Duplication::components/admin::bypass_repository_pattern","severity":"S2","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx","components/admin/errors-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/jobs-tab.tsx","components/admin/logs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/analytics-tab.tsx"],"line":null,"why_it_matters":"9 admin tabs implement data fetching and CRUD operations inline instead of using the established repository pattern (lib/db/*.ts or lib/firestore-service.ts). Each tab independently manages Cloud Function calls, loading states, error handling, and data transformation. 7300+ lines of duplicated patterns.","evidence":["9 admin tabs with inline data access: users (2092), errors (1095), dashboard (1031), logs (730), jobs (625), privileges (600), analytics (457) lines","5 tabs already migrated to AdminCrudTable (proving pattern works)","lib/firestore-service.ts and lib/db/*.ts exist as canonical service layers"],"suggested_fix":{"steps":["1. Create admin service layer (lib/admin-api.ts) as intermediary","2. Gradually migrate each admin tab to use service layer","3. Start with simplest tabs (links, prayers) as proof of concept"],"verification":["All admin data access goes through service layer","Inline Cloud Function calls eliminated from components","Consistent loading/error patterns across all admin tabs"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Testing","title":"Test coverage unknown for admin features","fingerprint":"Testing::components/admin::unknown_coverage","severity":"S2","effort":"E2","confidence":40,"files":["components/admin/users-tab.tsx","components/admin/errors-tab.tsx","components/admin/dashboard-tab.tsx","functions/src/admin.ts"],"line":null,"why_it_matters":"SUSPECTED: Test coverage for admin features is unknown. The 33 admin Cloud Functions and 9 admin tab components may have minimal or no test coverage. Needs investigation to confirm coverage gaps and establish testing requirements.","evidence":["functions/src/admin.ts: 33 exported functions, test coverage unknown","9 admin tab components, test coverage unknown","No test files found matching admin patterns in initial search"],"suggested_fix":{"steps":["1. Run test coverage analysis for admin features","2. Identify critical paths lacking tests","3. Add integration tests for admin Cloud Functions","4. Add component tests for complex admin tabs"],"verification":["Test coverage metrics available for admin features","Critical paths have integration tests","Admin functions have at least happy-path tests"]},"acceptance_tests":["Verify fix applied correctly"]}
{"category":"Architecture","title":"SonarQube cognitive complexity unmeasured","fingerprint":"Architecture::analysis::sonarqube_unmeasured","severity":"S3","effort":"E1","confidence":40,"files":["components/admin/users-tab.tsx","components/admin/errors-tab.tsx","functions/src/admin.ts"],"line":null,"why_it_matters":"SUSPECTED: No SonarQube analysis found (no analysis/sonarqube-manifest.md). Cognitive complexity metrics for mega-components and the 4108-line admin.ts are unmeasured. Metrics would quantify refactoring priority and track improvement.","evidence":["No analysis/sonarqube-manifest.md found","admin.ts: 4108 lines, complexity unmeasured","users-tab.tsx: 2092 lines, 43 state hooks, complexity unmeasured","errors-tab.tsx: 1095 lines, complexity unmeasured"],"suggested_fix":{"steps":["1. Run SonarQube scan on codebase","2. Capture cognitive complexity metrics for identified mega-files","3. Set complexity thresholds for components and functions"],"verification":["SonarQube scan results available","Complexity metrics documented for priority files"]},"acceptance_tests":["Verify fix applied correctly"]}