{"category":"Security","title":"Sentry DSN, Firebase API key, and reCAPTCHA site key committed in .env.production","fingerprint":"Security::.env.production::NEXT_PUBLIC_SENTRY_DSN::secrets-in-env-production","severity":"S1","effort":"E1","confidence":100,"files":[".env.production"],"symbols":["NEXT_PUBLIC_SENTRY_DSN","NEXT_PUBLIC_FIREBASE_API_KEY","NEXT_PUBLIC_FIREBASE_APP_ID","NEXT_PUBLIC_FIREBASE_APPCHECK_RECAPTCHA_SITE_KEY"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"The .env.production file is checked into Git and contains the Sentry DSN (which allows sending arbitrary error data to your Sentry project), Firebase API key, App ID, reCAPTCHA site key, and messaging sender ID. While Firebase API keys are designed to be public and restricted via App Check/rules, the Sentry DSN allows anyone to send events to your Sentry project, consuming quota or polluting data. All these values are in version history permanently.","suggested_fix":"Move secrets to CI environment variables or GitHub Actions secrets. For Sentry DSN specifically, restrict the DSN via Sentry's inbound filter settings. Consider adding .env.production to .gitignore and using GitHub secrets for build-time injection.","acceptance_tests":["Verify .env.production is not committed in future pushes","Verify build still works with env vars injected at build time","Verify Sentry DSN is restricted via Sentry project settings"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":[".env.production lines 5-21: contains NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyDGvM5kFwkgSTUS..., NEXT_PUBLIC_SENTRY_DSN=https://f585a8353ec50d104e5484fedca6c2f2@..."],"notes":"Firebase API keys are restricted by App Check/Firestore rules, so exposure is low-risk. Sentry DSN is higher risk."}
{"category":"Security","title":"Hardcoded reCAPTCHA site key fallback in Cloud Functions","fingerprint":"Security::functions/src/recaptcha-verify.ts::verifyRecaptchaToken::hardcoded-recaptcha-key","severity":"S2","effort":"E0","confidence":100,"files":["functions/src/recaptcha-verify.ts"],"symbols":["verifyRecaptchaToken","RECAPTCHA_ACTIONS"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Line 66 has a hardcoded fallback: process.env.RECAPTCHA_SITE_KEY || '6LdeazosAAAAA...'. This makes key rotation difficult and creates environment confusion. If the env var is unset, the function silently uses the hardcoded key rather than failing closed.","suggested_fix":"Remove the hardcoded fallback. Fail closed with a clear error if RECAPTCHA_SITE_KEY is not set.","acceptance_tests":["Unset RECAPTCHA_SITE_KEY → function throws failed-precondition","Set RECAPTCHA_SITE_KEY → verification works normally"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":["functions/src/recaptcha-verify.ts:66 — const siteKey = process.env.RECAPTCHA_SITE_KEY || '6LdeazosAAAAAMDNCh1hTUDKh_UeS6xWY1-85B2O';"],"notes":"Previously identified in SEC-003/SEC-108 audits, still open."}
{"category":"Security","title":"App Check is entirely disabled on client and server","fingerprint":"Security::lib/firebase.ts::initializeFirebase::appcheck-disabled","severity":"S1","effort":"E2","confidence":100,"files":["lib/firebase.ts","functions/src/index.ts"],"symbols":["initializeFirebase","_appCheck","saveDailyLog"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"The entire App Check initialization block in lib/firebase.ts is commented out (lines 57-90), and server-side requireAppCheck is set to false. This means there is NO attestation layer verifying that requests come from your legitimate app. Any attacker can call your Cloud Functions directly using the public Firebase config. Disabled since Dec 31, 2025 — 5+ weeks past stated re-enable date.","suggested_fix":"Re-enable App Check on both client (lib/firebase.ts) and server (requireAppCheck: true in functions/src/index.ts). Test with debug token in development.","acceptance_tests":["App Check tokens are attached to Cloud Function calls","Requests without valid App Check tokens are rejected","Legitimate app usage still works"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":["lib/firebase.ts:57-90 — entire App Check block is /* commented out */","functions/src/index.ts — requireAppCheck: false"],"notes":""}
{"category":"Hygiene","title":"Dual hooks directories: hooks/ and lib/hooks/","fingerprint":"Hygiene::hooks/::lib/hooks/::dual-hooks-directories","severity":"S2","effort":"E1","confidence":95,"files":["hooks/use-journal.ts","hooks/use-daily-quote.ts","hooks/use-geolocation.ts","hooks/use-speech-recognition.ts"],"symbols":["useJournal","useDailyQuote","useGeolocation","useSpeechRecognition"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Hooks exist in both hooks/ (top-level) and lib/hooks/. This creates ambiguity about where to place new hooks and fragments the import paths.","suggested_fix":"Consolidate all hooks into hooks/ at top level. Update all imports.","acceptance_tests":["All hooks live in one directory","All imports compile correctly"],"pr_bucket_suggestion":"hooks-standardization","dependencies":[],"evidence":["hooks/ contains: use-daily-quote.ts, use-geolocation.ts, use-journal.ts, use-speech-recognition.ts","lib/hooks/ exists as a separate directory"],"notes":""}
{"category":"Hygiene","title":"Dual database directories: lib/database/ and lib/db/","fingerprint":"Hygiene::lib/database/::lib/db/::dual-db-directories","severity":"S2","effort":"E1","confidence":95,"files":["lib/database/","lib/db/"],"symbols":["COLLECTIONS","buildUserPath"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Two directories handle database-related utilities. Creates confusion about where to add new DB helpers.","suggested_fix":"Consolidate into a single lib/db/ directory.","acceptance_tests":["All DB helpers in one directory","No broken imports","Tests still pass"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["lib/database/ and lib/db/ both exist"],"notes":""}
{"category":"Types","title":"Dual type locations: types/ and lib/types/","fingerprint":"Types::types/::lib/types/::dual-type-directories","severity":"S3","effort":"E1","confidence":90,"files":["types/journal.ts","lib/types/"],"symbols":["JournalEntry","JournalEntryType","DailyLog"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Types are split between types/journal.ts at root and lib/types/ with additional type definitions like daily-log.ts. Fragmentation makes it hard to discover canonical type definitions.","suggested_fix":"Consolidate all client-side types into types/ directory.","acceptance_tests":["All client types in types/","No duplicate type definitions","TypeScript compilation succeeds"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["types/journal.ts exports JournalEntry, JournalEntryType","lib/types/ directory exists with additional type files"],"notes":""}
{"category":"Framework","title":"OfflineIndicator uses navigator.onLine in useState initializer without SSR guard","fingerprint":"Framework::components/status/offline-indicator.tsx::OfflineIndicator::ssr-navigator-access","severity":"S1","effort":"E0","confidence":100,"files":["components/status/offline-indicator.tsx"],"symbols":["OfflineIndicator"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Line 7: useState(() => navigator.onLine) — navigator is not available during SSR. This will throw ReferenceError: navigator is not defined.","suggested_fix":"Use a safe default: useState(true) and update in useEffect.","acceptance_tests":["Component renders without error during SSR","Online/offline detection works correctly in browser"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["components/status/offline-indicator.tsx:7 — const [isOnline, setIsOnline] = useState(() => navigator.onLine);"],"notes":""}
{"category":"Testing","title":"useDailyQuote test only checks module structure, not actual behavior","fingerprint":"Testing::tests/use-daily-quote.test.ts::useDailyQuote::weak-hook-test","severity":"S2","effort":"E1","confidence":100,"files":["tests/use-daily-quote.test.ts"],"symbols":["useDailyQuote","UseDailyQuoteResult"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"The test only verifies typeof useDailyQuote === 'function'. It never invokes the hook or tests its fetch/rotation/caching logic. Provides false confidence in test coverage.","suggested_fix":"Use React Testing Library to test: loading state, successful quote fetch, error handling, and quote rotation logic.","acceptance_tests":["Tests invoke the hook with mocked Firestore","Tests verify loading → loaded transitions","Tests verify error state handling"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["tests/use-daily-quote.test.ts — it('exports useDailyQuote hook function', () => { assert.strictEqual(typeof useDailyQuote, 'function'); })"],"notes":""}
{"category":"Testing","title":"secure-caller test only checks constants and types, not callSecureFunction behavior","fingerprint":"Testing::tests/secure-caller.test.ts::callSecureFunction::weak-type-only-test","severity":"S2","effort":"E1","confidence":100,"files":["tests/secure-caller.test.ts"],"symbols":["RECAPTCHA_ACTIONS","CallSecureFunctionOptions","SecureFunctionResult"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Tests only verify that constants equal expected string values and that TypeScript types can be instantiated. The actual callSecureFunction logic is never tested. This is a security-critical path with zero behavioral test coverage.","suggested_fix":"Add tests that mock reCAPTCHA token generation and httpsCallable to verify: successful call, rate limit handling, auth error handling, retry logic.","acceptance_tests":["callSecureFunction success path is tested","Error handling paths are tested","Rate limit errors produce correct user-facing messages"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["tests/secure-caller.test.ts: all describe blocks test constants and type shapes, never call the actual function"],"notes":""}
{"category":"Testing","title":"firestore-service test skips the primary saveDailyLog test","fingerprint":"Testing::tests/firestore-service.test.ts::saveDailyLog::skipped-test","severity":"S2","effort":"E1","confidence":100,"files":["tests/firestore-service.test.ts"],"symbols":["createFirestoreService","saveDailyLog"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"The saveDailyLog test has skip: 'Requires Firebase Cloud Functions - integration test'. The primary write path for the application has no unit test coverage.","suggested_fix":"Mock httpsCallable to test the client-side flow: rate limiting checks, reCAPTCHA token handling, error message extraction, retry logic.","acceptance_tests":["saveDailyLog test runs and passes without skip","Mock verifies httpsCallable is called with correct parameters","Error paths are covered"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["tests/firestore-service.test.ts:57-68 — test with skip annotation"],"notes":""}
{"category":"Debugging","title":"Production logger only sends errors to Sentry, drops warn and info","fingerprint":"Debugging::lib/logger.ts::log::production-warn-dropped","severity":"S2","effort":"E1","confidence":100,"files":["lib/logger.ts"],"symbols":["log","logger"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"In production, only level='error' is logged to console and Sentry. Warnings are completely silenced — rate limit warnings, deprecation notices, and degraded operation signals are invisible in production.","suggested_fix":"Send warn-level events to Sentry as breadcrumbs or to a structured log sink. At minimum, log warnings to production console.","acceptance_tests":["logger.warn() produces output in production","Sentry receives warning breadcrumbs","No sensitive data leaked in production logs"],"pr_bucket_suggestion":"misc","dependencies":[],"evidence":["lib/logger.ts:108-117 — dev/test only console","lib/logger.ts:120 — if (isProduction && level === 'error')"],"notes":""}
{"category":"Debugging","title":"No correlation IDs for request tracing across client and Cloud Functions","fingerprint":"Debugging::lib/firestore-service.ts::handleCloudFunctionCallError::no-correlation-id","severity":"S2","effort":"E2","confidence":85,"files":["lib/firestore-service.ts","functions/src/security-wrapper.ts","functions/src/security-logger.ts"],"symbols":["handleCloudFunctionCallError","withSecurityChecks","logSecurityEvent"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"When a Cloud Function call fails, there is no correlation ID linking the client-side error to the server-side security log. Debugging requires manual timestamp correlation.","suggested_fix":"Generate a requestId on the client (crypto.randomUUID()) and pass it in the Cloud Function data. Log the same ID on both sides.","acceptance_tests":["Client attaches requestId to Cloud Function calls","Server logs include the same requestId","Sentry events include requestId as a tag"],"pr_bucket_suggestion":"misc","dependencies":[],"evidence":["lib/firestore-service.ts: handleCloudFunctionCallError logs userId + error code but no requestId"],"notes":""}
{"category":"AICode","title":"Duplicate generateSearchableText implementations","fingerprint":"AICode::hooks/use-journal.ts::scripts/migrate-to-journal.ts::generateSearchableText::duplicate-implementation","severity":"S2","effort":"E1","confidence":100,"files":["hooks/use-journal.ts","scripts/migrate-to-journal.ts"],"symbols":["generateSearchableText"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"generateSearchableText is implemented in both hooks/use-journal.ts (client) and scripts/migrate-to-journal.ts (migration script) with similar but not identical switch/case logic","instances":[{"file":"hooks/use-journal.ts","symbol":"generateSearchableText"},{"file":"scripts/migrate-to-journal.ts","symbol":"generateSearchableText"}]},"why_it_matters":"Two separate implementations with different array handling. If a new entry type is added, both must be updated.","suggested_fix":"Extract generateSearchableText into lib/utils/searchable-text.ts and import in both locations.","acceptance_tests":["Single source of truth for generateSearchableText","Both consumers produce identical output for same inputs"],"pr_bucket_suggestion":"hooks-standardization","dependencies":[],"evidence":["hooks/use-journal.ts:89-138 uses sanitizeForSearch","scripts/migrate-to-journal.ts:195-230 uses isPrimitive filter"],"notes":"Classic AI code drift."}
{"category":"AICode","title":"color-sampler.tsx appears to be a dev/debugging tool committed to main","fingerprint":"AICode::components/color-sampler.tsx::ColorSampler::dev-tool-in-main","severity":"S3","effort":"E0","confidence":85,"files":["components/color-sampler.tsx","app/colors/"],"symbols":["ColorSampler"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"A 6.5KB color sampling/preview component with no user-facing purpose in the production app.","suggested_fix":"Move to a dev-only route guard or remove from production build.","acceptance_tests":["Component not accessible in production or explicitly marked as dev-only"],"pr_bucket_suggestion":"misc","dependencies":[],"evidence":["components/color-sampler.tsx: 6577 bytes"],"notes":""}
{"category":"Framework","title":"Massive use-journal.ts hook (438 lines) handling too many concerns","fingerprint":"Framework::hooks/use-journal.ts::useJournal::god-hook","severity":"S2","effort":"E2","confidence":90,"files":["hooks/use-journal.ts"],"symbols":["useJournal","generateSearchableText","generateTags","sanitizeForSearch","getRelativeDateLabel"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"At 438 lines, use-journal.ts combines 7+ concerns: date formatting, XSS sanitization, searchable text generation, tag generation, real-time Firestore subscription, Cloud Function calls, error handling, and retry logic. Violates single-responsibility.","suggested_fix":"Extract into focused modules: lib/utils/searchable-text.ts, lib/utils/date-label.ts, lib/utils/sanitize.ts. Keep the hook thin.","acceptance_tests":["Hook under 200 lines","Utility functions independently testable","Existing functionality unchanged"],"pr_bucket_suggestion":"hooks-standardization","dependencies":["AICode::hooks/use-journal.ts::scripts/migrate-to-journal.ts::generateSearchableText::duplicate-implementation"],"evidence":["hooks/use-journal.ts: 438 lines, 16608 bytes"],"notes":""}