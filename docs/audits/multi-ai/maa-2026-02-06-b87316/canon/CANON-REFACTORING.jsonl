{"category":"Hygiene/Duplication","title":"Direct Firestore SDK reads in UI/components bypass typed db/services","fingerprint":"Hygiene/Duplication::components/admin/admin-crud-table.tsx::AdminCrudTable::direct-firestore-reads-in-ui","severity":"S1","effort":"E2","confidence":92,"files":["components/admin/admin-crud-table.tsx","components/dev/lighthouse-tab.tsx","components/growth/DailySloganWidget.tsx","components/notebook/pages/today-page.tsx","hooks/use-journal.ts","lib/db/collections.ts"],"symbols":["AdminCrudTable","LighthouseTab","DailySloganWidget","TodayPage","useJournal","collectionRef"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Multiple UI modules directly call Firestore SDK (collection/query/getDocs/onSnapshot) and manually map docs, despite having typed collection helpers (lib/db/collections.ts) and db service modules. This creates drift in query patterns, error handling, and type safety.","instances":[{"file":"components/admin/admin-crud-table.tsx","symbol":"AdminCrudTable"},{"file":"components/dev/lighthouse-tab.tsx","symbol":"LighthouseTab"},{"file":"components/growth/DailySloganWidget.tsx","symbol":"DailySloganWidget"},{"file":"components/notebook/pages/today-page.tsx","symbol":"TodayPage"},{"file":"hooks/use-journal.ts","symbol":"useJournal"}],"consolidation_target":"lib/db/* services + lib/db/collections.ts (create small repo-layer functions per feature and have UI call those)"},"why_it_matters":"Firestore access scattered across UI increases duplication and makes behavior inconsistent (query limits, mapping, validation, error logging). It also makes refactors (schema/paths/security) harder and riskier.","suggested_fix":"Introduce feature-scoped repo/service functions (e.g., lib/db/dev-lighthouse.ts, lib/db/slogans.ts usage from widgets) that encapsulate Firestore reads, mapping, and validation. UI components should consume services/hooks only and stop importing firebase/firestore directly.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["components/admin/admin-crud-table.tsx:60-66 uses collection(db, config.collectionName) + getDocs","components/dev/lighthouse-tab.tsx:63-72 uses collection(db,'dev','lighthouse','history') + getDocs","components/growth/DailySloganWidget.tsx:23-29 uses collection(db,'slogans') + getDocs","components/notebook/pages/today-page.tsx:710+ dynamic import firebase/firestore then collection(db, users/${user.uid}/daily_logs)","hooks/use-journal.ts:270-305 uses collection(db, users/${user.uid}/journal) + onSnapshot"],"notes":"This is a cross-cutting boundary issue too (UI vs data layer).","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Hygiene/Duplication::components/admin/admin-crud-table.tsx::AdminCrudTable::direct-firestore-reads-in-ui"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0001","status":"CONFIRMED"}
{"category":"Architecture/Boundaries","title":"TodayPage is a high-complexity god-component mixing UI, Firestore queries, debug logging, and analytics","fingerprint":"Architecture/Boundaries::components/notebook/pages/today-page.tsx::TodayPage::god-component-split","severity":"S1","effort":"E3","confidence":85,"files":["components/notebook/pages/today-page.tsx"],"symbols":["TodayPage","calculateWeeklyStats"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Large multi-responsibility components accumulate cognitive complexity quickly and become the hardest places to safely refactor. They also encourage ad-hoc patterns (dynamic imports, console logs, direct SDK calls) that spread.","suggested_fix":"Extract Firestore query + mapping into a small lib/db module (daily logs repo) and extract weekly stats computation into a dedicated hook (useWeeklyStats). Strip dev-only console logging behind a single debug helper or remove entirely. Break TodayPage into subcomponents (StatsHeader, LogEditor, etc.).","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["components/notebook/pages/today-page.tsx exports default function TodayPage(...)","components/notebook/pages/today-page.tsx:~710+ calculateWeeklyStats dynamically imports firebase/firestore then runs queries and extensive console debugging"],"notes":"Even without Sonar data, this file clearly exceeds the repo's typical complexity envelope.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Architecture/Boundaries::components/notebook/pages/today-page.tsx::TodayPage::god-component-split"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0002","status":"CONFIRMED"}
{"category":"Security Hardening","title":"Error logging inconsistent: many call sites log raw error objects instead of sanitized errorType/errorCode","fingerprint":"Security/Hardening::components/growth/DailySloganWidget.tsx::DailySloganWidget::raw-error-logging-drift","severity":"S1","effort":"E2","confidence":88,"files":["app/admin/page.tsx","app/meetings/all/page.tsx","components/admin/analytics-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/errors-tab.tsx","components/admin/jobs-tab.tsx","components/admin/links-tab.tsx","components/admin/logs-tab.tsx","components/admin/prayers-tab.tsx","components/auth/sign-in-modal.tsx","components/growth/DailySloganWidget.tsx","components/growth/GratitudeCard.tsx","components/growth/NightReviewCard.tsx","components/growth/SpotCheckCard.tsx","components/growth/Step1WorksheetCard.tsx","components/journal/entry-forms/daily-log-form.tsx","components/journal/entry-forms/free-write-form.tsx","components/journal/entry-forms/gratitude-form.tsx","components/journal/entry-forms/inventory-form.tsx","components/journal/entry-forms/mood-form.tsx","components/journal/entry-wizard.tsx","components/journal/journal-hub.tsx","components/notebook/journal-modal.tsx","components/notebook/notebook-shell.tsx","components/notebook/pages/library-page.tsx","components/notebook/pages/resources-page.tsx","components/widgets/compact-meeting-countdown.tsx","hooks/use-speech-recognition.ts","lib/db/library.ts","lib/db/meetings.ts","lib/utils/retry.ts"],"symbols":["AdminPage","AllMeetingsPage","AnalyticsTab","DashboardTab","ErrorsTab","JobsTab","LinksTab","LogsTab","PrayersTab","SignInModal","DailySloganWidget","GratitudeCard","NightReviewCard","SpotCheckCard","Step1WorksheetCard","DailyLogForm","FreeWriteForm","GratitudeForm","InventoryForm","MoodForm","EntryWizard","JournalHub","JournalModal","NotebookShell","LibraryPage","ResourcesPage","CompactMeetingCountdown","useSpeechRecognition","getAllQuickLinks","MeetingsService","retryWithBackoff"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Many modules call logger.error(..., { error }) or logger.error(..., { error: err }) which can leak raw error objects (PII/stack traces/SDK internals), while other code follows a sanitized pattern (errorType/errorCode).","instances":[{"file":"app/admin/page.tsx","symbol":"AdminPage"},{"file":"components/growth/DailySloganWidget.tsx","symbol":"DailySloganWidget"},{"file":"components/admin/dashboard-tab.tsx","symbol":"DashboardTab"}],"consolidation_target":"lib/logger.ts (add logger.safeError / helper to normalize errorType+errorCode and forbid raw error payloads)"},"why_it_matters":"Raw error objects can contain sensitive metadata and are inconsistent with the repo's own CANON guidance. Consolidation reduces security/PII risk and keeps observability consistent.","suggested_fix":"Create a single helper (e.g., logErrorSafe(message, err, context)) that extracts errorType/errorCode and optionally masks identifiers. Replace all {error}/{error:err} callsites via codemod/grep-driven edits.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":["components/growth/DailySloganWidget.tsx:38 logger.error('Error fetching daily slogan', { error })","components/admin/dashboard-tab.tsx multiple logger.error(...,{ error: err })","components/journal/* forms logger.error(...,{ error })"],"notes":"Some admin/dev logs may be acceptable internally, but consolidating still improves predictability.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Security/Hardening::components/growth/DailySloganWidget.tsx::DailySloganWidget::raw-error-logging-drift"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0003","status":"CONFIRMED"}
{"category":"Hygiene/Duplication","title":"Cloud Function calling patterns duplicated despite existing secure-caller abstraction","fingerprint":"Hygiene/Duplication::lib/utils/secure-caller.ts::createSecureFunctionCaller::bypass-secure-caller","severity":"S1","effort":"E2","confidence":89,"files":["components/admin/admin-crud-table.tsx","components/admin/analytics-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/errors-tab.tsx","components/admin/jobs-tab.tsx","components/admin/logs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/users-tab.tsx","hooks/use-journal.ts","lib/auth/account-linking.ts","lib/firestore-service.ts","lib/utils/secure-caller.ts"],"symbols":["AdminCrudTable","AnalyticsTab","DashboardTab","ErrorsTab","JobsTab","LogsTab","PrivilegesTab","UsersTab","useJournal","linkWithEmail","linkWithGoogle","createFirestoreService","createSecureFunctionCaller"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Many call sites directly use getFunctions()+httpsCallable() even though lib/utils/secure-caller.ts exists to standardize retries, recaptcha, and result shaping.","instances":[{"file":"components/admin/users-tab.tsx","symbol":"UsersTab"},{"file":"hooks/use-journal.ts","symbol":"useJournal"},{"file":"lib/auth/account-linking.ts","symbol":"linkWithEmail"},{"file":"lib/firestore-service.ts","symbol":"createFirestoreService"}],"consolidation_target":"lib/utils/secure-caller.ts (wrap all callable usage)"},"why_it_matters":"Duplicated callable wiring increases inconsistency in retries, error normalization, auth/context, and security. It also bloats UI components and makes changes expensive.","suggested_fix":"Adopt secure-caller as the only supported path: create per-function typed wrappers built from createSecureFunctionCaller. Migrate admin tabs and hooks to call wrappers rather than httpsCallable directly.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["grep httpsCallable hits include components/admin/, hooks/use-journal.ts, lib/auth/account-linking.ts, lib/firestore-service.ts","lib/utils/secure-caller.ts defines createSecureFunctionCaller and documents standardized usage"],"notes":"Admin-only screens may keep custom behavior, but should still reuse the shared caller.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Hygiene/Duplication::lib/utils/secure-caller.ts::createSecureFunctionCaller::bypass-secure-caller"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0004","status":"CONFIRMED"}
{"category":"Duplication","title":"Admin API service missing: 30+ getFunctions()/httpsCallable() inline calls","fingerprint":"Duplication::components/admin::admin_api_service_missing","severity":"S1","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/errors-tab.tsx","components/admin/jobs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/admin-crud-table.tsx","components/admin/analytics-tab.tsx","components/admin/logs-tab.tsx","components/admin/links-tab.tsx","components/admin/prayers-tab.tsx","components/admin/meetings-tab.tsx","lib/auth/account-linking.ts"],"line":145,"description":"30+ getFunctions()/httpsCallable() calls scattered across 12 files. Every admin tab independently initializes Firebase Functions with identical boilerplate. users-tab.tsx alone has 10 instances. This is the #1 blocker for admin maintainability — adding a new admin endpoint requires duplicating boilerplate in 9+ files.","evidence":["components/admin/users-tab.tsx: 10 instances (lines 145, 164, 177, 190, 206, 218, 230, 245, 258, 270)","components/admin/dashboard-tab.tsx: 5 instances (lines 731, 754, 780, 806, 832)","components/admin/errors-tab.tsx: 3 instances (lines 331, 542, 774)","components/admin/jobs-tab.tsx: 3 instances (lines 184, 517, 545)","components/admin/privileges-tab.tsx: 3 instances (lines 87, 166, 213)","components/admin/admin-crud-table.tsx: 2 instances (lines 147, 193)","components/admin/analytics-tab.tsx: 1 instance (line 272)","components/admin/logs-tab.tsx: 1 instance (line 392)","lib/auth/account-linking.ts: 2 instances (lines 204, 329)"],"remediation":{"steps":["1. Create lib/admin-api.ts with typed AdminApiClient class following lib/firestore-service.ts pattern","2. Centralize getFunctions() initialization, error handling, retry logic, rate limiting","3. Replace all 30+ raw calls with AdminApiClient methods","4. Add centralized logging and telemetry"],"verification":["Zero raw getFunctions()/httpsCallable() calls in component files","All admin tabs use AdminApiClient","Centralized error handling and retry logic"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Duplication::components/admin::admin_api_service_missing"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0005","status":"CONFIRMED"}
{"category":"Complexity","title":"users-tab.tsx mega-component: 2092 lines, 43 state hooks","fingerprint":"Complexity::components/admin/users-tab.tsx::mega_component","severity":"S1","effort":"E3","confidence":100,"files":["components/admin/users-tab.tsx"],"line":1,"description":"users-tab.tsx at 2092 lines with 43 state hooks is the largest admin component. Contains user search, detail view, editing, status management, and 10 separate Cloud Function calls all inline. Untestable and risky to modify.","evidence":["components/admin/users-tab.tsx: 2092 lines","43 useState hooks","10 separate getFunctions()/httpsCallable() calls","User search, detail view, editing, status management all inline"],"remediation":{"steps":["1. Extract UserSearchPanel, UserDetailPanel, UserEditForm sub-components","2. Create useAdminUsers custom hook for Cloud Function calls","3. Adopt AdminApiClient (after admin API service created)","4. Target <300 lines for main component"],"verification":["users-tab.tsx under 300 lines","Each panel is independent testable component","43 state hooks distributed across sub-components"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Complexity::components/admin/users-tab.tsx::mega_component"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0006","status":"CONFIRMED"}
{"category":"Complexity","title":"errors-tab.tsx mega-component: 1095 lines","fingerprint":"Complexity::components/admin/errors-tab.tsx::mega_component","severity":"S1","effort":"E2","confidence":100,"files":["components/admin/errors-tab.tsx"],"line":1,"description":"errors-tab.tsx at 1095 lines with high complexity. Contains error listing, filtering, detail views, and 3 Cloud Function calls inline. Should be decomposed into focused sub-components.","evidence":["components/admin/errors-tab.tsx: 1095 lines","3 getFunctions()/httpsCallable() instances (lines 331, 542, 774)","High complexity rating"],"remediation":{"steps":["1. Extract ErrorListPanel, ErrorDetailPanel, ErrorFilterPanel sub-components","2. Create useAdminErrors custom hook","3. Target <300 lines for main component"],"verification":["errors-tab.tsx under 300 lines","Sub-components are independently testable"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Complexity::components/admin/errors-tab.tsx::mega_component"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0007","status":"CONFIRMED"}
{"category":"Duplication","title":"admin.ts Mega-File: 33 Cloud Functions with identical boilerplate","fingerprint":"Duplication::functions/src/admin.ts::mega_file_boilerplate","severity":"S1","effort":"E3","confidence":100,"files":["functions/src/admin.ts","functions/src/security-wrapper.ts"],"line":1,"description":"4108-line file with 33 Cloud Functions all following identical pattern: requireAdmin → Zod validate in try/catch → Firestore operation in try/catch → logSecurityEvent. security-wrapper.ts provides withSecurityChecks() used 9× in index.ts but 0× in admin.ts. Every function manually reimplements the same auth/validation/logging boilerplate.","evidence":["functions/src/admin.ts: 4108 lines, 33 exported Cloud Functions","functions/src/security-wrapper.ts: withSecurityChecks() used 9× in index.ts, 0× in admin.ts","All 33 instances: adminSaveMeeting, adminDeleteMeeting, adminSaveSoberLiving, adminDeleteSoberLiving, adminSaveQuote, adminDeleteQuote, adminHealthCheck, adminGetDashboardStats, adminSearchUsers, adminGetUserDetail, adminUpdateUser, adminDisableUser, adminSoftDeleteUser, adminUndeleteUser, adminTriggerJob, adminGetJobsStatus, adminGetJobRunHistory, adminGetSentryErrorSummary, adminGetLogs, adminGetErrorsWithUsers, adminGetUserActivityByHash, adminFindUserByHash, adminGetPrivilegeTypes, adminSavePrivilegeType, adminDeletePrivilegeType, adminSetUserPrivilege, adminListUsers, adminSendPasswordReset, adminGetStorageStats, adminGetRateLimitStatus, adminClearRateLimit, adminGetCollectionStats, adminGetUserAnalytics"],"remediation":{"steps":["1. Create withAdminChecks() wrapper in security-wrapper.ts (extends withSecurityChecks with requireAdmin)","2. Split admin.ts into domain modules: admin-meetings.ts, admin-users.ts, admin-jobs.ts, admin-analytics.ts, admin-privileges.ts, admin-system.ts","3. Migrate each function to use withAdminChecks() wrapper","4. Target ~400 lines per module"],"verification":["Each admin function uses withAdminChecks() wrapper","No manual requireAdmin/try-catch boilerplate remains","All admin functions pass existing tests"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Duplication::functions/src/admin.ts::mega_file_boilerplate"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0008","status":"CONFIRMED"}
{"category":"Duplication","title":"getFunctions()/httpsCallable() boilerplate in 10 files","fingerprint":"Duplication::components/admin::httpsCallable_boilerplate","severity":"S1","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/errors-tab.tsx","components/admin/jobs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/analytics-tab.tsx","components/admin/logs-tab.tsx","components/admin/admin-crud-table.tsx","hooks/use-journal.ts"],"line":null,"description":"28 raw getFunctions()/httpsCallable() calls scattered across 10 files. Every admin tab independently initializes Firebase Functions with identical boilerplate: const functions = getFunctions(); const fn = httpsCallable<Req, Res>(functions, 'functionName'). users-tab.tsx alone has 10 such calls.","evidence":["users-tab.tsx: 10 getFunctions() calls","dashboard-tab.tsx: 5 getFunctions() calls","errors-tab.tsx: 3 getFunctions() calls","jobs-tab.tsx: 3 getFunctions() calls","privileges-tab.tsx: 3 getFunctions() calls","analytics-tab.tsx: 1 getFunctions() call","logs-tab.tsx: 1 getFunctions() call","admin-crud-table.tsx: 2 getFunctions() calls","use-journal.ts: 2 getFunctions() calls"],"remediation":{"steps":["1. Create callAdminFunction<Req, Res>(name, data) helper that encapsulates getFunctions + httpsCallable + error handling","2. Create callCloudFunction<Req, Res>(name, data) variant for non-admin functions","3. Incrementally replace raw calls across all files"],"verification":["Zero raw getFunctions()/httpsCallable() calls remain in component files","All admin tabs use callAdminFunction() helper","use-journal.ts uses callCloudFunction() helper"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Duplication::components/admin::httpsCallable_boilerplate"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0009","status":"CONFIRMED"}
{"category":"Architecture","title":"Triple data access layer: 3 overlapping Firestore patterns","fingerprint":"Architecture::lib::triple_data_access_layer","severity":"S1","effort":"E3","confidence":100,"files":["lib/firestore-service.ts","lib/database/firestore-adapter.ts","lib/db/meetings.ts","lib/db/library.ts","lib/db/glossary.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts"],"line":null,"description":"Three overlapping Firestore access patterns coexist: (1) FirestoreService in lib/firestore-service.ts (476 lines) handles daily logs, inventory, journal; (2) FirestoreAdapter in lib/database/firestore-adapter.ts overlaps with daily logs; (3) Per-entity services in lib/db/*.ts (7 modules) handle meetings, quotes, slogans, glossary, etc. No clear canonical path for data access.","evidence":["lib/firestore-service.ts: 476 lines, handles daily logs + inventory + journal","lib/database/firestore-adapter.ts: overlaps with FirestoreService on daily logs","lib/db/*.ts: 7 separate modules (meetings, library, glossary, quotes, slogans, sober-living, collections)","Components import from different layers depending on which entity they need"],"remediation":{"steps":["1. Migrate FirestoreService methods into appropriate lib/db/ modules","2. Deprecate and remove FirestoreAdapter (functionality absorbed by lib/db/)","3. Establish lib/db/ as the single canonical data access layer","4. Update all component imports to use lib/db/ exclusively"],"verification":["FirestoreService removed or reduced to re-exports from lib/db/","FirestoreAdapter removed entirely","All data access goes through lib/db/ modules","No overlapping functionality between modules"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Architecture::lib::triple_data_access_layer"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0010","status":"CONFIRMED"}
{"category":"Security","title":"admin functions use weaker security checks than user-facing functions","fingerprint":"Security::functions/src/admin.ts::weak_admin_checks","severity":"S1","effort":"E2","confidence":100,"files":["functions/src/admin.ts","functions/src/security-wrapper.ts","functions/src/index.ts"],"line":null,"description":"User-facing functions in index.ts use withSecurityChecks() which enforces App Check, reCAPTCHA, rate limiting, and Zod validation. Admin functions in admin.ts use manual requireAdmin() + ad-hoc try/catch, missing standardized rate limiting and App Check enforcement. Admin endpoints should have equal or stronger security, not weaker.","evidence":["functions/src/index.ts: 9 functions use withSecurityChecks() with full security stack","functions/src/admin.ts: 33 functions use manual requireAdmin() without withSecurityChecks()","admin.ts functions lack standardized rate limiting pattern","admin.ts functions lack App Check enforcement"],"remediation":{"steps":["1. Create withAdminChecks() in security-wrapper.ts extending withSecurityChecks() with admin role verification","2. Migrate all 33 admin functions to use withAdminChecks()","3. Ensure admin rate limiting is at least as strict as user-facing functions"],"verification":["All admin functions use withAdminChecks() wrapper","Admin functions enforce App Check and rate limiting","No manual requireAdmin() calls remain outside wrapper"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Security::functions/src/admin.ts::weak_admin_checks"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0011","status":"CONFIRMED"}
{"category":"Hygiene/Duplication","title":"Cloud Function call boilerplate not migrated to callSecureFunction()","fingerprint":"Hygiene/Duplication::lib/firestore-service.ts::saveDailyLog::cf-call-boilerplate-not-migrated","severity":"S1","effort":"E2","confidence":95,"files":["lib/firestore-service.ts","hooks/use-journal.ts","lib/auth/account-linking.ts","lib/utils/secure-caller.ts"],"symbols":["saveDailyLog","saveInventoryEntry","saveNotebookJournalEntry","addEntry","crumplePage","linkEmailPassword","linkWithGoogle","callSecureFunction"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"7+ call sites repeat the same 4-step pattern: getRecaptchaToken -> dynamic import firebase/functions -> getFunctions()/httpsCallable() -> retryCloudFunction(). The canonical wrapper callSecureFunction() already exists in lib/utils/secure-caller.ts but is unused.","instances":[{"file":"lib/firestore-service.ts","symbol":"saveDailyLog"},{"file":"lib/firestore-service.ts","symbol":"saveInventoryEntry"},{"file":"lib/firestore-service.ts","symbol":"saveNotebookJournalEntry"},{"file":"hooks/use-journal.ts","symbol":"addEntry"},{"file":"hooks/use-journal.ts","symbol":"crumplePage"},{"file":"lib/auth/account-linking.ts","symbol":"linkEmailPassword"},{"file":"lib/auth/account-linking.ts","symbol":"linkWithGoogle"}],"consolidation_target":"lib/utils/secure-caller.ts (callSecureFunction)"},"why_it_matters":"The consolidation target already exists but isn't adopted. Every new Cloud Function call copies the boilerplate pattern instead of using the wrapper, compounding inconsistency and making reCAPTCHA/retry behavior changes require 7+ edits.","suggested_fix":"Migrate all 7 call sites to use callSecureFunction() or createSecureFunctionCaller() from lib/utils/secure-caller.ts. Remove inline dynamic imports of firebase/functions.","acceptance_tests":["npm run lint","npm test","All Cloud Function operations still work end-to-end"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["lib/firestore-service.ts: dynamic import 'firebase/functions' at lines ~188, ~378, ~434","hooks/use-journal.ts: getFunctions()/httpsCallable() at lines ~352, ~402","lib/auth/account-linking.ts: dynamic import 'firebase/functions' at lines ~213, ~335","lib/utils/secure-caller.ts: callSecureFunction() defined but 0 import references in production code"],"notes":"CANON-0076 from prior audits. The secure-caller.ts was created as the fix but adoption was never completed.","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Hygiene/Duplication::lib/firestore-service.ts::saveDailyLog::cf-call-boilerplate-not-migrated"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0012","status":"CONFIRMED"}
{"category":"Types/Correctness","title":"JournalEntryType string literals defined in 4+ locations without single source of truth","fingerprint":"Types/Correctness::types/journal.ts::JournalEntryType::entry-type-scattered","severity":"S1","effort":"E1","confidence":90,"files":["types/journal.ts","functions/src/schemas.ts","lib/firestore-service.ts","components/journal/entry-creator-menu.tsx"],"symbols":["JournalEntryType","journalEntrySchema","inventoryEntrySchema","saveNotebookJournalEntry","saveInventoryEntry"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"The 10 journal entry type strings are defined as a TypeScript union in types/journal.ts, a Zod enum in functions/src/schemas.ts, inline string literals in firestore-service.ts methods, and a subset literal in entry-creator-menu.tsx. No compile-time link between client and functions packages.","instances":[{"file":"types/journal.ts","symbol":"JournalEntryType"},{"file":"functions/src/schemas.ts","symbol":"journalEntrySchema.type"},{"file":"lib/firestore-service.ts","symbol":"saveNotebookJournalEntry"},{"file":"components/journal/entry-creator-menu.tsx","symbol":"onSelectType"}],"consolidation_target":"types/journal.ts should be the single source. Zod enum in schemas.ts should derive from it."},"why_it_matters":"Adding a new entry type requires finding and updating 4-6 files manually. Forgetting one creates silent runtime failures where server rejects valid client data or client sends data the server doesn't handle.","suggested_fix":"Export JOURNAL_ENTRY_TYPES const array from types/journal.ts. Derive the TypeScript type and Zod enum from it.","acceptance_tests":["npm run lint","npx tsc --noEmit"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["types/journal.ts:1-11 defines JournalEntryType with 10 literals","functions/src/schemas.ts:20-31 repeats the same 10 literals in z.enum()","lib/firestore-service.ts:~409-420 repeats subset inline","components/journal/entry-creator-menu.tsx:10 uses hardcoded subset"],"notes":"CANON-0067 from prior audits.","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Types/Correctness::types/journal.ts::JournalEntryType::entry-type-scattered"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0013","status":"CONFIRMED"}
{"category":"Architecture/Boundaries","title":"functions/src/admin.ts is 136KB — critical god file","fingerprint":"Architecture/Boundaries::functions/src/admin.ts::admin::god-file-136kb","severity":"S1","effort":"E3","confidence":95,"files":["functions/src/admin.ts"],"symbols":["admin"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"At 136KB, this is likely 3000-4000 lines. Any change risks merge conflicts. Testing, reviewing, and reasoning about this file is extremely difficult. Cold start time for Cloud Functions is proportional to bundle size.","suggested_fix":"Split into domain-specific modules: admin-users.ts, admin-meetings.ts, admin-content.ts, etc. Re-export from admin/index.ts.","acceptance_tests":["npm run build (in functions/)","All admin operations work end-to-end"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["functions/src/admin.ts has size 136418 bytes per GitHub API"],"notes":"Single highest-impact architecture improvement available.","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Architecture/Boundaries::functions/src/admin.ts::admin::god-file-136kb"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0014","status":"CONFIRMED"}
{"category":"Security Hardening","title":"App Check still disabled since Dec 2025","fingerprint":"Security Hardening::lib/firebase.ts::initializeFirebase::appcheck-disabled","severity":"S1","effort":"E2","confidence":98,"files":["lib/firebase.ts"],"symbols":["initializeFirebase","_appCheck"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"App Check prevents unauthorized API usage and bot attacks on Cloud Functions. Disabled 2+ months past stated re-enable date. All Cloud Functions unprotected from non-app callers.","suggested_fix":"Re-enable App Check initialization in lib/firebase.ts. Ensure all Cloud Functions have requireAppCheck: true. Test with debug tokens in dev.","acceptance_tests":["App Check initialized on client load","Cloud Functions reject calls without valid App Check tokens"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":["lib/firebase.ts:57-90 shows entire App Check block commented out","Comment says 'TEMPORARILY DISABLED' with Dec 31 date","Current date is Feb 2026"],"notes":"CANON-0002 from prior audits. Single highest-priority security item.","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Security Hardening::lib/firebase.ts::initializeFirebase::appcheck-disabled"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0015","status":"CONFIRMED"}
{"category":"Security","title":"Inconsistent secure callable usage: httpsCallable bypasses secure-caller wrapper","fingerprint":"Security::hooks/use-journal.ts::httpsCallable_bypass_secure_caller","severity":"S1","effort":"E2","confidence":90,"files":["hooks/use-journal.ts","lib/auth/account-linking.ts","lib/firestore-service.ts","lib/utils/secure-caller.ts"],"line":null,"description":"Direct httpsCallable usage exists in hooks/use-journal.ts, lib/auth/account-linking.ts, and lib/firestore-service.ts, bypassing the centralized secure-caller wrapper (lib/utils/secure-caller.ts) which handles error normalization, retries, and security logging.","evidence":["hooks/use-journal.ts: uses httpsCallable directly instead of secureCall wrapper","lib/auth/account-linking.ts: direct httpsCallable usage","lib/firestore-service.ts: direct httpsCallable usage","lib/utils/secure-caller.ts: defines createSecureFunctionCaller but is not universally adopted"],"remediation":{"steps":["1. Refactor hooks/use-journal.ts to use secureCall() wrapper for all Cloud Function calls","2. Refactor lib/firestore-service.ts to use secureCall() wrapper","3. Refactor lib/auth/account-linking.ts to use secureCall() wrapper","4. Ensure all httpsCallable usage goes through secure-caller"],"verification":["Zero direct httpsCallable() calls outside of secure-caller.ts","All Cloud Function invocations use centralized wrapper"]},"acceptance_tests":["Verify fix applied correctly"],"sources":[{"source":"jules","file":"refactoring-jules.jsonl","original_fingerprint":"Security::hooks/use-journal.ts::httpsCallable_bypass_secure_caller"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0016","status":"CONFIRMED"}
{"category":"Duplication","title":"Toast error handling duplicated: 55+ try-catch blocks across admin tabs","fingerprint":"Duplication::components/admin::toast_error_handling","severity":"S2","effort":"E2","confidence":70,"files":["components/admin/users-tab.tsx","components/admin/links-tab.tsx","components/admin/prayers-tab.tsx","components/admin/errors-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/jobs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/analytics-tab.tsx","components/admin/logs-tab.tsx"],"line":null,"description":"55+ similar try/catch blocks with toast.error() scattered across 9 admin tabs. Each implements error handling independently with inconsistent error messages. No centralized error telemetry. 55+ locations to update if error handling pattern changes.","evidence":["components/admin/users-tab.tsx: 55 try-catch blocks","components/admin/links-tab.tsx: 5 toast.error calls (lines 68, 110, 124, 139, 151)","components/admin/prayers-tab.tsx: 5 toast.error calls (lines 64, 104, 118, 133, 145)","All other admin tabs have similar patterns","Multiple admin tabs with independent error handling implementations","No shared error handling hook or utility across admin tabs"],"remediation":{"steps":["1. Create lib/utils/admin-error-handler.ts with handleAdminApiError(error, operation)","2. Embed in AdminApiClient if Finding #1 implemented","3. Standardize error message format and telemetry"],"verification":["All admin error handling uses centralized handler","Consistent error messages across all admin tabs","Centralized telemetry for admin errors"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Duplication::components/admin::toast_error_handling"},{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Consistency::components/admin::inconsistent_error_handling"}],"merged_from":["Duplication::components/admin::toast_error_handling","Consistency::components/admin::inconsistent_error_handling"],"verified":true,"consensus_score":2.5,"canonical_id":"CANON-0017","status":"CONFIRMED"}
{"category":"Hygiene/Duplication","title":"Repeated Firestore snapshot.docs.map -> {id,...data} casting patterns","fingerprint":"Hygiene/Duplication::lib/db/meetings.ts::MeetingsService::snapshot-doc-mapping-dup","severity":"S2","effort":"E1","confidence":90,"files":["components/admin/admin-crud-table.tsx","components/growth/DailySloganWidget.tsx","lib/db/glossary.ts","lib/db/meetings.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts"],"symbols":["AdminCrudTable","DailySloganWidget","getGlossaryTerms","MeetingsService","getQuotes","SlogansService","SoberLivingService"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Multiple modules map Firestore query snapshots into typed objects by spreading doc.data() and injecting id, then casting (as T / as Slogan / as Meeting...). This is repeated and inconsistent (sometimes id last, sometimes first).","instances":[{"file":"components/admin/admin-crud-table.tsx","symbol":"AdminCrudTable"},{"file":"components/growth/DailySloganWidget.tsx","symbol":"DailySloganWidget"},{"file":"lib/db/glossary.ts","symbol":"getGlossaryTerms"},{"file":"lib/db/meetings.ts","symbol":"MeetingsService"},{"file":"lib/db/quotes.ts","symbol":"getQuotes"},{"file":"lib/db/slogans.ts","symbol":"SlogansService"},{"file":"lib/db/sober-living.ts","symbol":"SoberLivingService"}],"consolidation_target":"lib/db/firestore-mappers.ts (e.g., mapDocWithId<T>(doc) + optional zod decode)"},"why_it_matters":"This pattern is a long-term correctness trap: schema changes, missing fields, or Timestamp/date conversions will break silently behind type casts. Consolidating allows consistent runtime validation and safer typing.","suggested_fix":"Add a small shared mapper that takes a QueryDocumentSnapshot and returns {id,...data} with optional zod schema decode. Replace local snapshot.docs.map casts with the shared helper.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["lib/db/glossary.ts:28 snapshot.docs.map((doc)=>({id:doc.id,...doc.data()})) as GlossaryTerm","lib/db/quotes.ts:35 snapshot.docs.map((doc)=>({id:doc.id,...doc.data()})) as Quote","lib/db/slogans.ts:41 snapshot.docs.map((d)=>({id:d.id,...d.data()})) as Slogan","lib/db/sober-living.ts:33 snapshot.docs.map((doc)=>({id:doc.id,...doc.data()})) as SoberLivingHome","components/growth/DailySloganWidget.tsx:27 snapshot.docs.map((d)=>({id:d.id,...d.data()})) as Slogan","components/admin/admin-crud-table.tsx:62 snapshot.docs.map((d)=>({id:d.id,...d.data()})) as T"],"notes":"Keep the mapper tiny and dependency-free to avoid circular imports.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Hygiene/Duplication::lib/db/meetings.ts::MeetingsService::snapshot-doc-mapping-dup"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0018","status":"CONFIRMED"}
{"category":"Types/Correctness","title":"Timestamp/string->Date conversion helper duplicated and inconsistent","fingerprint":"Types/Correctness::components/dev/lighthouse-tab.tsx::toDate::timestamp-conversion-dup","severity":"S2","effort":"E0","confidence":96,"files":["components/dev/lighthouse-tab.tsx","lib/types/firebase-types.ts"],"symbols":["toDate","toDate"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Local helper converts string|Timestamp to Date, while shared lib/types/firebase-types.ts exposes toDate(value: unknown): Date|null with broader handling and validation.","instances":[{"file":"components/dev/lighthouse-tab.tsx","symbol":"toDate"},{"file":"lib/types/firebase-types.ts","symbol":"toDate"}],"consolidation_target":"lib/types/firebase-types.ts::toDate"},"why_it_matters":"Duplicate conversion utilities drift over time (e.g., handling Date/number/invalid values). Using the shared helper reduces correctness bugs and simplifies future Timestamp handling changes.","suggested_fix":"Replace components/dev/lighthouse-tab.tsx local toDate with import { toDate } from '@/lib/types/firebase-types' and handle null return (fallback UI).","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["components/dev/lighthouse-tab.tsx defines function toDate(value: string | Timestamp): Date","lib/types/firebase-types.ts exports function toDate(value: unknown): Date | null"],"notes":"This is a quick win and a good pattern for other date conversions.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Types/Correctness::components/dev/lighthouse-tab.tsx::toDate::timestamp-conversion-dup"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0019","status":"CONFIRMED"}
{"category":"Security Hardening","title":"reCAPTCHA action strings/constants duplicated across client and functions; raw strings used","fingerprint":"Security/Hardening::lib/utils/secure-caller.ts::RECAPTCHA_ACTIONS::recaptcha-action-drift","severity":"S2","effort":"E2","confidence":86,"files":["hooks/use-journal.ts","lib/auth/account-linking.ts","lib/firestore-service.ts","lib/utils/secure-caller.ts","functions/src/recaptcha-verify.ts"],"symbols":["useJournal","linkWithEmail","linkWithGoogle","createFirestoreService","RECAPTCHA_ACTIONS","verifyRecaptchaToken"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"reCAPTCHA action identifiers exist in multiple places (client constants, server constants) while callers often pass raw string literals. This risks action mismatch and makes rotation/renaming hard.","instances":[{"file":"hooks/use-journal.ts","symbol":"useJournal"},{"file":"lib/auth/account-linking.ts","symbol":"linkWithEmail"},{"file":"lib/utils/secure-caller.ts","symbol":"RECAPTCHA_ACTIONS"},{"file":"functions/src/recaptcha-verify.ts","symbol":"RECAPTCHA_ACTIONS"}],"consolidation_target":"shared constants consumed by both app and functions"},"why_it_matters":"Action mismatch defeats a key protection (token reuse prevention) and causes hard-to-debug production failures. A single source of truth reduces drift.","suggested_fix":"Move action names to a shared module that both environments can import. Update call sites to use RECAPTCHA_ACTIONS constants (no raw strings) and tighten types (RecaptchaAction).","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"security-hardening","dependencies":[],"evidence":["hooks/use-journal.ts uses getRecaptchaToken('save_journal_entry') and getRecaptchaToken('delete_journal_entry')","lib/auth/account-linking.ts uses getRecaptchaToken('migrate_user_data')","lib/firestore-service.ts uses getRecaptchaToken('save_daily_log' / 'save_inventory' / 'save_journal_entry')","lib/utils/secure-caller.ts exports RECAPTCHA_ACTIONS (client-side)","functions/src/recaptcha-verify.ts exports RECAPTCHA_ACTIONS (server-side)"],"notes":"If shared imports across app/functions are hard, add a script/test that asserts both constant sets match exactly.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Security/Hardening::lib/utils/secure-caller.ts::RECAPTCHA_ACTIONS::recaptcha-action-drift"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0020","status":"CONFIRMED"}
{"category":"Types/Correctness","title":"Firestore collection names/paths inconsistently hard-coded vs central COLLECTIONS helpers","fingerprint":"Types/Correctness::lib/db/collections.ts::COLLECTIONS::collection-name-drift","severity":"S2","effort":"E1","confidence":82,"files":["components/dev/lighthouse-tab.tsx","components/growth/DailySloganWidget.tsx","lib/db/library.ts","lib/db/meetings.ts","lib/db/slogans.ts","lib/db/collections.ts"],"symbols":["LighthouseTab","DailySloganWidget","getAllQuickLinks","MeetingsService","SlogansService","COLLECTIONS"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Several modules directly embed collection names as strings while lib/db/collections.ts defines COLLECTIONS constants and user path builders.","instances":[{"file":"components/growth/DailySloganWidget.tsx","symbol":"DailySloganWidget"},{"file":"components/dev/lighthouse-tab.tsx","symbol":"LighthouseTab"},{"file":"lib/db/library.ts","symbol":"getAllQuickLinks"},{"file":"lib/db/meetings.ts","symbol":"MeetingsService"},{"file":"lib/db/slogans.ts","symbol":"SlogansService"}],"consolidation_target":"lib/db/collections.ts (expand COLLECTIONS to cover all root collections)"},"why_it_matters":"Stringly-typed collection paths create silent drift and make refactors (rename/move collections) painful. Centralizing enables static checks and safer access patterns.","suggested_fix":"Replace hard-coded collection names with COLLECTIONS constants. Extend COLLECTIONS to include quick_links/prayers and any dev namespaces.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["components/growth/DailySloganWidget.tsx uses collection(db,'slogans')","components/dev/lighthouse-tab.tsx uses collection(db,'dev','lighthouse','history')","lib/db/library.ts uses collection(db,'quick_links') and collection(db,'prayers')"],"notes":"If dev paths shouldn't be in COLLECTIONS, still define them once in a dev-only module.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Types/Correctness::lib/db/collections.ts::COLLECTIONS::collection-name-drift"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0021","status":"CONFIRMED"}
{"category":"Testing Infrastructure","title":"Quality gates don't include patterns:check and dependency health in primary test pipeline","fingerprint":"Testing Infrastructure::package.json::scripts.test::missing-quality-gate-hooks","severity":"S2","effort":"E0","confidence":94,"files":["package.json"],"symbols":["scripts.test","scripts.test:coverage","scripts.patterns:check","scripts.deps:circular","scripts.deps:unused"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Refactoring rules (pattern compliance, circular deps, unused exports) are only effective if they run in the default quality pipeline. Otherwise regressions slip in.","suggested_fix":"Add a single meta-script (e.g., 'check': lint + patterns:check + deps:circular + deps:unused + test) and have CI call it.","acceptance_tests":["npm run lint","npm run patterns:check","npm run deps:circular","npm run deps:unused","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["package.json scripts.test runs test:build then node --test dist-tests; does not run patterns:check/deps:","package.json includes scripts.patterns:check, scripts.deps:circular, scripts.deps:unused but not chained into test"],"notes":"Low-risk and makes refactor consolidation enforceable.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Testing Infrastructure::package.json::scripts.test::missing-quality-gate-hooks"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0022","status":"CONFIRMED"}
{"category":"Architecture/Boundaries","title":"AdminCrudTable mixes UI concerns with data access; config allows both service and direct collection fetch","fingerprint":"Architecture/Boundaries::components/admin/admin-crud-table.tsx::AdminCrudTable::service-boundary-leak","severity":"S2","effort":"E1","confidence":84,"files":["components/admin/admin-crud-table.tsx"],"symbols":["AdminCrudTable","fetchItems"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Allowing either 'service' or 'collectionName' invites drift: some entities get robust service logic while others get ad-hoc reads/writes.","suggested_fix":"Make service mandatory in AdminCrudConfig and remove the direct Firestore path. Provide small entity services for the remaining cases.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["components/admin/admin-crud-table.tsx:52-66 fetchItems chooses between config.service.getAll() vs direct collection(db, config.collectionName) + getDocs"],"notes":"Small but high-leverage boundary standardization.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Architecture/Boundaries::components/admin/admin-crud-table.tsx::AdminCrudTable::service-boundary-leak"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0023","status":"CONFIRMED"}
{"category":"Consistency","title":"Timestamp inconsistency: Timestamp.now() vs serverTimestamp()","fingerprint":"Consistency::lib/db::timestamp_inconsistency","severity":"S2","effort":"E1","confidence":100,"files":["lib/db/glossary.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/library.ts","lib/db/users.ts"],"line":34,"description":"Client-side Timestamp.now() used in 3 service files while 6+ other locations correctly use serverTimestamp(). Client timestamps cause race conditions when client clock is wrong, incorrect query ordering, and audit trail inconsistencies.","evidence":["lib/db/glossary.ts:34 - createdAt: Timestamp.now() (client-side)","lib/db/quotes.ts:41 - createdAt: Timestamp.now() (client-side)","lib/db/slogans.ts:52 - createdAt: Timestamp.now() (client-side)","lib/db/library.ts:72,73,82,122,123,132 - 6 uses of serverTimestamp() (correct)","lib/db/users.ts:113,114,151 - 3 uses of serverTimestamp() (correct)","functions/src/admin.ts:742,836,931,1002,1415,1479 - 6 uses of FieldValue.serverTimestamp() (correct)"],"remediation":{"steps":["1. Replace Timestamp.now() with serverTimestamp() in glossary.ts:34, quotes.ts:41, slogans.ts:52","2. Document timestamp policy in ARCHITECTURE.md: always use serverTimestamp() for audit fields","3. Test that createdAt fields are correctly populated after migration"],"verification":["Zero Timestamp.now() calls remain for audit fields (createdAt, updatedAt)","All new documents use serverTimestamp()","Query ordering unaffected"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Consistency::lib/db::timestamp_inconsistency"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0024","status":"CONFIRMED"}
{"category":"Consistency","title":"Bypassed typed collection helpers: 27 raw collection() calls","fingerprint":"Consistency::lib/db::bypassed_collection_helpers","severity":"S2","effort":"E0","confidence":100,"files":["components/admin/admin-crud-table.tsx","components/dev/lighthouse-tab.tsx","components/growth/DailySloganWidget.tsx","components/notebook/pages/today-page.tsx","lib/db/glossary.ts","lib/db/library.ts","lib/db/meetings.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts"],"line":60,"description":"lib/db/collections.ts provides typed getCollection()/getDocument() helpers and COLLECTIONS constants but has 0 usages. All 7 services + 5 components use raw collection(db, 'string_literal') — 27 instances total. Bypassing typed helpers loses compile-time type checking, autocomplete, and protection against typos.","evidence":["components/admin/admin-crud-table.tsx:60 - collection(db, config.collectionName)","components/dev/lighthouse-tab.tsx:83 - collection(db, 'dev', 'lighthouse', 'history')","components/growth/DailySloganWidget.tsx:25 - collection(db, 'slogans')","components/notebook/pages/today-page.tsx:735 - collection(db, `users/${user.uid}/daily_logs`)","lib/db/glossary.ts:26 - collection(db, COLLECTION)","lib/db/library.ts:49,69,99,119 - 4x collection(db, 'quick_links')","lib/db/meetings.ts:111,140,170,223 - 4x collection(db, 'meetings')","lib/db/quotes.ts:33 - collection(db, COLLECTION)","lib/db/slogans.ts:39,48 - 2x collection(db, COLLECTION_NAME)","lib/db/sober-living.ts:31,37,57,62 - 4x collection(db, COLLECTION)"],"remediation":{"steps":["1. Expand COLLECTIONS constant with any missing collection names","2. Replace all 27 raw collection() calls with getCollection() typed helpers","3. Use getDocument() for single-document access patterns"],"verification":["Zero raw collection(db, 'string') calls in lib/db/ and components","All collection access uses typed helpers","COLLECTIONS constant covers all collection names in codebase"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Consistency::lib/db::bypassed_collection_helpers"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0025","status":"CONFIRMED"}
{"category":"Duplication","title":"Query builder duplication in lib/db/*.ts services","fingerprint":"Duplication::lib/db::query_builder_duplication","severity":"S2","effort":"E1","confidence":100,"files":["lib/db/glossary.ts","lib/db/quotes.ts","lib/db/sober-living.ts","lib/db/meetings.ts"],"line":26,"description":"Repeated query(collection(db, COLLECTION)) + orderBy() + getDocs() pattern across lib/db/ service files. Inconsistent pagination (some use limit, some don't). Repeated import boilerplate makes it harder to add features like cursor pagination uniformly.","evidence":["lib/db/glossary.ts:26 - query(collection(db, COLLECTION))","lib/db/quotes.ts:33 - query(collection(db, COLLECTION))","lib/db/sober-living.ts:31,57 - 2x query(collection(db, COLLECTION))","lib/db/meetings.ts:112,140,170 - more complex but similar pattern"],"remediation":{"steps":["1. Create lib/db/query-builders.ts with helpers: listAll(), listOrdered(), addPagination()","2. Replace repeated query patterns with query builder helpers","3. Standardize pagination approach across all services"],"verification":["All lib/db/ services use query builder helpers","Consistent pagination pattern","Reduced import boilerplate"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Duplication::lib/db::query_builder_duplication"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0026","status":"CONFIRMED"}
{"category":"Complexity","title":"dashboard-tab.tsx mega-component: 1031 lines with 5 separate fetches","fingerprint":"Complexity::components/admin/dashboard-tab.tsx::mega_component","severity":"S2","effort":"E2","confidence":100,"files":["components/admin/dashboard-tab.tsx"],"line":1,"description":"dashboard-tab.tsx at 1031 lines with 5 separate Cloud Function fetch operations. Each dashboard section independently manages loading state, error handling, and data transformation.","evidence":["components/admin/dashboard-tab.tsx: 1031 lines","5 separate fetch operations (lines 731, 754, 780, 806, 832)","High complexity (5 separate fetches)"],"remediation":{"steps":["1. Extract custom hooks for each dashboard metric","2. Extract DashboardMetricCard, DashboardChart sub-components","3. Target <300 lines for main component"],"verification":["dashboard-tab.tsx under 500 lines","Custom hooks encapsulate data fetching","Each dashboard section is a sub-component"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Complexity::components/admin/dashboard-tab.tsx::mega_component"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0027","status":"CONFIRMED"}
{"category":"Types","title":"Entry type consolidation needed: duplicate type definitions","fingerprint":"Types::types::entry_type_consolidation","severity":"S2","effort":"E2","confidence":100,"files":["types/journal.ts","functions/src/schemas.ts"],"line":null,"description":"Entry types (journal entries, log entries) are defined in multiple locations. Frontend types/ directory and functions/src/schemas.ts both define overlapping types, creating potential drift. May discover types are intentionally separate (client vs server shapes).","evidence":["types/journal.ts: frontend type definitions","functions/src/schemas.ts: Zod schemas defining equivalent server-side types","Multiple imports across components reference different type sources"],"remediation":{"steps":["1. Audit all entry type definitions across types/ and functions/src/","2. Identify intentional vs accidental differences","3. Establish single source of truth using z.infer<> from Zod schemas","4. Update all imports to canonical source"],"verification":["Single canonical definition per entity type","All imports reference same source","No type drift between client and server"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Types::types::entry_type_consolidation"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0028","status":"CONFIRMED"}
{"category":"Security","title":"Rate limiting inconsistent in admin functions","fingerprint":"Security::functions/src/admin.ts::inconsistent_rate_limiting","severity":"S2","effort":"E1","confidence":100,"files":["functions/src/admin.ts","functions/src/index.ts"],"line":null,"description":"Admin functions in admin.ts implement rate limiting ad-hoc while user-facing functions in index.ts use standardized withSecurityChecks() rate limiting. Some admin functions may lack rate limiting entirely. Inconsistent enforcement creates potential for abuse of admin endpoints.","evidence":["functions/src/admin.ts: 33 admin functions with ad-hoc security checks","functions/src/index.ts: standardized rate limiting via withSecurityChecks()","No centralized rate limiting for admin endpoints"],"remediation":{"steps":["1. Audit all 33 admin functions for rate limiting coverage","2. Standardize rate limiting via withAdminChecks() wrapper","3. Document rate limit policy for admin vs user-facing endpoints"],"verification":["All admin functions have consistent rate limiting","Rate limits documented per endpoint category"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Security::functions/src/admin.ts::inconsistent_rate_limiting"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0029","status":"CONFIRMED"}
{"category":"Duplication","title":"account-linking.ts bypasses service pattern with raw httpsCallable","fingerprint":"Duplication::lib/auth/account-linking.ts::raw_httpsCallable","severity":"S2","effort":"E1","confidence":100,"files":["lib/auth/account-linking.ts"],"line":204,"description":"lib/auth/account-linking.ts has 2 raw getFunctions()/httpsCallable() calls (lines 204, 329) that bypass whatever service pattern exists. As a non-admin file using the same anti-pattern, this confirms the issue extends beyond admin tabs.","evidence":["lib/auth/account-linking.ts:204 - getFunctions()/httpsCallable() raw call","lib/auth/account-linking.ts:329 - getFunctions()/httpsCallable() raw call"],"remediation":{"steps":["1. Create callCloudFunction() helper (non-admin variant)","2. Replace raw calls in account-linking.ts","3. Ensure error handling matches service pattern"],"verification":["Zero raw httpsCallable() calls in account-linking.ts","Uses centralized callable helper"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Duplication::lib/auth/account-linking.ts::raw_httpsCallable"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0030","status":"CONFIRMED"}
{"category":"Duplication","title":"Admin tabs bypass repository pattern for data access","fingerprint":"Duplication::components/admin::bypass_repository_pattern","severity":"S2","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx","components/admin/errors-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/jobs-tab.tsx","components/admin/logs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/analytics-tab.tsx"],"line":null,"description":"9 admin tabs implement data fetching and CRUD operations inline instead of using the established repository pattern (lib/db/*.ts or lib/firestore-service.ts). Each tab independently manages Cloud Function calls, loading states, error handling, and data transformation. 7300+ lines of duplicated patterns.","evidence":["9 admin tabs with inline data access: users (2092), errors (1095), dashboard (1031), logs (730), jobs (625), privileges (600), analytics (457) lines","5 tabs already migrated to AdminCrudTable (proving pattern works)","lib/firestore-service.ts and lib/db/*.ts exist as canonical service layers"],"remediation":{"steps":["1. Create admin service layer (lib/admin-api.ts) as intermediary","2. Gradually migrate each admin tab to use service layer","3. Start with simplest tabs (links, prayers) as proof of concept"],"verification":["All admin data access goes through service layer","Inline Cloud Function calls eliminated from components","Consistent loading/error patterns across all admin tabs"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Duplication::components/admin::bypass_repository_pattern"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0031","status":"CONFIRMED"}
{"category":"Consistency","title":"COLLECTIONS constants built but never adopted","fingerprint":"Consistency::lib/db/collections.ts::constants_unused","severity":"S2","effort":"E1","confidence":100,"files":["lib/db/collections.ts","lib/db/meetings.ts","lib/db/library.ts","lib/db/glossary.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts","components/dev/lighthouse-tab.tsx","components/growth/DailySloganWidget.tsx","components/notebook/pages/today-page.tsx","components/admin/admin-crud-table.tsx","hooks/use-journal.ts"],"line":null,"description":"lib/db/collections.ts defines COLLECTIONS constants and typed getCollection()/getDocument() helpers. Zero lib/db/ service files use them. All 7 services + 5 components use raw collection(db, 'string_literal') instead. 12 bypass instances identified.","evidence":["lib/db/meetings.ts: 4× raw collection() calls","lib/db/library.ts: 4× raw collection() calls","lib/db/glossary.ts: raw collection() call","lib/db/quotes.ts: raw collection() call","lib/db/slogans.ts: raw collection() call","lib/db/sober-living.ts: raw collection() call","components/dev/lighthouse-tab.tsx: raw collection() call","components/growth/DailySloganWidget.tsx: raw collection() call","components/notebook/pages/today-page.tsx: raw collection() call","components/admin/admin-crud-table.tsx: raw collection() call","hooks/use-journal.ts: raw collection() call"],"remediation":{"steps":["1. Add missing COLLECTIONS entries: quick_links, prayers, dev/lighthouse/history","2. Replace all raw collection(db, 'string') calls with COLLECTIONS constants","3. Use getCollection()/getDocument() typed helpers where applicable"],"verification":["Zero raw collection(db, 'string_literal') calls remain in lib/db/ and components","All collection names come from COLLECTIONS constants","Missing collections (quick_links, prayers, dev/lighthouse/history) added"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Consistency::lib/db/collections.ts::constants_unused"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0032","status":"CONFIRMED"}
{"category":"Duplication","title":"9 unmigrated admin tabs with duplicated CRUD/fetch patterns","fingerprint":"Duplication::components/admin::unmigrated_tabs","severity":"S2","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx","components/admin/errors-tab.tsx","components/admin/dashboard-tab.tsx","components/admin/logs-tab.tsx","components/admin/jobs-tab.tsx","components/admin/privileges-tab.tsx","components/admin/analytics-tab.tsx","components/admin/links-tab.tsx","components/admin/prayers-tab.tsx"],"line":null,"description":"5 tabs use AdminCrudTable. 9 tabs don't, totaling ~7300 lines of duplicated CRUD/fetch patterns. Each unmigrated tab independently implements loading states, error handling, data fetching, and CRUD operations.","evidence":["users-tab.tsx: 2092 lines, High complexity (10 separate Cloud Function calls)","errors-tab.tsx: 1095 lines, High complexity","dashboard-tab.tsx: 1031 lines, High complexity (5 separate fetches)","logs-tab.tsx: 730 lines, Medium complexity","jobs-tab.tsx: 625 lines, Medium complexity","privileges-tab.tsx: 600 lines, Medium complexity","analytics-tab.tsx: 457 lines, Low complexity","links-tab.tsx: 344 lines, Low (could adopt AdminCrudTable directly)","prayers-tab.tsx: 323 lines, Low (could adopt AdminCrudTable directly)"],"remediation":{"steps":["1. Migrate links-tab.tsx and prayers-tab.tsx to AdminCrudTable (easiest, direct fit)","2. Create specialized variants of AdminCrudTable for medium-complexity tabs","3. Gradually migrate remaining tabs, starting with lower complexity"],"verification":["links-tab.tsx and prayers-tab.tsx use AdminCrudTable","Total line count across admin tabs reduced by >30%","All tabs share common loading/error/CRUD patterns"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Duplication::components/admin::unmigrated_tabs"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0033","status":"CONFIRMED"}
{"category":"Types","title":"Duplicate UserProfile and LogEntry type definitions","fingerprint":"Types::types::duplicate_user_profile_log_entry","severity":"S2","effort":"E1","confidence":90,"files":["types/user.ts","types/daily-log.ts","functions/src/schemas.ts"],"line":null,"description":"UserProfile and LogEntry types are defined in multiple locations with slightly different shapes. Frontend types/ directory and functions/src/schemas.ts both define these types, leading to potential drift and import confusion.","evidence":["types/ directory: UserProfile type definition","functions/src/schemas.ts: Zod schemas that implicitly define the same types","Multiple imports across components reference different sources"],"remediation":{"steps":["1. Establish single source of truth for shared types (recommend functions/src/schemas.ts with z.infer<>)","2. Export inferred types from schemas","3. Update all imports to use canonical source"],"verification":["Single definition for UserProfile and LogEntry","All imports reference the same source","No type drift between frontend and backend definitions"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Types::types::duplicate_user_profile_log_entry"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0034","status":"CONFIRMED"}
{"category":"Complexity","title":"today-page.tsx oversized component (1199+ lines)","fingerprint":"Complexity::components/notebook/pages/today-page.tsx::oversized","severity":"S2","effort":"E2","confidence":100,"files":["components/notebook/pages/today-page.tsx"],"line":null,"description":"today-page.tsx exceeds 1199 lines with multiple responsibilities: daily log management, journal entries, inventory tracking, meeting display, slogan display, and quote display. Should be decomposed into focused sub-components with custom hooks for data fetching.","evidence":["components/notebook/pages/today-page.tsx: 1199+ lines","Multiple data fetching patterns inline","Multiple UI sections that could be independent components"],"remediation":{"steps":["1. Extract custom hooks: useDailyLog, useJournalEntries, useInventory, useMeetings","2. Extract sub-components: DailyLogSection, JournalSection, InventorySection, MeetingSection","3. Keep today-page.tsx as thin orchestrator composing sub-components","4. Target <400 lines for main component"],"verification":["today-page.tsx under 400 lines","Each sub-component is self-contained with own hook","No functionality regression"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Complexity::components/notebook/pages/today-page.tsx::oversized"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0035","status":"CONFIRMED"}
{"category":"Complexity","title":"users-tab.tsx oversized component (2092 lines)","fingerprint":"Complexity::components/admin/users-tab.tsx::oversized","severity":"S2","effort":"E2","confidence":100,"files":["components/admin/users-tab.tsx"],"line":null,"description":"users-tab.tsx at 2092 lines is the largest admin tab with 10 separate Cloud Function calls, user search, user detail view, user editing, and multiple sub-features all in one file. Should be decomposed into focused components.","evidence":["components/admin/users-tab.tsx: 2092 lines","10 separate getFunctions()/httpsCallable() calls","High complexity: search, detail view, editing, status management all inline"],"remediation":{"steps":["1. Extract UserSearchPanel, UserDetailPanel, UserEditForm sub-components","2. Create useAdminUsers custom hook for all Cloud Function calls","3. Adopt callAdminFunction() helper (after PR#2)","4. Target <400 lines for main component"],"verification":["users-tab.tsx under 400 lines","Each panel is independent component","10 raw httpsCallable calls replaced with callAdminFunction()"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Complexity::components/admin/users-tab.tsx::oversized"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0036","status":"CONFIRMED"}
{"category":"Duplication","title":"links-tab.tsx simple CRUD tab not using AdminCrudTable","fingerprint":"Duplication::components/admin/links-tab.tsx::no_crud_table","severity":"S2","effort":"E1","confidence":100,"files":["components/admin/links-tab.tsx","components/admin/admin-crud-table.tsx","components/admin/prayers-tab.tsx"],"line":null,"description":"links-tab.tsx at 344 lines implements basic CRUD operations manually when it could directly adopt the existing AdminCrudTable component. Low complexity tab with straightforward list/add/edit/delete pattern that perfectly fits the existing abstraction.","evidence":["components/admin/links-tab.tsx: 344 lines of manual CRUD","components/admin/admin-crud-table.tsx: existing reusable CRUD component","5 tabs already successfully use AdminCrudTable","components/admin/prayers-tab.tsx: 323 lines of manual CRUD"],"remediation":{"steps":["1. Define column/form config for links entity","2. Replace manual CRUD implementation with AdminCrudTable","3. Verify all existing functionality preserved"],"verification":["links-tab.tsx uses AdminCrudTable","Line count reduced by >50%","All CRUD operations still functional"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Duplication::components/admin/links-tab.tsx::no_crud_table"}],"merged_from":["Duplication::components/admin/links-tab.tsx::no_crud_table","Duplication::components/admin/prayers-tab.tsx::no_crud_table"],"verified":true,"consensus_score":2,"canonical_id":"CANON-0037","status":"CONFIRMED"}
{"category":"Hygiene/Duplication","title":"CRUD boilerplate duplicated across 5+ lib/db/ services","fingerprint":"Hygiene/Duplication::lib/db/quotes.ts::QuotesService::crud-boilerplate-dup","severity":"S2","effort":"E2","confidence":85,"files":["lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts","lib/db/glossary.ts","lib/db/library.ts"],"symbols":["QuotesService","SlogansService"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"Each lib/db/ service reimplements getAll/add/update/delete with identical collection/getDocs/addDoc/updateDoc/deleteDoc patterns. Only collection name and type differ.","instances":[{"file":"lib/db/quotes.ts","symbol":"QuotesService"},{"file":"lib/db/slogans.ts","symbol":"SlogansService"},{"file":"lib/db/sober-living.ts","symbol":"SoberLivingService"},{"file":"lib/db/glossary.ts","symbol":"GlossaryService"},{"file":"lib/db/library.ts","symbol":"LibraryService"}],"consolidation_target":"lib/db/create-crud-service.ts (factory function)"},"why_it_matters":"Adding validation, error handling, or caching to any CRUD operation requires editing 5+ files. A single factory could enforce consistent patterns.","suggested_fix":"Create createCrudService<T>(collectionName, options?) factory that generates typed getAll/add/update/delete methods. Migrate services one at a time.","acceptance_tests":["npm run lint","npm test","Admin panel CRUD for quotes/slogans/glossary still works"],"pr_bucket_suggestion":"firebase-access","dependencies":[],"evidence":["lib/db/quotes.ts: getAllQuotes/addQuote/updateQuote/deleteQuote pattern","lib/db/slogans.ts: getAllSlogans/addSlogan/updateSlogan/deleteSlogan (identical structure)"],"notes":"CANON-0021 from prior audits.","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Hygiene/Duplication::lib/db/quotes.ts::QuotesService::crud-boilerplate-dup"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0038","status":"CONFIRMED"}
{"category":"Architecture/Boundaries","title":"Hooks split across hooks/ and lib/hooks/ directories","fingerprint":"Architecture/Boundaries::hooks/::use-journal::hooks-split-directories","severity":"S2","effort":"E1","confidence":80,"files":["hooks/use-daily-quote.ts","hooks/use-geolocation.ts","hooks/use-journal.ts","hooks/use-speech-recognition.ts"],"symbols":["useDailyQuote","useGeolocation","useJournal","useSpeechRecognition"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Developers don't know whether to look in hooks/ or lib/hooks/ for a hook. Import paths are inconsistent.","suggested_fix":"Consolidate all hooks into the top-level hooks/ directory. Update import aliases.","acceptance_tests":["npm run lint","npx tsc --noEmit","No imports from lib/hooks/ remain"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["hooks/ directory has 4 files","lib/hooks/ directory exists as separate location"],"notes":"","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Architecture/Boundaries::hooks/::use-journal::hooks-split-directories"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0039","status":"CONFIRMED"}
{"category":"Architecture/Boundaries","title":"lib/db/ services bypass firestore-service.ts repository pattern","fingerprint":"Architecture/Boundaries::lib/db/quotes.ts::QuotesService::bypasses-service-layer","severity":"S2","effort":"E2","confidence":85,"files":["lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts","lib/db/glossary.ts","lib/db/library.ts","lib/db/meetings.ts","lib/db/users.ts","lib/firestore-service.ts"],"symbols":["QuotesService","SlogansService","FirestoreService"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Architecture docs say all Firestore operations should go through lib/firestore-service.ts, but lib/db/ services directly import db from lib/firebase.ts and call Firestore SDK methods. This bypasses centralized validation, logging, and rate limiting.","suggested_fix":"Decide: either (a) firestore-service.ts is only for user-scoped writes and lib/db/ is for public/admin reads, then document clearly; or (b) route all DB access through firestore-service.ts.","acceptance_tests":["Architecture boundary documented in DEVELOPMENT.md"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["lib/db/quotes.ts:1 imports db from '../firebase'","lib/db/slogans.ts:6 imports db from '@/lib/firebase'","CLAUDE.md Section 3: 'Add new queries to service files, not inline in components'"],"notes":"The actual pattern appears to be: firestore-service.ts for user-scoped writes (via Cloud Functions), lib/db/ for read-only public/admin data. Reasonable boundary but undocumented.","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Architecture/Boundaries::lib/db/quotes.ts::QuotesService::bypasses-service-layer"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0040","status":"CONFIRMED"}
{"category":"Testing Infrastructure","title":"Critical auth and journal paths have minimal/no test coverage","fingerprint":"Testing Infrastructure::hooks/use-journal.ts::useJournal::missing-critical-tests","severity":"S2","effort":"E2","confidence":85,"files":["hooks/use-journal.ts","lib/auth/account-linking.ts","lib/recaptcha.ts","lib/db/meetings.ts"],"symbols":["useJournal","addEntry","crumplePage","linkEmailPassword","linkWithGoogle","getRecaptchaToken"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Core journal hook (16KB) and account linking (17.5% coverage) are security-critical paths with no dedicated tests. Regressions break core functionality or create security vulnerabilities.","suggested_fix":"Add tests/use-journal.test.ts and tests/account-linking.test.ts. Mock httpsCallable per project patterns.","acceptance_tests":["tests/use-journal.test.ts exists with coverage for addEntry, crumplePage","tests/account-linking.test.ts exists","npm test passes"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["No test file for use-journal.ts in tests/","Prior audit docs state account-linking.ts at 17.5% coverage"],"notes":"","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Testing Infrastructure::hooks/use-journal.ts::useJournal::missing-critical-tests"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0041","status":"CONFIRMED"}
{"category":"Architecture","title":"Direct Firestore collection access bypasses Repository pattern","fingerprint":"Architecture::hooks/use-journal.ts::direct_collection_access_bypass","severity":"S2","effort":"E1","confidence":85,"files":["hooks/use-journal.ts","lib/db/slogans.ts","lib/db/meetings.ts","lib/db/collections.ts","functions/src/jobs.ts"],"line":null,"description":"Direct collection(db, path) calls are scattered across hooks/ and lib/db/ files instead of using the centralized lib/db/collections.ts helpers or FirestoreService. This violates the Repository pattern and leads to scattered query logic, inconsistent error handling, and schema drift risk.","evidence":["hooks/use-journal.ts: direct collection(db, ...) calls","lib/db/slogans.ts: direct collection() calls instead of COLLECTIONS constants","lib/db/meetings.ts: direct collection() calls","functions/src/jobs.ts: direct collection access"],"remediation":{"steps":["1. Move all collection references to lib/db/collections.ts as the single source of truth","2. Access collections via FirestoreService or typed helpers from collections.ts","3. Remove direct collection(db, ...) calls from hooks/ and components/"],"verification":["grep for collection(db in hooks/ directory yields no results","All Firestore access goes through centralized service layer"]},"acceptance_tests":["Verify fix applied correctly"],"sources":[{"source":"jules","file":"refactoring-jules.jsonl","original_fingerprint":"Architecture::hooks/use-journal.ts::direct_collection_access_bypass"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0042","status":"CONFIRMED"}
{"category":"Duplication","title":"Repeated dynamic imports of firebase/functions in multiple files","fingerprint":"Duplication::lib/firestore-service.ts::repeated_dynamic_function_imports","severity":"S2","effort":"E1","confidence":80,"files":["lib/firestore-service.ts","lib/auth/account-linking.ts"],"line":null,"description":"Repeated dynamic imports of firebase/functions appear in lib/firestore-service.ts and lib/auth/account-linking.ts. Each file independently imports and initializes Firebase Functions, creating duplication and inconsistency.","evidence":["lib/firestore-service.ts: dynamic import of firebase/functions","lib/auth/account-linking.ts: dynamic import of firebase/functions"],"remediation":{"steps":["1. Centralize Firebase Functions import in lib/firebase.ts or a dedicated helper","2. Export a shared getFunctions() singleton","3. Replace dynamic imports in individual files with centralized helper"],"verification":["Single source for Firebase Functions initialization","No repeated dynamic imports of firebase/functions"]},"acceptance_tests":["Verify fix applied correctly"],"sources":[{"source":"jules","file":"refactoring-jules.jsonl","original_fingerprint":"Duplication::lib/firestore-service.ts::repeated_dynamic_function_imports"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0043","status":"CONFIRMED"}
{"category":"Types","title":"JournalEntry type duplication between frontend and backend","fingerprint":"Types::types/journal.ts::journal_entry_type_duplication","severity":"S2","effort":"E1","confidence":85,"files":["types/journal.ts","functions/src/schemas.ts"],"line":null,"description":"JournalEntry types are redefined separately in the frontend (types/journal.ts) and backend functions (functions/src/), creating high risk of schema drift between client and server representations.","evidence":["types/journal.ts: frontend JournalEntry type definition","functions/src/schemas.ts: backend Zod schema defining equivalent server-side types","Separate definitions create drift risk"],"remediation":{"steps":["1. Create shared type definition module consumed by both frontend and functions","2. Use z.infer<> from Zod schemas as the single source of truth","3. Update all imports to reference canonical type source"],"verification":["Single JournalEntry type definition used by both client and server","No duplicate type definitions"]},"acceptance_tests":["Verify fix applied correctly"],"sources":[{"source":"jules","file":"refactoring-jules.jsonl","original_fingerprint":"Types::types/journal.ts::journal_entry_type_duplication"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0044","status":"CONFIRMED"}
{"category":"Architecture","title":"Inconsistent service patterns: class-based vs object-based services","fingerprint":"Architecture::lib/db::inconsistent_service_patterns","severity":"S2","effort":"E2","confidence":80,"files":["lib/firestore-service.ts","lib/db/slogans.ts","lib/db/meetings.ts","lib/db/glossary.ts","lib/db/quotes.ts","lib/db/sober-living.ts"],"line":null,"description":"Competing service patterns exist: FirestoreService uses a class-based pattern while lib/db/ services (SlogansService, MeetingsService, etc.) use object-based patterns. This fragmentation makes applying global policies like caching, logging, or error handling difficult.","evidence":["lib/firestore-service.ts: class-based FirestoreService pattern","lib/db/slogans.ts: object-based SlogansService","lib/db/meetings.ts: object-based MeetingsService","lib/db/glossary.ts, lib/db/quotes.ts, lib/db/sober-living.ts: object-based patterns"],"remediation":{"steps":["1. Choose a canonical service pattern (recommend object-based modules in lib/db/)","2. Migrate FirestoreService methods into appropriate lib/db/ modules","3. Ensure consistent error handling, caching, and logging across all services"],"verification":["Single consistent service pattern across all data access modules","No competing class-based vs object-based patterns"]},"acceptance_tests":["Verify fix applied correctly"],"sources":[{"source":"jules","file":"refactoring-jules.jsonl","original_fingerprint":"Architecture::lib/db::inconsistent_service_patterns"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0045","status":"CONFIRMED"}
{"category":"Testing Infrastructure","title":"No automated guardrail to prevent new raw logger.error({error}) call sites","fingerprint":"Testing Infrastructure::scripts/check-pattern-compliance.js::main::missing-logger-guardrail","severity":"S2","effort":"E1","confidence":70,"files":["scripts/check-pattern-compliance.js","components/growth/DailySloganWidget.tsx","components/admin/dashboard-tab.tsx"],"symbols":["main","DailySloganWidget","DashboardTab"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"You already have a pattern-compliance system; extending it to cover the biggest drift source (raw error logging) prevents slow regression.","suggested_fix":"Add a pattern rule that flags logger.error(...,{ error }) unless the payload is sanitized (errorType/errorCode). Add a script test to assert the rule is enforced.","acceptance_tests":["npm run patterns:check","npm run test"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["grep results show many logger.error(...,{ error }) call sites across app/components/lib","repo already includes scripts/check-pattern-compliance.js"],"notes":"Turns a big refactor cluster into a permanently enforced standard.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Testing Infrastructure::scripts/check-pattern-compliance.js::main::missing-logger-guardrail"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0046","status":"SUSPECTED"}
{"category":"Testing","title":"Test coverage unknown for admin features","fingerprint":"Testing::components/admin::unknown_coverage","severity":"S2","effort":"E2","confidence":40,"files":["components/admin/users-tab.tsx","components/admin/errors-tab.tsx","components/admin/dashboard-tab.tsx","functions/src/admin.ts"],"line":null,"description":"SUSPECTED: Test coverage for admin features is unknown. The 33 admin Cloud Functions and 9 admin tab components may have minimal or no test coverage. Needs investigation to confirm coverage gaps and establish testing requirements.","evidence":["functions/src/admin.ts: 33 exported functions, test coverage unknown","9 admin tab components, test coverage unknown","No test files found matching admin patterns in initial search"],"remediation":{"steps":["1. Run test coverage analysis for admin features","2. Identify critical paths lacking tests","3. Add integration tests for admin Cloud Functions","4. Add component tests for complex admin tabs"],"verification":["Test coverage metrics available for admin features","Critical paths have integration tests","Admin functions have at least happy-path tests"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Testing::components/admin::unknown_coverage"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0047","status":"SUSPECTED"}
{"category":"Architecture","title":"FirestoreAdapter overlaps with FirestoreService on daily logs","fingerprint":"Architecture::lib/database/firestore-adapter.ts::overlapping_adapter","severity":"S2","effort":"E1","confidence":40,"files":["lib/database/firestore-adapter.ts","lib/firestore-service.ts"],"line":null,"description":"SUSPECTED: FirestoreAdapter appears to duplicate daily log access methods already provided by FirestoreService. If confirmed, one should be removed to eliminate confusion about which to import. Needs investigation to confirm overlap extent.","evidence":["lib/database/firestore-adapter.ts: daily log methods","lib/firestore-service.ts: daily log methods (overlapping scope)"],"remediation":{"steps":["1. Audit both files to confirm exact method overlap","2. If confirmed, migrate callers of FirestoreAdapter to FirestoreService (or lib/db/)","3. Remove FirestoreAdapter"],"verification":["No duplicate daily log access methods","Single canonical module for daily log data access"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Architecture::lib/database/firestore-adapter.ts::overlapping_adapter"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0048","status":"SUSPECTED"}
{"category":"Complexity","title":"dashboard-tab.tsx may have extractable data-fetching hooks","fingerprint":"Complexity::components/admin/dashboard-tab.tsx::extractable_hooks","severity":"S2","effort":"E2","confidence":40,"files":["components/admin/dashboard-tab.tsx"],"line":null,"description":"SUSPECTED: dashboard-tab.tsx at 1031 lines with 5 separate fetch operations likely contains extractable custom hooks and sub-components. Needs investigation to confirm decomposition opportunities.","evidence":["components/admin/dashboard-tab.tsx: 1031 lines","5 separate fetch operations identified"],"remediation":{"steps":["1. Audit file to identify independent data-fetching patterns","2. Extract custom hooks for each dashboard metric","3. Extract sub-components for each dashboard section"],"verification":["dashboard-tab.tsx under 500 lines","Custom hooks encapsulate data fetching"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Complexity::components/admin/dashboard-tab.tsx::extractable_hooks"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0049","status":"SUSPECTED"}
{"category":"Architecture/Boundaries","title":"DB modules split across lib/db/ and lib/database/ directories","fingerprint":"Architecture/Boundaries::lib/db/::collections::db-split-directories","severity":"S2","effort":"E1","confidence":75,"files":["lib/db/collections.ts","lib/db/quotes.ts","lib/db/slogans.ts","lib/db/sober-living.ts","lib/db/glossary.ts","lib/db/library.ts","lib/db/meetings.ts","lib/db/users.ts"],"symbols":["QuotesService","SlogansService"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Two directories for the same concern creates ambiguity about where new DB code should go.","suggested_fix":"Audit lib/database/ contents. Merge into lib/db/ or create clear separation of concerns.","acceptance_tests":["npm run lint","npx tsc --noEmit"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["lib/db/ has 8 files","lib/database/ exists as separate directory"],"notes":"","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Architecture/Boundaries::lib/db/::collections::db-split-directories"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0050","status":"SUSPECTED"}
{"category":"Hygiene/Duplication","title":"Growth card dialog/save state pattern duplicated across 4 components","fingerprint":"Hygiene/Duplication::components/growth/SpotCheckCard.tsx::SpotCheckCard::growth-card-dialog-dup","severity":"S2","effort":"E1","confidence":40,"files":["components/growth/SpotCheckCard.tsx","components/growth/GratitudeCard.tsx","components/growth/NightReviewCard.tsx","components/growth/Step1WorksheetCard.tsx"],"symbols":["SpotCheckCard","GratitudeCard","NightReviewCard","Step1WorksheetCard"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"isOpen/isSaving/handleSave state management pattern repeated in 4 growth card components","instances":[{"file":"components/growth/SpotCheckCard.tsx","symbol":"SpotCheckCard"},{"file":"components/growth/GratitudeCard.tsx","symbol":"GratitudeCard"},{"file":"components/growth/NightReviewCard.tsx","symbol":"NightReviewCard"},{"file":"components/growth/Step1WorksheetCard.tsx","symbol":"Step1WorksheetCard"}],"consolidation_target":"hooks/use-growth-card-dialog.ts"},"why_it_matters":"Each new growth card requires copying 20+ lines of dialog state boilerplate.","suggested_fix":"Extract useGrowthCardDialog(saveConfig) hook.","acceptance_tests":["npm run lint","npm test"],"pr_bucket_suggestion":"hooks-standardization","dependencies":[],"evidence":["Prior audit REF-007 identified this pattern"],"notes":"CANON-0079. Confidence low — haven't inspected these files directly.","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Hygiene/Duplication::components/growth/SpotCheckCard.tsx::SpotCheckCard::growth-card-dialog-dup"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0051","status":"SUSPECTED"}
{"category":"Hygiene/Duplication","title":"DailyQuoteCard component may be duplicated in 2-3 locations","fingerprint":"Hygiene/Duplication::components/widgets/daily-quote-card.tsx::DailyQuoteCard::quote-card-dup","severity":"S2","effort":"E1","confidence":35,"files":["components/notebook/features/daily-quote-card.tsx","components/widgets/daily-quote-card.tsx","components/widgets/compact-daily-quote.tsx"],"symbols":["DailyQuoteCard","CompactDailyQuote"],"duplication_cluster":{"is_cluster":true,"cluster_summary":"2-3 quote card implementations with same fetch logic","instances":[{"file":"components/notebook/features/daily-quote-card.tsx","symbol":"DailyQuoteCard"},{"file":"components/widgets/daily-quote-card.tsx","symbol":"DailyQuoteCard"},{"file":"components/widgets/compact-daily-quote.tsx","symbol":"CompactDailyQuote"}],"consolidation_target":"components/widgets/daily-quote-card.tsx with variant prop"},"why_it_matters":"Same fetch logic in 2-3 places means feature drift.","suggested_fix":"Consolidate to single component with variant prop.","acceptance_tests":["npm run lint","npx tsc --noEmit"],"pr_bucket_suggestion":"ui-primitives","dependencies":[],"evidence":["Prior audit CANON-0013/CANON-0073 identified this pattern"],"notes":"Confidence low — notebook version may have been removed.","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Hygiene/Duplication::components/widgets/daily-quote-card.tsx::DailyQuoteCard::quote-card-dup"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0052","status":"SUSPECTED"}
{"category":"Architecture/Boundaries","title":"resources-page.tsx is 728-line god component","fingerprint":"Architecture/Boundaries::components/notebook/pages/resources-page.tsx::ResourcesPage::god-component","severity":"S2","effort":"E2","confidence":35,"files":["components/notebook/pages/resources-page.tsx"],"symbols":["ResourcesPage"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Mixes meeting and sober-home logic with distinct data fetching, filtering, and display in one component.","suggested_fix":"Extract MeetingsSection and SoberHomesSection components. Create useResourceFilters hook.","acceptance_tests":["npm run lint","npx tsc --noEmit"],"pr_bucket_suggestion":"boundaries","dependencies":[],"evidence":["Prior audit REF-004 identified 728 lines"],"notes":"CANON from prior audit. Confidence low — may have been refactored.","sources":[{"source":"copilot","file":"refactoring-copilot.jsonl","original_fingerprint":"Architecture/Boundaries::components/notebook/pages/resources-page.tsx::ResourcesPage::god-component"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0053","status":"SUSPECTED"}
{"category":"Consistency","title":"Timestamp pattern undocumented in ARCHITECTURE.md","fingerprint":"Consistency::docs::timestamp_pattern_undocumented","severity":"S3","effort":"E0","confidence":100,"files":["ARCHITECTURE.md"],"line":null,"description":"No documented policy for timestamp usage in ARCHITECTURE.md. The codebase uses both Timestamp.now() and serverTimestamp() inconsistently. A documented pattern would prevent future inconsistencies.","evidence":["ARCHITECTURE.md: no timestamp usage policy","Mixed usage: 3 files use Timestamp.now(), 3+ files use serverTimestamp()"],"remediation":{"steps":["1. Add timestamp policy section to ARCHITECTURE.md","2. Document: always use serverTimestamp() for createdAt/updatedAt audit fields","3. Document when Timestamp.now() is acceptable (client-only display timestamps)"],"verification":["ARCHITECTURE.md contains timestamp usage policy","Policy referenced in onboarding docs"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Consistency::docs::timestamp_pattern_undocumented"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0054","status":"CONFIRMED"}
{"category":"Consistency","title":"Missing COLLECTIONS constants for 3 entities","fingerprint":"Consistency::lib/db/collections.ts::missing_entries","severity":"S3","effort":"E0","confidence":100,"files":["lib/db/collections.ts"],"line":null,"description":"COLLECTIONS constants object in lib/db/collections.ts is missing entries for quick_links, prayers, and dev/lighthouse/history. Components accessing these collections use raw string literals with no type safety or centralized reference.","evidence":["lib/db/collections.ts: no entry for quick_links","lib/db/collections.ts: no entry for prayers","lib/db/collections.ts: no entry for dev/lighthouse/history"],"remediation":{"steps":["1. Add QUICK_LINKS, PRAYERS, and LIGHTHOUSE_HISTORY to COLLECTIONS constant","2. Update components using these collections to use the new constants"],"verification":["COLLECTIONS contains entries for all collection names used in codebase","No raw string literals for these 3 collections remain"]},"sources":[{"source":"claude","file":"refactoring-claude.jsonl","original_fingerprint":"Consistency::lib/db/collections.ts::missing_entries"}],"verified":true,"consensus_score":2,"canonical_id":"CANON-0055","status":"CONFIRMED"}
{"category":"Types/Correctness","title":"Potential duplicated domain types across lib/types and types/ with drift risk","fingerprint":"Types/Correctness::types/journal.ts::JournalEntry::possible-type-drift","severity":"S3","effort":"E1","confidence":35,"files":["types/journal.ts","hooks/use-journal.ts","lib/firestore-service.ts"],"symbols":["JournalEntry","useJournal","createFirestoreService"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"When types exist in multiple places or get re-exported inconsistently, refactors become risky and runtime validation gets skipped.","suggested_fix":"Confirm whether overlapping Journal/DailyLog/Inventory entity definitions exist outside types/*. If so, consolidate into types/ and re-export from lib/types if desired.","acceptance_tests":["npm run lint","npm run test","npm run test:coverage"],"pr_bucket_suggestion":"types-domain","dependencies":[],"evidence":["hooks/use-journal.ts imports JournalEntry from '@/types/journal' while FirestoreService also shapes journal payloads"],"notes":"Needs full search to confirm drift; suspected only.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Types/Correctness::types/journal.ts::JournalEntry::possible-type-drift"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0056","status":"SUSPECTED"}
{"category":"Testing Infrastructure","title":"Dependency health baselines (circular/unused exports) not verifiable; potential drift","fingerprint":"Testing Infrastructure::knip.json::knip::needs-fresh-baseline","severity":"S3","effort":"E1","confidence":30,"files":["knip.json","package.json"],"symbols":["knip","scripts.deps:circular","scripts.deps:unused"],"duplication_cluster":{"is_cluster":false},"why_it_matters":"Even small circular/unused-export drift compounds refactoring cost and encourages awkward boundaries.","suggested_fix":"Run npm run deps:circular and npm run deps:unused in CI and keep a documented baseline; fail on regressions.","acceptance_tests":["npm run deps:circular","npm run deps:unused"],"pr_bucket_suggestion":"tests-hardening","dependencies":[],"evidence":["package.json defines deps:circular and deps:unused but they are not part of npm test pipeline"],"notes":"Cannot run these commands (no node_modules), so this remains suspected.","sources":[{"source":"chatgpt","file":"refactoring-chatgpt.jsonl","original_fingerprint":"Testing Infrastructure::knip.json::knip::needs-fresh-baseline"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0057","status":"SUSPECTED"}
{"category":"Architecture","title":"SonarQube cognitive complexity unmeasured","fingerprint":"Architecture::analysis::sonarqube_unmeasured","severity":"S3","effort":"E1","confidence":40,"files":["components/admin/users-tab.tsx","components/admin/errors-tab.tsx","functions/src/admin.ts"],"line":null,"description":"SUSPECTED: No SonarQube analysis found (no analysis/sonarqube-manifest.md). Cognitive complexity metrics for mega-components and the 4108-line admin.ts are unmeasured. Metrics would quantify refactoring priority and track improvement.","evidence":["No analysis/sonarqube-manifest.md found","admin.ts: 4108 lines, complexity unmeasured","users-tab.tsx: 2092 lines, 43 state hooks, complexity unmeasured","errors-tab.tsx: 1095 lines, complexity unmeasured"],"remediation":{"steps":["1. Run SonarQube scan on codebase","2. Capture cognitive complexity metrics for identified mega-files","3. Set complexity thresholds for components and functions"],"verification":["SonarQube scan results available","Complexity metrics documented for priority files"]},"sources":[{"source":"claude-code","file":"refactoring-claude-code.jsonl","original_fingerprint":"Architecture::analysis::sonarqube_unmeasured"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0058","status":"SUSPECTED"}
{"category":"Duplication","title":"Repeated HTMLMotionProps<'button'> extension across Growth components","fingerprint":"Duplication::components/growth::repeated_html_motion_props","severity":"S3","effort":"E0","confidence":75,"files":["components/growth/GratitudeCard.tsx","components/growth/NightReviewCard.tsx","components/growth/SpotCheckCard.tsx","components/growth/Step1WorksheetCard.tsx"],"line":null,"description":"HTMLMotionProps<'button'> is repeatedly extended across multiple Growth components instead of using a shared type definition. Minor duplication but easy to consolidate.","evidence":["components/growth/GratitudeCard.tsx: extends HTMLMotionProps<'button'>","components/growth/NightReviewCard.tsx: extends HTMLMotionProps<'button'>","components/growth/SpotCheckCard.tsx: extends HTMLMotionProps<'button'>","components/growth/Step1WorksheetCard.tsx: extends HTMLMotionProps<'button'>"],"remediation":{"steps":["1. Extract shared AnimatedButtonProps type to a shared types file","2. Replace individual HTMLMotionProps extensions with shared type"],"verification":["Single AnimatedButtonProps type definition","All Growth components use shared type"]},"acceptance_tests":["Verify fix applied correctly"],"sources":[{"source":"jules","file":"refactoring-jules.jsonl","original_fingerprint":"Duplication::components/growth::repeated_html_motion_props"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0059","status":"SUSPECTED"}
{"category":"Security","title":"Potential path traversal risk in test scripts using non-literal fs arguments","fingerprint":"Security::tests::potential_path_traversal_test_scripts","severity":"S3","effort":"E1","confidence":35,"files":["tests/scripts/validate-audit-s0s1.test.ts"],"line":null,"description":"SUSPECTED: Lint warnings indicate non-literal arguments to filesystem methods (existsSync, writeFileSync) in test scripts. While low risk in a test environment, validating inputs or using path.join with sanitization is recommended as a defensive measure.","evidence":["Test scripts use non-literal arguments to existsSync and writeFileSync","Lint warnings for filesystem method usage"],"remediation":{"steps":["1. Validate file paths in test scripts using path.join()","2. Ensure no user-controlled input reaches filesystem methods"],"verification":["All filesystem calls in tests use validated, literal or path.join-constructed paths"]},"acceptance_tests":["Verify fix applied correctly"],"sources":[{"source":"jules","file":"refactoring-jules.jsonl","original_fingerprint":"Security::tests::potential_path_traversal_test_scripts"}],"verified":true,"consensus_score":1.5,"canonical_id":"CANON-0060","status":"SUSPECTED"}