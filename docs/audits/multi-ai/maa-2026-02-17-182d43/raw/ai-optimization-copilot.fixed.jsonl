{"category":"ai-optimization","title":"COMMAND_REFERENCE.md is 109KB â€” loaded on demand but risks massive token cost if read","fingerprint":"ai-optimization::.claude/COMMAND_REFERENCE.md::oversized-reference-doc","severity":"S1","effort":"E2","confidence":85,"files":[".claude/COMMAND_REFERENCE.md"],"why_it_matters":"At 109KB, this single file consumes ~27,000 tokens if read in full. Any skill or session flow that reads this file injects massive context. It duplicates information already present in individual SKILL.md files and HOOKS.md.","suggested_fix":"Split into focused reference files (commands-ref.md, agents-ref.md, hooks-ref.md) under 10KB each, or create a lightweight index that links to sections on demand.","acceptance_tests":["COMMAND_REFERENCE.md replaced with files <15KB each","No skill/hook reads the full 109KB file in a single operation","All information is still accessible via smaller, focused files"],"evidence":[".claude/COMMAND_REFERENCE.md has size 108,954 bytes","Content duplicates slash command, agent, skill, hook, and MCP docs that each have their own files"]}
{"category":"ai-optimization","title":"Shell hooks (.sh) are dead code â€” replaced by .js equivalents but still present","fingerprint":"ai-optimization::.claude/hooks/shell-hooks::dead-shell-hooks","severity":"S2","effort":"E0","confidence":90,"files":[".claude/hooks/session-start.sh",".claude/hooks/check-mcp-servers.sh",".claude/hooks/check-edit-requirements.sh",".claude/hooks/check-write-requirements.sh",".claude/hooks/pattern-check.sh"],"why_it_matters":"settings.json references only .js versions (session-start.js, check-mcp-servers.js, post-write-validator.js, pattern-check.js). The .sh scripts are not invoked by any hook, CI workflow, or npm script. They add ~35KB of dead code that confuses audits and inflates the hooks directory.","suggested_fix":"Delete the 5 .sh files after verifying no other script references them. The .js equivalents are already the active versions.","acceptance_tests":[".claude/hooks/*.sh files are removed","All functionality still works via .js hooks","No references to deleted .sh files remain in docs or scripts"],"evidence":["settings.json hooks reference: session-start.js, check-mcp-servers.js, post-write-validator.js","check-edit-requirements.sh and check-write-requirements.sh are not referenced in settings.json at all","session-start.sh comments say 'Cross-platform replacement for session-start.sh' in session-start.js"]}
{"category":"ai-optimization","title":"session-start.js uses execSync with shell:true â€” subprocess overhead + injection risk","fingerprint":"ai-optimization::.claude/hooks/session-start.js::execsync-shell-true","severity":"S1","effort":"E1","confidence":95,"files":[".claude/hooks/session-start.js"],"why_it_matters":"session-start.js runs on every session start and uses execSync with {shell: true} for npm ci, npm run build, and version checks (lines 49, 55, 306-311). This spawns a shell subprocess for each command, adding latency and introducing shell injection risk. The hook itself warns about exec injection patterns in post-write-validator.js.","suggested_fix":"Replace execSync({shell:true}) with execFileSync('npm', ['ci', ...], {shell:false}) for npm commands. Use execFileSync('node', ['-v']) for version checks.","acceptance_tests":["No execSync calls with shell:true remain in session-start.js","All npm commands use execFileSync with argument arrays","Session startup time is not degraded"],"evidence":["Line 18: const { execSync } = require('node:child_process')","Line 306-311: execSync(command, { shell: true, timeout: timeoutMs })","Lines 49, 55: execSync('node -v'), execSync('npm -v')"]}
{"category":"ai-optimization","title":"stop-serena-dashboard.js uses 6+ execFileSync calls at session start â€” port check may be unnecessary","fingerprint":"ai-optimization::.claude/hooks/stop-serena-dashboard.js::unnecessary-session-start-overhead","severity":"S2","effort":"E1","confidence":80,"files":[".claude/hooks/stop-serena-dashboard.js"],"why_it_matters":"This hook runs on every SessionStart and spawns multiple synchronous child processes (lsof, ps, kill) to stop a Serena dashboard that may not be running. In remote Claude Code environments, Serena is unlikely to be active. The hook is 250+ lines of security-hardened process termination code that executes unconditionally.","suggested_fix":"Add a fast-path check: if port 24282 is not listening, exit immediately with zero subprocess spawns. Or make this hook conditional on a local-only environment flag.","acceptance_tests":["Hook exits in <5ms when no process is listening on port 24282","No child processes are spawned when port is free","Hook still correctly stops Serena when it IS running"],"evidence":["settings.json line 28-32: stop-serena-dashboard.js runs on every SessionStart","Hook uses execFileSync for: lsof, ps (multiple calls), kill/SIGTERM","Already has continueOnError: true suggesting it's non-essential"]}
{"category":"ai-optimization","title":"check-edit-requirements.sh and check-write-requirements.sh share ~90% identical code","fingerprint":"ai-optimization::.claude/hooks/check-edit-write-requirements::duplicate-shell-hooks","severity":"S2","effort":"E1","confidence":95,"files":[".claude/hooks/check-edit-requirements.sh",".claude/hooks/check-write-requirements.sh"],"why_it_matters":"These two shell scripts have nearly identical input validation, path sanitization, security keyword matching, and file type classification. They differ only in the specific post-task messages. This duplication means bugs must be fixed in two places. However, these are also dead .sh files (see dead shell hooks finding), so this is only relevant if the .sh files are kept.","suggested_fix":"Since .js replacements exist (post-write-validator.js handles Write/Edit/MultiEdit), simply delete both .sh files. If .sh files need to stay, merge into a single parameterized script.","acceptance_tests":["Either both .sh files deleted, or consolidated into one parameterized script","No duplicated validation logic exists across hooks"],"evidence":["check-edit-requirements.sh lines 1-75 are structurally identical to check-write-requirements.sh lines 1-76","Both have identical path traversal rejection, sanitization, and security keyword regex","settings.json uses post-write-validator.js for all Write/Edit/MultiEdit operations"]}
{"category":"ai-optimization","title":"post-write-validator.js and pattern-check.js share identical INLINE_PATTERNS arrays","fingerprint":"ai-optimization::.claude/hooks/post-write-validator-pattern-check::duplicated-inline-patterns","severity":"S2","effort":"E1","confidence":95,"files":[".claude/hooks/post-write-validator.js",".claude/hooks/pattern-check.js"],"why_it_matters":"Both hooks contain identical INLINE_PATTERNS arrays (~70 lines each) with the same regex patterns for clickable div, test-mock-firestore, SQL injection, and shell injection detection. The checkInlinePatterns function is also duplicated. Any pattern update must be made in both files or they drift.","suggested_fix":"Extract INLINE_PATTERNS and checkInlinePatterns into a shared module (e.g., .claude/hooks/lib/inline-patterns.js) and import from both hooks.","acceptance_tests":["INLINE_PATTERNS defined in exactly one file","Both hooks import from the shared module","Pattern check behavior unchanged"],"evidence":["post-write-validator.js lines 480-540: identical patterns to pattern-check.js lines 91-158","checkInlinePatterns function logic is duplicated in both files","Both contain sql-injection-risk, shell-command-injection, test-mock-firestore-directly patterns"]}
{"category":"ai-optimization","title":"Multiple hooks contain duplicated gitExec helper function","fingerprint":"ai-optimization::.claude/hooks/multiple::duplicated-gitexec-helper","severity":"S2","effort":"E1","confidence":90,"files":[".claude/hooks/post-read-handler.js",".claude/hooks/pre-compaction-save.js",".claude/hooks/compaction-handoff.js",".claude/hooks/commit-tracker.js",".claude/hooks/check-remote-session-context.js"],"why_it_matters":"At least 5 hooks define their own gitExec() function with identical logic: execFileSync('git', args, {cwd, encoding, timeout}). This is ~10 lines duplicated 5 times. The state-utils.js shared module pattern already exists but doesn't include git utilities.","suggested_fix":"Add a gitExec function to .claude/hooks/lib/ (either state-utils.js or a new git-utils.js) and import it from all hooks.","acceptance_tests":["gitExec defined in exactly one shared module","All 5+ hooks import from the shared module","Git operations still work correctly from all hooks"],"evidence":["post-read-handler.js: function gitExec(args) { try { return execFileSync('git', args, {cwd: projectDir ...})","pre-compaction-save.js: function gitExec(args) { try { return execFileSync('git', args, {cwd: projectDir ...})","compaction-handoff.js, commit-tracker.js, check-remote-session-context.js all have equivalent functions"]}
{"category":"ai-optimization","title":"Multiple hooks contain duplicated projectDir security validation boilerplate","fingerprint":"ai-optimization::.claude/hooks/multiple::duplicated-projectdir-validation","severity":"S2","effort":"E1","confidence":90,"files":[".claude/hooks/post-read-handler.js",".claude/hooks/commit-tracker.js",".claude/hooks/compaction-handoff.js",".claude/hooks/check-mcp-servers.js",".claude/hooks/agent-trigger-enforcer.js",".claude/hooks/check-remote-session-context.js"],"why_it_matters":"At least 6 hooks contain identical ~15-line boilerplate for resolving and validating CLAUDE_PROJECT_DIR with path traversal protection. This pattern includes safeBaseDir, projectDirInput, path.resolve, platform-specific lowercase checks, and bidirectional containment validation. Any security fix must be applied to all copies.","suggested_fix":"Extract into .claude/hooks/lib/project-dir.js that exports a validated projectDir. All hooks import it.","acceptance_tests":["Project directory validation defined in exactly one module","All hooks use the shared module","Path traversal protection still works"],"evidence":["post-read-handler.js lines 40-55: safeBaseDir/projectDirInput/projectDir/baseForCheck/projectForCheck pattern","commit-tracker.js lines 24-40: identical pattern","compaction-handoff.js lines 35-50: identical pattern","check-remote-session-context.js lines 67-76: same pattern with minor variant"]}
{"category":"ai-optimization","title":"Scripts not in package.json: add-false-positive.js, assign-review-tier.js, seed-commit-log.js, sync-claude-settings.js â€” potentially dead","fingerprint":"ai-optimization::scripts::unreferenced-scripts","severity":"S2","effort":"E1","confidence":75,"files":["scripts/add-false-positive.js","scripts/assign-review-tier.js","scripts/seed-commit-log.js","scripts/sync-claude-settings.js","scripts/enrichment_failures.json"],"why_it_matters":"These scripts exist in scripts/ but have no entry in package.json scripts section. They may be called by skills, hooks, or used manually, but without a package.json entry they're harder to discover and may be truly dead code. enrichment_failures.json (6KB) appears to be output data committed to the repo.","suggested_fix":"Verify each script's usage: check if any SKILL.md, hook, or CI workflow references them. If unused, delete. If used, add to package.json for discoverability. Move enrichment_failures.json to .gitignore if it's generated output.","acceptance_tests":["Each script either has a package.json entry or is confirmed used by a skill/hook","enrichment_failures.json is either documented or removed","No truly orphaned scripts remain"],"evidence":["package.json scripts section has 90 entries but none reference add-false-positive.js, assign-review-tier.js, seed-commit-log.js, or sync-claude-settings.js","scripts/enrichment_failures.json is a 6KB data file in the scripts directory","sync-claude-settings.js IS referenced in CROSS_PLATFORM_SETUP.md and HOOKS.md docs"]}
{"category":"ai-optimization","title":"hook-warnings-log.jsonl has repetitive low-value entries â€” no rotation","fingerprint":"ai-optimization::.claude/state/hook-warnings-log.jsonl::unbounded-log-growth","severity":"S2","effort":"E1","confidence":85,"files":[".claude/state/hook-warnings-log.jsonl"],"why_it_matters":"hook-warnings-log.jsonl grows unbounded with 15 nearly identical entries visible ('WARNING TRIGGERS (recommended actions):' repeated with only timestamps differing). Over time this file will grow indefinitely, consuming storage and making log analysis harder. The same trigger fires on every push without new information.","suggested_fix":"Add log rotation: keep only the last 100 entries (or last 7 days). Deduplicate consecutive identical messages (store count instead of repeating).","acceptance_tests":["hook-warnings-log.jsonl has a maximum size or entry count","Consecutive duplicate messages are deduplicated","Rotation runs automatically (e.g., in session-start or pre-push)"],"evidence":[".claude/state/hook-warnings-log.jsonl: 15 entries visible, 14 are identical 'WARNING TRIGGERS' messages","Each entry is ~170 bytes, growing without bounds","No rotation logic found in any hook or script"]}
{"category":"ai-optimization","title":"MCP servers configured but 4 are disabled â€” disabled list should match actual config","fingerprint":"ai-optimization::.claude/settings.json::disabled-mcp-servers","severity":"S3","effort":"E0","confidence":80,"files":[".claude/settings.json",".claude/mcp.global-template.json"],"why_it_matters":"settings.json disables 4 MCP servers (rube, serena, nextjs-devtools, filesystem) but mcp.global-template.json only defines 2 servers (ccusage, playwright). The disabled servers reference names that don't appear in the template, suggesting stale configuration from removed MCP servers.","suggested_fix":"Remove disabled server names that no longer exist in any MCP config. Document which MCP servers are intentionally disabled and why.","acceptance_tests":["disabledMcpjsonServers only contains names that exist in .mcp.json","Stale server names are removed","A comment or doc explains disabled servers"],"evidence":["settings.json line 6: disabledMcpjsonServers: [\"rube\", \"serena\", \"nextjs-devtools\", \"filesystem\"]","mcp.global-template.json only defines: ccusage, playwright","The disabled servers may be in .mcp.json (user-local file not in repo) â€” confidence adjusted"]}
{"category":"ai-optimization","title":"session-start.js runs verbose console output on every session â€” format waste","fingerprint":"ai-optimization::.claude/hooks/session-start.js::verbose-session-output","severity":"S2","effort":"E1","confidence":80,"files":[".claude/hooks/session-start.js"],"why_it_matters":"session-start.js outputs detailed status messages ('ðŸ“‹ Environment:', node/npm versions, 'â”' separator lines, emoji-prefixed status for every step) that consume ~200-400 tokens of Claude's context window on every single session. Much of this is human-readable formatting (box-drawing characters, emoji) that provides no actionable information to the AI.","suggested_fix":"Reduce output to a single summary line ('SessionStart: OK (3 warnings)' or 'SessionStart: deps installed, functions built'). Detailed output can go to a log file if needed for debugging.","acceptance_tests":["Session start output is <5 lines for the success path","Detailed logs written to .claude/state/session-start.log if needed","Warnings still surface clearly"],"evidence":["Lines 43-44: emoji + separator line","Lines 47-60: environment version logging","Lines 219-235: multi-line secrets status","Lines 304-312: per-step status with emoji"]}
{"category":"ai-optimization","title":"Multiple hooks duplicate loadJson/saveJson atomic write pattern","fingerprint":"ai-optimization::.claude/hooks/multiple::duplicated-json-io","severity":"S3","effort":"E1","confidence":85,"files":[".claude/hooks/post-read-handler.js",".claude/hooks/compaction-handoff.js",".claude/hooks/pre-compaction-save.js"],"why_it_matters":"At least 3 hooks implement their own loadJson/saveJson functions with atomic write (temp file + rename) and symlink guard integration. The state-utils.js module already provides readState/writeState but some hooks don't use it, duplicating the atomic write pattern with slight variations.","suggested_fix":"Standardize on state-utils.js for all JSON state I/O. Extend it if needed for non-state-directory paths.","acceptance_tests":["All hooks use state-utils.js or a single shared JSON I/O module","No duplicated atomic-write implementations remain","Existing functionality unchanged"],"evidence":["post-read-handler.js lines 86-155: loadJson + saveJson with backup-swap","compaction-handoff.js lines 66-84: loadJson + saveJson","state-utils.js already exports readState/writeState with atomic writes"]}