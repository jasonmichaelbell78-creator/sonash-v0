{"category":"ai-optimization","title":"Cross-cutting: Hook process spawn explosion — 10+ Node.js processes per tool use across all hook domains","fingerprint":"ai-optimization::cross-cutting::hook-process-spawn-explosion","severity":"S1","effort":"E2","confidence":95,"files":[".claude/settings.json",".claude/hooks/check-requirements.js",".claude/hooks/pattern-check.js",".claude/hooks/firestore-write-block.js",".claude/hooks/app-check-validator.js",".claude/hooks/typescript-strict-check.js",".claude/hooks/repository-pattern-check.js",".claude/hooks/test-mocking-validator.js",".claude/hooks/component-size-check.js",".claude/hooks/agent-trigger-enforcer.js",".claude/hooks/audit-s0s1-validator.js",".claude/hooks/large-context-warning.js",".claude/hooks/auto-save-context.js",".claude/hooks/compaction-handoff.js",".claude/hooks/alerts-reminder.js",".claude/hooks/analyze-user-request.js",".claude/hooks/session-end-reminder.js",".claude/hooks/plan-mode-suggestion.js"],"why_it_matters":"The single most impactful architectural issue: every Write spawns 10 processes, every Edit spawns 9, every Read spawns 3, every UserPromptSubmit spawns 4. This is 26+ process spawns per edit-read-prompt cycle. At ~40ms cold-start each, that is over 1 second of pure process overhead per interaction cycle. Connects findings: 2a::posttooluse-write::10-sequential-hooks, 2a::posttooluse-edit::9-sequential-hooks, 2a::posttooluse-read::redundant-state-tracking, 2a::userpromptsubmit::4-hooks-every-message, 2a::posttooluse::duplicate-file-reads, 2d::write-hook-overload, 2d::read-hook-overhead.","suggested_fix":"Consolidate into 3 unified hook entry points: (1) post-tool-use-write-edit.js for all Write/Edit/MultiEdit checks, (2) context-monitor.js for all Read tracking, (3) user-prompt-handler.js for all UserPromptSubmit logic. Each reads target file once, runs all checks in-process, shares state. Reduces 26 spawns to 3 per cycle.","acceptance_tests":["Write/Edit triggers 1 hook process instead of 9-10","Read triggers 1 hook process instead of 3","UserPromptSubmit triggers 1 hook process instead of 4","Total per-cycle latency under 200ms"]}
{"category":"ai-optimization","title":"Cross-cutting: Unbounded append-only state files with no rotation across 5+ JSONL/JSON files","fingerprint":"ai-optimization::cross-cutting::unbounded-state-file-growth","severity":"S2","effort":"E1","confidence":92,"files":[".claude/state/commit-log.jsonl",".claude/state/reviews.jsonl",".claude/state/agent-invocations.jsonl",".claude/override-log.jsonl",".claude/state/warned-files.json",".claude/state/velocity-log.jsonl",".claude/state/handoff.json"],"why_it_matters":"Systemic pattern: every state file is append-only with zero rotation, archival, or size-cap logic. commit-log.jsonl (39KB), reviews.jsonl (19KB), handoff.json (25KB with embedded commit log), warned-files.json (48 entries no expiry), override-log.jsonl, and agent-invocations.jsonl all grow without bound. The 166:16 session begin/end imbalance (2e finding) means the cleanup mechanism (session-end) runs only 10% of the time, compounding the problem. Connects findings: 2e::commit-log.jsonl::no-rotation, 2e::reviews.jsonl::no-rotation, 2e::override-log.jsonl::no-rotation, 2e::agent-invocations.jsonl::no-rotation, 2e::warned-files.json::no-expiry, 2e::handoff.json::embedded-commit-log.","suggested_fix":"Create a unified state-hygiene.js module with rotation logic for all JSONL files (keep last N entries, archive rest) and expiry logic for JSON files (prune entries older than 30 days or referencing deleted files). Call it from session-start.js (not session-end) to ensure it runs on every session regardless of whether session-end is invoked.","acceptance_tests":["All JSONL state files have documented size caps","Rotation runs on session-start, not session-end","No state file exceeds its cap after rotation","Total .claude/state/ directory size stays under 50KB"]}
{"category":"ai-optimization","title":"Cross-cutting: Decorative/verbose stdout output injected into context across hooks and skills","fingerprint":"ai-optimization::cross-cutting::stdout-context-injection-bloat","severity":"S2","effort":"E1","confidence":88,"files":[".claude/hooks/session-start.js",".claude/hooks/alerts-reminder.js",".claude/hooks/analyze-user-request.js",".claude/hooks/compact-restore.js",".claude/hooks/auto-save-context.js",".claude/hooks/large-context-warning.js",".claude/hooks/commit-tracker.js"],"why_it_matters":"Systemic pattern: hooks use console.log (stdout) for decorative output, which gets injected into Claude's context window. session-start.js outputs ~50 lines of checklist/tips, alerts-reminder.js injects on every prompt, analyze-user-request.js re-injects directives on every matching message, compact-restore.js injects stale recovery blocks. Combined, hooks inject 100-200 lines of non-actionable text into context per session. Connects findings: 1b::session-start.js::verbose-decorative-output, 1b::hooks::decorative-error-output, 2d::session-start.js::checklist-stdout-bloat, 2d::alerts-reminder.js::context-injection-every-prompt, 2d::analyze-user-request.js::directive-context-injection, 2d::compact-restore.js::stale-handoff-injection.","suggested_fix":"Establish a hook output protocol: stdout (context-injected) is ONLY for actionable warnings requiring agent response. All decorative, informational, and repeated messages go to stderr (user-visible only). Add a hookOutput(message, {level: 'info'|'warn'|'action'}) helper that routes to the correct stream. Apply across all hooks.","acceptance_tests":["Total stdout from all hooks combined is under 15 lines per session when no issues exist","Decorative borders and emoji are on stderr only","Repeated alerts use cooldown before re-injecting to stdout","hookOutput helper is used by all hooks"]}
{"category":"ai-optimization","title":"Cross-cutting: Duplicated boilerplate across audit skills — 50%+ shared content in 9 skill files","fingerprint":"ai-optimization::cross-cutting::audit-skill-boilerplate-duplication","severity":"S2","effort":"E2","confidence":85,"files":[".claude/skills/audit-comprehensive/SKILL.md",".claude/skills/audit-code/SKILL.md",".claude/skills/audit-security/SKILL.md",".claude/skills/audit-ai-optimization/SKILL.md",".claude/skills/audit-performance/SKILL.md",".claude/skills/audit-process/SKILL.md",".claude/skills/audit-enhancements/SKILL.md",".claude/skills/audit-documentation/SKILL.md",".claude/skills/audit-refactoring/SKILL.md",".claude/skills/doc-optimizer/SKILL.md"],"why_it_matters":"Systemic duplication across the skill layer: 9 audit skills share Persistence Rules, Output Format, checkpoint logic, and TDMS integration instructions (50%+ overlap, ~4000 duplicated lines). doc-optimizer separately duplicates CRITICAL RETURN PROTOCOL 13 times within its own SKILL.md. Agent prompts across audit-process, audit-documentation, and audit-enhancements lack standardized JSONL format specs and return protocols that other skills have. Connects findings: 1c::audit-*/SKILL.md::shared-boilerplate-duplication, 1c::doc-optimizer/SKILL.md::duplicated-return-protocol, 2b::audit-process/SKILL.md::missing-return-protocol, 2b::audit-documentation/SKILL.md::vague-agent-prompts, 2b::audit-enhancements/SKILL.md::missing-jsonl-spec-in-prompt.","suggested_fix":"Create .claude/skills/audit-shared-base.md containing: Persistence Rules, JSONL Output Format schema, Checkpoint Protocol, CRITICAL RETURN PROTOCOL, FALSE_POSITIVES.jsonl loading, and TDMS Integration. Each audit SKILL.md includes one reference line. Also standardize all agent prompts to include the JSONL schema and return protocol from the shared base.","acceptance_tests":["Shared base file exists with all common sections","Each audit SKILL.md references shared base instead of duplicating","doc-optimizer CRITICAL RETURN PROTOCOL appears once","All agent prompts include JSONL schema and return protocol","Total audit skill lines reduced by 40%+"]}
{"category":"ai-optimization","title":"Cross-cutting: Session-end rarely runs (10% rate) — all cleanup logic is unreachable","fingerprint":"ai-optimization::cross-cutting::session-end-unreachable-cleanup","severity":"S2","effort":"E1","confidence":92,"files":[".claude/hooks/.session-state.json",".claude/skills/session-end/SKILL.md",".claude/state/commit-log.jsonl",".claude/state/reviews.jsonl",".claude/tmp-alerts.json",".claude/hooks/.session-agents.json",".claude/hooks/.agent-trigger-state.json",".claude/state/task-audit-template-overhaul.state.json"],"why_it_matters":"Root cause that explains multiple findings: 166 session begins vs 16 session ends means session-end cleanup runs only ~10% of the time. All state cleanup depends on session-end step 6, which almost never executes. This is WHY state files grow unbounded (no rotation), temp files persist (.claude/tmp-alerts.json), ephemeral files are not cleaned (.session-agents.json, .agent-trigger-state.json), and stale task states linger (task-audit-template-overhaul.state.json). Fixing this ONE root cause makes all state management findings less severe. Connects findings: 2e::.session-state.json::begin-end-imbalance, 2e::commit-log.jsonl::no-rotation, 2e::reviews.jsonl::no-rotation, 2e::tmp-alerts.json::persistent-temp, 2e::session-end/SKILL.md::missing-ephemeral-cleanup, 2e::task-audit-template-overhaul.state.json::stale-task.","suggested_fix":"Move critical cleanup from session-end to session-start.js (which runs 100% of sessions): (1) prune JSONL files exceeding size caps, (2) delete .claude/tmp-*.json, (3) remove ephemeral agent state files, (4) expire stale task state files older than 7 days. Session-end keeps its audit/review steps but is no longer the sole cleanup mechanism.","acceptance_tests":["session-start.js performs state hygiene on every startup","Cleanup runs even when session-end is skipped","State files are bounded regardless of session-end invocation rate","Session-end cleanup is a bonus, not the only path"]}
{"category":"ai-optimization","title":"Cross-cutting: Duplicated regex and parsing patterns across 5+ hooks without shared helpers","fingerprint":"ai-optimization::cross-cutting::duplicated-parsing-helpers","severity":"S2","effort":"E1","confidence":85,"files":[".claude/hooks/commit-tracker.js",".claude/hooks/auto-save-context.js",".claude/hooks/session-start.js",".claude/hooks/pattern-check.js",".claude/hooks/compaction-handoff.js",".claude/hooks/pre-compaction-save.js"],"why_it_matters":"Multiple hooks implement identical logic independently: JSONL line counting (.trim().split('\\n').filter(Boolean).length in 5 locations), markdown field extraction (/Current Session Count.*:(\\d+)/i in 3+ locations), git command execution patterns (some use execSync with shell, others use execFileSync without). This creates maintenance burden and inconsistency — compaction-handoff.js uses execSync (shell injection risk) while commit-tracker.js uses execFileSync (safe). Connects findings: 1b::scripts::duplicated-jsonl-line-count, 1b::scripts::duplicated-markdown-field-regex, 2a::compaction-handoff.js::execsync-shell-overhead.","suggested_fix":"Create scripts/lib/hook-helpers.js with: countJsonlLines(filePath), parseMarkdownField(content, fieldName), gitExec(args) using execFileSync. Import in all hooks. This also fixes the execSync security issue as a side effect — one safe implementation replaces all variants.","acceptance_tests":["hook-helpers.js exists with countJsonlLines, parseMarkdownField, gitExec","All hooks import from hook-helpers instead of inline implementations","No execSync used for git commands (all use the shared gitExec helper)","JSONL counting is consistent across all hooks"]}
{"category":"ai-optimization","title":"Cross-cutting: Skill index desynchronized from filesystem — 9 orphaned skills + 2 duplicates + stale superseded entry","fingerprint":"ai-optimization::cross-cutting::skill-index-desync","severity":"S2","effort":"E0","confidence":98,"files":[".claude/skills/SKILL_INDEX.md",".claude/skills/find-skills/SKILL.md",".claude/skills/pre-commit-fixer/SKILL.md",".claude/skills/task-next/SKILL.md",".claude/skills/multi-ai-audit/SKILL.md",".claude/skills/add-debt/SKILL.md",".claude/skills/verify-technical-debt/SKILL.md",".claude/skills/pr-retro/SKILL.md",".claude/skills/sonarcloud/SKILL.md",".claude/skills/test-suite/SKILL.md",".claude/skills/sonarcloud-sprint/SKILL.md"],"why_it_matters":"Systemic index maintenance failure: 9 skills exist on filesystem but are missing from SKILL_INDEX.md (find-skills, pre-commit-fixer, task-next, multi-ai-audit, add-debt, verify-technical-debt, pr-retro, sonarcloud, test-suite). 2 skills are listed twice (code-reviewer, senior-fullstack). sonarcloud-sprint is listed but superseded by sonarcloud. The header claims 55 skills but the actual unique count is wrong. This means skill discovery is broken — users cannot find 16% of available skills. Connects findings: 2b::find-skills::orphaned-from-index, 2b::pre-commit-fixer::orphaned-from-index, 2b::task-next::orphaned-from-index, 2b::multi-ai-audit::orphaned-from-index, 2b::add-debt::orphaned-from-index, 2b::verify-technical-debt::orphaned-from-index, 2b::pr-retro::orphaned-from-index, 2b::sonarcloud::orphaned-from-index, 2b::test-suite::orphaned-from-index, 2b::SKILL_INDEX.md::code-reviewer-duplicate-listing, 2b::SKILL_INDEX.md::senior-fullstack-duplicate-listing, 2b::sonarcloud-sprint::superseded-by-sonarcloud, 2b::SKILL_INDEX.md::inaccurate-skill-count.","suggested_fix":"Automate index generation: create scripts/sync-skill-index.js that reads all .claude/skills/*/SKILL.md directories, extracts title/description from each SKILL.md, and regenerates SKILL_INDEX.md. Add to pre-commit hook or session-start to prevent future drift. Immediately fix by adding 9 missing skills, removing 2 duplicates, replacing sonarcloud-sprint with sonarcloud.","acceptance_tests":["All skills in filesystem are listed in SKILL_INDEX.md","No duplicate listings","sonarcloud-sprint replaced by sonarcloud","Total count matches ls .claude/skills/ | wc -l","sync-skill-index.js script prevents future drift"]}
{"category":"ai-optimization","title":"Cross-cutting: Oversized skill files loaded fully into context — 5 skills exceed 500 lines","fingerprint":"ai-optimization::cross-cutting::oversized-skill-context-cost","severity":"S2","effort":"E2","confidence":85,"files":[".claude/skills/doc-optimizer/SKILL.md",".claude/skills/audit-comprehensive/SKILL.md",".claude/skills/pr-review/SKILL.md",".claude/skills/session-begin/SKILL.md",".claude/skills/code-reviewer/SKILL.md",".claude/skills/audit-process/SKILL.md"],"why_it_matters":"Skill files are loaded entirely into context when invoked. Five skills exceed 500 lines: doc-optimizer (~800 lines with 13x duplicated return protocol), audit-comprehensive (854 lines), pr-review (840 lines), session-begin (361 lines with redundant hook-automated sections), code-reviewer (313 lines with 150 lines of irrelevant generic boilerplate). Combined, these consume ~30K tokens when invoked. session-begin runs every session making its bloat particularly costly. Connects findings: 1c::doc-optimizer/SKILL.md::duplicated-return-protocol, 2d::pr-review/SKILL.md::oversized-skill-file, 2d::audit-comprehensive/SKILL.md::oversized-skill-file, 2d::session-begin/SKILL.md::skill-bloat, 2d::code-reviewer/SKILL.md::generic-boilerplate.","suggested_fix":"Apply a consistent split pattern: each SKILL.md has a core protocol (under 300 lines) and a REFERENCE.md for situational sections. Core loads always; reference loads on-demand. For session-begin: remove hook-automated sections. For code-reviewer: strip non-project technologies. For doc-optimizer: extract shared return protocol. Target: no SKILL.md over 400 lines.","acceptance_tests":["No SKILL.md exceeds 400 lines","Reference sections in separate files loaded on-demand","session-begin under 300 lines","code-reviewer has no irrelevant technology references","Total token cost of skill loading reduced by 40%+"]}
{"category":"ai-optimization","title":"Cross-cutting: MCP configuration debt — unused servers, stale permissions, and dead tool references","fingerprint":"ai-optimization::cross-cutting::mcp-configuration-debt","severity":"S2","effort":"E1","confidence":88,"files":[".mcp.json",".claude/settings.local.json",".claude/mcp.global-template.json",".claude/skills/save-context/SKILL.md",".claude/skills/audit-enhancements/SKILL.md",".claude/skills/pr-retro/SKILL.md"],"why_it_matters":"Systemic MCP configuration neglect: git server configured but unused and redundant with Bash git. filesystem server duplicates native Read/Write/Glob/Grep tools with 7 stale permissions. memory server not enabled but 3 skills reference mcp__memory__ tools (silent failures). serena has 3 approved permissions but is in disabledMcpjsonServers. github listed in enabledMcpjsonServers but not configured in .mcp.json. puppeteer in global template conflicts with active playwright. Total: 13+ stale permission entries and 3 unused server configs consuming startup overhead. Connects findings: 2c::git-server-unused, 2c::memory-server-not-enabled, 2c::filesystem-server-redundant, 2c::github-server-unconfigured, 2c::stale-filesystem-permissions, 2c::stale-serena-permissions, 2c::puppeteer-playwright-conflict, 2c::firebase-server-ambiguous.","suggested_fix":"MCP cleanup sweep: (1) Remove git and filesystem servers from .mcp.json, (2) Either enable memory server or remove mcp__memory__ from 3 skills, (3) Remove all mcp__filesystem__* and mcp__serena__* permissions from settings.local.json, (4) Remove github from enabledMcpjsonServers, (5) Update global template to use playwright. Net result: cleaner config, faster startup, no silent tool failures.","acceptance_tests":["Only actively-used MCP servers in .mcp.json","No stale permissions in settings.local.json","No skill references tools from disabled/unconfigured servers","MCP startup overhead reduced by removing unused servers"]}
{"category":"ai-optimization","title":"Cross-cutting: Session startup critical path exceeds 30 seconds from sequential operations across hooks and skills","fingerprint":"ai-optimization::cross-cutting::session-startup-critical-path","severity":"S2","effort":"E2","confidence":90,"files":[".claude/hooks/session-start.js",".claude/hooks/check-remote-session-context.js",".claude/hooks/stop-serena-dashboard.js",".claude/skills/session-begin/SKILL.md","ROADMAP.md","docs/agent_docs/CODE_PATTERNS.md"],"why_it_matters":"Session startup is the cumulative result of multiple findings: session-start.js spawns 6+ sequential execSync subprocesses (2a finding), check-remote-session-context.js does synchronous git fetch + up to 11 git subprocess spawns (2a finding), stop-serena-dashboard.js spawns PowerShell with 500-2000ms cold start (2a finding), then session-begin skill reads ROADMAP.md fully (3164 lines, 2d finding), CODE_PATTERNS.md (600 lines, 2d finding), INDEX.md, DOCUMENT_DEPENDENCIES.md, and runs crossdoc:check. Total startup: 30-60 seconds of wall time plus 4000+ lines of mandatory context reads. Connects findings: 2a::session-start.js::sequential-execsync, 2a::check-remote-session-context.js::git-fetch-critical-path, 2a::stop-serena-dashboard.js::powershell-subprocess-overhead, 2d::session-begin/SKILL.md::full-roadmap-read, 2d::session-begin/SKILL.md::code-patterns-startup-read, 2d::session-begin/SKILL.md::excessive-mandatory-reads.","suggested_fix":"Three-pronged fix: (1) Parallelize independent operations in session-start.js using Promise.all (node -v, npm -v, pattern check, consolidation can all run concurrently), (2) Make check-remote-session-context.js non-blocking (advisory output) with fetch caching, (3) Make session-begin reads surgical (ROADMAP Active Sprint only via offset/limit, CODE_PATTERNS Quick Reference only, conditional crossdoc:check). Target: under 10 seconds startup, under 500 lines mandatory reads.","acceptance_tests":["Session startup completes in under 15 seconds","Independent hook operations run in parallel","ROADMAP.md reads only Active Sprint section","CODE_PATTERNS.md reads only Quick Reference section","crossdoc:check only runs when doc files changed"]}
{"category":"ai-optimization","title":"Cross-cutting: Skill overlap clusters — 4 distinct overlap groups with unclear boundaries","fingerprint":"ai-optimization::cross-cutting::skill-overlap-clusters","severity":"S2","effort":"E2","confidence":80,"files":[".claude/skills/sonarcloud-sprint/SKILL.md",".claude/skills/sonarcloud/SKILL.md",".claude/skills/frontend-design/SKILL.md",".claude/skills/senior-frontend/SKILL.md",".claude/skills/ui-design-system/SKILL.md",".claude/skills/ux-researcher-designer/SKILL.md",".claude/skills/senior-qa/SKILL.md",".claude/skills/webapp-testing/SKILL.md",".claude/skills/test-suite/SKILL.md",".claude/skills/checkpoint/SKILL.md",".claude/skills/save-context/SKILL.md",".claude/skills/docs-sync/SKILL.md",".claude/skills/docs-update/SKILL.md"],"why_it_matters":"Four distinct overlap clusters where users cannot determine which skill to invoke: (1) sonarcloud-sprint is superseded by sonarcloud but both exist, (2) frontend-design vs senior-frontend vs ui-design-system vs ux-researcher-designer form a 3-4 way design overlap, (3) senior-qa vs webapp-testing vs test-suite overlap on testing execution, (4) checkpoint vs save-context and docs-sync vs docs-update are near-duplicates. This creates decision paralysis and risks invoking the wrong skill. Connects findings: 2b::sonarcloud-sprint::superseded-by-sonarcloud, 2b::frontend-design::overlaps-senior-frontend, 2b::ui-design-system::3-way-design-overlap, 2b::senior-qa::testing-skill-overlap, 2b::checkpoint::overlaps-save-context, 2b::docs-sync::overlaps-docs-update.","suggested_fix":"Resolution per cluster: (1) Delete sonarcloud-sprint, keep sonarcloud with --sprint flag, (2) Add decision tree to SKILL_INDEX for design skills with clear boundaries, (3) Merge webapp-testing into test-suite, keep senior-qa for strategy, (4) Merge checkpoint+save-context and docs-sync+docs-update into single skills. Net: remove 4 skills, add decision trees for remaining overlaps.","acceptance_tests":["sonarcloud-sprint directory deleted","Design skills have documented decision tree in SKILL_INDEX","webapp-testing merged into test-suite","checkpoint and save-context merged","docs-sync and docs-update merged","No user-facing ambiguity about which skill to use"]}
{"category":"ai-optimization","title":"Cross-cutting: execSync vs execFileSync inconsistency creates both performance and security issues","fingerprint":"ai-optimization::cross-cutting::execsync-inconsistency","severity":"S2","effort":"E1","confidence":90,"files":[".claude/hooks/compaction-handoff.js",".claude/hooks/commit-tracker.js",".claude/hooks/pre-compaction-save.js",".claude/hooks/session-start.js",".claude/hooks/check-remote-session-context.js"],"why_it_matters":"Some hooks use execSync (spawns shell, injection risk, ~20-50ms overhead) while others use execFileSync (direct process, safe, faster) for identical git operations. compaction-handoff.js uses execSync for all 5 git calls while commit-tracker.js and pre-compaction-save.js correctly use execFileSync. session-start.js uses execSync for npm/node version checks. This inconsistency is both a performance issue (unnecessary shell spawns) and a security issue (shell injection via crafted branch names or paths). The shared helper pattern from the duplicated-parsing-helpers finding would fix this automatically. Connects findings: 2a::compaction-handoff.js::execsync-shell-overhead, 2a::session-start.js::sequential-execsync, 2a::pre-compaction-save.js::7-sequential-git-calls, 2a::commit-tracker.js::4-git-subprocesses.","suggested_fix":"Standardize on execFileSync for all subprocess calls across hooks via the shared gitExec helper. Audit every execSync call and migrate to execFileSync with array arguments. This is a simple mechanical fix that improves both security and performance.","acceptance_tests":["Zero execSync calls remain in .claude/hooks/ (all migrated to execFileSync)","gitExec shared helper handles all git subprocess calls","No shell injection risk from crafted branch names or paths"]}
