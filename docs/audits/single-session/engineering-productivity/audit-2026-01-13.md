# SoNash Engineering Productivity Audit Report

**Date:** 2026-01-13 **Auditor:** Staff+ Engineering Productivity Specialist
**Repo:** https://github.com/jasonmichaelbell78-creator/sonash-v0

---

## Purpose

This audit identifies engineering productivity inefficiencies and provides
prioritized recommendations for improvements to development workflows, tooling,
and documentation.

## Version History

| Version | Date       | Changes              |
| ------- | ---------- | -------------------- |
| 1.0     | 2026-01-13 | Initial audit report |

---

## Executive Summary

### Top 5 Inefficiencies

| #   | Issue                                                                         | Location                                        | Impact                                 |
| --- | ----------------------------------------------------------------------------- | ----------------------------------------------- | -------------------------------------- |
| 1   | No offline queue - writes fail when offline despite offline being REQUIRED    | `hooks/use-journal.ts:319-340`                  | Data loss, user frustration            |
| 2   | Scattered golden path - dev workflow info in 4+ files                         | `DEVELOPMENT.md`, `README.md`, `AI_WORKFLOW.md` | Context switching, onboarding friction |
| 3   | Logger not integrated with Sentry - production errors lack structured context | `lib/logger.ts:107-109` (TODO comment)          | Harder debugging                       |
| 4   | CI runs npm ci twice - no cache sharing between jobs                          | `.github/workflows/ci.yml:24,119`               | ~60s wasted per CI run                 |
| 5   | No doctor script - environment validation done manually                       | `package.json` (missing script)                 | Hours lost to "works on my machine"    |

### Top 5 Simplifications (by ROI)

| #   | Change                                                  | Effort | ROI                                          |
| --- | ------------------------------------------------------- | ------ | -------------------------------------------- |
| 1   | Add `npm run dev:offline` for emulator mode             | S      | High - single command for offline dev        |
| 2   | Create `docs/DEV_WORKFLOW.md` as single source of truth | S      | High - stops doc hunting                     |
| 3   | Integrate `logger.error` with `Sentry.captureMessage`   | S      | High - all errors now in Sentry with context |
| 4   | Add `scripts/doctor.js` for env validation              | S      | High - saves hours on setup issues           |
| 5   | Cache npm ci in CI between jobs                         | S      | Medium - 60s faster CI                       |

### Do These 3 Things This Week

1. **EFF-004: Integrate logger with Sentry (~30 min)**
   - Remove TODO at `lib/logger.ts:107`
   - Add `Sentry.captureMessage(message, { level: 'error', extra: context })`
   - Immediately improves production debugging

2. **EFF-003: Add doctor script (~1 hour)**
   - Create `scripts/doctor.js` to check Node version, Firebase CLI, env vars
   - Add `npm run doctor` to `package.json`
   - Saves future setup headaches

3. **EFF-001: Add dev:offline script (~30 min)**
   - `npm install -D concurrently`
   - Add
     `"dev:offline": "concurrently \"firebase emulators:start\" \"npm run dev\""`
   - Enables easy offline testing

### Stop Doing

- Stop manually running `firebase emulators:start` in separate terminal
- Stop looking in multiple docs for dev commands
- Stop ignoring offline scenarios in testing

---

## Golden Path (Solo Dev, Daily Deploy)

### Current State vs Target

| Step        | Current                                      | Target                                   |
| ----------- | -------------------------------------------- | ---------------------------------------- |
| Setup       | `npm install && cd functions && npm install` | `npm run setup` (one command)            |
| Dev         | `npm run dev`                                | ✅ Works                                 |
| Offline Dev | Manual: 2 terminals                          | `npm run dev:offline`                    |
| Test        | `npm test`                                   | ✅ Works                                 |
| Deploy      | `git push` (triggers CI)                     | ✅ Works                                 |
| Verify      | Manual testing                               | `npm run smoke`                          |
| Rollback    | Unknown                                      | `firebase hosting:rollback` (needs docs) |

### Proposed Golden Path Commands

```bash
# Setup (one-time)
npm run setup              # Installs deps, runs doctor, shows next steps

# Daily Development
npm run dev                # Online mode (uses production Firebase)
npm run dev:offline        # Offline mode (uses emulators)

# Testing
npm test                   # Unit tests (~10s)
npm run smoke              # Quick E2E verification (~30s)

# Deploy
git push origin main       # CI runs, deploys to Firebase

# Verify
npm run smoke -- --prod    # Verify production deployment

# Rollback (if needed)
firebase hosting:rollback --site sonash-app
```

---

## Debugging Playbook

### Where to Look First

1. **Browser DevTools Console** - client-side errors
2. **Sentry Dashboard** - production errors with context
3. **Firebase Console → Functions → Logs** - server-side errors
4. **`npm run dev` console output** - development errors

### How to Capture Logs

- Enable verbose logging: `localStorage.setItem('debug', 'true')`
- Export Sentry event link from Sentry dashboard
- Use browser DevTools → Network → filter by `/functions/` for Cloud Function
  calls

### How to Reproduce

- Get user's network status (online/offline) at time of bug
- Check Sentry for correlation ID (once implemented)
- Use `npm run dev:offline` to test offline scenarios
- Use Firebase Emulator UI at `localhost:4000` to inspect Firestore state

---

## Findings by Tier

### Quick Wins (S effort, do this week)

#### EFF-001: Add `npm run dev:offline` Script

- **Evidence:** `package.json:5-12` - no offline dev command exists
- **Why:** Developers must manually run 2 terminals for offline testing
- **Fix:** Add concurrently + script
- **Verification:** `npm run dev:offline`, verify `localhost:3000` and
  `localhost:4000` work

#### EFF-002: Create `docs/DEV_WORKFLOW.md`

- **Evidence:** Info scattered across `DEVELOPMENT.md` (759 lines), `README.md`,
  `AI_WORKFLOW.md`
- **Why:** Solo dev wastes time hunting for commands
- **Fix:** Create single 100-line doc with all golden path commands
- **Verification:** New developer can follow doc end-to-end

#### EFF-003: Add `scripts/doctor.js`

- **Evidence:** `package.json` - no environment validation script
- **Why:** Missing env vars cause cryptic errors
- **Fix:** Script that checks Node, npm, Firebase CLI, `.env.local`
- **Verification:** `npm run doctor` passes on working setup, fails clearly on
  broken setup

#### EFF-004: Integrate Logger with Sentry

- **Evidence:** `lib/logger.ts:107-109` - TODO comment for 4+ weeks
- **Why:** 50+ `logger.error` calls never reach Sentry
- **Fix:** Add `Sentry.captureMessage` in production error handler
- **Verification:** Trigger error, verify appears in Sentry with context

#### EFF-005: Cache npm ci Between CI Jobs

- **Evidence:** `.github/workflows/ci.yml:24,119` - `npm ci` runs twice
- **Why:** ~60s wasted per CI run
- **Fix:** Merge jobs or add explicit cache
- **Verification:** CI time decreases by ~60s

### Medium Wins (M effort, do next sprint)

#### EFF-006: Add Correlation IDs

- **Evidence:** `lib/logger.ts` - no request tracing
- **Why:** Can't correlate frontend errors with backend logs
- **Fix:** Generate correlation ID per request, pass through all logs
- **Verification:** Make request, find same correlation ID in frontend and
  backend logs

#### EFF-007: Add Network Status to Logs

- **Evidence:** `lib/logger.ts` - no offline context
- **Why:** When errors occur, no visibility into online/offline state
- **Fix:** Add `isOnline` to logger context and Sentry tags
- **Verification:** Go offline, trigger error, see `isOnline: false` in Sentry

#### EFF-008: Create Smoke Test Script

- **Evidence:** `package.json` - no smoke test command
- **Why:** No quick way to verify deployment
- **Fix:** Script that hits homepage, auth endpoint, Cloud Function
- **Verification:** `npm run smoke` passes on healthy deployment

#### EFF-009: Add Bug Report Template

- **Evidence:** `.github/` - only one issue template (App Check specific)
- **Why:** Bug reports missing critical info (offline status, env)
- **Fix:** Create `.github/ISSUE_TEMPLATE/bug_report.md`
- **Verification:** New issue shows template with all fields

### Deep Refactors (L effort, plan for Q2)

#### EFF-010: Implement Offline Queue (CRITICAL)

- **Evidence:** `hooks/use-journal.ts:319-340` - all writes require network
- **Why:** Offline is REQUIRED but writes fail when offline
- **Fix:** IndexedDB queue with pending/synced/failed states, sync on reconnect
- **Verification:** Go offline, make entry, verify pending state, go online,
  verify sync

#### EFF-011: Add Offline Tests

- **Evidence:** `tests/firestore-service.test.ts:53-67` - tests skipped for
  Cloud Functions
- **Why:** No automated testing of offline scenarios
- **Fix:** Mock network status, test queue behavior
- **Verification:** `npm test -- --grep offline` all pass

#### EFF-012: Split Large Cloud Functions Files

- **Evidence:** `functions/src/admin.ts` (36KB), `functions/src/index.ts` (25KB)
- **Why:** Large files harder to maintain, slower cold starts
- **Fix:** Split by domain (admin-health, admin-dashboard, etc.)
- **Verification:** Deploy, verify all functions still work

---

## Process/Docs/Commands Section

### Documentation Assessment

| Document            | Lines  | Purpose               | Recommendation                                     |
| ------------------- | ------ | --------------------- | -------------------------------------------------- |
| `DEVELOPMENT.md`    | 759    | Dev setup             | Keep, but extract golden path to `DEV_WORKFLOW.md` |
| `README.md`         | 280    | Project overview      | Keep, link to `DEV_WORKFLOW.md`                    |
| `AI_WORKFLOW.md`    | 600    | AI agent instructions | Keep separate                                      |
| `docs/*.md`         | 19,654 | Various               | Archive older docs, consolidate where possible     |
| `scripts/README.md` | 150    | Script documentation  | Keep, add script discovery command                 |

### Missing Documentation

- **Rollback procedure** - How to revert a bad deployment
- **Offline behavior spec** - What should happen when offline
- **Debugging runbook** - Step-by-step for common issues

### Script Discovery Problem

**Problem:** 41 scripts in `scripts/` folder. Hard to find the right one.

**Solution:** Add `npm run scripts:list` that categorizes scripts:

- **Dev:** doctor, seed, dev:offline
- **Test:** test, smoke
- **Deploy:** (handled by CI)
- **Docs:** docs:check, docs:index
- **Review:** review:check, patterns:check

### Recommended Repo Conventions

- **One command per workflow step** - setup, dev, test, deploy, verify, rollback
- **Scripts in npm, not direct node calls** - `npm run seed` not
  `npx tsx scripts/seed.ts`
- **Docs under 200 lines or split** - Long docs are rarely read
- **Error messages include fix hints** - "Run `npm run doctor` to check setup"

---

## Offline-Specific Section

### Current Strategy

| Component           | Implementation                                 | Status               |
| ------------------- | ---------------------------------------------- | -------------------- |
| Offline Detection   | `navigator.onLine` (implicit)                  | Not explicit         |
| Local Storage       | `lib/utils/storage.ts` - localStorage wrapper  | ✅ Works             |
| Backup              | `lib/utils/anonymous-backup.ts` - localStorage | ✅ Works but limited |
| Sync Queue          | None                                           | ❌ MISSING           |
| Conflict Resolution | None                                           | ❌ MISSING           |
| Offline UI          | None (errors shown)                            | ❌ MISSING           |

### Failure Modes

1. **Write when offline** → Cloud Function call fails → Error shown to user →
   Data lost
2. **Go offline mid-write** → Retry 3x with backoff → Eventually fails → Data
   lost
3. **Reconnect after offline** → No sync → Previous writes lost
4. **Conflict (edited on two devices)** → No resolution → Last write wins (data
   loss)

### Proposed Offline Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      User Action                             │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   Network Check                              │
│         navigator.onLine + periodic ping                     │
└──────────────┬───────────────────────┬──────────────────────┘
               │                       │
        Online │               Offline │
               ▼                       ▼
┌──────────────────────┐   ┌──────────────────────────────────┐
│   Cloud Function     │   │   IndexedDB Queue                │
│   (immediate sync)   │   │   status: 'pending'              │
└──────────────────────┘   └─────────────┬────────────────────┘
                                         │
                                         ▼ (on reconnect)
                           ┌──────────────────────────────────┐
                           │   Sync Queue to Cloud            │
                           │   - Batch writes                 │
                           │   - Conflict resolution          │
                           │   - status: 'synced' or 'failed' │
                           └──────────────────────────────────┘
```

### Reproducible Offline Test Recipe

```bash
# 1. Start in offline mode
npm run dev:offline

# 2. Create a journal entry (should work locally)

# 3. In DevTools → Network → check "Offline"

# 4. Create another journal entry
# CURRENT: Shows error
# TARGET: Shows pending indicator, queues write

# 5. Uncheck "Offline"

# 6. Verify entry syncs
# CURRENT: Entry is lost
# TARGET: Entry syncs automatically, shows synced indicator
```

---

## Dependencies & Bundle

### Unused Dependencies (from `npm run deps:unused`)

```
Unlisted dependencies (1):
leaflet.markercluster/dist/MarkerCluster.css  components/maps/meeting-map.tsx:8:9
```

**Recommendation:** Add `leaflet.markercluster` to dependencies or use CSS
import from CDN.

### Large Dependencies

| Package                 | Size   | Necessary?                     |
| ----------------------- | ------ | ------------------------------ |
| firebase                | ~500KB | Yes (core functionality)       |
| recharts                | ~200KB | Yes (analytics charts)         |
| framer-motion           | ~150KB | Review usage - may be overkill |
| leaflet + react-leaflet | ~150KB | Yes (maps)                     |

### Consolidation Opportunities

- **Date libraries** - Using date-fns (good choice, tree-shakeable)
- **UI components** - Using shadcn/ui (good choice, copy-paste components)
- **Form handling** - Using react-hook-form + zod (good choices)

### Scripts/CI Impact

- **Current CI time:** ~4-5 minutes
- **After caching fix:** ~3-4 minutes
- **Main bottlenecks:** npm ci (60s), build (60s), tests (30s)

---

## Appendix: File References

| Finding           | File                            | Lines   |
| ----------------- | ------------------------------- | ------- |
| No offline queue  | `hooks/use-journal.ts`          | 319-340 |
| Logger TODO       | `lib/logger.ts`                 | 107-109 |
| Anonymous backup  | `lib/utils/anonymous-backup.ts` | 36-67   |
| CI double install | `.github/workflows/ci.yml`      | 24, 119 |
| Retry utility     | `lib/utils/retry.ts`            | 124-181 |
| Error handling    | `lib/utils/callable-errors.ts`  | 113-148 |
| Firestore service | `lib/firestore-service.ts`      | 175-253 |
| Large admin file  | `functions/src/admin.ts`        | 1-1000+ |
