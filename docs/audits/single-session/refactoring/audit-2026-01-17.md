# Refactoring Audit - 2026-01-17

## Baselines

| Metric | Value |
|--------|-------|
| SonarCloud CRITICAL code smells | 0 (no CRITICAL issues currently) |
| Circular dependencies | 0 (madge clean) |
| Unused exports | 1 (lint-staged in devDependencies) |
| Files > 300 lines | 23 |
| Files > 500 lines | 9 |
| Files > 700 lines | 4 |
| TODO/FIXME/HACK markers | 2 |
| Linter suppressions | 4 |
| Total files analyzed | 159 |

### Largest Files (Potential God Objects)

| Lines | File |
|-------|------|
| 1117 | components/notebook/pages/today-page.tsx |
| 924 | components/admin/users-tab.tsx |
| 845 | components/growth/Step1WorksheetCard.tsx |
| 728 | components/notebook/pages/resources-page.tsx |
| 617 | lib/db/meetings.ts |
| 582 | components/growth/NightReviewCard.tsx |
| 566 | components/settings/settings-page.tsx |
| 554 | components/onboarding/onboarding-wizard.tsx |
| 529 | components/admin/logs-tab.tsx |

## Findings Summary

| Severity | Count | Category | Confidence |
|----------|-------|----------|------------|
| S0 | 0 | - | - |
| S1 | 4 | GodObject (2), Duplication (1), Architecture (1) | HIGH |
| S2 | 5 | GodObject (2), Duplication (2), Architecture (1) | HIGH/MEDIUM |
| S3 | 3 | TechDebt | HIGH |

**Total: 12 findings (0 S0, 4 S1, 5 S2, 3 S3)**

## Category Breakdown

### 1. God Objects (4 findings)

| ID | Severity | File | Metrics |
|----|----------|------|---------|
| REF-001 | S1 | today-page.tsx:1 | 1117 lines, 14 useState, 10 useEffect, 24 imports |
| REF-002 | S1 | users-tab.tsx:1 | 924 lines, 21 useState, 5 interfaces |
| REF-003 | S2 | Step1WorksheetCard.tsx:1 | 845 lines, 34 data fields, 4 constants |
| REF-004 | S2 | resources-page.tsx:1 | 728 lines, 3 responsibilities |

**Key Insight**: 4 files exceed 700 lines. TodayPage and UsersTab are the highest-priority split candidates.

### 2. Code Duplication (3 findings)

| ID | Severity | Pattern | Instances |
|----|----------|---------|-----------|
| REF-005 | S1 | Time-of-day rotation logic | 2 files (80+ lines each) |
| REF-006 | S2 | reCAPTCHA token fetch | 5 instances |
| REF-007 | S2 | Growth card dialog/save | 4 components |

**Key Insight**: REF-005 (content rotation) is the highest-value extraction - fixing bugs in one place instead of two.

### 3. Architecture Violations (2 findings)

| ID | Severity | Issue | Impact |
|----|----------|-------|--------|
| REF-008 | S1 | Direct Firebase SDK in 22+ files | SDK changes require 22+ file edits |
| REF-009 | S2 | Deprecated method still used | Dual write paths, inconsistent metadata |

**Key Insight**: Firebase SDK scattered usage is the top architecture concern.

### 4. Technical Debt (3 findings)

| ID | Severity | Issue | Count |
|----|----------|-------|-------|
| REF-010 | S3 | Duplicate interface definition | 1 file |
| REF-011 | S3 | TODO markers | 2 |
| REF-012 | S3 | Linter suppressions | 4 |

**Key Insight**: Technical debt count is low - only 2 TODOs and 4 suppressions is healthy.

## Cross-Reference with CANON-REFACTOR

| This Audit | CANON Finding | Status |
|------------|---------------|--------|
| REF-001 | CANON-0072 | Still relevant (TodayPage god component) |
| REF-005 | CANON-0065 | Still relevant (rotation duplication) |
| REF-006 | CANON-0076 | Still relevant (reCAPTCHA duplication) |
| REF-007 | CANON-0079 | Still relevant (growth card pattern) |
| REF-008 | CANON-0075 | Still relevant (Firebase SDK scattered) |
| REF-009 | CANON-0070 | Still relevant (deprecated method) |
| REF-010 | CANON-0087 | Still relevant (duplicate interface) |

**7 of 12 findings align with prior Multi-AI audit** - indicates these are persistent issues requiring dedicated sprint.

## False Positives Filtered

- 0 findings excluded (no matches in FALSE_POSITIVES.jsonl for refactoring category)

Note: FP-004 (explicit ESLint disables with comments) matches REF-012, but REF-012 is documented as-is rather than filtered.

## Quick Wins (E0-E1)

1. **REF-010**: Remove duplicate CloudFunctionError interface (~5 min)
2. **REF-011**: Convert TODOs to GitHub issues (~15 min)
3. **REF-005**: Extract time rotation to lib/utils/content-rotation.ts (~2 hours)
4. **REF-006**: Create callSecureFunction wrapper (~2 hours)

**Estimated Quick Win Time**: ~4.5 hours for top 4 quick wins

## Batch Fix Opportunities

| Pattern | Auto-Fixable | Tool |
|---------|--------------|------|
| Duplicate CloudFunctionError | Yes | Manual (1 deletion) |
| TODO markers | Partial | Convert to issues |

No large-scale auto-fixable batches identified in refactoring category.

## Recommendations

### Immediate (This Sprint)

1. **Extract content rotation utility** (REF-005) - Highest value for code quality
2. **Remove duplicate interface** (REF-010) - Quick 5-minute fix
3. **Convert TODOs to issues** (REF-011) - Track properly

### Short-term (Next Sprint)

4. **Create callSecureFunction wrapper** (REF-006) - Security + DRY
5. **Extract useGrowthCardDialog hook** (REF-007) - Reduces 4 components
6. **Split TodayPage** (REF-001) - Highest-impact refactor

### Medium-term

7. **Centralize Firebase SDK access** (REF-008) - Architecture improvement
8. **Migrate from deprecated method** (REF-009) - Remove dual write
9. **Split UsersTab** (REF-002) - Admin panel cleanup

## Positive Findings

- **No circular dependencies** - madge reports clean
- **Only 2 TODO markers** - codebase is well-maintained
- **Only 4 linter suppressions** - TypeScript discipline is good
- **Only 1 unused export** - knip shows clean dependency graph
- **SonarCloud CRITICAL: 0** - no critical code smells currently

## Comparison with Prior Audit (2026-01-10)

| Metric | 2026-01-10 | 2026-01-17 | Change |
|--------|------------|------------|--------|
| Files > 300 lines | ~20 | 23 | +3 |
| Circular deps | 0 | 0 | No change |
| TODO markers | ~5 | 2 | -3 (improved) |
| CANON findings still open | 27 | 7 tracked | Good persistence |

Key observations:
- TODO count reduced (good maintenance)
- Large file count slightly increased (more features)
- Prior CANON findings still relevant - need dedicated refactoring sprint

---

## Audit Metadata

| Field | Value |
|-------|-------|
| Date | 2026-01-17 |
| Auditor | Claude Code (claude-opus-4-5-20251101) |
| Scope | app/, components/, lib/, hooks/, functions/ |
| Duration | Single session |
| Commits Since Last Audit | 295 |
| Files Changed | 248 |
| Prior Audit | 2026-01-10 (Multi-AI, 27 canonical findings) |
