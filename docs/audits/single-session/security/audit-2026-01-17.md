# Security Audit - 2026-01-17

## Baselines

| Metric                       | Value                                                            |
| ---------------------------- | ---------------------------------------------------------------- |
| npm audit                    | 0 vulnerabilities (0 critical, 0 high, 0 moderate, 0 low)        |
| Security ESLint warnings     | 307 warnings (documented false positives per FP-011 to FP-015)   |
| SonarCloud Security Hotspots | 97 TO_REVIEW (14 HIGH, 48 MEDIUM, 35 LOW)                        |
| SonarCloud Vulnerabilities   | 0                                                                |
| Security-sensitive files     | 16 changed since last audit                                      |
| .env files                   | .env.local, .env.local.example, .env.production (all gitignored) |

### SonarCloud Security Hotspot Breakdown

| Category                        | HIGH | MEDIUM | LOW | Total |
| ------------------------------- | ---- | ------ | --- | ----- |
| auth (hard-coded password)      | 4    | 0      | 0   | 4     |
| command-injection               | 10   | 0      | 0   | 10    |
| dos (ReDoS)                     | 0    | 33     | 0   | 33    |
| weak-cryptography (Math.random) | 0    | 15     | 0   | 15    |
| rce (javascript:)               | 0    | 1      | 0   | 1     |
| encrypt-data (http)             | 0    | 0      | 1   | 1     |
| others (PATH, SHA, geolocation) | 0    | 0      | 34  | 34    |

## Findings Summary

| Severity | Count | OWASP Category     | Confidence  |
| -------- | ----- | ------------------ | ----------- |
| S0       | 0     | -                  | -           |
| S1       | 2     | A01, A05           | HIGH        |
| S2       | 3     | A02, A03           | MEDIUM      |
| S3       | 6     | A02, A05, A06, A07 | HIGH/MEDIUM |

**Total: 11 findings (2 HIGH carry-forward from prior audit)**

## Critical/High Findings (Immediate Action)

### SEC-001: Missing critical security headers (S1) - CARRY-FORWARD

**File:** firebase.json:6 **OWASP:** A05:2021 Security Misconfiguration
**Status:** UNRESOLVED from audit-2026-01-13 (SEC-002)

Missing headers:

- Content-Security-Policy (CSP)
- X-Frame-Options
- X-Content-Type-Options
- Strict-Transport-Security (HSTS)
- Referrer-Policy
- Permissions-Policy

**Impact:** Clickjacking, MIME-sniffing attacks, protocol downgrade attacks, XSS
risk increased.

**Recommendation:** Add comprehensive security headers to firebase.json. Start
with permissive CSP and tighten iteratively.

---

### SEC-002: App Check disabled on Cloud Functions (S1) - CARRY-FORWARD

**File:** functions/src/index.ts:84 **OWASP:** A01:2021 Broken Access Control
**Status:** UNRESOLVED from audit-2026-01-13 (SEC-001)

Firebase App Check is disabled (`requireAppCheck: false`) on all Cloud Functions
with comment "TEMPORARILY DISABLED - waiting for throttle to clear".

**Impact:** Attackers can call Cloud Functions directly without proving they're
using the legitimate app.

**Recommendation:** Check if throttle period has cleared and re-enable App
Check.

## Medium Findings

### SEC-003: Hardcoded reCAPTCHA site key fallback (S2)

- **File:** functions/src/recaptcha-verify.ts:66
- **Issue:** Hardcoded key makes rotation difficult
- **Recommendation:** Remove fallback, fail early if env var missing

### SEC-005: OS command execution in CLI scripts (S2)

- **File:** scripts/ai-review.js:222 + 9 other scripts
- **Issue:** execSync/spawnSync with potentially unsanitized paths
- **Recommendation:** Use array-based spawn, sanitize paths

### SEC-006: ReDoS vulnerable regex patterns (S2)

- **File:** functions/src/admin.ts:143, security-logger.ts:390, + 31 scripts
- **Issue:** 33 regexes vulnerable to super-linear backtracking
- **Recommendation:** Review production code regexes, add input bounds

## Low/Informational Findings

| ID      | File                                     | Issue                                                               | Status          |
| ------- | ---------------------------------------- | ------------------------------------------------------------------- | --------------- |
| SEC-004 | lib/utils/errors.ts:69                   | "Potentially hard-coded password" - FALSE POSITIVE (error messages) | No action       |
| SEC-007 | components/celebrations/\*.tsx           | Math.random for visual effects - FALSE POSITIVE                     | No action       |
| SEC-008 | .github/workflows/\*.yml                 | Actions using version tags vs SHA                                   | Low risk        |
| SEC-009 | .github/workflows/deploy-firebase.yml:58 | Secret expansion in run block                                       | Acceptable      |
| SEC-010 | components/providers/error-boundary.tsx  | NODE_ENV checks                                                     | Correct pattern |
| SEC-011 | .claude/settings.json                    | Agent configs present                                               | Reviewed safe   |

## False Positives Filtered

- 307 ESLint security warnings (FP-011 to FP-015 in FALSE_POSITIVES.jsonl)
- SEC-004: SonarCloud hard-coded password flag on error messages
- SEC-007: SonarCloud weak-cryptography flag on visual randomization

## Firestore Rules Review

Firestore rules (firestore.rules) are properly configured:

- User data requires `isOwner(userId)` for read/write
- Sensitive collections (journal, daily_logs, inventoryEntries) block direct
  writes
- Public collections (meetings, sober_living, etc.) are read-only
- Admin writes require `isAdmin()` custom claim
- Rate limits collection is Cloud Functions only

## Dependency Security

**npm audit:** 0 vulnerabilities - CLEAN

No known vulnerabilities in direct or transitive dependencies.

## Recommendations

### Immediate (Before Next Deploy)

1. **Add security headers to firebase.json** (SEC-001) - Unresolved since
   2026-01-13
2. **Check App Check throttle status** (SEC-002) - Re-enable if throttle cleared

### Short-term (This Week)

3. **Remove hardcoded reCAPTCHA fallback** (SEC-003)
4. **Review ReDoS patterns in production code** (SEC-006) - Especially admin.ts
   and security-logger.ts

### Ongoing

5. **Pin GitHub Actions to commit SHAs** (SEC-008)
6. **Sanitize paths in CLI scripts** (SEC-005) - Lower priority as dev-only

---

## Audit Metadata

| Field                    | Value                                                                         |
| ------------------------ | ----------------------------------------------------------------------------- |
| Date                     | 2026-01-17                                                                    |
| Auditor                  | Claude Code (claude-opus-4-5-20251101)                                        |
| Scope                    | app/, components/, lib/, functions/, firestore.rules, firebase.json, .claude/ |
| Duration                 | Single session                                                                |
| Commits Since Last Audit | 172                                                                           |
| Security Files Changed   | 16                                                                            |
| Prior Audit              | 2026-01-13 (11 findings, 2 HIGH unresolved)                                   |
