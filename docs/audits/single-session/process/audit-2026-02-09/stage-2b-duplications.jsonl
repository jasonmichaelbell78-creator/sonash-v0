{"category":"process","title":"Duplicated: ESLint validation in pre-commit AND CI","fingerprint":"process::.husky/pre-commit::eslint-duplication","severity":"S2","effort":"E1","confidence":"HIGH","files":[".husky/pre-commit:9",".github/workflows/ci.yml:28"],"why_it_matters":"Running ESLint in both pre-commit and CI is redundant - pre-commit already blocks commits with errors, so CI check adds no value but doubles execution time","suggested_fix":"Keep ESLint blocking in pre-commit, make CI check non-blocking or remove it entirely. CI should only catch cases where pre-commit was bypassed","acceptance_tests":["ESLint runs once per commit lifecycle","CI doesn't duplicate pre-commit blocking checks","Documentation clarifies which checks are gates vs audits"],"file":".husky/pre-commit","line":9,"description":"Running ESLint in both pre-commit and CI is redundant - pre-commit already blocks commits with errors, so CI check adds no value but doubles execution time","recommendation":"Keep ESLint blocking in pre-commit, make CI check non-blocking or remove it entirely. CI should only catch cases where pre-commit was bypassed","id":"process::.husky/pre-commit::eslint-duplication"}
{"category":"process","title":"Duplicated: Pattern compliance check in pre-commit AND CI","fingerprint":"process::.husky/pre-commit::pattern-check-duplication","severity":"S2","effort":"E1","confidence":"HIGH","files":[".husky/pre-commit:35",".github/workflows/ci.yml:58-75"],"why_it_matters":"Pattern compliance runs in pre-commit (blocking all files) and CI (PR changed files only). This creates inconsistent behavior and wastes CI resources","suggested_fix":"Decide single source: either pre-commit blocks all or CI blocks changed files. Remove the other. Current setup means pre-commit catches issues CI might miss","acceptance_tests":["Pattern check runs in exactly one place","Behavior is consistent for all commits","Documentation clarifies pattern enforcement strategy"],"file":".husky/pre-commit","line":35,"description":"Pattern compliance runs in pre-commit (blocking all files) and CI (PR changed files only). This creates inconsistent behavior and wastes CI resources","recommendation":"Decide single source: either pre-commit blocks all or CI blocks changed files. Remove the other. Current setup means pre-commit catches issues CI might miss","id":"process::.husky/pre-commit::pattern-check-duplication"}
{"category":"process","title":"Duplicated: Technical debt schema validation in pre-commit AND CI","fingerprint":"process::.husky/pre-commit::debt-validation-duplication","severity":"S2","effort":"E1","confidence":"HIGH","files":[".husky/pre-commit:248","github/workflows/ci.yml:95"],"why_it_matters":"Tech debt schema validation runs in both pre-commit (blocking when MASTER_DEBT.jsonl staged) and CI. Double validation on same file wastes resources","suggested_fix":"Keep pre-commit validation (faster feedback). Make CI check non-blocking or remove it","acceptance_tests":["Schema validation runs once per commit","CI provides visibility without duplication","Fast local feedback preserved"],"file":".husky/pre-commit","line":248,"description":"Tech debt schema validation runs in both pre-commit (blocking when MASTER_DEBT.jsonl staged) and CI. Double validation on same file wastes resources","recommendation":"Keep pre-commit validation (faster feedback). Make CI check non-blocking or remove it","id":"process::.husky/pre-commit::debt-validation-duplication"}
{"category":"process","title":"Duplicated: CANON schema validation in pre-commit AND CI","fingerprint":"process::.husky/pre-commit::canon-validation-duplication","severity":"S2","effort":"E1","confidence":"HIGH","files":[".husky/pre-commit:97",".github/workflows/ci.yml:84"],"why_it_matters":"CANON validation runs in pre-commit (non-blocking warning) and CI (blocking). Inconsistent - same validation with different severity in two places","suggested_fix":"Unify validation behavior. Either pre-commit blocks or CI blocks, not both. Current state: pre-commit warns, CI blocks - confusing","acceptance_tests":["CANON validation has single blocking point","Severity is consistent across environments","Clear documentation of validation strategy"],"file":".husky/pre-commit","line":97,"description":"CANON validation runs in pre-commit (non-blocking warning) and CI (blocking). Inconsistent - same validation with different severity in two places","recommendation":"Unify validation behavior. Either pre-commit blocks or CI blocks, not both. Current state: pre-commit warns, CI blocks - confusing","id":"process::.husky/pre-commit::canon-validation-duplication"}
{"category":"process","title":"Duplicated: Test execution in pre-commit AND CI","fingerprint":"process::.husky/pre-commit::test-duplication","severity":"S1","effort":"E2","confidence":"HIGH","files":[".husky/pre-commit:59-87",".github/workflows/ci.yml:115"],"why_it_matters":"Tests run in pre-commit (conditionally blocking) AND CI (always blocking). For config changes, tests run twice. Adds 30-60s to commit+push workflow","suggested_fix":"Pre-commit: quick smoke tests only for high-risk changes. CI: full test suite. Or skip pre-commit tests entirely, rely on CI","acceptance_tests":["Tests run once per commit-push cycle OR","Pre-commit runs subset, CI runs full suite","Total test time reduced by 30-50%"],"file":".husky/pre-commit","line":59,"description":"Tests run in pre-commit (conditionally blocking) AND CI (always blocking). For config changes, tests run twice. Adds 30-60s to commit+push workflow","recommendation":"Pre-commit: quick smoke tests only for high-risk changes. CI: full test suite. Or skip pre-commit tests entirely, rely on CI","id":"process::.husky/pre-commit::test-duplication","evidence":[{"type":"code_reference","detail":".husky/pre-commit:59"},{"type":"description","detail":"Tests run in pre-commit (conditionally blocking) AND CI (always blocking). For config changes, tests run twice. Adds 30-60s to commit+push workflow"}],"verification_steps":{"first_pass":{"method":"code_search","evidence_collected":[".husky/pre-commit:59"]},"second_pass":{"method":"contextual_review","confirmed":true},"tool_confirmation":{"tool":"NONE","result":"confirmed via manual code review","reference":".husky/pre-commit:59"}}}
{"category":"process","title":"Duplicated: Path validation logic across 16+ hooks","fingerprint":"process::.claude/hooks::path-validation-duplication","severity":"S1","effort":"E2","confidence":"HIGH","files":[".claude/hooks/check-edit-requirements.js:18-63",".claude/hooks/check-write-requirements.js:18-63",".claude/hooks/firestore-write-block.js:40-99",".claude/hooks/repository-pattern-check.js:50-108",".claude/hooks/typescript-strict-check.js:19-78",".claude/hooks/test-mocking-validator.js:19-78",".claude/hooks/app-check-validator.js:19-78","scripts/lib/validate-paths.js:50-137"],"why_it_matters":"16+ hooks duplicate identical path validation (security checks, traversal prevention, normalization). Total ~800 lines. Shared utility exists but unused. Bug fixes must be applied 16+ times","suggested_fix":"All hooks import and use validateFilePath() from scripts/lib/validate-paths.js. Delete inline duplicates","acceptance_tests":["All hooks use shared validateFilePath()","No inline path validation remains","Security fix in validate-paths.js applies to all hooks","Test coverage for shared utility is comprehensive"],"file":".claude/hooks/check-edit-requirements.js","line":18,"description":"16+ hooks duplicate identical path validation (security checks, traversal prevention, normalization). Total ~800 lines. Shared utility exists but unused. Bug fixes must be applied 16+ times","recommendation":"All hooks import and use validateFilePath() from scripts/lib/validate-paths.js. Delete inline duplicates","id":"process::.claude/hooks::path-validation-duplication","evidence":[{"type":"code_reference","detail":".claude/hooks/check-edit-requirements.js:18"},{"type":"description","detail":"16+ hooks duplicate identical path validation (security checks, traversal prevention, normalization). Total ~800 lines. Shared utility exists but unused. Bug fixes must be applied 16+ times"}],"verification_steps":{"first_pass":{"method":"code_search","evidence_collected":[".claude/hooks/check-edit-requirements.js:18"]},"second_pass":{"method":"contextual_review","confirmed":true},"tool_confirmation":{"tool":"NONE","result":"confirmed via manual code review","reference":".claude/hooks/check-edit-requirements.js:18"}}}
{"category":"process","title":"Duplicated: File reading logic across 5 hooks","fingerprint":"process::.claude/hooks::file-reading-duplication","severity":"S2","effort":"E1","confidence":"HIGH","files":[".claude/hooks/firestore-write-block.js:114-124",".claude/hooks/repository-pattern-check.js:123-133",".claude/hooks/typescript-strict-check.js:104-114",".claude/hooks/test-mocking-validator.js:95-105",".claude/hooks/app-check-validator.js:92-102"],"why_it_matters":"5 hooks duplicate identical file reading logic: check if content provided, resolve path, readFileSync with error handling. ~50 lines duplicated","suggested_fix":"Create shared utility readFileForHook(filePath, projectDir) in scripts/lib/validate-paths.js. All hooks use it","acceptance_tests":["Shared readFileForHook() utility exists","All hooks use shared implementation","Error handling is consistent","No inline file reading remains"],"file":".claude/hooks/firestore-write-block.js","line":114,"description":"5 hooks duplicate identical file reading logic: check if content provided, resolve path, readFileSync with error handling. ~50 lines duplicated","recommendation":"Create shared utility readFileForHook(filePath, projectDir) in scripts/lib/validate-paths.js. All hooks use it","id":"process::.claude/hooks::file-reading-duplication"}
{"category":"process","title":"Duplicated: Error message extraction pattern across 42+ files","fingerprint":"process::scripts::error-handling-duplication","severity":"S1","effort":"E2","confidence":"HIGH","files":["scripts/check-pattern-compliance.js:40","scripts/check-doc-headers.js:65-67","scripts/check-cross-doc-deps.js:64","scripts/debt/validate-schema.js:31","scripts/lib/sanitize-error.js:63-95"],"why_it_matters":"Pattern 'err instanceof Error ? err.message : String(err)' appears in 42+ files. Shared sanitizeError() utility exists but unused. Inconsistent error handling","suggested_fix":"All scripts import and use sanitizeError() from scripts/lib/sanitize-error.js. Replace inline pattern","acceptance_tests":["All scripts use shared sanitizeError()","No inline error extraction remains","Error messages are consistently sanitized","Security: no sensitive data in logs"],"file":"scripts/check-pattern-compliance.js","line":40,"description":"Pattern 'err instanceof Error ? err.message : String(err)' appears in 42+ files. Shared sanitizeError() utility exists but unused. Inconsistent error handling","recommendation":"All scripts import and use sanitizeError() from scripts/lib/sanitize-error.js. Replace inline pattern","id":"process::scripts::error-handling-duplication","evidence":[{"type":"code_reference","detail":"scripts/check-pattern-compliance.js:40"},{"type":"description","detail":"Pattern 'err instanceof Error ? err.message : String(err)' appears in 42+ files. Shared sanitizeError() utility exists but unused. Inconsistent error handling"}],"verification_steps":{"first_pass":{"method":"code_search","evidence_collected":["scripts/check-pattern-compliance.js:40"]},"second_pass":{"method":"contextual_review","confirmed":true},"tool_confirmation":{"tool":"NONE","result":"confirmed via manual code review","reference":"scripts/check-pattern-compliance.js:40"}}}
{"category":"process","title":"Duplicated: TTY-aware color code across 3+ scripts","fingerprint":"process::scripts::tty-color-duplication","severity":"S3","effort":"E1","confidence":"HIGH","files":["scripts/check-doc-headers.js:48-56","scripts/check-cross-doc-deps.js:32-42","scripts/run-consolidation.js"],"why_it_matters":"TTY color detection and color object creation duplicated across scripts. ~15 lines each. Inconsistent color usage","suggested_fix":"Create shared getColors() utility in scripts/lib/ that returns color object. All scripts import it","acceptance_tests":["Shared getColors() utility exists","All scripts use shared implementation","Color output is consistent","Non-TTY output has no escape codes"],"file":"scripts/check-doc-headers.js","line":48,"description":"TTY color detection and color object creation duplicated across scripts. ~15 lines each. Inconsistent color usage","recommendation":"Create shared getColors() utility in scripts/lib/ that returns color object. All scripts import it","id":"process::scripts::tty-color-duplication"}
{"category":"process","title":"Duplicated: Security validations across all hooks","fingerprint":"process::.claude/hooks::security-validation-duplication","severity":"S2","effort":"E2","confidence":"HIGH","files":[".claude/hooks/check-edit-requirements.js:40-62",".claude/hooks/firestore-write-block.js:76-99",".claude/hooks/pattern-check.js:69-90"],"why_it_matters":"All hooks duplicate identical security validations: startsWith('-') check, multiline rejection, backslash normalization, absolute path blocking, traversal detection. Already covered by validateFilePath() but duplicated inline","suggested_fix":"Use validateFilePath() from validate-paths.js which includes all security checks. Delete inline duplicates","acceptance_tests":["No inline security validation remains","All hooks use validateFilePath()","Security checks are comprehensive and consistent"],"file":".claude/hooks/check-edit-requirements.js","line":40,"description":"All hooks duplicate identical security validations: startsWith('-') check, multiline rejection, backslash normalization, absolute path blocking, traversal detection. Already covered by validateFilePath() but duplicated inline","recommendation":"Use validateFilePath() from validate-paths.js which includes all security checks. Delete inline duplicates","id":"process::.claude/hooks::security-validation-duplication"}
{"category":"process","title":"Duplicated: Git staged files retrieval across scripts","fingerprint":"process::scripts::git-staged-duplication","severity":"S3","effort":"E1","confidence":"HIGH","files":["scripts/check-cross-doc-deps.js:83-97","scripts/check-doc-headers.js","scripts/check-agent-compliance.js"],"why_it_matters":"Multiple scripts duplicate git diff --cached --name-only logic with error handling. ~15 lines each","suggested_fix":"Create shared getStagedFiles() utility in scripts/lib/. All scripts import it","acceptance_tests":["Shared getStagedFiles() utility exists","All scripts use shared implementation","Error handling is consistent"],"file":"scripts/check-cross-doc-deps.js","line":83,"description":"Multiple scripts duplicate git diff --cached --name-only logic with error handling. ~15 lines each","recommendation":"Create shared getStagedFiles() utility in scripts/lib/. All scripts import it","id":"process::scripts::git-staged-duplication"}
{"category":"process","title":"Duplicated: Config loading pattern across 17+ files","fingerprint":"process::scripts::config-loading-duplication","severity":"S3","effort":"E1","confidence":"HIGH","files":["scripts/check-pattern-compliance.js:34-43","scripts/check-doc-headers.js:69-77","scripts/check-cross-doc-deps.js:60-67","scripts/debt/validate-schema.js:26-34"],"why_it_matters":"17+ files duplicate loadConfig/loadConfigWithRegex pattern with try-catch and error message extraction. ~10 lines each. Shared utility exists but usage is inconsistent","suggested_fix":"Create loadConfigSafe() wrapper that handles try-catch internally. All scripts use one-liner: const config = loadConfigSafe('name')","acceptance_tests":["Shared loadConfigSafe() wrapper exists","All scripts use simplified one-liner","Error messages are consistent","Config loading is DRY"],"file":"scripts/check-pattern-compliance.js","line":34,"description":"17+ files duplicate loadConfig/loadConfigWithRegex pattern with try-catch and error message extraction. ~10 lines each. Shared utility exists but usage is inconsistent","recommendation":"Create loadConfigSafe() wrapper that handles try-catch internally. All scripts use one-liner: const config = loadConfigSafe('name')","id":"process::scripts::config-loading-duplication"}
{"category":"process","title":"Duplicated: Base directory resolution across hooks","fingerprint":"process::.claude/hooks::basedir-resolution-duplication","severity":"S2","effort":"E1","confidence":"HIGH","files":[".claude/hooks/check-edit-requirements.js:18",".claude/hooks/pattern-check.js:31-47",".claude/hooks/firestore-write-block.js:40-50"],"why_it_matters":"All hooks duplicate baseDir resolution: path.resolve(process.env.CLAUDE_PROJECT_DIR || process.cwd()) plus security validation. ~10 lines each across 16+ hooks","suggested_fix":"Create getProjectDir() utility in validate-paths.js that returns validated project directory. All hooks use it","acceptance_tests":["Shared getProjectDir() utility exists","All hooks use shared implementation","Security validation is consistent","CLAUDE_PROJECT_DIR handling is uniform"],"file":".claude/hooks/check-edit-requirements.js","line":18,"description":"All hooks duplicate baseDir resolution: path.resolve(process.env.CLAUDE_PROJECT_DIR || process.cwd()) plus security validation. ~10 lines each across 16+ hooks","recommendation":"Create getProjectDir() utility in validate-paths.js that returns validated project directory. All hooks use it","id":"process::.claude/hooks::basedir-resolution-duplication"}
{"category":"process","title":"Duplicated: JSON argument parsing across hooks","fingerprint":"process::.claude/hooks::json-parsing-duplication","severity":"S3","effort":"E1","confidence":"HIGH","files":[".claude/hooks/check-edit-requirements.js:20-31",".claude/hooks/firestore-write-block.js:59-69",".claude/hooks/pattern-check.js:49-67"],"why_it_matters":"All hooks duplicate JSON argument parsing: try parse, extract file_path/content, handle errors. ~15 lines each across 16+ hooks","suggested_fix":"Create parseHookArgs(arg) utility that returns {filePath, content, error}. All hooks use it","acceptance_tests":["Shared parseHookArgs() utility exists","All hooks use shared implementation","Error handling is consistent","Parsing logic is DRY"],"file":".claude/hooks/check-edit-requirements.js","line":20,"description":"All hooks duplicate JSON argument parsing: try parse, extract file_path/content, handle errors. ~15 lines each across 16+ hooks","recommendation":"Create parseHookArgs(arg) utility that returns {filePath, content, error}. All hooks use it","id":"process::.claude/hooks::json-parsing-duplication"}
{"category":"process","title":"Duplicated: File extension checks across hooks","fingerprint":"process::.claude/hooks::extension-check-duplication","severity":"S3","effort":"E1","confidence":"HIGH","files":[".claude/hooks/firestore-write-block.js:102",".claude/hooks/typescript-strict-check.js:81",".claude/hooks/repository-pattern-check.js:111",".claude/hooks/test-mocking-validator.js:81"],"why_it_matters":"Multiple hooks check file extensions with regex patterns. While patterns differ, the approach is duplicated","suggested_fix":"Create utility hasExtension(filePath, extensions) that accepts array of extensions. Standardize extension checking","acceptance_tests":["Shared hasExtension() utility exists","Extension checks are consistent","Code is more readable"],"file":".claude/hooks/firestore-write-block.js","line":102,"description":"Multiple hooks check file extensions with regex patterns. While patterns differ, the approach is duplicated","recommendation":"Create utility hasExtension(filePath, extensions) that accepts array of extensions. Standardize extension checking","id":"process::.claude/hooks::extension-check-duplication"}
{"category":"process","title":"Duplicated: ALLOWED_PATHS pattern matching across hooks","fingerprint":"process::.claude/hooks::allowed-paths-duplication","severity":"S2","effort":"E2","confidence":"HIGH","files":[".claude/hooks/firestore-write-block.js:30-38",".claude/hooks/repository-pattern-check.js:37-47",".claude/hooks/test-mocking-validator.js:88-92"],"why_it_matters":"Multiple hooks define ALLOWED_PATHS arrays and test with .some(pattern.test). Pattern is identical but lists differ. Hard to maintain consistency","suggested_fix":"Centralize path exemption rules in config file. Create isPathExempt(filePath, ruleSet) utility that loads from config","acceptance_tests":["Exemption rules in config file","Shared isPathExempt() utility","All hooks use shared implementation","Rules are easy to update"],"file":".claude/hooks/firestore-write-block.js","line":30,"description":"Multiple hooks define ALLOWED_PATHS arrays and test with .some(pattern.test). Pattern is identical but lists differ. Hard to maintain consistency","recommendation":"Centralize path exemption rules in config file. Create isPathExempt(filePath, ruleSet) utility that loads from config","id":"process::.claude/hooks::allowed-paths-duplication"}
{"category":"process","title":"Duplicated: check-edit-requirements and check-write-requirements logic","fingerprint":"process::.claude/hooks::edit-write-requirements-duplication","severity":"S1","effort":"E2","confidence":"HIGH","files":[".claude/hooks/check-edit-requirements.js:1-108",".claude/hooks/check-write-requirements.js:1-106"],"why_it_matters":"These two hooks are 95% identical. Same path validation (lines 18-63), same security checks, same file type detection. Only difference: priority order and specific messages. ~200 lines duplicated","suggested_fix":"Merge into single check-file-requirements.js that handles both Edit and Write. Pass operation type as parameter","acceptance_tests":["Single check-file-requirements.js exists","Handles both Edit and Write operations","Shared validation logic","Priority order configurable","Old hooks deleted"],"file":".claude/hooks/check-edit-requirements.js","line":1,"description":"These two hooks are 95% identical. Same path validation (lines 18-63), same security checks, same file type detection. Only difference: priority order and specific messages. ~200 lines duplicated","recommendation":"Merge into single check-file-requirements.js that handles both Edit and Write. Pass operation type as parameter","id":"process::.claude/hooks::edit-write-requirements-duplication","evidence":[{"type":"code_reference","detail":".claude/hooks/check-edit-requirements.js:1"},{"type":"description","detail":"These two hooks are 95% identical. Same path validation (lines 18-63), same security checks, same file type detection. Only difference: priority order and specific messages. ~200 lines duplicated"}],"verification_steps":{"first_pass":{"method":"code_search","evidence_collected":[".claude/hooks/check-edit-requirements.js:1"]},"second_pass":{"method":"contextual_review","confirmed":true},"tool_confirmation":{"tool":"NONE","result":"confirmed via manual code review","reference":".claude/hooks/check-edit-requirements.js:1"}}}
{"category":"process","title":"Duplicated: Pattern check implementation between hook and script","fingerprint":"process::patterns::check-implementation-duplication","severity":"S2","effort":"E2","confidence":"HIGH","files":[".claude/hooks/pattern-check.js:1-223","scripts/check-pattern-compliance.js:1-400"],"why_it_matters":"Hook invokes script but also duplicates path validation, file size checks, and output formatting. Hook should be thin wrapper, not duplicate logic","suggested_fix":"Hook should only validate input and delegate to script. Remove duplicated validation logic from hook","acceptance_tests":["Hook is thin wrapper (<50 lines)","All validation in script","No duplicated logic","Hook handles only I/O formatting"],"file":".claude/hooks/pattern-check.js","line":1,"description":"Hook invokes script but also duplicates path validation, file size checks, and output formatting. Hook should be thin wrapper, not duplicate logic","recommendation":"Hook should only validate input and delegate to script. Remove duplicated validation logic from hook","id":"process::patterns::check-implementation-duplication"}
{"category":"process","title":"Duplicated: Validation between validate-audit.js and validate-schema.js","fingerprint":"process::validation::audit-schema-duplication","severity":"S2","effort":"E2","confidence":"HIGH","files":["scripts/validate-audit.js:1-80","scripts/debt/validate-schema.js:1-80"],"why_it_matters":"Both validators load schema from config, validate JSONL structure, check required fields. Core validation logic is similar but implemented twice","suggested_fix":"Extract shared validateJsonlSchema(file, schemaConfig) utility. Both validators use it with different schema configs","acceptance_tests":["Shared validateJsonlSchema() utility exists","Both validators use shared core","Only schema-specific logic differs","Validation behavior is consistent"],"file":"scripts/validate-audit.js","line":1,"description":"Both validators load schema from config, validate JSONL structure, check required fields. Core validation logic is similar but implemented twice","recommendation":"Extract shared validateJsonlSchema(file, schemaConfig) utility. Both validators use it with different schema configs","id":"process::validation::audit-schema-duplication"}
