{"id":"SYST-2026-02-19-D22-001","domain":22,"domain_name":"Sentry & Monitoring","check_id":"22.3","severity":"S1","effort":"E1","category":"security","title":"Dual-logger SENSITIVE_KEYS mismatch — client missing 7 PII keys, server missing 2 identity keys","description":"The client logger (lib/logger.ts:7) has 9 SENSITIVE_KEYS: token, authorization, password, uid, email, auth, idToken, accessToken, refreshToken. The server logger (functions/src/security-logger.ts:161) has 16 SENSITIVE_KEYS: token, authorization, password, secret, cookie, apikey, email, phone, ssn, credit, card, bearer, session, refresh, access, error. The client is missing 7 server keys including PII-critical ones: phone, ssn, credit, card. If client-side error context includes these keys, PII leaks to Sentry unredacted. The server is missing uid and auth keys, meaning user IDs in server log context may not be redacted.","file":"lib/logger.ts","line":7,"evidence":["Client SENSITIVE_KEYS (lib/logger.ts:7-17): token, authorization, password, uid, email, auth, idToken, accessToken, refreshToken — 9 keys","Server SENSITIVE_KEYS (functions/src/security-logger.ts:161-178): token, authorization, password, secret, cookie, apikey, email, phone, ssn, credit, card, bearer, session, refresh, access, error — 16 keys","Client MISSING: secret, cookie, apikey, phone, ssn, credit, card, bearer, session, refresh, access, error — 12 keys not redacted on client","Server MISSING: uid, auth, idToken, accessToken, refreshToken — 5 keys not redacted on server","Different redaction algorithms: client uses looksLikeSensitiveId heuristic, server uses isSensitiveKey key-name matching"],"confidence":"HIGH","recommendation":"Extract SENSITIVE_KEYS to a shared module or ensure both lists cover all PII-relevant keys. At minimum, add phone, ssn, credit, card to the client list.","verification_steps":{"first_pass":{"method":"grep","evidence_collected":["grep SENSITIVE_KEYS lib/logger.ts — 9 keys found","grep SENSITIVE_KEYS functions/src/security-logger.ts — 16 keys found","Compared lists: 7 common keys, 12 client-missing, 5 server-missing"]},"second_pass":{"method":"contextual_review","confirmed":true},"tool_confirmation":{"tool":"NONE","result":"confirmed — manual comparison of both SENSITIVE_KEYS arrays shows significant divergence","reference":"lib/logger.ts:7-17, functions/src/security-logger.ts:161-178"}},"suggested_fix":"Option A (best): Create shared-constants/sensitive-keys.ts importable by both loggers. Option B (quick): Add phone, ssn, credit, card, secret, cookie, apikey to client logger SENSITIVE_KEYS. Add uid, auth to server logger SENSITIVE_KEYS.","status":"accepted","suggestion_text":"Accept at S1. PII redaction gaps mean sensitive data (phone numbers, SSNs, credit card fragments) could leak to Sentry from client-side errors. This is a compliance risk.","counter_argument":"Client and server handle different data. The client rarely encounters phone/ssn/credit data since those aren't collected by the app. The server handles request metadata where uid/auth keys are already hashed before logging.","related_findings":["D22-002","D22-003"],"detected_at":"2026-02-19T17:30:00Z","reviewed_at":"2026-02-19T17:35:00Z"}
{"id":"SYST-2026-02-19-D22-002","domain":22,"domain_name":"Sentry & Monitoring","check_id":"22.8","severity":"S2","effort":"E1","category":"observability","title":"No source map upload to Sentry — production stack traces are minified and unreadable","description":"next.config.mjs does not use withSentryConfig wrapper or any Sentry webpack plugin. No source map upload configuration exists. @sentry/nextjs v10.30.0 is installed and provides the withSentryConfig wrapper, but it's not being used. Production JavaScript is minified, so all error stack traces in Sentry show minified function names and line numbers, making debugging production errors significantly harder.","recommendation":"Wrap next.config.mjs export with withSentryConfig to enable automatic source map upload during builds.","file":"next.config.mjs","line":1,"evidence":"next.config.mjs — no withSentryConfig wrapper, no Sentry webpack plugin\n@sentry/nextjs v10.30.0 installed (includes withSentryConfig)\nNo .sentryclirc or sentry.properties file\nProduction stack traces will show minified code","suggested_fix":"In next.config.mjs: import { withSentryConfig } from '@sentry/nextjs'; then wrap the export: export default withSentryConfig(nextConfig, { org: 'sonash', project: 'javascript-nextjs', silent: true, hideSourceMaps: true }). Note: with output: 'export', verify withSentryConfig is compatible with static exports.","status":"accepted","suggestion_text":"Accept at S2. Without source maps, production error debugging requires manual source map reconstruction. This significantly slows incident response.","counter_argument":"Source map upload requires Sentry auth token in CI/CD and increases build time. For a static export, source maps can be generated locally and uploaded manually when investigating specific errors. The app is relatively small.","related_findings":["D22-001"],"detected_at":"2026-02-19T17:30:00Z","reviewed_at":"2026-02-19T17:35:00Z"}
{"id":"SYST-2026-02-19-D22-003","domain":22,"domain_name":"Sentry & Monitoring","check_id":"22.6","severity":"S2","effort":"E0","category":"security","title":"Server logger (security-logger.ts) does not strip control characters — log injection possible","description":"The client logger (lib/logger.ts:85-87) strips control characters using regex /[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g before logging, preventing log injection attacks. The server logger (functions/src/security-logger.ts) has no equivalent control character stripping. Malicious input containing ANSI escape codes or null bytes could be injected into GCP Cloud Logging, potentially manipulating log viewers, hiding entries, or exploiting log parsing tools.","recommendation":"Add control character stripping to the server logger's message formatting, matching the client logger's approach.","file":"functions/src/security-logger.ts","line":119,"evidence":"lib/logger.ts:85-87 — strips control characters: message.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, '')\nfunctions/src/security-logger.ts — grep for control/strip/sanitize: 0 matches\nServer logs go to GCP Cloud Logging + Sentry + Firestore security_logs","suggested_fix":"Add to logSecurityEvent() in security-logger.ts before logging: const cleanMessage = message.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, ''); Use cleanMessage instead of raw message in log output.","status":"accepted","suggestion_text":"Accept at S2. Log injection is a known OWASP concern. The client already mitigates this; the server should match.","counter_argument":"GCP Cloud Logging uses structured JSON format which inherently escapes special characters. The risk is primarily with log viewing tools that interpret ANSI codes. The server processes authenticated requests only, reducing the attack surface.","related_findings":["D22-001"],"detected_at":"2026-02-19T17:30:00Z","reviewed_at":"2026-02-19T17:35:00Z"}
